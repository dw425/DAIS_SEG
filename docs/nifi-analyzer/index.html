<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NiFi Flow Analyzer</title>
  <script type="module" crossorigin>function aa(e,n){for(var t=0;t<n.length;t++){const s=n[t];if(typeof s!="string"&&!Array.isArray(s)){for(const a in s)if(a!=="default"&&!(a in e)){const o=Object.getOwnPropertyDescriptor(s,a);o&&Object.defineProperty(e,a,o.get?o:{enumerable:!0,get:()=>s[a]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();const ia="modulepreload",ca=function(e,n){return new URL(e,n).href},Rr={},ut=function(n,t,s){let a=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");a=i(t.map(d=>{if(d=ca(d,s),d in Rr)return;Rr[d]=!0;const u=d.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(!!s)for(let m=r.length-1;m>=0;m--){const g=r[m];if(g.href===d&&(!u||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${f}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":ia,u||(h.as="script"),h.crossOrigin="",h.href=d,l&&h.setAttribute("nonce",l),document.head.appendChild(h),u)return new Promise((m,g)=>{h.addEventListener("load",m),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return a.then(i=>{for(const r of i||[])r.status==="rejected"&&o(r.reason);return n().catch(o)})},fr=Object.freeze({parsed:null,analysis:null,assessment:null,notebook:null,migrationReport:null,finalReport:null,manifest:null,validation:null,valueAnalysis:null});let Fe={...fr};const bn=new Set;function la(e={}){return Fe={...fr,...e},bn.clear(),{getState:le,setState:Je,subscribe:da,resetState:It}}function le(e){return e!==void 0?Fe[e]:{...Fe}}function Je(e){if(!e||typeof e!="object")return;const n={...Fe};Object.assign(Fe,e),mr(n)}function da(e){if(typeof e!="function")throw new TypeError("subscribe() expects a function");return bn.add(e),()=>bn.delete(e)}function It(){const e={...Fe};Fe={...fr},mr(e)}const pa=Object.freeze({analyze:["parsed"],assess:["parsed","analysis"],convert:["parsed","assessment"],report:["parsed","notebook"],reportFinal:["parsed","notebook","migrationReport"],validate:["parsed","notebook"],value:["parsed","notebook"]});function Xe(){return JSON.parse(JSON.stringify(Fe))}function Ye(e){if(!e||typeof e!="object")return;const n={...Fe};Fe={...e},mr(n)}function Cn(e){const n=pa[e];if(!n)return{ok:!0,missing:[]};const t=n.filter(s=>Fe[s]==null);return{ok:t.length===0,missing:t}}function mr(e){const n={...Fe};for(const t of bn)try{t(n,e)}catch(s){console.error("[state] subscriber threw:",s)}}class ua{constructor(){this._handlers=new Map}on(n,t){return this._handlers.has(n)||this._handlers.set(n,new Set),this._handlers.get(n).add(t),()=>this.off(n,t)}once(n,t){const s=(...a)=>{this.off(n,s),t(...a)};return this.on(n,s)}off(n,t){const s=this._handlers.get(n);s&&(s.delete(t),s.size===0&&this._handlers.delete(n))}emit(n,...t){const s=this._handlers.get(n);if(s)for(const a of s)try{a(...t)}catch(o){console.error(`[EventBus] handler for "${n}" threw:`,o)}}clear(n){n?this._handlers.delete(n):this._handlers.clear()}}const An=new ua,vn=new Map;let $t=null;function Is(){if($t!==null)return $t;try{const e="__ls_probe__";localStorage.setItem(e,"1"),localStorage.removeItem(e),$t=!0}catch{$t=!1}return $t}function fa(e,n=null){try{if(Is()){const t=localStorage.getItem(e);if(t===null)return n;try{return JSON.parse(t)}catch{return t}}return vn.has(e)?vn.get(e):n}catch{return n}}function ma(e,n){const t=typeof n=="string"?n:JSON.stringify(n);try{return Is()?(localStorage.setItem(e,t),!0):(vn.set(e,n),!0)}catch{return vn.set(e,n),!1}}const Fs="dbx_config",Te=Object.freeze({catalog:"",schema:"",secretScope:"",cloudProvider:"azure",sparkVersion:"14.3.x-scala2.12",nodeType:"Standard_DS3_v2",numWorkers:2,workspacePath:"/Workspace/Migrations/NiFi"});function ha(){try{const e=fa(Fs);return e?{...Te,...JSON.parse(e)}:{...Te}}catch{return{...Te}}}function ga(e){try{ma(Fs,JSON.stringify(e))}catch{}}function Ls(){return{catalog:document.getElementById("cfgCatalog")?.value||"",schema:document.getElementById("cfgSchema")?.value||"",secretScope:document.getElementById("cfgScope")?.value||"",cloudProvider:document.getElementById("cfgCloud")?.value||Te.cloudProvider,sparkVersion:document.getElementById("cfgSparkVersion")?.value||Te.sparkVersion,nodeType:document.getElementById("cfgNodeType")?.value||Te.nodeType,numWorkers:parseInt(document.getElementById("cfgWorkers")?.value)||Te.numWorkers,workspacePath:document.getElementById("cfgWorkspacePath")?.value||Te.workspacePath}}function _a(e,n){return!n||!n.catalog?e:e.replace(/<catalog>|\{catalog\}/g,n.catalog).replace(/<schema>|\{schema\}/g,n.schema||"default").replace(/<scope>|\{scope\}/g,n.secretScope||"migration_secrets").replace(/<workspace_path>/g,n.workspacePath||Te.workspacePath).replace(/<spark_version>/g,n.sparkVersion||Te.sparkVersion).replace(/<node_type>/g,n.nodeType||Te.nodeType)}class Ee extends Error{constructor(n,{code:t,phase:s,severity:a,cause:o,context:i}={}){super(n),this.name="AppError",this.code=t||"UNKNOWN",this.phase=s||"",this.severity=a||"medium",this.cause=o||null,this.context=i||{},this.timestamp=Date.now()}}function Ae(e,n={}){const t=e instanceof Ee?e:new Ee(e.message||String(e),{code:"UNHANDLED",cause:e,...n});console.error(`[${t.code}] ${t.message}`,t)}function ya(){document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{if(e.classList.contains("locked"))return;document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".panel").forEach(t=>t.classList.remove("active")),e.classList.add("active");const n=document.getElementById("panel-"+e.dataset.tab);n&&n.classList.add("active")})})}function rt(e){document.querySelectorAll(".tab").forEach(n=>{n.classList.toggle("active",n.dataset.tab===e)}),document.querySelectorAll(".panel").forEach(n=>{n.classList.toggle("active",n.id==="panel-"+e)})}function fe(e,n){const t=document.querySelector(`.tab[data-tab="${e}"]`);t&&(t.classList.remove("locked","processing","done"),n==="locked"?t.classList.add("locked"):n==="processing"?t.classList.add("processing"):n==="done"&&t.classList.add("done"),n!=="locked"&&(t.style.pointerEvents="",t.style.opacity=""))}function ct(e){fe(e,"ready")}function V(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let yt="",xn="",bt=null;const ba=[".gz",".zip",".nar",".jar",".tgz",".docx",".xlsx"];function Ns(e){const n=e.toLowerCase();return n.endsWith(".tar.gz")||n.endsWith(".xml.gz")||n.endsWith(".json.gz")?!0:ba.some(t=>n.endsWith(t))}function Os(){return yt}function hr(e,n){yt=e,xn=n,bt=null}function Ms(){return xn}function Bs(){return bt}function va(){const e=document.getElementById("fileInput");if(!e)return Promise.resolve();const n=e.files[0];if(!n)return Promise.resolve();xn=n.name;const t=document.getElementById("fileName");t&&(t.textContent="Loaded: "+n.name,t.classList.remove("hidden"));const s=Ns(n.name);return new Promise(a=>{const o=new FileReader;o.onload=i=>{s?(bt=new Uint8Array(i.target.result),yt=""):(yt=i.target.result,bt=null),a()},o.onerror=()=>a(),s?o.readAsArrayBuffer(n):o.readAsText(n)})}function js(){const e=document.getElementById("fileInput"),n=document.getElementById("fileDropZone");!e||!n||(e.setAttribute("accept",".xml,.json,.sql,.txt,.csv,.gz,.zip,.nar,.jar,.tgz,.tar.gz,.docx,.xlsx"),n.addEventListener("click",()=>e.click()),n.addEventListener("dragover",t=>{t.preventDefault(),n.style.borderColor="var(--primary)"}),n.addEventListener("dragleave",()=>{n.style.borderColor="var(--border)"}),n.addEventListener("drop",async t=>{t.preventDefault(),n.style.borderColor="var(--border)";const s=t.dataTransfer.files[0];if(s){xn=s.name;const a=document.getElementById("fileName");a&&(a.textContent="Loaded: "+s.name,a.classList.remove("hidden"));const o=Ns(s.name);await new Promise(i=>{const r=new FileReader;r.onload=c=>{o?(bt=new Uint8Array(c.target.result),yt=""):(yt=c.target.result,bt=null),i()},r.onerror=()=>i(),o?r.readAsArrayBuffer(s):r.readAsText(s)}),e.dispatchEvent(new Event("change",{bubbles:!0}))}}))}const ka=Object.freeze(Object.defineProperty({__proto__:null,getUploadedBytes:Bs,getUploadedContent:Os,getUploadedName:Ms,handleFile:va,initFileUpload:js,setUploadedContent:hr},Symbol.toStringTag,{value:"Module"})),Sa={etl:`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<flowController encoding-version="1.4">
  <rootGroup><name>ETL_Demo_Pipeline</name>
    <processor><id>p1</id><name>Read Source CSV</name><class>org.apache.nifi.processors.standard.GetFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>5 min</schedulingPeriod><state>RUNNING</state>
      <property><name>Input Directory</name><value>/data/input/sales</value></property>
      <property><name>File Filter</name><value>[^\\\\.].*\\\\.csv</value></property>
      <autoTerminatedRelationship>failure</autoTerminatedRelationship>
    </processor>
    <processor><id>p2</id><name>Validate Schema</name><class>org.apache.nifi.processors.standard.ValidateRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Record Reader</name><value>CSVReader</value></property>
      <property><name>Record Writer</name><value>CSVWriter</value></property>
    </processor>
    <processor><id>p3</id><name>Route by Region</name><class>org.apache.nifi.processors.standard.RouteOnAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Routing Strategy</name><value>Route to Property name</value></property>
      <property><name>us_east</name><value>\${region:equals("US-East")}</value></property>
      <property><name>us_west</name><value>\${region:equals("US-West")}</value></property>
      <property><name>europe</name><value>\${region:equals("EU")}</value></property>
    </processor>
    <processor><id>p4</id><name>Transform Sales Data</name><class>org.apache.nifi.processors.standard.ReplaceText</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Search Value</name><value>"amount":"(\\d+)"</value></property>
      <property><name>Replacement Value</name><value>"amount_cents":"\${1}00"</value></property>
      <property><name>Replacement Strategy</name><value>Regex Replace</value></property>
    </processor>
    <processor><id>p5</id><name>Query Sales Summary</name><class>org.apache.nifi.processors.standard.ExecuteSQL</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Database Connection Pooling Service</name><value>DBCPService</value></property>
      <property><name>SQL select query</name><value>SELECT region, product, SUM(amount) as total, COUNT(*) as cnt FROM sales.transactions WHERE trade_date >= CURRENT_DATE - 7 GROUP BY region, product</value></property>
    </processor>
    <processor><id>p6</id><name>Update Attributes</name><class>org.apache.nifi.processors.standard.UpdateAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>output.filename</name><value>\${filename:substringBefore('.')}_processed_\${now():format('yyyyMMdd')}.csv</value></property>
      <property><name>batch.id</name><value>\${UUID()}</value></property>
    </processor>
    <processor><id>p7</id><name>Write to Data Lake</name><class>org.apache.nifi.processors.standard.PutFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Directory</name><value>/data/output/processed_sales</value></property>
      <property><name>Conflict Resolution Strategy</name><value>replace</value></property>
    </processor>
    <processor><id>p8</id><name>Insert to Warehouse</name><class>org.apache.nifi.processors.standard.PutDatabaseRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Database Connection Pooling Service</name><value>DBCPService</value></property>
      <property><name>Table Name</name><value>warehouse.sales_processed</value></property>
      <property><name>Statement Type</name><value>INSERT</value></property>
    </processor>
    <processor><id>p9</id><name>Log Completion</name><class>org.apache.nifi.processors.standard.LogMessage</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
      <property><name>Log Level</name><value>info</value></property>
      <property><name>Log Message</name><value>ETL batch complete: \${batch.id}</value></property>
    </processor>
    <connection><id>c1</id><source><id>p1</id><type>PROCESSOR</type></source><destination><id>p2</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>c2</id><source><id>p2</id><type>PROCESSOR</type></source><destination><id>p3</id><type>PROCESSOR</type></destination><relationship>valid</relationship></connection>
    <connection><id>c3</id><source><id>p3</id><type>PROCESSOR</type></source><destination><id>p4</id><type>PROCESSOR</type></destination><relationship>us_east</relationship></connection>
    <connection><id>c4</id><source><id>p3</id><type>PROCESSOR</type></source><destination><id>p4</id><type>PROCESSOR</type></destination><relationship>us_west</relationship></connection>
    <connection><id>c5</id><source><id>p3</id><type>PROCESSOR</type></source><destination><id>p4</id><type>PROCESSOR</type></destination><relationship>europe</relationship></connection>
    <connection><id>c6</id><source><id>p4</id><type>PROCESSOR</type></source><destination><id>p5</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>c7</id><source><id>p5</id><type>PROCESSOR</type></source><destination><id>p6</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>c8</id><source><id>p6</id><type>PROCESSOR</type></source><destination><id>p7</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>c9</id><source><id>p6</id><type>PROCESSOR</type></source><destination><id>p8</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>c10</id><source><id>p8</id><type>PROCESSOR</type></source><destination><id>p9</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
  </rootGroup>
  <controllerServices>
    <controllerService><id>cs1</id><name>DBCPService</name><class>org.apache.nifi.dbcp.DBCPConnectionPool</class><property><name>Database Connection URL</name><value>jdbc:postgresql://db.example.com:5432/analytics</value></property><property><name>Database User</name><value>etl_user</value></property><property><name>Password</name><value>s3cur3_p4ss</value></property></controllerService>
  </controllerServices>
</flowController>`,streaming:`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<flowController encoding-version="1.4">
  <rootGroup><name>Streaming_IoT_Pipeline</name>
    <processGroup><name>IoT Ingestion</name>
      <processor><id>s1</id><name>Consume Kafka Events</name><class>org.apache.nifi.processors.kafka.pubsub.ConsumeKafka_2_6</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>100 ms</schedulingPeriod><state>RUNNING</state>
        <property><name>Kafka Brokers</name><value>kafka-broker-1:9092,kafka-broker-2:9092</value></property>
        <property><name>Topic Name(s)</name><value>iot.sensor.readings</value></property>
        <property><name>Group ID</name><value>nifi-iot-consumer</value></property>
      </processor>
      <processor><id>s2</id><name>Parse JSON Payload</name><class>org.apache.nifi.processors.standard.EvaluateJsonPath</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Destination</name><value>flowfile-attribute</value></property>
        <property><name>sensor_id</name><value>$.sensor_id</value></property>
        <property><name>temperature</name><value>$.readings.temperature</value></property>
        <property><name>humidity</name><value>$.readings.humidity</value></property>
        <property><name>timestamp</name><value>$.event_time</value></property>
      </processor>
      <processor><id>s3</id><name>Route by Threshold</name><class>org.apache.nifi.processors.standard.RouteOnAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Routing Strategy</name><value>Route to Property name</value></property>
        <property><name>alert</name><value>\${temperature:gt(100):or(\${humidity:gt(95)})}</value></property>
        <property><name>normal</name><value>\${temperature:le(100):and(\${humidity:le(95)})}</value></property>
      </processor>
      <connection><id>sc1</id><source><id>s1</id><type>PROCESSOR</type></source><destination><id>s2</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>sc2</id><source><id>s2</id><type>PROCESSOR</type></source><destination><id>s3</id><type>PROCESSOR</type></destination><relationship>matched</relationship></connection>
    </processGroup>
    <processGroup><name>Alert Processing</name>
      <processor><id>s4</id><name>Enrich Alert Data</name><class>org.apache.nifi.processors.standard.LookupAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Lookup Service</name><value>DeviceRegistry</value></property>
        <property><name>device.name</name><value>\${sensor_id}</value></property>
      </processor>
      <processor><id>s5</id><name>Format Alert Notification</name><class>org.apache.nifi.processors.standard.ReplaceText</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Replacement Value</name><value>{"alert":"THRESHOLD_EXCEEDED","sensor":"\${sensor_id}","temp":"\${temperature}","humidity":"\${humidity}","device":"\${device.name}","time":"\${timestamp}"}</value></property>
        <property><name>Replacement Strategy</name><value>Always Replace</value></property>
      </processor>
      <processor><id>s6</id><name>Send Alert to API</name><class>org.apache.nifi.processors.standard.InvokeHTTP</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Remote URL</name><value>https://alerts.example.com/api/v2/notify</value></property>
        <property><name>HTTP Method</name><value>POST</value></property>
        <property><name>Content-Type</name><value>application/json</value></property>
      </processor>
      <connection><id>sc3</id><source><id>s4</id><type>PROCESSOR</type></source><destination><id>s5</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>sc4</id><source><id>s5</id><type>PROCESSOR</type></source><destination><id>s6</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <processGroup><name>Data Storage</name>
      <processor><id>s7</id><name>Batch Readings</name><class>org.apache.nifi.processors.standard.MergeContent</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Merge Strategy</name><value>Bin-Packing Algorithm</value></property>
        <property><name>Minimum Number of Entries</name><value>100</value></property>
        <property><name>Maximum Number of Entries</name><value>1000</value></property>
        <property><name>Max Bin Age</name><value>30 sec</value></property>
      </processor>
      <processor><id>s8</id><name>Convert to Parquet</name><class>org.apache.nifi.processors.standard.ConvertRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Record Reader</name><value>JsonTreeReader</value></property>
        <property><name>Record Writer</name><value>ParquetRecordSetWriter</value></property>
      </processor>
      <processor><id>s9</id><name>Write to Delta Lake</name><class>org.apache.nifi.processors.standard.PutHDFS</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Directory</name><value>/data/iot/sensor_readings/\${now():format('yyyy/MM/dd')}</value></property>
        <property><name>Conflict Resolution Strategy</name><value>replace</value></property>
      </processor>
      <processor><id>s10</id><name>Insert to Timeseries DB</name><class>org.apache.nifi.processors.standard.PutDatabaseRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Database Connection Pooling Service</name><value>TimeseriesDBCP</value></property>
        <property><name>Table Name</name><value>iot.sensor_readings</value></property>
        <property><name>Statement Type</name><value>INSERT</value></property>
      </processor>
      <connection><id>sc5</id><source><id>s7</id><type>PROCESSOR</type></source><destination><id>s8</id><type>PROCESSOR</type></destination><relationship>merged</relationship></connection>
      <connection><id>sc6</id><source><id>s8</id><type>PROCESSOR</type></source><destination><id>s9</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>sc7</id><source><id>s8</id><type>PROCESSOR</type></source><destination><id>s10</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <connection><id>sc_g1</id><source><id>s3</id><type>PROCESSOR</type></source><destination><id>s4</id><type>PROCESSOR</type></destination><relationship>alert</relationship></connection>
    <connection><id>sc_g2</id><source><id>s3</id><type>PROCESSOR</type></source><destination><id>s7</id><type>PROCESSOR</type></destination><relationship>normal</relationship></connection>
    <connection><id>sc_g3</id><source><id>s3</id><type>PROCESSOR</type></source><destination><id>s7</id><type>PROCESSOR</type></destination><relationship>alert</relationship></connection>
  </rootGroup>
</flowController>`,full:`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<flowController encoding-version="1.4">
  <rootGroup><name>Manufacturing_Data_Pipeline</name>
    <processGroup><name>Data Ingestion</name>
      <processor><id>f1</id><name>Scan Input Directory</name><class>org.apache.nifi.processors.standard.GetFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>1 min</schedulingPeriod><state>RUNNING</state>
        <property><name>Input Directory</name><value>/data/mfg/incoming</value></property>
        <property><name>File Filter</name><value>.*\\.(csv|json|xml)</value></property>
        <property><name>Keep Source File</name><value>false</value></property>
      </processor>
      <processor><id>f2</id><name>List SFTP Uploads</name><class>org.apache.nifi.processors.standard.ListFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>5 min</schedulingPeriod><state>RUNNING</state>
        <property><name>Input Directory</name><value>/sftp/uploads/mfg_data</value></property>
        <property><name>File Filter</name><value>production_.*\\.csv</value></property>
      </processor>
      <processor><id>f3</id><name>Fetch Upload Contents</name><class>org.apache.nifi.processors.standard.FetchFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>File to Fetch</name><value>\${absolute.path}/\${filename}</value></property>
      </processor>
      <processor><id>f4</id><name>Query Production Metrics</name><class>org.apache.nifi.processors.standard.ExecuteSQL</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>10 min</schedulingPeriod><state>RUNNING</state>
        <property><name>Database Connection Pooling Service</name><value>MfgDBCP</value></property>
        <property><name>SQL select query</name><value>SELECT lot_id, wafer_id, step_name, measurement, result, operator, meas_time FROM mfg_data.production_steps WHERE meas_time >= CURRENT_TIMESTAMP - INTERVAL '1' HOUR ORDER BY meas_time</value></property>
      </processor>
      <connection><id>fc1</id><source><id>f2</id><type>PROCESSOR</type></source><destination><id>f3</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <processGroup><name>Data Transformation</name>
      <processor><id>f5</id><name>Route by File Type</name><class>org.apache.nifi.processors.standard.RouteOnAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Routing Strategy</name><value>Route to Property name</value></property>
        <property><name>csv_files</name><value>\${filename:endsWith('.csv')}</value></property>
        <property><name>json_files</name><value>\${filename:endsWith('.json')}</value></property>
        <property><name>xml_files</name><value>\${filename:endsWith('.xml')}</value></property>
      </processor>
      <processor><id>f6</id><name>Parse JSON Metrics</name><class>org.apache.nifi.processors.standard.EvaluateJsonPath</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Destination</name><value>flowfile-attribute</value></property>
        <property><name>lot_id</name><value>$.lot_id</value></property>
        <property><name>status</name><value>$.quality_status</value></property>
        <property><name>yield_pct</name><value>$.yield_percentage</value></property>
      </processor>
      <processor><id>f7</id><name>Normalize Data Format</name><class>org.apache.nifi.processors.standard.ConvertRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Record Reader</name><value>InferAvroReader</value></property>
        <property><name>Record Writer</name><value>CSVRecordSetWriter</value></property>
      </processor>
      <processor><id>f8</id><name>Add Processing Metadata</name><class>org.apache.nifi.processors.standard.UpdateAttribute</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>processing.timestamp</name><value>\${now():format('yyyy-MM-dd HH:mm:ss')}</value></property>
        <property><name>source.system</name><value>nifi_mfg_pipeline</value></property>
        <property><name>batch.id</name><value>\${UUID()}</value></property>
        <property><name>output.filename</name><value>\${filename:substringBefore('.')}_enriched_\${now():format('yyyyMMdd_HHmmss')}.csv</value></property>
      </processor>
      <connection><id>fc2</id><source><id>f5</id><type>PROCESSOR</type></source><destination><id>f6</id><type>PROCESSOR</type></destination><relationship>json_files</relationship></connection>
      <connection><id>fc3</id><source><id>f5</id><type>PROCESSOR</type></source><destination><id>f7</id><type>PROCESSOR</type></destination><relationship>csv_files</relationship></connection>
      <connection><id>fc4</id><source><id>f6</id><type>PROCESSOR</type></source><destination><id>f8</id><type>PROCESSOR</type></destination><relationship>matched</relationship></connection>
      <connection><id>fc5</id><source><id>f7</id><type>PROCESSOR</type></source><destination><id>f8</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <processGroup><name>Data Loading</name>
      <processor><id>f9</id><name>Write to Staging</name><class>org.apache.nifi.processors.standard.PutFile</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Directory</name><value>/data/mfg/staging</value></property>
        <property><name>Conflict Resolution Strategy</name><value>replace</value></property>
      </processor>
      <processor><id>f10</id><name>Upload to HDFS</name><class>org.apache.nifi.processors.hadoop.PutHDFS</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Directory</name><value>/data/warehouse/mfg_production</value></property>
        <property><name>Conflict Resolution Strategy</name><value>replace</value></property>
      </processor>
      <processor><id>f11</id><name>Insert Production Records</name><class>org.apache.nifi.processors.standard.PutDatabaseRecord</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Database Connection Pooling Service</name><value>MfgDBCP</value></property>
        <property><name>Table Name</name><value>mfg_data.production_processed</value></property>
        <property><name>Statement Type</name><value>INSERT</value></property>
      </processor>
      <processor><id>f12</id><name>Transfer to Partner SFTP</name><class>org.apache.nifi.processors.standard.PutSFTP</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Hostname</name><value>sftp.partner.example.com</value></property>
        <property><name>Port</name><value>22</value></property>
        <property><name>Username</name><value>mfg_data_xfer</value></property>
        <property><name>Password</name><value>xfer_s3cret!</value></property>
        <property><name>Remote Path</name><value>/incoming/mfg/\${now():format('yyyyMMdd')}</value></property>
      </processor>
      <connection><id>fc6</id><source><id>f9</id><type>PROCESSOR</type></source><destination><id>f10</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>fc7</id><source><id>f9</id><type>PROCESSOR</type></source><destination><id>f11</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>fc8</id><source><id>f10</id><type>PROCESSOR</type></source><destination><id>f12</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <processGroup><name>Orchestration</name>
      <processor><id>f13</id><name>Signal Data Ready</name><class>org.apache.nifi.processors.standard.Notify</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Signal Counter Name</name><value>mfg_data_ready</value></property>
        <property><name>Signal Counter Delta</name><value>1</value></property>
      </processor>
      <processor><id>f14</id><name>Wait for All Sources</name><class>org.apache.nifi.processors.standard.Wait</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>5 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Signal Counter Name</name><value>mfg_data_ready</value></property>
        <property><name>Target Signal Count</name><value>3</value></property>
      </processor>
      <processor><id>f15</id><name>Run Aggregation Script</name><class>org.apache.nifi.processors.standard.ExecuteStreamCommand</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Command</name><value>/opt/scripts/aggregate_mfg.sh</value></property>
        <property><name>Command Arguments</name><value>/data/mfg/staging /data/mfg/aggregated</value></property>
      </processor>
      <processor><id>f16</id><name>Refresh Impala Tables</name><class>org.apache.nifi.processors.standard.ExecuteStreamCommand</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Command</name><value>impala-shell</value></property>
        <property><name>Command Arguments</name><value>-q INVALIDATE METADATA mfg_data.production_processed; COMPUTE STATS mfg_data.production_processed;</value></property>
      </processor>
      <processor><id>f17</id><name>Log Pipeline Status</name><class>org.apache.nifi.processors.standard.LogMessage</class><schedulingStrategy>TIMER_DRIVEN</schedulingStrategy><schedulingPeriod>0 sec</schedulingPeriod><state>RUNNING</state>
        <property><name>Log Level</name><value>info</value></property>
        <property><name>Log Message</name><value>Manufacturing pipeline complete: batch=\${batch.id}, files=\${file.count}, timestamp=\${processing.timestamp}</value></property>
      </processor>
      <connection><id>fc9</id><source><id>f14</id><type>PROCESSOR</type></source><destination><id>f15</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>fc10</id><source><id>f15</id><type>PROCESSOR</type></source><destination><id>f16</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
      <connection><id>fc11</id><source><id>f16</id><type>PROCESSOR</type></source><destination><id>f17</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    </processGroup>
    <connection><id>fc_g1</id><source><id>f1</id><type>PROCESSOR</type></source><destination><id>f5</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>fc_g2</id><source><id>f3</id><type>PROCESSOR</type></source><destination><id>f5</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>fc_g3</id><source><id>f4</id><type>PROCESSOR</type></source><destination><id>f8</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>fc_g4</id><source><id>f8</id><type>PROCESSOR</type></source><destination><id>f9</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>fc_g5</id><source><id>f11</id><type>PROCESSOR</type></source><destination><id>f13</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
    <connection><id>fc_g6</id><source><id>f12</id><type>PROCESSOR</type></source><destination><id>f13</id><type>PROCESSOR</type></destination><relationship>success</relationship></connection>
  </rootGroup>
  <controllerServices>
    <controllerService><id>cs_mfg</id><name>MfgDBCP</name><class>org.apache.nifi.dbcp.DBCPConnectionPool</class>
      <property><name>Database Connection URL</name><value>jdbc:oracle:thin:@mfg-db.example.com:1521/MFGPRD</value></property>
      <property><name>Database User</name><value>mfg_reader</value></property>
      <property><name>Password</name><value>mfg_r34d3r!</value></property>
      <property><name>Database Driver Class Name</name><value>oracle.jdbc.driver.OracleDriver</value></property>
    </controllerService>
  </controllerServices>
</flowController>`};async function wa(e,n){const t=Sa[e];if(!t)return;const s={etl:"ETL Pipeline (9 processors)",streaming:"Streaming IoT (10 processors)",full:"Manufacturing Migration (17 processors)"};hr(t,`sample_${e}_flow.xml`);const a=document.getElementById("fileName");a&&(a.textContent="Sample: "+(s[e]||e),a.classList.remove("hidden"));const o=document.getElementById("pasteInput");o&&(o.value=""),typeof n=="function"&&await n()}async function Ea(e,n,t){const s=document.getElementById("fileName");s&&(s.textContent="Loading: "+n+"...",s.classList.remove("hidden"));try{const a=await fetch(e);if(!a.ok)throw new Error("HTTP "+a.status);const o=await a.text();hr(o,n),s&&(s.textContent="Sample: "+n);const i=document.getElementById("pasteInput");i&&(i.value=""),typeof t=="function"&&await t()}catch(a){s&&(s.textContent="Failed to load "+n+" — "+a.message,s.style.color="var(--red)",setTimeout(()=>{s.style.color=""},3e3))}}const qs=/password|secret|token|key|auth|credential|cert|private|keytab|passphrase/i;function Ca(e,n){return qs.test(e)?"********":n}function Us(e){return qs.test(e)}function zs(e){let n=0;const t=[],s=new Set,a={},o={},i=[];function r(c){a[c]=o[c]=n++,t.push(c),s.add(c);for(const l of e[c]||[])a[l]===void 0?(r(l),o[c]=Math.min(o[c],o[l])):s.has(l)&&(o[c]=Math.min(o[c],a[l]));if(o[c]===a[c]){const l=[];let d;do d=t.pop(),s.delete(d),l.push(d);while(d!==c);l.length>1&&i.push(l)}}for(const c of Object.keys(e))a[c]===void 0&&r(c);return i}const xa={GetFile:"source",GetHTTP:"source",ConsumeKafka:"source",ConsumeKafka_2_6:"source",ConsumeKafkaRecord_2_6:"source",QueryDatabaseTable:"source",QueryDatabaseTableRecord:"source",ListenHTTP:"source",GetSFTP:"source",GetFTP:"source",GenerateFlowFile:"source",ListS3:"source",FetchS3Object:"source",ListFile:"source",ListSFTP:"source",ListFTP:"source",TailFile:"source",GetMongo:"source",FetchFile:"source",GetElasticsearch:"source",GetSQS:"source",ConsumeJMS:"source",ConsumeMQTT:"source",ConsumeAMQP:"source",GetHDFS:"source",FetchHDFS:"source",ListHDFS:"source",ConsumeAzureEventHub:"source",FetchAzureBlobStorage:"source",HandleHttpRequest:"source",ConsumeGCPubSub:"source",ConsumeKinesisStream:"source",GetDynamoDB:"source",FetchGCS:"source",ListGCSBucket:"source",GetHBase:"source",GetCouchbaseKey:"source",GetCypher:"source",ReplaceText:"transform",EvaluateJsonPath:"transform",ConvertRecord:"transform",UpdateAttribute:"transform",FlattenJson:"transform",JoltTransformJSON:"transform",SplitJson:"transform",SplitContent:"transform",MergeContent:"transform",MergeRecord:"transform",CompressContent:"transform",ConvertAvroToJSON:"transform",ConvertAvroToORC:"transform",ConvertCSVToAvro:"transform",ConvertJSONToAvro:"transform",ConvertJSONToSQL:"transform",ExtractText:"transform",TransformXml:"transform",EvaluateXPath:"transform",EvaluateXQuery:"transform",EncryptContent:"transform",HashAttribute:"transform",SplitXml:"transform",SplitText:"transform",SplitAvro:"transform",SplitRecord:"transform",ExtractGrok:"transform",ExtractHL7Attributes:"transform",ExecuteScript:"transform",ExecuteGroovyScript:"transform",AttributesToJSON:"transform",ForkRecord:"transform",SampleRecord:"transform",JoltTransformRecord:"transform",ConvertCharacterSet:"transform",ParseCEF:"transform",ParseEvtx:"transform",ParseNetflowv5:"transform",ParseSyslog5424:"transform",UnpackContent:"transform",IdentifyMimeType:"transform",ModifyBytes:"transform",SegmentContent:"transform",DuplicateFlowFile:"transform",RouteOnAttribute:"route",RouteOnContent:"route",RouteText:"route",RouteHL7:"route",ValidateRecord:"route",DistributeLoad:"route",DetectDuplicate:"route",ExecuteSQL:"process",InvokeHTTP:"process",ExecuteStreamCommand:"process",LookupRecord:"process",LookupAttribute:"process",HandleHttpResponse:"process",ExecuteProcess:"process",InvokeAWSGatewayApi:"process",PutFile:"sink",PutHDFS:"sink",PutDatabaseRecord:"sink",PutSQL:"sink",PutS3Object:"sink",PutSFTP:"sink",PutFTP:"sink",PutEmail:"sink",PublishKafka:"sink",PublishKafka_2_6:"sink",PublishKafkaRecord_2_6:"sink",PutAzureBlobStorage:"sink",PutAzureDataLakeStorage:"sink",PutElasticsearch:"sink",PutMongo:"sink",PutHBaseJSON:"sink",PutHBaseCell:"sink",PutSNS:"sink",PutDynamoDB:"sink",PutKinesisStream:"sink",PutGCSObject:"sink",PublishGCPubSub:"sink",PutDatabaseRecord:"sink",PutSyslog:"sink",PutTCP:"sink",LogMessage:"utility",LogAttribute:"utility",Wait:"utility",Notify:"utility",DebugFlow:"utility",CountText:"utility"};function Ce(e){return xa[e]||(/^(Get|List|Consume|Listen|Fetch|Tail|Query)/i.test(e)?"source":/^(Put|Publish|Send|Post)/i.test(e)?"sink":/^(Route|Distribute|Control|Validate|Detect)/i.test(e)?"route":/^(Convert|Split|Merge|Replace|Transform|Extract|Evaluate|Flatten|Compress|Encrypt|Hash)/i.test(e)?"transform":/^(Execute|Invoke|Lookup|Handle)/i.test(e)?"process":/^(Log|Debug|Count|Wait|Notify)/i.test(e)?"utility":"process")}const Nt=["source","route","transform","process","sink","utility"],Pa={source:"#3B82F6",route:"#EAB308",transform:"#A855F7",process:"#6366F1",sink:"#21C354",utility:"#808495"},Ta={source:"SOURCES",route:"ROUTING",transform:"TRANSFORMS",process:"PROCESSING",sink:"SINKS",utility:"UTILITY"};function Da(e){const n=[["source",e.sources],["route",e.routes],["transform",e.transforms],["process",e.processes],["sink",e.sinks],["utility",e.utilities]];return n.sort((t,s)=>s[1]!==t[1]?s[1]-t[1]:Nt.indexOf(t[0])-Nt.indexOf(s[0])),n[0][1]>0?n[0][0]:"process"}function Ra(e,n){return n&&n._nifi?$a(n._nifi):{nodes:[],connections:[],tierLabels:{},tierColors:{},cycles:[]}}function $a(e,n){const t=[],s=[],a={},o=e.processors||[],i=e.connections||[];e.processGroups;const r={};o.forEach(S=>{const y=S.group||"(root)";r[y]||(r[y]={sources:0,sinks:0,routes:0,transforms:0,processes:0,utilities:0,total:0,processors:[],typeCount:{}});const C=Ce(S.type);r[y][C+"s"]=(r[y][C+"s"]||0)+1,r[y].total++,r[y].processors.push(S),r[y].typeCount[S.type]=(r[y].typeCount[S.type]||0)+1});const c={};o.forEach(S=>{c[S.name]=S.group||"(root)"});const l={},d={};i.forEach(S=>{const y=c[S.sourceName]||"(root)",C=c[S.destinationName]||"(root)";if(y!==C){const P=y+"|"+C;l[P]=(l[P]||0)+1}else d[y]=(d[y]||0)+1});const u=Object.keys(r),f={};Object.keys(l).forEach(S=>{const[y,C]=S.split("|");f[y]||(f[y]=new Set),f[y].add(C)}),u.forEach(S=>{f[S]||(f[S]=new Set)});const p=zs(f),h=new Set,m={};p.forEach((S,y)=>{S.forEach(C=>{h.add(C),m[C]=y})});const g={};u.forEach(S=>{g[S]=Da(r[S])});const _={};Nt.forEach(S=>{_[S]=[]}),u.forEach(S=>{_[g[S]].push(S)}),Nt.forEach(S=>{const y=S+"s";_[S].sort((C,P)=>{const R=(r[C][y]||0)/(r[C].total||1),A=(r[P][y]||0)/(r[P].total||1);return A!==R?A-R:r[P].total-r[C].total})});let E=0;Nt.forEach(S=>{const y=_[S];if(!y.length)return;E++;const C=Pa[S],P=C.replace("#","").match(/.{2}/g).map(R=>parseInt(R,16));a[E]={label:Ta[S],color:C,bg:`rgba(${P[0]},${P[1]},${P[2]},0.06)`,role:S},y.forEach(R=>{const A=r[R],T=Object.entries(A.typeCount).sort((U,Y)=>Y[1]-U[1]).slice(0,3).map(([U,Y])=>`${U}(${Y})`).join(", "),I=h.has(R),v=m[R],M=I?p[v]:[],K=I?Object.entries(l).filter(([U])=>{const[Y,j]=U.split("|");return p[v].includes(Y)&&p[v].includes(j)}).map(([U,Y])=>{const[j,X]=U.split("|");return{from:j,to:X,count:Y}}):[];t.push({id:"pg_"+R,name:R,tier:E,type:"process_group",dominantRole:g[R],subtype:g[R]+"s",procCount:A.total,srcCount:A.sources,sinkCount:A.sinks,routeCount:A.routes,transformCount:A.transforms,processCount:A.processes,utilityCount:A.utilities,intraConns:d[R]||0,topTypes:T,inCycle:I,sccMembers:M,cycleEdges:K,expandable:!0,detail:{processors:A.processors,typeCount:A.typeCount,intraConns:d[R]||0}})})}),Object.entries(l).forEach(([S,y])=>{const[C,P]=S.split("|"),R=h.has(C)&&h.has(P)&&m[C]===m[P];s.push({from:"pg_"+C,to:"pg_"+P,label:y>1?y+" flows":"1 flow",type:"flow",color:R?"#EF4444":"#4B5563",width:Math.min(1+y*.3,4),inCycle:R})});const w=[],x={};o.forEach(S=>{x[S.type]=(x[S.type]||0)+1}),Object.entries(x).sort((S,y)=>y[1]-S[1]).forEach(([S,y])=>{const C=Ce(S);w.push({name:S,writers:y,readers:0,lookups:0,total:y,role:C})});const b=p.map((S,y)=>({id:y,groups:S,edgeCount:Object.keys(l).filter(C=>{const[P,R]=C.split("|");return S.includes(P)&&S.includes(R)}).length}));return{nodes:t,connections:s,tierLabels:a,diagramType:"nifi_flow",densityData:w,cycleData:b}}function Gs(e,n=250){let t=null,s=null,a=null;function o(...i){s=i,a=this,clearTimeout(t),t=setTimeout(()=>{t=null,e.apply(a,s),s=a=null},n)}return o.cancel=()=>{clearTimeout(t),t=null,s=a=null},o.flush=()=>{t!==null&&(clearTimeout(t),t=null,e.apply(a,s),s=a=null)},o}function Aa(e,n,t,s,a){const o=new Set([e]),i=new Set;function r(d){t.forEach(u=>{const f=u.from+"|"+u.to;u.from===d&&!i.has(f)&&(i.add(f),o.add(u.to),r(u.to))})}function c(d){t.forEach(u=>{const f=u.from+"|"+u.to;u.to===d&&!i.has(f)&&(i.add(f),o.add(u.from),c(u.from))})}r(e),c(e),Object.entries(s).forEach(([d,u])=>{o.has(d)?(u.classList.add("highlighted"),u.classList.remove("dimmed"),d===e&&u.classList.add("selected")):(u.classList.add("dimmed"),u.classList.remove("highlighted","selected"))});const l=a.querySelector("svg.tier-svg");l&&l.querySelectorAll("path[data-from]").forEach(d=>{const u=d.dataset.from+"|"+d.dataset.to;i.has(u)?(d.setAttribute("opacity","1"),d.setAttribute("stroke","#FAFAFA"),d.setAttribute("stroke-width","3"),d.setAttribute("filter","url(#glow)"),d.setAttribute("marker-end","url(#arrow-white)"),d.style.transition="all 0.2s ease"):(d.setAttribute("opacity","0.08"),d.removeAttribute("filter"))})}const Ia=Gs(Aa,30);function Fa(e,n){Object.values(e).forEach(s=>{s.classList.remove("highlighted","dimmed","selected")});const t=n.querySelector("svg.tier-svg");t&&t.querySelectorAll("path[data-from]").forEach(s=>{s.setAttribute("opacity","0.35"),s.setAttribute("stroke",s.dataset.origColor||"#4B5563"),s.setAttribute("stroke-width",s.dataset.origWidth||"1.5"),s.removeAttribute("filter");const a=s.dataset.origColor||"",o=a.includes("EF44")?"arrow-red":a.includes("F59E")||a.includes("F5")?"arrow-amber":a.includes("6366")?"arrow-purple":a.includes("3B82")?"arrow-blue":a.includes("21C3")?"arrow-green":"arrow-default";s.setAttribute("marker-end",`url(#${o})`),s.style.transition=""})}function mt(e,n,t){const s={};e.forEach(r=>{s[r.from]||(s[r.from]=[]),s[r.from].push({to:r.to,key:r.from+"|"+r.to})});const a=new Set([n]),o={},i=[n];for(;i.length;){const r=i.shift();if(r===t){const c=[],l=[];let d=t;for(;d!==n;)c.unshift(d),l.unshift(o[d].key),d=o[d].from;return c.unshift(n),{pathNodes:c,pathEdgeKeys:l,found:!0}}for(const c of s[r]||[])a.has(c.to)||(a.add(c.to),o[c.to]={from:r,key:c.key},i.push(c.to))}return{pathNodes:[],pathEdgeKeys:[],found:!1}}function Hs(e){let n=document.getElementById("pathTraceToast");n||(n=document.createElement("div"),n.id="pathTraceToast",n.className="path-trace-toast",document.body.appendChild(n));const t=e.selected.length,s=e.pathNodes.size,a=t===1?"1 node selected — click another to trace route":`${t} nodes selected — ${s} in path`;n.innerHTML=`<span>${a}</span><span class="toast-hint">Click nodes to build route</span><span class="toast-clear" id="pathTraceToastClear">✕ Clear</span>`,n.style.display="flex";const o=document.getElementById("pathTraceToastClear");o&&(o.onclick=()=>{n.style.display="none"})}function La(){const e=document.getElementById("pathTraceToast");e&&(e.style.display="none")}function $r(){const e=document.getElementById("pathTraceToast");if(e){const n=document.createElement("span");n.style.cssText="color:var(--red);margin-left:8px",n.textContent="No direct path",e.appendChild(n),setTimeout(()=>{n.parentNode&&n.remove()},2500)}}function Na(e,n){const t=new Set([e]),s=new Set,a=[e],o=new Set([e]);for(;a.length;){const c=a.shift();n.forEach(l=>{l.from===c&&!o.has(l.to)&&(o.add(l.to),t.add(l.to),s.add(l.from+"|"+l.to),a.push(l.to))})}const i=[e],r=new Set([e]);for(;i.length;){const c=i.shift();n.forEach(l=>{l.to===c&&!r.has(l.from)&&(r.add(l.from),t.add(l.from),s.add(l.from+"|"+l.to),i.push(l.from))})}return{reachNodes:t,reachEdges:s}}function Ws(e,n,t){Object.entries(n).forEach(([a,o])=>{o.classList.remove("path-selected","path-member","path-dimmed","highlighted","dimmed","selected"),e.selected.includes(a)?o.classList.add("path-selected"):e.pathNodes.has(a)?o.classList.add("path-member"):o.classList.add("path-dimmed")});const s=t.querySelector("svg.tier-svg");s&&s.querySelectorAll("path[data-from]").forEach(a=>{const o=a.dataset.from+"|"+a.dataset.to,i=a.dataset.to+"|"+a.dataset.from;e.pathEdgeKeys.has(o)||e.pathEdgeKeys.has(i)?(a.setAttribute("opacity","1"),a.setAttribute("stroke","#FACA15"),a.setAttribute("stroke-width","3"),a.setAttribute("filter","url(#glow)"),a.setAttribute("marker-end","url(#arrow-white)"),a.style.transition="all 0.2s ease"):(a.setAttribute("opacity","0.04"),a.removeAttribute("filter"),a.style.transition="all 0.2s ease")})}function Oa(e,n,t,s,a){n.selected=[e],n.active=!0;const{reachNodes:o,reachEdges:i}=Na(e,t);n.pathNodes=o,n.pathEdgeKeys=i,Ws(n,s,a),Hs(n)}function Ma(e,n,t,s,a){if(!n.selected.includes(e)){if(n.selected.push(e),n.selected.length===2){const o=n.selected[0],i=n.selected[1];let r=mt(t,o,i);if(r.found||(r=mt(t,i,o)),!r.found){const c=t.flatMap(l=>[l,{from:l.to,to:l.from,label:l.label,type:l.type,color:l.color,width:l.width}]);r=mt(c,o,i)}r.found?(n.pathNodes=new Set(r.pathNodes),n.pathEdgeKeys=new Set(r.pathEdgeKeys)):(n.pathNodes=new Set(n.selected),n.pathEdgeKeys=new Set,$r())}else{const o=n.selected[n.selected.length-2];let i=mt(t,o,e);if(i.found||(i=mt(t,e,o)),!i.found){const r=t.flatMap(c=>[c,{from:c.to,to:c.from,label:c.label,type:c.type,color:c.color,width:c.width}]);i=mt(r,o,e)}i.found?(i.pathNodes.forEach(r=>n.pathNodes.add(r)),i.pathEdgeKeys.forEach(r=>n.pathEdgeKeys.add(r))):(n.pathNodes.add(e),$r())}Ws(n,s,a),Hs(n)}}function In(e,n,t){e.selected=[],e.pathNodes=new Set,e.pathEdgeKeys=new Set,e.active=!1,Object.values(n).forEach(a=>{a.classList.remove("path-selected","path-member","path-dimmed")});const s=t.querySelector("svg.tier-svg");s&&s.querySelectorAll("path[data-from]").forEach(a=>{a.setAttribute("opacity","0.35"),a.setAttribute("stroke",a.dataset.origColor||"#4B5563"),a.setAttribute("stroke-width",a.dataset.origWidth||"1.5"),a.removeAttribute("filter");const o=a.dataset.origColor||"",i=o.includes("EF44")?"arrow-red":o.includes("F59E")||o.includes("F5")?"arrow-amber":o.includes("6366")?"arrow-purple":o.includes("3B82")?"arrow-blue":o.includes("21C3")?"arrow-green":"arrow-default";a.setAttribute("marker-end",`url(#${i})`),a.style.transition=""}),La()}function nr(e,n,t){const s=e.querySelector("svg.tier-svg");if(s&&s.remove(),!n.length)return;const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.classList.add("tier-svg"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width=e.scrollWidth+"px",a.style.height=e.scrollHeight+"px",a.style.pointerEvents="none",a.style.zIndex="1",a.setAttribute("viewBox",`0 0 ${e.scrollWidth} ${e.scrollHeight}`);const o=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=document.createElementNS("http://www.w3.org/2000/svg","filter");i.setAttribute("id","glow"),i.setAttribute("x","-50%"),i.setAttribute("y","-50%"),i.setAttribute("width","200%"),i.setAttribute("height","200%");const r=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");r.setAttribute("stdDeviation","3"),r.setAttribute("result","blur"),i.appendChild(r);const c=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),l=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");l.setAttribute("in","blur");const d=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");d.setAttribute("in","SourceGraphic"),c.appendChild(l),c.appendChild(d),i.appendChild(c),o.appendChild(i),Object.entries({default:"#4B5563",blue:"#3B82F6",purple:"#6366F1",red:"#EF4444",amber:"#F59E0B",green:"#21C354",white:"#FAFAFA"}).forEach(([p,h])=>{const m=document.createElementNS("http://www.w3.org/2000/svg","marker");m.setAttribute("id","arrow-"+p),m.setAttribute("viewBox","0 0 10 8"),m.setAttribute("refX","10"),m.setAttribute("refY","4"),m.setAttribute("markerWidth","8"),m.setAttribute("markerHeight","6"),m.setAttribute("orient","auto");const g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("d","M0,0 L10,4 L0,8 Z"),g.setAttribute("fill",h),m.appendChild(g),o.appendChild(m)}),a.appendChild(o);const f=e.getBoundingClientRect();n.forEach(p=>{const h=t[p.from],m=t[p.to];if(!h||!m)return;const g=h.getBoundingClientRect(),_=m.getBoundingClientRect(),E=g.left+g.width/2-f.left+e.scrollLeft,w=g.top+g.height-f.top+e.scrollTop,x=_.left+_.width/2-f.left+e.scrollLeft,b=_.top-f.top+e.scrollTop,S=b-w,y=Math.max(Math.abs(S)*.35,30),C=(x-E)*.15,P=document.createElementNS("http://www.w3.org/2000/svg","path");P.setAttribute("d",`M${E},${w} C${E+C},${w+y} ${x-C},${b-y} ${x},${b}`);const R=p.color||"#4B5563";P.setAttribute("stroke",R),P.setAttribute("stroke-width",String(p.width||1.5)),P.setAttribute("fill","none");const A=R.includes("EF44")?"arrow-red":R.includes("F59E")||R.includes("F5")?"arrow-amber":R.includes("6366")?"arrow-purple":R.includes("3B82")?"arrow-blue":R.includes("21C3")?"arrow-green":"arrow-default";P.setAttribute("marker-end",`url(#${A})`),P.setAttribute("opacity","0.35"),P.dataset.from=p.from,P.dataset.to=p.to,P.dataset.origColor=R,P.dataset.origWidth=String(p.width||1.5),p.dash&&P.setAttribute("stroke-dasharray","6,4"),p.inCycle&&P.setAttribute("stroke-dasharray","8,4"),a.appendChild(P)}),e.style.position="relative",e.insertBefore(a,e.firstChild)}const Ar={source:"#3B82F6",route:"#EAB308",transform:"#A855F7",process:"#6366F1",sink:"#21C354",utility:"#808495"};function Ir(e,n,t,s,a,o,i,r){const c="sub_"+e.id,l=o.querySelector(`[data-sub-band="${c}"]`);if(l){l.remove(),n.classList.remove("expanded");const m=n.querySelector(".expand-indicator");m&&(m.textContent="▶ expand"),Object.keys(a).forEach(g=>{g.startsWith("proc_"+e.name+"|")&&delete a[g]}),requestAnimationFrame(()=>nr(o,s.connections,a));return}n.classList.add("expanded");const d=n.querySelector(".expand-indicator");d&&(d.textContent="▼ collapse");const u=e.detail&&e.detail.processors||[],f=["source","route","transform","process","sink","utility"],p={source:"Sources",route:"Routing",transform:"Transforms",process:"Processing",sink:"Sinks",utility:"Utility"},h=document.createElement("div");h.className="tier-sub-band",h.dataset.subBand=c,f.forEach(m=>{const g=u.filter(w=>Ce(w.type)===m);if(!g.length)return;const _=document.createElement("div");_.className="tier-band-label",_.style.color=Ar[m]||"#808495",_.textContent=`${e.name} → ${p[m]} (${g.length})`,h.appendChild(_);const E=document.createElement("div");E.className="tier-nodes",g.forEach(w=>{const x=document.createElement("div");x.className="tier-node";const b="proc_"+e.name+"|"+w.name;x.dataset.nodeId=b,(w.state==="DISABLED"||w.state==="STOPPED")&&(x.style.opacity="0.5"),x.style.borderTopColor=Ar[m]||"#808495",x.style.borderTopWidth="3px";const S=document.createElement("div");S.className="node-name",S.textContent=w.name.length>20?w.name.substring(0,17)+"...":w.name,S.title=w.name,x.appendChild(S);const y=document.createElement("div");y.className="node-meta",y.textContent=w.type,x.appendChild(y),x.addEventListener("click",C=>{C.stopPropagation(),ut(()=>Promise.resolve().then(()=>Ba),void 0,import.meta.url).then(P=>{P.showNodeDetail({name:w.name,type:"processor",subtype:m,meta:w.type,group:e.name,state:w.state,propCount:Object.keys(w.properties||{}).length,detail:w},i,r)})}),E.appendChild(x),a[b]=x}),h.appendChild(E)}),t.after(h),requestAnimationFrame(()=>nr(o,s.connections,a))}function gn(e,n,t){if(!n)return;let s='<div class="node-detail">';if(s+=`<h4>${V(e.name)}</h4>`,t==="nifi_flow"&&e.type==="process_group"&&e.detail){const a=e.detail;if(s+=`<p><strong>Processors:</strong> ${e.procCount} &middot; <strong>Internal Connections:</strong> ${a.intraConns||0}</p>`,s+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin:8px 0">',e.srcCount&&(s+=`<span class="ns ns-tx">${e.srcCount} sources</span>`),e.routeCount&&(s+=`<span class="ns" style="background:#EAB308;color:#000">${e.routeCount} routes</span>`),e.transformCount&&(s+=`<span class="ns" style="background:#A855F7;color:white">${e.transformCount} transforms</span>`),e.processCount&&(s+=`<span class="ns ns-ext">${e.processCount} processors</span>`),e.sinkCount&&(s+=`<span class="ns" style="background:#21C354;color:white">${e.sinkCount} sinks</span>`),e.utilityCount&&(s+=`<span class="ns" style="background:#808495;color:white">${e.utilityCount} utility</span>`),s+="</div>",a.typeCount){const o=Object.entries(a.typeCount).sort((i,r)=>r[1]-i[1]);s+='<table style="font-size:0.75rem"><thead><tr><th>Processor Type</th><th>Count</th></tr></thead><tbody>',o.slice(0,15).forEach(([i,r])=>{s+=`<tr><td>${V(i)}</td><td>${r}</td></tr>`}),o.length>15&&(s+=`<tr><td colspan="2" style="color:var(--text2)">+${o.length-15} more types</td></tr>`),s+="</tbody></table>"}a.processors&&a.processors.length&&(s+='<p style="margin-top:8px"><strong>Processors (first 10):</strong></p>',s+='<ul style="font-size:0.75rem;margin:4px 0 4px 16px">',a.processors.slice(0,10).forEach(o=>{s+=`<li>${V(o.name)} <code style="font-size:0.65rem">${V(o.type)}</code></li>`}),a.processors.length>10&&(s+=`<li style="color:var(--text2)">+${a.processors.length-10} more</li>`),s+="</ul>"),e.inCycle&&e.sccMembers&&(s+='<div style="margin:8px 0;padding:8px 12px;border:1px solid #EF4444;border-radius:6px;background:rgba(239,68,68,0.08);font-size:0.8rem">',s+='<strong style="color:#EF4444">Circular Dependency Detected</strong><br>',s+="Cycle with: "+e.sccMembers.filter(o=>o!==e.name).map(V).join(", "),e.cycleEdges&&e.cycleEdges.length&&(s+="<br><br><strong>Cycle edges:</strong><br>",e.cycleEdges.forEach(o=>{s+=`${V(o.from)} → ${V(o.to)} (${o.count} flow${o.count>1?"s":""})<br>`})),s+="</div>")}else if(t==="nifi_flow"&&e.detail){const a=e.detail;s+=`<p><strong>Type:</strong> ${V(a.type)} <code style="font-size:0.7rem">${V(a.fullType||"")}</code></p>`,s+=`<p><strong>Group:</strong> ${V(a.group||"(root)")}</p>`,s+=`<p><strong>State:</strong> ${V(a.state||"N/A")}</p>`,a.schedulingStrategy&&(s+=`<p><strong>Scheduling:</strong> ${V(a.schedulingStrategy)} / ${V(a.schedulingPeriod)}</p>`);const o=Object.keys(a.properties||{}),i=o.filter(r=>Us(r)).length;o.length&&(s+=`<p><strong>Properties (${o.length}):</strong>${i?` <span style="color:#EAB308;font-size:0.75rem">&#x26A0; ${i} sensitive masked</span>`:""}</p><pre style="max-height:200px;overflow:auto;font-size:0.75rem">`,o.slice(0,20).forEach(r=>{s+=`${V(r)}: ${V(Ca(r,(a.properties[r]||"").substring(0,100)))}
`}),o.length>20&&(s+=`... +${o.length-20} more
`),s+="</pre>")}else if(t==="dependency_graph"&&e.type==="session"&&e.detail){const a=e.detail;s+=`<p><strong>Sources:</strong> ${a.sources} &middot; <strong>Targets:</strong> ${a.targets} &middot; <strong>Lookups:</strong> ${a.lookups}</p>`,e.seq&&(s+=`<p><strong>Execution Order:</strong> #${e.seq}</p>`),a.source_tables&&a.source_tables.length&&(s+='<p style="margin-top:6px"><strong>Source Tables:</strong></p><ul style="font-size:0.8rem;margin:4px 0 4px 16px">',a.source_tables.slice(0,10).forEach(o=>{s+=`<li>${V(o.name)}</li>`}),a.source_tables.length>10&&(s+=`<li style="color:var(--text2)">+${a.source_tables.length-10} more</li>`),s+="</ul>"),a.target_tables&&a.target_tables.length&&(s+='<p><strong>Target Tables:</strong></p><ul style="font-size:0.8rem;margin:4px 0 4px 16px">',a.target_tables.forEach(o=>{s+=`<li>${V(o.name)}${o.load_type?' <code style="font-size:0.7rem">'+V(o.load_type)+"</code>":""}</li>`}),s+="</ul>"),e.hasConflict&&e.conflictDetails&&e.conflictDetails.length&&(s+='<div class="alert alert-warn" style="margin:8px 0;padding:8px 12px;font-size:0.8rem"><strong>Conflicts:</strong><br>',e.conflictDetails.forEach(o=>{s+=`${V(o.table_name)} &mdash; ${V(o.conflict_type)}<br>`}),s+="</div>")}else if(t==="dependency_graph"&&(e.type==="table_output"||e.type==="conflict_gate")&&e.detail){const a=e.detail;a.writers&&a.writers.length&&(s+=`<p><strong>Writers:</strong> ${a.writers.map(V).join(", ")}</p>`),a.readers&&a.readers.length&&(s+=`<p><strong>Readers:</strong> ${a.readers.map(V).join(", ")}</p>`),a.lookups&&a.lookups.length&&(s+=`<p><strong>Lookup Readers:</strong> ${a.lookups.map(V).join(", ")}</p>`),a.conflicts&&a.conflicts.length&&(s+='<div class="alert alert-warn" style="margin:8px 0;padding:8px 12px;font-size:0.8rem"><strong>Conflicts:</strong><br>',a.conflicts.forEach(o=>{s+=`${V(o.conflict_type)}${o.writers?" &mdash; Writers: "+o.writers.map(V).join(", "):""}<br>`}),s+="</div>")}else if(e.detail&&e.detail.columns){const a=e.detail;s+=`<p><strong>Schema:</strong> ${V(a.schema||"dbo")} &middot; <strong>Rows:</strong> ${a.row_count}</p>`,s+='<table style="font-size:0.75rem"><thead><tr><th>Column</th><th>Type</th><th>PK</th><th>Null</th></tr></thead><tbody>',a.columns.slice(0,15).forEach(o=>{s+=`<tr><td>${V(o.name)}</td><td>${V(o.data_type)}</td><td>${o.is_primary_key?"Y":""}</td><td>${o.nullable?"Y":"N"}</td></tr>`}),a.columns.length>15&&(s+=`<tr><td colspan="4" style="color:var(--text2)">+${a.columns.length-15} more columns</td></tr>`),s+="</tbody></table>",a.foreign_keys&&a.foreign_keys.length&&(s+='<p style="margin-top:8px"><strong>Foreign Keys:</strong></p>',a.foreign_keys.forEach(o=>{s+=`<p style="font-size:0.8rem"><code>${V(o.column||o.fk_column)}</code> &rarr; <code>${V(o.references_table)}(${V(o.references_column)})</code></p>`}))}s+="</div>",n.innerHTML=s}const Ba=Object.freeze(Object.defineProperty({__proto__:null,showNodeDetail:gn},Symbol.toStringTag,{value:"Module"})),ja={source:"#3B82F6",route:"#EAB308",transform:"#A855F7",process:"#6366F1",sink:"#21C354",utility:"#808495"};function qa(e,n,t,s,a,o){const{nodes:i,connections:r,tierLabels:c}=n,l={};i.forEach(u=>{l[u.tier]||(l[u.tier]=[]),l[u.tier].push(u)});const d=Object.keys(l).map(Number).sort((u,f)=>u-f);return d.forEach(u=>{const f=c[u]||{label:`TIER ${u}`,color:"#808495",bg:"rgba(128,132,149,0.06)"},p=document.createElement("div");p.className="tier-band",p.style.background=f.bg,p.style.borderLeft=`3px solid ${f.color}`;const h=document.createElement("div");h.className="tier-band-label",h.style.color=f.color,h.textContent=f.label,p.appendChild(h);const m=document.createElement("div");m.className="tier-nodes",l[u].forEach(g=>{const _=document.createElement("div");if(_.dataset.nodeId=g.id,_.dataset.role=g.subtype||g.dominantRole||"",_.dataset.conf=String(g.conf||0),_.dataset.name=g.name||"",_.dataset.type=g.procType||g.type||"",g.type==="session"){if(_.className="tier-node",g.hasConflict?(_.style.borderColor="#EF4444",_.style.borderTopColor="#EF4444"):g.subtype==="root"?_.style.borderTopColor="#3B82F6":_.style.borderTopColor="#6366F1",_.style.borderTopWidth="3px",g.seq){const b=document.createElement("div");b.className="node-seq",b.textContent=g.seq,g.hasConflict&&(b.style.background="#EF4444"),_.appendChild(b)}const E=document.createElement("div");E.className="node-name";const w=(g.name||"").replace(/^s_m_(?:Load_|LOAD_)?/i,"");E.textContent=w.length>22?w.substring(0,19)+"...":w,E.title=g.name||"",_.appendChild(E);const x=document.createElement("div");if(x.className="node-stats",x.innerHTML=`<span class="ns ns-tx">${g.srcCount||0} tx</span><span class="ns ns-ext">${g.tgtCount||0} ext</span>`+(g.lkpCount?`<span class="ns ns-lkp">${g.lkpCount} lkp</span>`:""),_.appendChild(x),g.hasConflict){const b=document.createElement("div");b.className="node-badge red",b.textContent="!",b.title=(g.conflictDetails||[]).map(S=>(S.table_name||"")+": "+(S.conflict_type||"")).join(", "),_.appendChild(b)}}else if(g.type==="table_output"){_.className="tier-node table-output",g.isConflict?_.style.borderColor="#EF4444":g.isChain?_.style.borderColor="#F59E0B":_.style.borderColor="#21C354";const E=document.createElement("div");E.style.cssText="font-size:0.8rem;margin-bottom:2px",E.textContent=g.isConflict?"⚠":g.isChain?"Ⅱ":"✓",_.appendChild(E);const w=document.createElement("div");w.className="node-name",w.textContent=(g.name||"").length>20?(g.name||"").substring(0,17)+"...":g.name||"",w.title=g.name||"",_.appendChild(w);const x=document.createElement("div");x.className="node-class",x.style.color=g.isConflict?"#FCA5A5":g.isChain?"#FDE68A":"#86EFAC",x.textContent=g.isConflict?"CONFLICT":g.isChain?"CHAIN":"INDEPENDENT",_.appendChild(x)}else if(g.type==="conflict_gate"){_.className="tier-node conflict-gate";const E=document.createElement("div");E.style.cssText="font-size:1.2rem;margin-bottom:2px",E.textContent="⚠",_.appendChild(E);const w=document.createElement("div");w.className="node-name",w.textContent=(g.name||"").length>25?(g.name||"").substring(0,22)+"...":g.name||"",w.title=g.name||"",_.appendChild(w);const x=document.createElement("div");x.className="node-meta",x.textContent=`${g.writerCount||0}W / ${g.readerCount||0}R / ${g.lookupCount||0}L`,_.appendChild(x);const b=document.createElement("div");b.className="node-class",b.style.color="#FCA5A5",b.textContent="CONFLICT",_.appendChild(b)}else if(g.type==="process_group"){_.className="tier-node expandable",g.inCycle&&_.classList.add("in-cycle");const E=ja[g.dominantRole]||"#6366F1";if(_.style.borderTopColor=E,_.style.borderTopWidth="3px",_.style.minWidth="160px",_.style.maxWidth="240px",g.inCycle){const y=document.createElement("div");y.className="cycle-badge",y.textContent="↻",y.title="Cycle: "+(g.sccMembers||[]).filter(C=>C!==g.name).join(", "),_.appendChild(y)}const w=document.createElement("div");w.className="node-name",w.textContent=(g.name||"").length>28?(g.name||"").substring(0,25)+"...":g.name||"",w.title=g.name||"",_.appendChild(w);const x=document.createElement("div");x.className="node-badge",x.textContent=g.procCount||0,x.title=(g.procCount||0)+" processors",_.appendChild(x);const b=document.createElement("div");b.className="node-stats",g.srcCount&&(b.innerHTML+=`<span class="ns ns-tx">${g.srcCount} src</span>`),(g.transformCount||0)+(g.routeCount||0)&&(b.innerHTML+=`<span class="ns" style="background:#A855F7;color:white">${(g.transformCount||0)+(g.routeCount||0)} xfm</span>`),g.processCount&&(b.innerHTML+=`<span class="ns ns-ext">${g.processCount} proc</span>`),g.sinkCount&&(b.innerHTML+=`<span class="ns" style="background:#21C354;color:white">${g.sinkCount} sink</span>`),g.utilityCount&&(b.innerHTML+=`<span class="ns" style="background:#808495;color:white">${g.utilityCount} util</span>`),_.appendChild(b);const S=document.createElement("div");S.className="expand-indicator",S.textContent="▶ expand",_.appendChild(S)}else{_.className="tier-node",(g.state==="DISABLED"||g.state==="STOPPED")&&(_.style.opacity="0.5"),g.subtype==="source"?_.style.borderTopColor="#3B82F6":g.subtype==="sink"?_.style.borderTopColor="#21C354":g.subtype==="route"?_.style.borderTopColor="#EAB308":g.subtype==="transform"?_.style.borderTopColor="#A855F7":g.type==="table"&&(_.style.borderTopColor="#3B82F6"),_.style.borderTopWidth="3px";const E=document.createElement("div");if(E.className="node-name",E.textContent=(g.name||"").length>25?(g.name||"").substring(0,22)+"...":g.name||"",E.title=g.name||"",_.appendChild(E),g.meta){const w=document.createElement("div");w.className="node-meta",w.textContent=g.meta,_.appendChild(w)}if(g.rows){const w=document.createElement("div");w.className="node-badge",w.textContent=g.rows>=1e3?Math.round(g.rows/1e3)+"K":g.rows,_.appendChild(w)}}_.addEventListener("mouseenter",()=>{s.active||Ia(g.id,i,r,t,e)}),_.addEventListener("mouseleave",()=>{s.active||Fa(t,e)}),_.addEventListener("click",E=>{E.stopPropagation(),s.active&&!s.selected.includes(g.id)?(Ma(g.id,s,r,t,e),gn(g,a,o)):s.active&&s.selected.includes(g.id)?(g.type==="process_group"&&g.expandable&&Ir(g,_,p,n,t,e,a,o),gn(g,a,o)):(Oa(g.id,s,r,t,e),g.type==="process_group"&&g.expandable&&Ir(g,_,p,n,t,e,a,o),gn(g,a,o))}),m.appendChild(_),t[g.id]=_}),p.appendChild(m),e.appendChild(p)}),{sortedTiers:d}}function Ua(e,n,t,s,a,o,i){const r=document.getElementById("sidebarClearBtn");if(!e.activeTypes.size){Qs(a,o),i.querySelectorAll(".density-row").forEach(u=>u.classList.remove("filter-dimmed")),r&&(r.style.display="none");return}r&&(r.style.display="block");const c=new Set;e.activeTypes.forEach(u=>{n[u]&&n[u].forEach(f=>c.add(f))});const l=new Set;s.forEach(u=>{c.has(u.from)&&c.has(u.to)&&l.add(u.from+"|"+u.to)}),Object.entries(a).forEach(([u,f])=>{f.classList.remove("path-selected","path-member","path-dimmed","highlighted","dimmed","selected"),c.has(u)?f.classList.add("path-member"):f.classList.add("path-dimmed")});const d=o.querySelector("svg.tier-svg");d&&d.querySelectorAll("path[data-from]").forEach(u=>{const f=u.dataset.from+"|"+u.dataset.to;l.has(f)?(u.setAttribute("opacity","0.8"),u.setAttribute("stroke",u.dataset.origColor||"#4B5563"),u.setAttribute("stroke-width",u.dataset.origWidth||"1.5")):u.setAttribute("opacity","0.04")}),i.querySelectorAll(".density-row").forEach(u=>{e.activeTypes.has(u.dataset.typeName)?u.classList.remove("filter-dimmed"):u.classList.add("filter-dimmed")})}function Qs(e,n){Object.values(e).forEach(s=>{s.classList.remove("path-selected","path-member","path-dimmed")});const t=n.querySelector("svg.tier-svg");t&&t.querySelectorAll("path[data-from]").forEach(s=>{s.setAttribute("opacity","0.35"),s.setAttribute("stroke",s.dataset.origColor||"#4B5563"),s.setAttribute("stroke-width",s.dataset.origWidth||"1.5"),s.removeAttribute("filter");const a=s.dataset.origColor||"",o=a.includes("EF44")?"arrow-red":a.includes("F59E")||a.includes("F5")?"arrow-amber":a.includes("6366")?"arrow-purple":a.includes("3B82")?"arrow-blue":a.includes("21C3")?"arrow-green":"arrow-default";s.setAttribute("marker-end",`url(#${o})`),s.style.transition=""})}let He={role:"all",conf:"all",search:""};function Ks(e,n,t){He[n]=t;const s=e.parentElement;s&&s.querySelectorAll("[data-node-id]").forEach(a=>{const o=a.dataset.role||"",i=parseFloat(a.dataset.conf||0),r=(a.dataset.name||"").toLowerCase(),c=(a.dataset.type||"").toLowerCase();let l=!0;He.role!=="all"&&o!==He.role&&(l=!1),He.conf==="high"&&i<.7&&(l=!1),He.conf==="med"&&(i<.3||i>=.7)&&(l=!1),He.conf==="low"&&i>=.3&&(l=!1),He.search&&!r.includes(He.search.toLowerCase())&&!c.includes(He.search.toLowerCase())&&(l=!1),a.style.opacity=l?"1":"0.15",a.style.pointerEvents=l?"":"none"})}const za=Gs((e,n)=>{Ks(e,"search",n)},150);function Fn(e,n,t){n==="search"?za(e,t):Ks(e,n,t)}function Ga(e,n,t,s){const a=document.getElementById(n),o=document.getElementById(t),i=document.getElementById(s);if(!a)return;a.innerHTML="",a.style.minHeight="200px";const{nodes:r,connections:c,tierLabels:l,diagramType:d,densityData:u}=e;if(!r.length){a.innerHTML='<p style="text-align:center;padding:20px;color:var(--text2)">No nodes to display</p>';return}const f=document.createElement("div");f.className="filter-toolbar";let p='<div class="filter-group"><label>Role:</label>';["all","source","transform","route","process","sink","utility"].forEach(b=>{const S={all:"",source:"#3B82F6",transform:"#A855F7",route:"#EAB308",process:"#6366F1",sink:"#21C354",utility:"#808495"},y=S[b]?' style="border-color:'+S[b]+";color:"+S[b]+'"':"";p+='<button class="filter-btn'+(b==="all"?" active":"")+'"'+y+' data-filter-role="'+b+'">'+(b==="all"?"All":b.charAt(0).toUpperCase()+b.slice(1))+"</button>"}),p+='</div><div class="filter-group"><label>Confidence:</label>',[{k:"all",l:"All",s:""},{k:"high",l:"High",s:"border-color:var(--green);color:var(--green)"},{k:"med",l:"Med",s:"border-color:var(--amber);color:var(--amber)"},{k:"low",l:"Low",s:"border-color:var(--red);color:var(--red)"}].forEach(b=>{p+='<button class="filter-btn'+(b.k==="all"?" active":"")+'"'+(b.s?' style="'+b.s+'"':"")+' data-filter-conf="'+b.k+'">'+b.l+"</button>"}),p+='</div><div class="filter-group"><input class="filter-search" type="text" placeholder="Search processors..."></div>',f.innerHTML=p,f.querySelectorAll("[data-filter-role]").forEach(b=>{b.addEventListener("click",()=>{b.parentElement.querySelectorAll(".filter-btn").forEach(S=>S.classList.remove("active")),b.classList.add("active"),Fn(f,"role",b.dataset.filterRole)})}),f.querySelectorAll("[data-filter-conf]").forEach(b=>{b.addEventListener("click",()=>{b.parentElement.querySelectorAll(".filter-btn").forEach(S=>S.classList.remove("active")),b.classList.add("active"),Fn(f,"conf",b.dataset.filterConf)})});const h=f.querySelector(".filter-search");h&&h.addEventListener("input",()=>{Fn(f,"search",h.value)}),a.appendChild(f);const m={selected:[],pathNodes:new Set,pathEdgeKeys:new Set,active:!1},g={};qa(a,e,g,m,o,d),requestAnimationFrame(()=>{nr(a,c,g)}),document.addEventListener("keydown",b=>{b.key==="Escape"&&m.active&&In(m,g,a)}),a.addEventListener("click",b=>{(b.target===a||b.target.classList.contains("tier-band")||b.target.classList.contains("tier-band-label"))&&m.active&&In(m,g,a)});const _=document.getElementById("tierDensitySidebar"),E=document.getElementById("densityBars"),w={activeTypes:new Set};if(_&&E&&u&&u.length){_.classList.remove("hidden");const b=_.querySelector("h4");if(b&&(b.textContent=d==="nifi_flow"?"Filter by Type":"Connection Density"),E.innerHTML="",d==="nifi_flow"){const C=document.createElement("div");C.className="sidebar-filter-hint",C.textContent="Click to filter diagram",E.appendChild(C)}const S=Math.max(...u.map(C=>C.total)),y={};if(d==="nifi_flow"&&r.forEach(C=>{C.type==="process_group"&&C.detail&&C.detail.typeCount&&Object.keys(C.detail.typeCount).forEach(P=>{y[P]||(y[P]=new Set),y[P].add(C.id)})}),u.forEach(C=>{const P=document.createElement("div");if(P.className="density-row",P.dataset.typeName=C.name,C.role){const R={source:"#3B82F6",sink:"#21C354",route:"#EAB308",transform:"#A855F7",process:"#6366F1",utility:"#808495"},A=Math.max(4,C.total/S*80);P.innerHTML=`<span class="density-bar" style="width:${A}px;background:${R[C.role]||"#808495"}" title="${C.total}x"></span><span class="density-label" title="${C.name}">${C.name} (${C.total})</span>`}else{const R=Math.max(2,C.writers/S*60),A=Math.max(0,C.readers/S*60),T=Math.max(0,C.lookups/S*60);let I=`<span class="density-bar" style="width:${R}px;background:#EF4444" title="${C.writers} writer(s)"></span>`;C.readers&&(I+=`<span class="density-bar" style="width:${A}px;background:#3B82F6" title="${C.readers} reader(s)"></span>`),C.lookups&&(I+=`<span class="density-bar" style="width:${T}px;background:#F59E0B" title="${C.lookups} lookup(s)"></span>`),P.innerHTML=I+`<span class="density-label" title="${C.name}">${C.name}</span>`}d==="nifi_flow"&&P.addEventListener("click",()=>{m.active&&In(m,g,a);const R=C.name;w.activeTypes.has(R)?(w.activeTypes.delete(R),P.classList.remove("filter-active")):(w.activeTypes.add(R),P.classList.add("filter-active")),Ua(w,y,r,c,g,a,E)}),E.appendChild(P)}),d==="nifi_flow"){const C=document.createElement("div");C.className="sidebar-clear-btn",C.id="sidebarClearBtn",C.textContent="✕ Clear filter",C.addEventListener("click",()=>{w.activeTypes.clear(),E.querySelectorAll(".density-row").forEach(P=>P.classList.remove("filter-active","filter-dimmed")),Qs(g,a),C.style.display="none"}),E.appendChild(C)}}else _&&_.classList.add("hidden");if(i){i.innerHTML="";const b=r.filter(y=>y.type==="session").length,S=r.filter(y=>y.type==="table_output"||y.type==="conflict_gate").length;if(d==="dependency_graph")i.innerHTML=[`<span>${b} Sessions</span>`,`<span>${S} Tables</span>`,`<span style="color:#EF4444">${r.filter(y=>y.hasConflict||y.type==="conflict_gate").length} Conflicts</span>`,'<span><span class="leg-line" style="background:#6366F1"></span> Dependency</span>','<span><span class="leg-line" style="background:#F59E0B;border-top:2px dashed #F59E0B"></span> Lookup</span>','<span><span class="leg-line" style="background:#EF4444"></span> Conflict</span>','<span><span class="leg-line" style="background:#21C354"></span> Independent</span>','<span><span class="leg-line" style="background:#F59E0B"></span> Chain</span>'].join("");else if(d==="nifi_flow"){const y=r.filter(R=>R.type==="process_group").length,C=r.filter(R=>R.type==="processor").length,P=e.cycleData?e.cycleData.length:0;i.innerHTML=[`<span>${y} Process Groups</span>`,C?`<span>${C} Processors</span>`:"",`<span>${c.length} Connections</span>`,P?`<span style="color:#EF4444">${P} Cycle(s)</span>`:"",'<span><span class="leg-line" style="background:#3B82F6"></span> Source</span>','<span><span class="leg-line" style="background:#EAB308"></span> Route</span>','<span><span class="leg-line" style="background:#A855F7"></span> Transform</span>','<span><span class="leg-line" style="background:#6366F1"></span> Process</span>','<span><span class="leg-line" style="background:#21C354"></span> Sink</span>','<span><span class="leg-line" style="background:#EF4444;border-top:2px dashed #EF4444"></span> Cycle Edge</span>','<span style="color:var(--text2);font-size:0.7rem">Click nodes to trace route &middot; Esc to clear</span>'].join("")}else d==="sql_tables"?i.innerHTML=['<span><span class="leg-line" style="background:#3B82F6;border-top:2px solid #3B82F6"></span> Foreign Key</span>',`<span>${r.length} tables &middot; ${c.length} relationships</span>`].join(""):i.innerHTML=[`<span>${r.length} objects</span>`,c.length?'<span><span class="leg-line" style="background:#4B5563;border-top:2px dashed #4B5563"></span> Shared columns</span>':""].join("")}const x=document.getElementById("tierDiagramContainer");x&&x.classList.remove("hidden")}function ie(e,n){const t=e.querySelector(":scope > "+n);return t?t.textContent.trim():""}function Fr(e){const n={};return e.querySelectorAll("config > properties > entry").forEach(t=>{const s=t.querySelector(":scope > key")?.textContent||"",a=t.querySelector(":scope > value");s&&a&&(n[s]=a.textContent||"")}),Object.keys(n).length||e.querySelectorAll(":scope > properties > entry").forEach(t=>{const s=t.querySelector(":scope > key")?.textContent||"",a=t.querySelector(":scope > value");s&&a&&(n[s]=a.textContent||"")}),Object.keys(n).length||e.querySelectorAll(":scope > property").forEach(t=>{const s=t.querySelector(":scope > name")?.textContent||"",a=t.querySelector(":scope > value")?.textContent||"";s&&(n[s]=a)}),n}function Lr(e,n){const t=[],s=[],a=[],o=[],i=[],r={};function c(y,C){const P=y.querySelector(":scope > contents")||y,R=P.querySelectorAll(":scope > processors"),A=R.length===0?P.querySelectorAll(":scope > processor"):[];(R.length>0?R:A).forEach(j=>{const X=ie(j,"name"),O=ie(j,"type")||ie(j,"class"),L=O.split(".").pop(),F=ie(j,"state"),G=Fr(j),z=j.querySelector("config > schedulingPeriod")?.textContent||ie(j,"schedulingPeriod")||"",ne=j.querySelector("config > schedulingStrategy")?.textContent||ie(j,"schedulingStrategy")||"",de=ie(j,"id");de&&(r[de]=X||L),s.push({name:X,type:L,fullType:O,state:F,properties:G,group:C,schedulingPeriod:z,schedulingStrategy:ne,_id:de||"gen_"+s.length})});const I=P.querySelectorAll(":scope > connections"),v=I.length===0?P.querySelectorAll(":scope > connection"):[];(I.length>0?I:v).forEach(j=>{const X=j.querySelector("source > id")?.textContent||ie(j,"sourceId")||"",O=j.querySelector("destination > id")?.textContent||ie(j,"destinationId")||"",L=j.querySelector("source > type")?.textContent||"",F=j.querySelector("destination > type")?.textContent||"",G=[];j.querySelectorAll(":scope > selectedRelationships").forEach(ne=>{ne.textContent&&G.push(ne.textContent)}),G.length||j.querySelectorAll(":scope > relationship").forEach(ne=>{ne.textContent&&G.push(ne.textContent)});const z=ie(j,"backPressureObjectThreshold");a.push({sourceId:X,destinationId:O,sourceType:L,destinationType:F,relationships:G,backPressure:z})}),P.querySelectorAll(":scope > inputPorts").forEach(j=>{const X=ie(j,"id"),O=ie(j,"name");X&&(r[X]=O||"input_port")}),P.querySelectorAll(":scope > outputPorts").forEach(j=>{const X=ie(j,"id"),O=ie(j,"name");X&&(r[X]=O||"output_port")});const K=P.querySelectorAll(":scope > processGroups"),U=K.length===0?P.querySelectorAll(":scope > processGroup"):[];(K.length>0?K:U).forEach(j=>{const X=ie(j,"name"),O=ie(j,"id");O&&(r[O]=X),i.push({name:X,parentGroup:C}),c(j,X)})}const l=e.querySelector("template > snippet")||e.querySelector("snippet")||e.querySelector("flowController > rootGroup")||e.querySelector("rootGroup")||e.querySelector("processGroupFlow > flow")||e.documentElement,d=e.querySelector("controllerServices"),u=l.querySelectorAll(":scope > controllerServices"),f=d?d.querySelectorAll(":scope > controllerService"):[];(u.length>0?u:f).forEach(y=>{const C=ie(y,"name"),P=ie(y,"type")||ie(y,"class"),R=ie(y,"state"),A={};y.querySelectorAll(":scope > properties > entry").forEach(T=>{const I=T.querySelector(":scope > key")?.textContent||"",v=T.querySelector(":scope > value");I&&v&&(A[I]=v.textContent||"")}),y.querySelectorAll(":scope > property").forEach(T=>{const I=T.querySelector(":scope > name")?.textContent||"",v=T.querySelector(":scope > value")?.textContent||"";I&&(A[I]=v)}),o.push({name:C,type:P.split(".").pop(),fullType:P,state:R,properties:A})});const h=l.querySelectorAll(":scope > processGroups"),m=h.length===0?l.querySelectorAll(":scope > processGroup"):[];(h.length>0?h:m).forEach(y=>{const C=ie(y,"name"),P=ie(y,"id");P&&(r[P]=C),i.push({name:C,parentGroup:"(root)"}),c(y,C)});const _=l.querySelectorAll(":scope > processors"),E=_.length===0?l.querySelectorAll(":scope > processor"):[];(_.length>0?_:E).forEach(y=>{const C=ie(y,"name"),P=ie(y,"type")||ie(y,"class"),R=ie(y,"id");R&&(r[R]=C||P.split(".").pop());const A=Fr(y),T=y.querySelector("config > schedulingPeriod")?.textContent||ie(y,"schedulingPeriod")||"",I=y.querySelector("config > schedulingStrategy")?.textContent||ie(y,"schedulingStrategy")||"";s.push({name:C,type:P.split(".").pop(),fullType:P,state:ie(y,"state"),properties:A,group:"(root)",schedulingPeriod:T,schedulingStrategy:I,_id:R||"gen_"+s.length})});const x=l.querySelectorAll(":scope > connections"),b=x.length===0?l.querySelectorAll(":scope > connection"):[];return(x.length>0?x:b).forEach(y=>{const C=y.querySelector("source > id")?.textContent||ie(y,"sourceId")||"",P=y.querySelector("destination > id")?.textContent||ie(y,"destinationId")||"",R=y.querySelector("source > type")?.textContent||"",A=y.querySelector("destination > type")?.textContent||"",T=[];y.querySelectorAll(":scope > selectedRelationships").forEach(v=>{v.textContent&&T.push(v.textContent)}),T.length||y.querySelectorAll(":scope > relationship").forEach(v=>{v.textContent&&T.push(v.textContent)});const I=ie(y,"backPressureObjectThreshold");a.some(v=>v.sourceId===C&&v.destinationId===P&&v.relationships.join(",")===T.join(","))||a.push({sourceId:C,destinationId:P,sourceType:R,destinationType:A,relationships:T,backPressure:I})}),a.forEach(y=>{y.sourceName=r[y.sourceId]||y.sourceId.substring(0,12)+"...",y.destinationName=r[y.destinationId]||y.destinationId.substring(0,12)+"..."}),{tables:t,processors:s,connections:a,controllerServices:o,processGroups:i,idToName:r}}function Nr(e,n){const t=[],s=[],a=[],o=[];function i(d,u){const f=d.name||u||"root";d.name&&a.push({name:f,id:d.identifier||f}),(d.processors||[]).forEach(p=>{const h={};Array.isArray(p.properties)?p.properties.forEach(m=>{m.name&&m.value&&(h[m.name]=m.value)}):p.properties&&Object.entries(p.properties).forEach(([m,g])=>{g!==null&&(h[m]=String(g))}),t.push({id:p.identifier||p.id||"p_"+t.length,name:p.name||p.type||"Unknown",type:(p.type||"").replace(/^org\.apache\.nifi\.processors?\.\w+\./,""),class:p.type||"",group:f,state:p.scheduledState||p.state||"STOPPED",schedulingStrategy:p.schedulingStrategy||"TIMER_DRIVEN",schedulingPeriod:p.schedulingPeriod||"0 sec",properties:h,relationships:p.autoTerminatedRelationships||[]})}),(d.connections||[]).forEach(p=>{s.push({sourceId:p.source?.id||p.sourceId||"",destinationId:p.destination?.id||p.destinationId||"",sourceName:p.source?.name||p.sourceName||"",destinationName:p.destination?.name||p.destinationName||"",relationships:p.selectedRelationships||[],backPressure:p.backPressureObjectThreshold||""})}),(d.controllerServices||[]).forEach(p=>{o.push({name:p.name||p.type||"Unknown",type:(p.type||"").replace(/^org\.apache\.nifi\.\w+\./,""),state:p.scheduledState||"ENABLED",properties:p.properties||{}})}),(d.processGroups||[]).forEach(p=>i(p,p.name||f))}i(e,"root");const r={};t.forEach(d=>{r[d.id]=d.name}),s.forEach(d=>{!d.sourceName&&d.sourceId&&(d.sourceName=r[d.sourceId]||d.sourceId),!d.destinationName&&d.destinationId&&(d.destinationName=r[d.destinationId]||d.destinationId)});const c=/password|secret|token|key|auth|credential|cert|private|keytab|passphrase/i,l={processors:t,connections:s,processGroups:a,controllerServices:o,clouderaTools:[],deepPropertyInventory:{filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set},sqlTables:[],sqlTableMeta:{}};return t.forEach(d=>{Object.entries(d.properties).forEach(([u,f])=>{f&&(/\$\{/.test(f)&&(l.deepPropertyInventory.nifiEL[f]||(l.deepPropertyInventory.nifiEL[f]=[]),l.deepPropertyInventory.nifiEL[f].push(d.name)),/jdbc:/i.test(f)&&(l.deepPropertyInventory.jdbcUrls[f]||(l.deepPropertyInventory.jdbcUrls[f]=[]),l.deepPropertyInventory.jdbcUrls[f].push(d.name)),c.test(u)&&(l.deepPropertyInventory.credentialRefs[u]||(l.deepPropertyInventory.credentialRefs[u]=[]),l.deepPropertyInventory.credentialRefs[u].push(d.name)))})}),{source_name:n,source_type:"nifi_registry_json",_nifi:l,parse_warnings:[],_deferredProcessorWork:null}}function Ha(e){if(!e)return"";let n=e;return n.charCodeAt(0)===65279&&(n=n.substring(1)),n=n.replace(/\r\n/g,`
`).replace(/\r/g,`
`),n=n.replace(/\x00/g,""),n=n.replace(/\u00A0/g," "),n=n.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'"),n.trim()}const Zt=50*1024*1024;async function Or(e){try{if(!e||e.length===0)return[];if(e.length>Zt)return{error:"File exceeds 50MB limit"};const{default:n}=await ut(async()=>{const{default:s}=await Promise.resolve().then(()=>ta);return{default:s}},void 0,import.meta.url);return n.inflate(e,{to:"string"})}catch(n){return{error:"Gzip decompression failed: "+n.message}}}async function Wa(e){try{if(e&&e.length>Zt)return{error:"File exceeds 50MB limit"};const{default:n}=await ut(async()=>{const{default:i}=await Promise.resolve().then(()=>Pr);return{default:i}},void 0,import.meta.url),t=await n.loadAsync(e),s=[],a=[/flow\.xml$/i,/flow\.json$/i,/template.*\.xml$/i,/\.xml$/i,/\.json$/i,/\.sql$/i,/META-INF\/MANIFEST\.MF$/i],o=Object.keys(t.files).filter(i=>!t.files[i].dir);for(const i of o){const r=i.split(".").pop().toLowerCase();if(["xml","json","sql","txt","properties","cfg","yaml","yml","mf"].includes(r)){const c=await t.files[i].async("string");s.push({filename:i,content:c,type:r})}}return s.sort((i,r)=>{const c=a.findIndex(d=>d.test(i.filename)),l=a.findIndex(d=>d.test(r.filename));return(c===-1?999:c)-(l===-1?999:l)}),s}catch(n){return{error:"ZIP extraction failed: "+n.message}}}async function Qa(e){try{if(e&&e.length>Zt)return{error:"File exceeds 50MB limit"};const{default:n}=await ut(async()=>{const{default:s}=await Promise.resolve().then(()=>ta);return{default:s}},void 0,import.meta.url),t=n.inflate(e);return Js(t)}catch(n){return{error:"TAR.GZ extraction failed: "+n.message}}}function Js(e){try{if(!e||e.length===0)return[];const n=[];let t=0;const s=new TextDecoder;for(;t<e.length-512;){const a=e.slice(t,t+512);let o=s.decode(a.slice(0,100)).replace(/\0/g,"").trim();if(!o)break;const i=s.decode(a.slice(124,136)).replace(/\0/g,"").trim(),r=parseInt(i,8)||0,c=s.decode(a.slice(156,157));if(t+=512,c==="L"){const l=s.decode(e.slice(t,t+r)).replace(/\0/g,"").trim();if(t+=Math.ceil(r/512)*512,t>=e.length-512)break;const d=e.slice(t,t+512),u=s.decode(d.slice(124,136)).replace(/\0/g,"").trim(),f=parseInt(u,8)||0,p=s.decode(d.slice(156,157));if(t+=512,p==="0"||p===""||p==="\0"){const h=l.split(".").pop().toLowerCase();if(["xml","json","sql","txt","properties","cfg","yaml","yml"].includes(h)){const m=s.decode(e.slice(t,t+f));n.push({filename:l,content:m,type:h})}}t+=Math.ceil(f/512)*512;continue}if(c==="x"||c==="g"){t+=Math.ceil(r/512)*512;continue}if(c==="0"||c===""||c==="\0"){const l=o.split(".").pop().toLowerCase();if(["xml","json","sql","txt","properties","cfg","yaml","yml"].includes(l)){const d=s.decode(e.slice(t,t+r));n.push({filename:o,content:d,type:l})}}t+=Math.ceil(r/512)*512}return n}catch(n){return{error:"Tar parsing failed: "+n.message}}}function Ka(e){const n=[];let t="",s=0;for(;s<e.length;){const o=e[s];if(o==="-"&&e[s+1]==="-"){const i=e.indexOf(`
`,s);i===-1?(t+=e.slice(s),s=e.length):(t+=e.slice(s,i+1),s=i+1);continue}if(o==="/"&&e[s+1]==="*"){const i=e.indexOf("*/",s+2);i===-1?(t+=e.slice(s),s=e.length):(t+=e.slice(s,i+2),s=i+2);continue}if(o==="'"){let i=s+1;for(t+=o;i<e.length;)if(e[i]==="'"&&e[i+1]==="'")t+="''",i+=2;else if(e[i]==="'"){t+="'",i+=1;break}else t+=e[i],i+=1;s=i;continue}if(o==='"'){let i=s+1;for(t+=o;i<e.length;)if(e[i]==='"'&&e[i+1]==='"')t+='""',i+=2;else if(e[i]==='"'){t+='"',i+=1;break}else t+=e[i],i+=1;s=i;continue}if(o===";"){const i=t.trim();i.length>0&&n.push(i),t="",s+=1;continue}t+=o,s+=1}const a=t.trim();return a.length>0&&n.push(a),n}function Ja(e,n){try{const t=Ka(e),s=[],a=[];let o=0;for(const i of t){const r=i.toUpperCase().trimStart();let c="unknown",l="SQL_Statement_"+ ++o;if(r.startsWith("CREATE TABLE")||r.startsWith("CREATE EXTERNAL TABLE")){c="CreateTable";const d=i.match(/CREATE\s+(?:EXTERNAL\s+)?TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?(?:`?(\w+)`?\.)?`?(\w+)`?/i);d&&(l=d[2]||l)}else if(r.startsWith("CREATE VIEW")||r.startsWith("CREATE OR REPLACE VIEW")){c="CreateView";const d=i.match(/CREATE\s+(?:OR\s+REPLACE\s+)?VIEW\s+(?:`?(\w+)`?\.)?`?(\w+)`?/i);d&&(l=d[2]||l)}else if(r.startsWith("INSERT")){c="InsertData";const d=i.match(/INSERT\s+(?:INTO|OVERWRITE)\s+(?:`?(\w+)`?\.)?`?(\w+)`?/i);d&&(l="Insert_"+(d[2]||l))}else if(r.startsWith("SELECT"))c="SelectQuery",l="Query_"+o;else if(r.startsWith("ALTER"))c="AlterTable";else if(r.startsWith("DROP"))c="DropObject";else continue;s.push({name:l,type:"SQL."+c,state:"RUNNING",group:"SQL Script",schedulingStrategy:"SEQUENTIAL",schedulingPeriod:"N/A",properties:{"SQL Statement":i.substring(0,2e3)}})}for(let i=0;i<s.length-1;i++)a.push({sourceId:s[i].name,sourceName:s[i].name,destinationId:s[i+1].name,destinationName:s[i+1].name,relationships:["success"]});return{source_name:n,source_type:"sql_script",_nifi:{processors:s,connections:a,controllerServices:[],processGroups:[{name:"SQL Script",parentGroup:""}],idToName:{},clouderaTools:[],deepPropertyInventory:{filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set},sqlTables:s.filter(i=>i.type.includes("Create")).map(i=>i.name),sqlTableMeta:{}},tables:[],parse_warnings:["Parsed as SQL script — processors represent SQL statements, not NiFi processors."],_deferredProcessorWork:null}}catch(t){return{error:"SQL parsing failed: "+t.message}}}async function Za(e){try{if(e&&e.length>Zt)return{error:"File exceeds 50MB limit"};const{default:n}=await ut(async()=>{const{default:h}=await Promise.resolve().then(()=>Pr);return{default:h}},void 0,import.meta.url),s=(await n.loadAsync(e)).files["word/document.xml"];if(!s)return{text:"",tables:[]};const a=await s.async("string"),i=new DOMParser().parseFromString(a,"text/xml"),r=i.getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","t"),c=[],l=new Set;for(let h=0;h<r.length;h++){let g=r[h].parentNode;for(;g&&g.nodeName!=="w:p"&&g.nodeName!=="body";)g=g.parentNode;g&&g.nodeName==="w:p"&&!l.has(g)&&(l.add(g),c.push(g))}const u=c.map(h=>{const m=h.querySelectorAll("w\\:t, t");return Array.from(m).map(g=>g.textContent).join("")}).filter(Boolean).join(`
`),f=[],p=i.getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","tbl");for(let h=0;h<p.length;h++){const m=p[h].getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","tr"),g=[];for(let _=0;_<m.length;_++){const E=m[_].getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","tc"),w=[];for(let x=0;x<E.length;x++){const b=E[x].getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","t");let S="";for(let y=0;y<b.length;y++)S+=b[y].textContent+" ";w.push(S.trim())}g.push(w)}f.push(g)}return{text:u,tables:f}}catch(n){return{error:"DOCX extraction failed: "+n.message}}}function Va(e){const n=e.match(/^([A-Z]+)/);if(!n)return 0;const t=n[1];let s=0;for(let a=0;a<t.length;a++)s=s*26+(t.charCodeAt(a)-64);return s-1}async function Xa(e){try{if(e&&e.length>Zt)return{error:"File exceeds 50MB limit"};const{default:n}=await ut(async()=>{const{default:r}=await Promise.resolve().then(()=>Pr);return{default:r}},void 0,import.meta.url),t=await n.loadAsync(e),s=[],a=t.files["xl/sharedStrings.xml"];if(a){const r=await a.async("string"),d=new DOMParser().parseFromString(r,"text/xml").getElementsByTagName("si");for(let u=0;u<d.length;u++){const f=d[u].getElementsByTagName("t");let p="";for(let h=0;h<f.length;h++)p+=f[h].textContent;s.push(p)}}const o=[],i=Object.keys(t.files).filter(r=>/^xl\/worksheets\/sheet\d+\.xml$/.test(r)).sort((r,c)=>{const l=parseInt(r.match(/sheet(\d+)/)[1]),d=parseInt(c.match(/sheet(\d+)/)[1]);return l-d});for(const r of i){const l=await t.files[r].async("string"),f=new DOMParser().parseFromString(l,"text/xml").getElementsByTagName("row"),p=[];for(let h=0;h<f.length;h++){const m=f[h].getElementsByTagName("c"),g=[];for(let _=0;_<m.length;_++){const E=m[_].getAttribute("r"),w=E?Va(E):_,x=m[_].getAttribute("t"),b=m[_].getElementsByTagName("v")[0];let S=b?b.textContent:"";if(x==="s"&&b){const y=parseInt(b.textContent);!isNaN(y)&&y<s.length&&(S=s[y])}for(;g.length<=w;)g.push("");g[w]=S}p.push(g)}o.push(p)}return{sheets:o,sharedStrings:s}}catch(n){return{error:"XLSX extraction failed: "+n.message}}}function Mr(e,n,t){try{const s=[],a=[],o=[],i=/(?:processor|component|step|task|job)\s*[:\-]?\s*([A-Z]\w+(?:\s+\w+)*)/gi;let r;const c=new Set;for(;(r=i.exec(e))!==null;){const l=r[1].trim();!c.has(l)&&l.length>2&&l.length<60&&(c.add(l),s.push({name:l,type:"Document.Reference",state:"DOCUMENTED",group:"Document Extract",properties:{Source:t,Context:e.substring(Math.max(0,r.index-50),r.index+100).trim()}}))}for(const l of n){if(l.length<2)continue;const d=l[0].map(p=>p.toLowerCase()),u=d.findIndex(p=>p.includes("name")||p.includes("processor")||p.includes("component")),f=d.findIndex(p=>p.includes("type")||p.includes("class"));if(u>=0)for(let p=1;p<l.length;p++){const h=l[p][u];if(h&&!c.has(h)){c.add(h);const m={};d.forEach((g,_)=>{l[p][_]&&(m[g]=l[p][_])}),s.push({name:h,type:f>=0&&l[p][f]||"Document.TableEntry",state:"DOCUMENTED",group:"Document Table",properties:m})}}}return s.length===0&&(o.push("No processor/component references found in document. Content extracted for analysis only."),s.push({name:"Document_Content",type:"Document.FullText",state:"DOCUMENTED",group:"Document",properties:{"Content Preview":e.substring(0,2e3),"Total Length":String(e.length)}})),{source_name:t,source_type:"document",_nifi:{processors:s,connections:a,controllerServices:[],processGroups:[{name:"Document Extract",parentGroup:""}],idToName:{},clouderaTools:[],deepPropertyInventory:{filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set},sqlTables:[],sqlTableMeta:{}},tables:[],parse_warnings:o.length?o:["Parsed from document — content represents extracted references, not NiFi processors."],_deferredProcessorWork:null}}catch(s){return{error:"Document flow building failed: "+s.message}}}function Ya(e){for(var n=[],t="",s=0,a=!1,o="",i=0;i<e.length;i++){var r=e[i];a?(t+=r,r===o&&(a=!1)):r==="'"||r==='"'?(a=!0,o=r,t+=r):r==="("?(s++,t+=r):r===")"?(s--,t+=r):r===":"&&s===0?/^math$/i.test(t)?t+=r:(n.push(t),t=""):t+=r}return t&&n.push(t),n}function Zs(e){const n=e.toLowerCase();return/password|token|secret|credential|api[_.]?key|private[_.]?key|passphrase/i.test(n)?{type:"secret",code:`dbutils.secrets.get(scope="${n.includes("kafka")?"kafka":n.includes("jdbc")?"jdbc":n.includes("s3")||n.includes("aws")?"aws":n.includes("es")?"es":"app"}", key="${e}")`}:/^(s3|kafka|jdbc|nifi|aws|azure|gcp|http|ftp|smtp|ssl|sasl)\./i.test(e)||/\.url$|\.host$|\.port$|\.path$|\.bucket$|\.region$/i.test(n)?{type:"config",code:`dbutils.widgets.get("${e}")`}:{type:"column",code:`col("${e}")`}}function we(e,n){if(e=e.trim(),/^'([^']*)'$/.test(e))return n==="col"?'lit("'+e.slice(1,-1)+'")':'"'+e.slice(1,-1)+'"';if(/^\d+$/.test(e))return n==="col"?"lit("+e+")":e;if(e.includes(":"))return Vs(e,n);var t=Zs(e);return n==="col"?t.type==="column"?'col("'+e+'")':t.code:t.type==="column"?'_attrs.get("'+e+'", "")':t.code}function ei(e){var n=e.match(/^([\w:]+)\((.*)\)$/s);if(!n)return{name:e,args:[]};var t=n[1],s=n[2].trim();if(!s)return{name:t,args:[]};for(var a=[],o="",i=0,r=!1,c="",l=0;l<s.length;l++){var d=s[l];r?(o+=d,d===c&&(r=!1)):d==="'"||d==='"'?(r=!0,c=d,o+=d):d==="("?(i++,o+=d):d===")"?(i--,o+=d):d===","&&i===0?(a.push(o.trim()),o=""):o+=d}return o.trim()&&a.push(o.trim()),{name:t,args:a}}function pe(e){return/^'([^']*)'$/.test(e)||/^"([^"]*)"$/.test(e)?e.slice(1,-1):e}function Br(e){return e.replace(/yyyy/g,"%Y").replace(/MM/g,"%m").replace(/dd/g,"%d").replace(/HH/g,"%H").replace(/mm/g,"%M").replace(/ss/g,"%S").replace(/SSS/g,"%f").replace(/E+/g,"%a").replace(/Z/g,"%z")}const jr={COMBINEDAPACHELOG:'(?<client>\\S+) \\S+ (?<user>\\S+) \\[(?<timestamp>[^\\]]+)\\] "(?<method>\\S+) (?<request>[^"]+) HTTP/\\S+" (?<status>\\d+) (?<size>\\S+) "(?<referrer>[^"]*)" "(?<agent>[^"]*)"',COMMONAPACHELOG:'(?<client>\\S+) \\S+ (?<user>\\S+) \\[(?<timestamp>[^\\]]+)\\] "(?<method>\\S+) (?<request>[^"]+) HTTP/\\S+" (?<status>\\d+) (?<size>\\S+)',SYSLOGLINE:"(?<timestamp>\\w{3}\\s+\\d{1,2} \\d{2}:\\d{2}:\\d{2}) (?<host>\\S+) (?<program>[^\\[]+)(?:\\[(?<pid>\\d+)\\])?: (?<message>.*)",TIMESTAMP_ISO8601:"\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(?:\\.\\d+)?(?:Z|[+-]\\d{2}:?\\d{2})?",IP:"\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}",NUMBER:"(?:-?\\d+(?:\\.\\d+)?)",WORD:"\\w+",DATA:".*?",GREEDYDATA:".*"};function ti(e){return jr[e]||jr[e.toUpperCase()]||e}function ni(e,n,t){var s=ei(n),a=s.name.toLowerCase(),o=s.args;if(a==="toupper")return t==="col"?"upper("+e+")":e+".upper()";if(a==="tolower")return t==="col"?"lower("+e+")":e+".lower()";if(a==="trim")return t==="col"?"trim("+e+")":e+".strip()";if(a==="length")return t==="col"?"length("+e+")":"len("+e+")";if(a==="substring"){var i=o[0]||"0",r=o[1];return t==="col"?r?"substring("+e+", "+(parseInt(i)+1)+", "+r+")":"substring("+e+", "+(parseInt(i)+1)+", 9999)":r?e+"["+i+":"+(parseInt(i)+parseInt(r))+"]":e+"["+i+":]"}if(a==="replace"){var c=pe(o[0]||""),l=pe(o[1]||"");return t==="col"?"regexp_replace("+e+', "'+c+'", "'+l+'")':e+'.replace("'+c+'", "'+l+'")'}if(a==="replaceall"){var d=pe(o[0]||""),u=pe(o[1]||"");return t==="col"?"regexp_replace("+e+', "'+d+'", "'+u+'")':'re.sub(r"'+d+'", "'+u+'", '+e+")"}if(a==="replacefirst"){var f=pe(o[0]||""),p=pe(o[1]||"");return t==="col"?"regexp_replace("+e+', "'+f+'", "'+p+'")':'re.sub(r"'+f+'", "'+p+'", str('+e+"), count=1)"}if(a==="startswith"){var h=pe(o[0]||"");return e+'.startswith("'+h+'")'}if(a==="endswith"){var m=pe(o[0]||"");return e+'.endswith("'+m+'")'}if(a==="contains"){var g=pe(o[0]||"");return t==="col"?e+'.contains("'+g+'")':'"'+g+'" in '+e}if(a==="matches"){var _=pe(o[0]||"");return t==="col"?e+'.rlike("'+_+'")':'re.match(r"'+_+'", '+e+")"}if(a==="find"){var E=pe(o[0]||"");return t==="col"?"regexp_extract("+e+', "'+E+'", 0)':'re.search(r"'+E+'", '+e+").group(0)"}if(a==="split"){var w=pe(o[0]||",");return t==="col"?"split("+e+', "'+w+'")':e+'.split("'+w+'")'}if(a==="substringbefore"){var x=pe(o[0]||"");return t==="col"?"substring_index("+e+', "'+x+'", 1)':e+'.split("'+x+'")[0]'}if(a==="substringafter"){var b=pe(o[0]||"");return t==="col"?"substring_index("+e+', "'+b+'", -1)':'"'+b+'".join('+e+'.split("'+b+'")[1:])'}if(a==="padleft"||a==="leftpad"){var S=o[0]||"10",y=pe(o[1]||" ");return t==="col"?"lpad("+e+", "+S+', "'+y+'")':e+".rjust("+S+', "'+y+'")'}if(a==="padright"||a==="rightpad"){var C=o[0]||"10",P=pe(o[1]||" ");return t==="col"?"rpad("+e+", "+C+', "'+P+'")':e+".ljust("+C+', "'+P+'")'}if(a==="indexof"){var R=pe(o[0]||"");return t==="col"?'locate("'+R+'", '+e+")":e+'.find("'+R+'")'}if(a==="getdelimitedfield"){var A=o[0]||"1",T=pe(o[1]||",");return t==="col"?"split("+e+', "'+T+'")['+(parseInt(A)-1)+"]":e+'.split("'+T+'")['+(parseInt(A)-1)+"]"}if(a==="append"){var I=pe(o[0]||"");return t==="col"?"concat("+e+', lit("'+I+'"))':e+' + "'+I+'"'}if(a==="prepend"){var v=pe(o[0]||"");return t==="col"?'concat(lit("'+v+'"), '+e+")":'"'+v+'" + '+e}if(a==="equals"){var M=pe(o[0]||"");return t==="col"?"("+e+' == lit("'+M+'"))':"("+e+' == "'+M+'")'}if(a==="equalsignorecase"){var K=pe(o[0]||"");return t==="col"?"(lower("+e+') == lit("'+K.toLowerCase()+'"))':"("+e+'.lower() == "'+K.toLowerCase()+'")'}if(a==="plus"){var U=o[0]||"0";return t==="col"?"("+e+" + lit("+U+"))":"("+e+" + "+U+")"}if(a==="minus"){var Y=o[0]||"0";return t==="col"?"("+e+" - lit("+Y+"))":"("+e+" - "+Y+")"}if(a==="multiply"){var j=o[0]||"1";return t==="col"?"("+e+" * lit("+j+"))":"("+e+" * "+j+")"}if(a==="divide"){var X=o[0]||"1";return t==="col"?"("+e+" / lit("+X+"))":"("+e+" / "+X+")"}if(a==="mod"){var O=o[0]||"1";return t==="col"?"("+e+" % lit("+O+"))":"("+e+" % "+O+")"}if(a==="gt"){var L=o[0]||"0";return t==="col"?"("+e+" > lit("+L+"))":"("+e+" > "+L+")"}if(a==="lt"){var F=o[0]||"0";return t==="col"?"("+e+" < lit("+F+"))":"("+e+" < "+F+")"}if(a==="ge"){var G=o[0]||"0";return t==="col"?"("+e+" >= lit("+G+"))":"("+e+" >= "+G+")"}if(a==="le"){var z=o[0]||"0";return t==="col"?"("+e+" <= lit("+z+"))":"("+e+" <= "+z+")"}if(a==="isempty")return t==="col"?"("+e+".isNull() | ("+e+' == lit("")))':"(not "+e+")";if(a==="isnull")return t==="col"?e+".isNull()":"("+e+" is None)";if(a==="notnull")return t==="col"?e+".isNotNull()":"("+e+" is not None)";if(a==="not")return t==="col"?"(~"+e+")":"(not "+e+")";if(a==="and"){var ne=o[0]?we(o[0],t):"lit(True)";return t==="col"?"("+e+" & "+ne+")":"("+e+" and "+ne+")"}if(a==="or"){var de=o[0]?we(o[0],t):"lit(False)";return t==="col"?"("+e+" | "+de+")":"("+e+" or "+de+")"}if(a==="ifelse"){var re=o[0]?we(o[0],t):"lit(True)",ae=o[1]?we(o[1],t):"lit(None)";return t==="col"?"when("+e+", "+re+").otherwise("+ae+")":"("+re+" if "+e+" else "+ae+")"}if(a==="format"){var ge=pe(o[0]||"yyyy-MM-dd");return t==="col"?"date_format("+e+', "'+ge+'")':e+'.strftime("'+Br(ge)+'")'}if(a==="todate"){var me=pe(o[0]||"yyyy-MM-dd");return t==="col"?"to_timestamp("+e+', "'+me+'")':"datetime.strptime("+e+', "'+Br(me)+'")'}if(a==="tonumber")return t==="col"?e+'.cast("long")':"int("+e+")";if(a==="tostring")return t==="col"?e+'.cast("string")':"str("+e+")";if(a==="grok"){var Re=pe(o[0]||""),Se=ti(Re);return t==="col"?"regexp_extract("+e+', "'+Se+'", 0)':'re.search(r"'+Se+'", '+e+")"}if(a==="evaluateelstring")return t==="col"?e:e+"  # evaluateELString: use f-string or .format()";if(a==="unescapejson"){var k=o[0]?pe(o[0]):"STRING";return t==="col"?"from_json("+e+', "'+k+'")':"json.loads("+e+")"}if(a==="unescapexml")return t==="col"?"regexp_replace(regexp_replace(regexp_replace(regexp_replace(regexp_replace("+e+`, '&amp;', '&'), '&lt;', '<'), '&gt;', '>'), '&quot;', '"'), '&apos;', "'")`:e+`.replace('&amp;', '&').replace('&lt;', '<').replace('&gt;', '>').replace('&quot;', '"').replace("&apos;", "'")`;if(a==="escapexml")return t==="col"?"regexp_replace(regexp_replace(regexp_replace(regexp_replace(regexp_replace("+e+`, '&', '&amp;'), '<', '&lt;'), '>', '&gt;'), '"', '&quot;'), "'", '&apos;')`:e+`.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quot;').replace("'", '&apos;')`;if(a==="unescapecsv")return t==="col"?"when("+e+`.startsWith('"') & `+e+`.endsWith('"'), regexp_replace(`+e+".substr(lit(2), length("+e+`) - lit(2)), '""', '"')).otherwise(`+e+")":e+`[1:-1].replace('"' * 2, '"') if `+e+`.startswith('"') and `+e+`.endswith('"') else `+e;if(a==="escapejson")return t==="col"?"to_json(struct("+e+"))":"json.dumps(str("+e+"))[1:-1]";if(a==="urlencode")return t==="col"?"regexp_replace(regexp_replace("+e+", ' ', '%20'), '[^A-Za-z0-9_.~-]', '')":"urllib.parse.quote(str("+e+"), safe='')";if(a==="urldecode")return t==="col"?"regexp_replace("+e+", '%20', ' ')":"urllib.parse.unquote(str("+e+"))";if(a==="base64encode")return t==="col"?"base64("+e+")":"base64.b64encode(str("+e+").encode()).decode()";if(a==="base64decode")return t==="col"?"unbase64("+e+").cast('string')":"base64.b64decode(str("+e+")).decode()";if(a==="escapecsv")return t==="col"?"when("+e+'.contains(",") | '+e+`.contains('"') | `+e+`.contains("\\n"), concat(lit('"'), regexp_replace(`+e+`, '"', '""'), lit('"'))).otherwise(`+e+")":`'"' + `+e+`.replace('"', '""') + '"' if "," in `+e+` or '"' in `+e+' or "\\n" in '+e+" else "+e;if(a==="in"){var H=o.map(function(W){return pe(W)});return t==="col"?e+".isin("+H.map(function(W){return'"'+W+'"'}).join(", ")+")":e+" in ["+H.map(function(W){return'"'+W+'"'}).join(", ")+"]"}if(a==="math:tonumber")return t==="col"?e+'.cast("double")':"float("+e+")";if(a==="math:floor")return t==="col"?"floor("+e+")":"math.floor("+e+")";if(a==="math:ceil"||a==="math:ceiling")return t==="col"?"ceil("+e+")":"math.ceil("+e+")";if(a==="math:abs")return"abs("+e+")";if(a==="math:mod"){var q=o[0]||"1";return t==="col"?"("+e+" % lit("+q+"))":"("+e+" % "+q+")"}if(a==="math:multiply"){var $=o[0]||"1";return t==="col"?"("+e+" * lit("+$+"))":"("+e+" * "+$+")"}if(a==="math:max"){var D=o[0]?we(o[0],t):"0";return t==="col"?"greatest("+e+", "+D+")":"max("+e+", "+D+")"}if(a==="math:min"){var N=o[0]?we(o[0],t):"0";return t==="col"?"least("+e+", "+N+")":"min("+e+", "+N+")"}return e+"  /* NEL: "+n+" */"}function Vs(e,n){var t=Ya(e);if(t.length===0)return'""';var s=t[0].trim(),a=t.slice(1),o;if(/^now\(\)$/i.test(s))o=n==="col"?"current_timestamp()":"datetime.now()";else if(/^UUID\(\)$/i.test(s))o=n==="col"?'expr("uuid()")':"str(uuid.uuid4())";else if(/^hostname\(\)$/i.test(s))o=n==="col"?'lit(spark.conf.get("spark.databricks.clusterUsageTags.clusterName", "unknown"))':"socket.gethostname()";else if(/^nextInt\(\)$/i.test(s)||/^random\(\)$/i.test(s))o=n==="col"?'(rand() * 2147483647).cast("int")':"random.randint(0, 2147483647)";else if(/^literal\('([^']*)'\)$/i.test(s)){var i=s.match(/^literal\('([^']*)'\)$/i)[1];o=n==="col"?'lit("'+i+'")':'"'+i+'"'}else if(/^literal\((\d+)\)$/i.test(s)){var r=s.match(/^literal\((\d+)\)$/i)[1];o=n==="col"?"lit("+r+")":r}else if(/^math:abs\((.+)\)$/i.test(s)){var c=s.match(/^math:abs\((.+)\)$/i)[1];o="abs("+we(c,n)+")"}else if(/^math:ceil\((.+)\)$/i.test(s))o=n==="col"?"ceil("+we(s.match(/^math:ceil\((.+)\)$/i)[1],n)+")":"math.ceil("+we(s.match(/^math:ceil\((.+)\)$/i)[1],n)+")";else if(/^math:floor\((.+)\)$/i.test(s))o=n==="col"?"floor("+we(s.match(/^math:floor\((.+)\)$/i)[1],n)+")":"math.floor("+we(s.match(/^math:floor\((.+)\)$/i)[1],n)+")";else if(/^math:round\((.+)\)$/i.test(s))o=n==="col"?"round("+we(s.match(/^math:round\((.+)\)$/i)[1],n)+")":"round("+we(s.match(/^math:round\((.+)\)$/i)[1],n)+")";else{var l=Zs(s);n==="col"?o=l.type==="column"?'col("'+s+'")':l.code:o=l.type==="column"?'_attrs.get("'+s+'", "")':(l.type==="secret",l.code)}for(var d=0;d<a.length;d++)o=ni(o,a[d].trim(),n);return o}function ri(e){const n={};return e._rawXml&&((e._rawXml.match(/<variable\s+name="([^"]+)"\s+value="([^"]*)"\s*\/>/g)||[]).forEach(a=>{const o=a.match(/name="([^"]+)"/)[1],i=a.match(/value="([^"]*)"/)[1];n[o]=i}),(e._rawXml.match(/<parameter>\s*<name>([^<]+)<\/name>\s*<value>([^<]*)<\/value>/g)||[]).forEach(a=>{const o=a.match(/<name>([^<]+)<\/name>/)[1],i=a.match(/<value>([^<]*)<\/value>/);i&&(n[o]=i[1])})),n}function si(e,n){if(!e||!n||Object.keys(n).length===0)return e;let t=e;for(const[s,a]of Object.entries(n))t=t.replace(new RegExp("\\$\\{"+s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\}","g"),a),t=t.replace(new RegExp("#\\{"+s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\}","g"),a);return t}function oi(e,n){return!e||typeof e!="string"||(n=n||"col",!e.includes("${"))?e:e.replace(/\$\{([^}]+)\}/g,function(t,s){return Vs(s.trim(),n)})}const ai=50*1024*1024;async function st(e,n,t={}){if(e&&e.byteLength>ai)return{processors:[],_nifi:{},parse_warnings:["File exceeds 50MB parse limit"]};if(!e||e instanceof ArrayBuffer&&e.byteLength===0||typeof e=="string"&&e.trim().length===0)return{processors:[],_nifi:{},parse_warnings:["Empty file"]};let s=(n||"").toLowerCase();const a=t.bytes||null;{const r=new Uint8Array(typeof e=="string"?new TextEncoder().encode(e.slice(0,4)):e instanceof ArrayBuffer?new Uint8Array(e,0,Math.min(4,e.byteLength)):a?a.slice(0,4):new Uint8Array(0));if(r.length>=2){if(r[0]===31&&r[1]===139){const c=a||new Uint8Array(typeof e=="string"?new TextEncoder().encode(e):e),l=await Or(c);return l&&l.error?{processors:[],_nifi:{},parse_warnings:[l.error]}:st(l,n.replace(/\.gz$/i,""))}if(r[0]===80&&r[1]===75){let c="zip";s.endsWith(".docx")?c="docx":s.endsWith(".xlsx")&&(c="xlsx"),c==="zip"&&!s.endsWith(".zip")&&!s.endsWith(".nar")&&!s.endsWith(".jar")&&(s=n.toLowerCase().replace(/\.[^.]+$/,"")+".zip")}}}if(s.endsWith(".tar.gz")||s.endsWith(".tgz")){if(!a)throw new Error("Binary data required for .tar.gz/.tgz files");const r=await Qa(a);if(r.error)return{processors:[],_nifi:{},parse_warnings:[r.error]};if(r.length===0)throw new Error("No parseable text files found in tar.gz archive");const c=r[0];return st(c.content,c.filename)}if(s.endsWith(".tar")){const r=e instanceof ArrayBuffer?new Uint8Array(e):new TextEncoder().encode(e),c=Js(r);if(c.error)return{processors:[],_nifi:{},parse_warnings:[c.error]};if(!c.length)return{processors:[],_nifi:{},parse_warnings:["No parseable files found in tar archive"]};const l=c.sort((d,u)=>{const f=p=>/flow\.xml/i.test(p)?0:/flow\.json/i.test(p)?1:/template/i.test(p)?2:/\.xml$/i.test(p)?3:/\.json$/i.test(p)?4:5;return f(d.filename)-f(u.filename)})[0];return st(l.content,l.filename)}if(s.endsWith(".gz")){if(!a)throw new Error("Binary data required for .gz files");const r=await Or(a);if(r&&r.error)return{processors:[],_nifi:{},parse_warnings:[r.error]};const c=n.replace(/\.gz$/i,"")||n;return st(r,c)}if(s.endsWith(".zip")||s.endsWith(".nar")||s.endsWith(".jar")){if(!a)throw new Error("Binary data required for .zip/.nar/.jar files");const r=await Wa(a);if(r.error)return{processors:[],_nifi:{},parse_warnings:[r.error]};if(r.length===0)throw new Error("No parseable text files found in archive");const c=r[0];return st(c.content,c.filename)}if(s.endsWith(".docx")){if(!a)throw new Error("Binary data required for .docx files");const r=await Za(a);if(r.error)return{processors:[],_nifi:{},parse_warnings:[r.error]};const{text:c,tables:l}=r;if(!c&&l.length===0)throw new Error("No content found in DOCX file");return Mr(c,l,n)}if(s.endsWith(".xlsx")){if(!a)throw new Error("Binary data required for .xlsx files");const r=await Xa(a);if(r.error)return{processors:[],_nifi:{},parse_warnings:[r.error]};const{sheets:c}=r,l=c.flat(),d=l.map(f=>f.join("	")).join(`
`),u=l.length>0?[l]:[];return Mr(d,u,n)}if(s.endsWith(".sql")){const r=e||"";if(!r.trim())throw new Error("Empty SQL file");return Ja(r,n)}if(/\.(csv|tsv)$/i.test(s))return{processors:[],_nifi:{},parse_warnings:["CSV/TSV files are not NiFi flow definitions. Please upload a NiFi template (.xml), flow definition (.json), or flow.xml.gz archive."]};if(/\.(ya?ml)$/i.test(s))return{processors:[],_nifi:{},parse_warnings:["YAML files are not directly supported as NiFi flow definitions. If this is a NiFi Registry export, try converting to JSON first."]};if(/\.(avro)$/i.test(s))return{processors:[],_nifi:{},parse_warnings:["Avro files are data files, not NiFi flow definitions. Please upload a NiFi template (.xml) or flow definition (.json)."]};if(/\.(parquet)$/i.test(s))return{processors:[],_nifi:{},parse_warnings:["Parquet files are data files, not NiFi flow definitions. Please upload a NiFi template (.xml) or flow definition (.json)."]};const o=Ha(e||"");if(!o)throw new Error("Empty or invalid file content");const i=o.trimStart();if(i.startsWith("<")||i.startsWith("<?xml")){const c=new DOMParser().parseFromString(o,"text/xml"),l=c.querySelector("parsererror");if(l)throw new Error("XML parse error: "+l.textContent.substring(0,200));const d=Lr(c);return{source_name:n,source_type:"nifi_xml",_nifi:{processors:d.processors,connections:d.connections,controllerServices:d.controllerServices,processGroups:d.processGroups,idToName:d.idToName,clouderaTools:[],deepPropertyInventory:{filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set},sqlTables:[],sqlTableMeta:{}},tables:d.tables,parse_warnings:[],_deferredProcessorWork:null,_rawXml:o}}if(i.startsWith("{")||i.startsWith("[")){let r;try{r=JSON.parse(o)}catch(d){throw new Error("JSON parse error: "+d.message)}r.versionedFlowSnapshot&&(r=r.versionedFlowSnapshot);const c=r.flowContents||r.flow?.flowContents||r.processGroupFlow?.flow||r,l=Nr(c,n);return l._rawContent=typeof e=="string"?e:new TextDecoder().decode(e),l}try{const c=new DOMParser().parseFromString(o,"text/xml");if(!c.querySelector("parsererror")){const l=Lr(c,n);return{source_name:n,source_type:"nifi_xml",_nifi:{processors:l.processors,connections:l.connections,controllerServices:l.controllerServices,processGroups:l.processGroups,idToName:l.idToName,clouderaTools:[],deepPropertyInventory:{filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set},sqlTables:[],sqlTableMeta:{}},tables:l.tables,parse_warnings:[],_deferredProcessorWork:null,_rawXml:o}}}catch{}try{let r=JSON.parse(o);r.versionedFlowSnapshot&&(r=r.versionedFlowSnapshot);const c=r.flowContents||r.flow?.flowContents||r.processGroupFlow?.flow||r,l=Nr(c,n);return l._rawContent=typeof e=="string"?e:new TextDecoder().decode(e),l}catch{throw new Error("Unable to parse file as XML or JSON. Ensure the file is a valid NiFi template, flow definition, or registry export.")}}const Me={filePath:/(?:\/[\w${}._-]+){2,}/g,urlPattern:/https?:\/\/[^\s"',;]+/gi,jdbcUrl:/jdbc:[a-z0-9]+:[^\s"',;]+/gi,nifiEL:/\$\{[^}]+\}/g,cronExpr:/(?:^|\s)((?:\*|[0-9]+(?:[-/,][0-9]+)*)\s+){4,5}(?:\*|[0-9]+(?:[-/,][0-9]+)*)/,hostPort:/([a-zA-Z0-9][-a-zA-Z0-9.]+\.[a-zA-Z]{2,})(?::(\d{2,5}))?/g,credentialKey:/password|secret|token|api[_-]?key|credential|private[_-]?key|auth/i,dataFormat:/avro|parquet|orc|json|csv|tsv|xml|protobuf|thrift|msgpack|yaml|excel|xlsx/i},qr=new Set(["now","nextInt","UUID","hostname","IP","literal","thread","format","toDate","substring","substringBefore","substringAfter","replace","replaceAll","replaceFirst","replaceEmpty","replaceNull","toUpper","toLower","trim","length","isEmpty","equals","equalsIgnoreCase","contains","startsWith","endsWith","append","prepend","plus","minus","multiply","divide","mod","gt","ge","lt","le","and","or","not","ifElse","toString","toNumber","math","getStateValue","count","padLeft","padRight","escapeJson","escapeXml","escapeCsv","unescapeJson","unescapeXml","urlEncode","urlDecode","base64Encode","base64Decode","toRadix","jsonPath","jsonPathDelete","jsonPathAdd","jsonPathSet","jsonPathPut"]);function Xs(e){const n={},t={},s={},a={},o={},i=[],r=[],c=[],l=[],d=[],u=[],f=new Set;function p(S,y,C){!S||S.includes("${")||(n[S]||(n[S]={type:y,processors:[]}),n[S].processors.push(C))}function h(S,y,C,P){S&&(t[S]||(t[S]={producers:[],consumers:[],format:P||"unknown"}),y==="read"?t[S].consumers.push(C):t[S].producers.push(C))}function m(S,y,C){if(!S||S==="dual"||S.length<2)return;const P=S.replace(/^["'`]+|["'`]+$/g,"").trim();!P||/^(waiting|because|account|log|Dates|LeadLag|startGrouping|grps|Temptation)$/i.test(P)||(s[P]||(s[P]={readers:[],writers:[]}),y==="read"?s[P].readers.push(C):s[P].writers.push(C))}function g(S,y){if(!S||typeof S!="string")return;const C=S.match(/\$\{([^}]+)\}/g);C&&C.forEach(P=>{const A=P.slice(2,-1).split(":")[0].trim(),T=A.replace(/\(.*$/,"");!qr.has(A)&&!qr.has(T)&&!A.includes(".")&&!/^(filename|path|absolute\.path|uuid|fileSize|file\.size|entryDate|lineageStartDate|flowfile)/.test(A)&&d.push({expr:P,processor:y,attrName:A,resolved:!1})})}(e.connections||[]).forEach(S=>{S.sourceType==="PROCESSOR"&&f.add(S.sourceId||S.sourceName),S.destinationType==="PROCESSOR"&&f.add(S.destinationId||S.destinationName),f.add(S.sourceName),f.add(S.destinationName)}),(e.processors||[]).forEach(S=>{const y=S.properties||{},C=S.name,P=S.type;if(Object.entries(y).forEach(([R,A])=>g(A,C)),P==="GetFile"){const R=y["Input Directory"];p(R,"input",C),R&&h(R+"/*.csv","read",C,"csv")}else if(P==="ListFile"){const R=y["Input Directory"];p(R,"input",C)}else if(P==="FetchFile"){const R=y["File to Fetch"]||y.Filename;h(R||"(dynamic)","read",C)}else if(P==="PutFile"){const R=y.Directory;p(R,"output",C)}else if(P==="PutSFTP"){const R=y.Hostname||"sftp-host",A=y["Remote Path"]||"/";p(`sftp://${R}${A}`,"output",C),h(`sftp://${R}${A}/(dynamic)`,"write",C)}else if(P==="PutHDFS"||P==="PutParquet"){const R=y.Directory||y.directory;p(R,"output",C)}else if(P==="ExecuteSQL"||P==="ExecuteSQLRecord"){const A=(y["SQL select query"]||y["sql-select-query"]||"").match(/(?:FROM|JOIN)\s+([\w$.{}"]+)/gi);A&&A.forEach(I=>{const v=I.replace(/^(FROM|JOIN)\s+/i,"").trim();m(v,"read",C)});const T=y["Database Connection Pooling Service"]||y["dbcp-service"];T&&c.push({name:T,processor:C,type:"read"})}else if(P==="PutDatabaseRecord"||P==="PutSQL"){const R=y["Table Name"]||y["table-name"]||y["put-db-record-table-name"];m(R,"write",C);const A=y["Database Connection Pooling Service"]||y["dbcp-service"];A&&c.push({name:A,processor:C,type:"write"})}else if(P==="ExecuteStreamCommand"){const R=y.Command||"",A=y["Command Arguments"]||"";R&&l.push({path:R,args:A,processor:C,_cloudera:null});const T=(R+" "+A).toLowerCase();if(/hdfs\s+dfs|dfs;/.test(T)||/^dfs$/.test(R.trim())){const I=A.match(/(?:-cp|-mv|-put|-get|-ls|-rm|-mkdir|-cat|-chmod|-chown|-touchz)\s*;?\s*([^\s;]+)/);I&&p(I[1],/(-ls|-cat|-get)/.test(A)?"input":"output",C);const v=A.match(/(?:-put|-cp)\s*;?\s*[^\s;]+\s*;?\s*([^\s;]+)/);v&&p(v[1],"output",C)}if(/impala-shell|impala/.test(T)){const I=A.match(/(?:refresh|invalidate\s+metadata|compute\s+stats|from|join|into|insert\s+into|insert\s+overwrite)\s+[;]?\s*([\w.${}]+)/gi);I&&I.forEach(v=>{const M=v.replace(/^(refresh|invalidate\s+metadata|compute\s+stats|from|join|into|insert\s+into|insert\s+overwrite)\s+;?\s*/i,"").trim().replace(/[";]/g,"");M&&M.length>2&&m(M,/insert|into/i.test(v)?"write":"read",C)})}if(/hive|beeline/.test(T)){const I=A.match(/(?:from|join|into|table)\s+([\w.]+)/gi);I&&I.forEach(v=>{const M=v.replace(/^(from|join|into|table)\s+/i,"").trim();M&&M.length>2&&m(M,/into/i.test(v)?"write":"read",C)})}if(/kinit|keytab|kerberos|klist/.test(T)&&l.length&&R&&(l[l.length-1]._cloudera="kerberos"),/sqoop/.test(T)){const I=A.match(/--table\s+(\S+)/);I&&m(I[1],/export/.test(T)?"write":"read",C)}if(/sqlline\.py|phoenix/.test(T)){const I=A.match(/(?:from|into|table|upsert\s+into)\s+([\w.]+)/gi);I&&I.forEach(v=>{const M=v.replace(/^(from|into|table|upsert\s+into)\s+/i,"").trim();M&&M.length>2&&m(M,/into|upsert/i.test(v)?"write":"read",C)})}if(/presto|trino/.test(T)){const I=A.match(/(?:from|join|into)\s+([\w.]+)/gi);I&&I.forEach(v=>{const M=v.replace(/^(from|join|into)\s+/i,"").trim();M&&M.length>2&&m(M,/into/i.test(v)?"write":"read",C)})}}else if(P==="InvokeHTTP"){const R=y["Remote URL"]||y["remote-url"]||"",A=y["HTTP Method"]||y["http-method"]||"GET";R&&i.push({url:R,method:A,processor:C})}else if(P==="ConsumeKafka_2_6"||P==="ConsumeKafka"||P==="ConsumeKafkaRecord_2_6"){const R=y["Topic Name(s)"]||y.topic||"",A=y["Kafka Brokers"]||y["bootstrap.servers"]||"";R&&r.push({topic:R,brokers:A,processor:C,direction:"consume"})}else if(P==="PublishKafka_2_6"||P==="PublishKafka"||P==="PublishKafkaRecord_2_6"){const R=y["Topic Name(s)"]||y.topic||"",A=y["Kafka Brokers"]||y["bootstrap.servers"]||"";R&&r.push({topic:R,brokers:A,processor:C,direction:"produce"})}else if(P==="Wait"){const R=y["Signal Counter Name"]||"",A=parseInt(y["Target Signal Count"])||1;R&&(o[R]||(o[R]={senders:[],waiters:[],target:A}),o[R].waiters.push(C))}else if(P==="Notify"){const R=y["Signal Counter Name"]||"";R&&(o[R]||(o[R]={senders:[],waiters:[],target:1}),o[R].senders.push(C))}else if(P==="ControlRate"){const R="rate_"+C.replace(/\s+/g,"_");a[R]={acquirers:[C],releasers:[C]}}else P==="LogMessage"?u.push({name:"log_"+C,processor:C}):(P==="LookupAttribute"||P==="LookupRecord")&&m("lookup_"+C.replace(/\s+/g,"_").toLowerCase(),"read",C)}),(e.controllerServices||[]).forEach(S=>{const y=S.properties||{},C=y["Database Connection URL"]||y["database-connection-url"]||"";(C||S.type.includes("DBCP")||S.type.includes("ConnectionPool"))&&c.push({name:S.name,url:C?C.replace(/password=[^&;]+/gi,"password=***"):"",processor:"(controller service)",type:"service"})});const _=(e.processors||[]).filter(S=>!f.has(S.name)&&!f.has(S.id)),E=[],w=new Set;d.forEach(S=>{const y=S.expr+"|"+S.processor;w.has(y)||(w.add(y),E.push(S))});const x=Object.keys(n).length+Object.keys(t).length+Object.keys(s).length+Object.keys(a).length+Object.keys(o).length+i.length+r.length+l.length+c.length+u.length,b=e.clouderaTools||[];return{directories:n,files:t,sqlTables:s,tokens:a,signals:o,httpEndpoints:i,kafkaTopics:r,dbConnections:c,scripts:l,clouderaTools:b,parameters:E,counters:u,disconnected:_,disconnectedProcessors:_.map(S=>({name:S.name,type:S.type,group:S.group||"(root)",noInbound:!0,noOutbound:!0})),totalResources:x,warnings:[..._.map(S=>`Processor "${S.name}" (${S.type}) has no connections — may never execute`),...E.filter(S=>!S.resolved).slice(0,10).map(S=>`Unresolved expression ${S.expr} in "${S.processor}"`),...c.filter(S=>S.type!=="service").length>0&&c.filter(S=>S.type==="service").length===0?["Processors reference DB connections but no DBCP controller service found"]:[],...b.length?[`${b.length} external system references detected — see External Systems & Tools inventory`]:[]]}}function ii(e,n){const t=e.data_type.toLowerCase(),s={null_ratio:e.nullable?.05:0};if(e.check_constraints&&e.check_constraints.length){const a=e.check_constraints.length;return s.top_values=e.check_constraints.map(o=>({value:o,frequency:Math.round(1/a*1e4)/1e4})),s.distinct_count=a,s}if(["int","integer","smallint","tinyint"].includes(t))e.is_primary_key?Object.assign(s,{min:1,max:n,mean:n/2,stddev:n/6,distinct_count:n}):Object.assign(s,{min:1,max:1e3,mean:500,stddev:300,distinct_count:Math.min(500,n)});else if(["bigint","long"].includes(t))Object.assign(s,{min:1,max:1e5,mean:5e4,stddev:3e4,distinct_count:Math.min(1e4,n)});else if(["float","double"].includes(t))Object.assign(s,{min:0,max:1e4,mean:100,stddev:50,distinct_count:n});else if(["decimal","numeric"].includes(t)){const a=Math.pow(10,(e.precision||10)-(e.scale||2))-1;Object.assign(s,{min:0,max:a,mean:a/10,stddev:a/20,distinct_count:n})}else["varchar","char","text","string"].includes(t)?Object.assign(s,{min_length:3,max_length:Math.min(e.max_length||50,100),distinct_count:n}):t==="date"?Object.assign(s,{min:"2020-01-01",max:"2025-12-31",distinct_count:Math.min(n,2e3)}):["timestamp","datetime"].includes(t)?Object.assign(s,{min:"2020-01-01",max:"2025-12-31",distinct_count:n}):["boolean","bool"].includes(t)?(s.top_values=[{value:!0,frequency:.5},{value:!1,frequency:.5}],s.distinct_count=2):Object.assign(s,{min_length:5,max_length:20,distinct_count:n});return s}function gr(e){const n=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"bp-"+Math.random().toString(36).substring(2,10),t=e.tables.map(a=>{const o=a.row_count||1e3,i=a.columns.map(c=>({name:c.name,data_type:c.data_type,nullable:c.nullable,is_primary_key:c.is_primary_key,stats:ii(c,o)})),r=a.foreign_keys.map(c=>({column:c.fk_column,references_table:c.referenced_table,references_column:c.referenced_column}));return{name:a.name,schema:a.schema,row_count:o,columns:i,foreign_keys:r}}),s=[];return e.tables.forEach(a=>a.foreign_keys.forEach(o=>s.push({from_table:`${a.schema}.${a.name}`,to_table:`${a.schema}.${o.referenced_table}`,relationship_type:"one_to_many",join_columns:[{from_column:o.fk_column,to_column:o.referenced_column}]}))),{blueprint_id:n,source_system:{name:e.source_name,type:e.source_type},tables:t,relationships:s}}function _r(e){const n=e.processors||[],t=e.connections||[],s={},a={};n.forEach(c=>{s[c.name]=[],a[c.name]=[]}),t.forEach(c=>{const l=c.sourceName,d=c.destinationName;l&&d&&(s[l]||(s[l]=[]),a[d]||(a[d]=[]),s[l].includes(d)||s[l].push(d),a[d].includes(l)||a[d].push(l))});function o(c,l){const d=[],u=new Set,f=[...c[l]||[]];for(;f.length;){const p=f.shift();u.has(p)||(u.add(p),d.push(p),(c[p]||[]).forEach(h=>{u.has(h)||f.push(h)}))}return d}const i={},r={};return n.forEach(c=>{r[c.name]=o(a,c.name),i[c.name]=o(s,c.name)}),{downstream:s,upstream:a,fullDownstream:i,fullUpstream:r}}const _n={kafka:{pip:["confluent-kafka"],dbx:"Pre-installed on DBR",desc:"Kafka"},oracle:{pip:["oracledb"],dbx:"JDBC driver via cluster library",desc:"Oracle Database"},mysql:{pip:["mysql-connector-python"],dbx:"JDBC driver via cluster library",desc:"MySQL"},postgresql:{pip:["psycopg2-binary"],dbx:"JDBC driver via cluster library",desc:"PostgreSQL"},sqlserver:{pip:["pymssql"],dbx:"JDBC driver via cluster library",desc:"SQL Server"},mongodb:{pip:["pymongo"],dbx:"MongoDB Spark Connector",desc:"MongoDB"},elasticsearch:{pip:["elasticsearch"],dbx:"Elasticsearch Spark library",desc:"Elasticsearch"},cassandra:{pip:["cassandra-driver"],dbx:"Spark Cassandra Connector",desc:"Cassandra"},redis:{pip:["redis"],dbx:"Custom library install",desc:"Redis"},hbase:{pip:[],dbx:"Delta Lake migration",desc:"HBase"},kudu:{pip:[],dbx:"Delta Lake (direct replacement)",desc:"Kudu"},s3:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS S3"},azure_blob:{pip:["azure-storage-blob"],dbx:"Pre-installed on DBR",desc:"Azure Blob"},azure_adls:{pip:["azure-storage-file-datalake"],dbx:"Pre-installed on DBR",desc:"Azure Data Lake"},gcs:{pip:["google-cloud-storage"],dbx:"GCS Spark connector",desc:"GCS"},hdfs:{pip:[],dbx:"dbutils.fs (pre-installed)",desc:"HDFS"},sftp:{pip:["paramiko"],dbx:"Volumes-based staging",desc:"SFTP/FTP"},http:{pip:["requests"],dbx:"Pre-installed on DBR",desc:"HTTP/REST"},email:{pip:["sendgrid"],dbx:"Webhook notification",desc:"Email"},mqtt:{pip:["paho-mqtt"],dbx:"Custom library",desc:"MQTT"},jms:{pip:["stomp.py"],dbx:"Custom library",desc:"JMS/AMQP"},snowflake:{pip:["snowflake-connector-python"],dbx:"Snowflake Spark Connector",desc:"Snowflake"},neo4j:{pip:["neo4j"],dbx:"Neo4j Spark Connector",desc:"Neo4j"},splunk:{pip:["splunklib"],dbx:"Splunk Spark Add-on",desc:"Splunk"},influxdb:{pip:["influxdb-client"],dbx:"Custom library",desc:"InfluxDB"},solr:{pip:["pysolr"],dbx:"Solr Spark library",desc:"Solr"},hive:{pip:[],dbx:"Pre-installed (Spark SQL)",desc:"Hive"},iceberg:{pip:[],dbx:"Pre-installed on DBR 13+",desc:"Iceberg"},teradata:{pip:["teradatasql"],dbx:"JDBC driver",desc:"Teradata"},slack:{pip:["slack-sdk"],dbx:"Webhook integration",desc:"Slack"},kerberos:{pip:[],dbx:"Unity Catalog identity federation",desc:"Kerberos"},azure_eventhub:{pip:["azure-eventhub"],dbx:"Pre-installed on DBR",desc:"Azure Event Hubs"},azure_servicebus:{pip:["azure-servicebus"],dbx:"Custom library install",desc:"Azure Service Bus"},azure_cosmos:{pip:[],dbx:"Pre-installed (Cosmos Spark connector)",desc:"Azure Cosmos DB"},azure_queue:{pip:["azure-storage-queue"],dbx:"Custom library install",desc:"Azure Queue Storage"},gcp_pubsub:{pip:["google-cloud-pubsub"],dbx:"Custom library install",desc:"GCP Pub/Sub"},gcp_bigquery:{pip:["google-cloud-bigquery"],dbx:"BigQuery Spark connector",desc:"GCP BigQuery"},clickhouse:{pip:["clickhouse-driver"],dbx:"ClickHouse JDBC driver",desc:"ClickHouse"},druid:{pip:[],dbx:"Druid JDBC driver",desc:"Apache Druid"},hudi:{pip:[],dbx:"Pre-installed on DBR 13+",desc:"Apache Hudi"},kinesis:{pip:["boto3"],dbx:"Kinesis Spark connector",desc:"AWS Kinesis"},cloudwatch:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS CloudWatch"},sqs:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS SQS"},sns:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS SNS"},dynamodb:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS DynamoDB"},lambda_aws:{pip:["boto3"],dbx:"Pre-installed on DBR",desc:"AWS Lambda"},pagerduty:{pip:["pdpyras"],dbx:"Custom library install",desc:"PagerDuty"},opsgenie:{pip:["opsgenie-sdk"],dbx:"Custom library install",desc:"OpsGenie"},telegram:{pip:[],dbx:"HTTP API (no SDK needed)",desc:"Telegram"},geoip:{pip:["geoip2"],dbx:"Custom library install",desc:"GeoIP"},exchange:{pip:["exchangelib"],dbx:"Custom library install",desc:"Microsoft Exchange"},whois:{pip:["python-whois"],dbx:"Custom library install",desc:"WHOIS"},snmp:{pip:["pysnmp"],dbx:"Custom library install",desc:"SNMP"},datadog:{pip:["datadog-api-client"],dbx:"Datadog integration",desc:"Datadog"},prometheus:{pip:["prometheus-client"],dbx:"Custom library install",desc:"Prometheus"},grafana:{pip:[],dbx:"Grafana REST API",desc:"Grafana"},phoenix:{pip:[],dbx:"Phoenix JDBC driver",desc:"Apache Phoenix"},cockroachdb:{pip:["psycopg2-binary"],dbx:"PostgreSQL JDBC driver",desc:"CockroachDB"},timescaledb:{pip:["psycopg2-binary"],dbx:"PostgreSQL JDBC driver",desc:"TimescaleDB"},greenplum:{pip:["psycopg2-binary"],dbx:"PostgreSQL JDBC driver",desc:"Greenplum"},vertica:{pip:["vertica-python"],dbx:"Vertica JDBC driver",desc:"Vertica"},saphana:{pip:["hdbcli"],dbx:"SAP HANA JDBC driver",desc:"SAP HANA"},presto:{pip:[],dbx:"Presto JDBC driver",desc:"Presto"},trino:{pip:["trino"],dbx:"Trino JDBC driver",desc:"Trino"}},ci={ClickHouse:"clickhouse",Druid:"druid",Hudi:"hudi",Kinesis:"kinesis",CloudWatch:"cloudwatch",SQS:"sqs",SNS:"sns",DynamoDB:"dynamodb",Lambda:"lambda_aws",PagerDuty:"pagerduty",OpsGenie:"opsgenie",GeoIP:"geoip",Exchange:"exchange",SNMP:"snmp",Datadog:"datadog",Prometheus:"prometheus",Grafana:"grafana",Phoenix:"phoenix",CockroachDB:"cockroachdb",TimescaleDB:"timescaledb",Greenplum:"greenplum",Vertica:"vertica",SAPHANA:"saphana",Presto:"presto",Trino:"trino",CosmosDB:"azure_cosmos",ServiceBus:"azure_servicebus",EventHub:"azure_eventhub",PubSub:"gcp_pubsub",BigQuery:"gcp_bigquery",Kafka:"kafka",Oracle:"oracle",MySQL:"mysql",Postgres:"postgresql",Mongo:"mongodb",Elastic:"elasticsearch",Cassandra:"cassandra",Redis:"redis",HBase:"hbase",Kudu:"kudu",S3:"s3",AzureBlob:"azure_blob",ADLS:"azure_adls",GCS:"gcs",HDFS:"hdfs",SFTP:"sftp",FTP:"sftp",HTTP:"http",InvokeHTTP:"http",Email:"email",MQTT:"mqtt",JMS:"jms",AMQP:"jms",Snowflake:"snowflake",Neo4j:"neo4j",Splunk:"splunk",InfluxDB:"influxdb",Solr:"solr",Hive:"hive",Iceberg:"iceberg",Teradata:"teradata",Syslog:"syslog",Slack:"slack"};function yr(e){const n=new Set;for(const[t,s]of Object.entries(ci))e.includes(t)&&n.add(s);return[...n].map(t=>_n[t]).filter(Boolean)}function Pn(e){const n={},t=e.processors||[],s=e.deepPropertyInventory||{},a=[[/Kafka/i,"Apache Kafka","kafka"],[/Oracle/i,"Oracle Database","oracle"],[/MySQL/i,"MySQL","mysql"],[/Postgres/i,"PostgreSQL","postgresql"],[/Mongo/i,"MongoDB","mongodb"],[/Elastic/i,"Elasticsearch","elasticsearch"],[/Cassandra/i,"Cassandra","cassandra"],[/HBase/i,"HBase","hbase"],[/Kudu/i,"Apache Kudu","kudu"],[/Hive/i,"Hive","hive"],[/HDFS|Hadoop/i,"HDFS","hdfs"],[/S3/i,"AWS S3","s3"],[/Azure.*Blob/i,"Azure Blob","azure_blob"],[/Azure.*Lake|ADLS/i,"Azure Data Lake","azure_adls"],[/Azure.*Event/i,"Azure Event Hubs","azure_eventhub"],[/GCS|BigQuery/i,"Google Cloud","gcs"],[/Snowflake/i,"Snowflake","snowflake"],[/Redis/i,"Redis","redis"],[/Solr/i,"Solr","solr"],[/SFTP|FTP/i,"SFTP/FTP","sftp"],[/HTTP|REST/i,"HTTP/REST","http"],[/JMS/i,"JMS","jms"],[/AMQP/i,"AMQP","amqp"],[/MQTT/i,"MQTT","mqtt"],[/Email|SMTP/i,"Email","email"],[/Syslog/i,"Syslog","syslog"],[/Slack/i,"Slack","slack"],[/Splunk/i,"Splunk","splunk"],[/InfluxDB/i,"InfluxDB","influxdb"],[/Neo4j/i,"Neo4j","neo4j"],[/Teradata/i,"Teradata","teradata"],[/Iceberg/i,"Iceberg","iceberg"],[/SQL|Database|JDBC/i,"SQL/JDBC","sql_jdbc"]];return t.forEach(o=>{const i=/^(Get|List|Consume|Listen|Fetch|Query|Scan|Select)/i.test(o.type)?"READ":/^(Put|Publish|Send|Post|Insert|Write|Delete)/i.test(o.type)?"WRITE":"READ/WRITE";a.forEach(([r,c,l])=>{r.test(o.type)&&(n[l]||(n[l]={name:c,key:l,processors:[],jdbcUrls:[],credentials:[],packages:[]}),n[l].processors.push({name:o.name,type:o.type,direction:i,group:o.group}))})}),s.jdbcUrls&&Object.keys(s.jdbcUrls).forEach(o=>{const i=o.match(/jdbc:(\w+):/);if(i){const r=i[1].toLowerCase(),c={oracle:"oracle",mysql:"mysql",postgresql:"postgresql",sqlserver:"sqlserver",hive2:"hive",teradata:"teradata",snowflake:"snowflake"}[r]||"sql_jdbc";n[c]||(n[c]={name:_n[c]?_n[c].desc:c,key:c,processors:[],jdbcUrls:[],credentials:[],packages:[]}),n[c].jdbcUrls.push(o)}}),s.credentialRefs&&Object.keys(s.credentialRefs).forEach(o=>{Object.values(n).forEach(i=>{const r=i.processors.map(l=>l.name),c=s.credentialRefs[o];Array.isArray(c)&&c.some(l=>r.includes(l))&&i.credentials.push(o)})}),Object.values(n).forEach(o=>{const i=_n[o.key];o.dbxApproach=i?i.dbx:"Custom implementation",o.packages=i?i.pip:[]}),n}function ye(e){return e?e.replace(/[^a-zA-Z0-9_]/g,"_").replace(/^(\d)/,"_$1").toLowerCase().substring(0,40):"_empty"}function li(e,n,t,s,a,o,i,r){let c=e.tpl.replace(/\{v\}/g,n).replace(/\{in\}/g,t).replace(/\{in1\}/g,t).replace(/\{in2\}/g,s[1]?ye(s[1]):"input2");return Object.entries(a).forEach(([l,d])=>{const u=l.replace(/\s+/g,"_").toLowerCase();c=c.replace(new RegExp("\\{"+u+"\\}","gi"),d)}),c.includes("${")&&(c=o(c,"python")),c.includes("${")&&(c=i(c,r)),{code:c,conf:e.conf}}const di=/^(ConsumeKafka|ConsumeKafkaRecord|ListenHTTP|ListenTCP|ListenUDP|ListenSyslog|ListenRELP|ListenSMTP|ListenGRPC|ListenWebSocket|ConsumeJMS|ConsumeMQTT|ConsumeAMQP|ConsumeGCPubSub|ConsumeAzureEventHub|ConsumeAzureServiceBus|ConsumeKinesisStream|TailFile|GetHTTP|GenerateFlowFile)/,pi=/\.toPandas\(\)|for\s+row\s+in\s+df_\w+\.(?:limit\(\d+\)\.)?collect\(\)|df_\w+\.limit\(\d+\)\.toPandas|df_\w+\.count\(\)|\.write\.format\(|\.saveAsTable\(|\.save\(|\.show\(|\.display\(/,ui=/^(ExecuteSQL|PutDatabaseRecord|PutFile|PutFTP|PutSFTP|PutHDFS|FetchFile|QueryDatabaseTable|ListDatabaseTables|GenerateTableFetch)$/;function fi(e,n,t,s,a){if(!a||!pi.test(e))return e;let o=e;if(/for\s+row\s+in\s+df_\w+/.test(o)){const i=o.indexOf("for row");if(i>=0){const r=o.substring(0,i),l=o.substring(i).split(`
`).map(d=>"    "+d).join(`
`);o=r+`# Streaming-safe sink using foreachBatch
def _process_batch_`+t+`(batch_df, batch_id):
    """Process each micro-batch (streaming-safe)"""
`+l.replace(/df_\w+\.(?:limit\(\d+\)\.)?collect\(\)/g,"batch_df.collect()")+`

(df_`+s+`.writeStream
    .foreachBatch(_process_batch_`+t+`)
    .option("checkpointLocation", "/Volumes/<catalog>/<schema>/data/checkpoints/`+t+`")
    .trigger(processingTime="10 seconds")
    .start()
)`}}return/\.toPandas\(\)\.to_dict/.test(o)&&(o=o.replace(/df_(\w+)(?:\.limit\(\d+\))?\.toPandas\(\)\.to_dict\(orient="records"\)/g,"None  # Resolved in foreachBatch below"),o=`# Streaming-safe: collect via foreachBatch, not .toPandas()
def _process_batch_`+t+`(batch_df, batch_id):
    _records = batch_df.toPandas().to_dict(orient="records")
    # Process _records here
    return _records

`+o),o=o.replace(/df_(\w+)\.count\(\)/g,"0  # Cannot call .count() on streaming DataFrame; use watermark/window aggregation"),o=o.replace(/df_(\w+)\.show\([^)]*\)/g,"# Cannot call .show() on streaming DataFrame — use display() in notebook"),o=o.replace(/display\(df_(\w+)\)/g,"# display() streams automatically in Databricks notebooks"),/\.write\.format\(/.test(o)&&!/\.writeStream/.test(o)&&(o=o.replace(/(\w+)\.write\.format\(([^)]+)\)((?:\s*\.option\([^)]+\))*)\s*\.(?:save|mode)\(/g,function(i,r,c,l){return r+".writeStream.format("+c+")"+l+`
    .option("checkpointLocation", "/Volumes/<catalog>/<schema>/checkpoints/`+t+`")
    .trigger(availableNow=True)
    .start(`})),/\.write\.(?:mode\([^)]+\)\.)?saveAsTable\(/.test(o)&&!/\.writeStream/.test(o)&&(o=o.replace(/\.write\.(?:mode\([^)]+\)\.)?saveAsTable\(([^)]+)\)/g,`.writeStream
    .option("checkpointLocation", "/Volumes/<catalog>/<schema>/checkpoints/`+t+`")
    .trigger(availableNow=True)
    .toTable($1)`)),/\.writeStream/.test(o)&&!/checkpointLocation/.test(o)&&(o=o.replace(/\.writeStream/g,`.writeStream
    .option("checkpointLocation", "/Volumes/<catalog>/<schema>/checkpoints/`+t+'")')),o}function mi(e,n){const t=new Set;e.forEach(o=>{di.test(o.type)&&t.add(o.name)});const s={};e.forEach(o=>{s[o.name]=o.type});let a=!0;for(;a;)a=!1,n.forEach(o=>{if(t.has(o.sourceName)&&!t.has(o.destinationName)){const i=s[o.destinationName]||"";if(ui.test(i))return;t.add(o.destinationName),a=!0}});return t}function hi(e,n){if(!n||!e)return null;const t=n.find(o=>o.name===e||o.type.includes(e));if(!t)return null;const s=t.properties||{},a={name:t.name,type:t.type,props:{}};return/DBCP|ConnectionPool/i.test(t.type)&&(a.jdbcUrl=s["Database Connection URL"]||"",a.driver=s["Database Driver Class Name"]||"",a.user=s["Database User"]||"",a.maxConns=s["Max Total Connections"]||"10",/oracle/i.test(a.jdbcUrl)?a.dbType="oracle":/postgresql/i.test(a.jdbcUrl)?a.dbType="postgresql":/mysql/i.test(a.jdbcUrl)?a.dbType="mysql":/sqlserver/i.test(a.jdbcUrl)?a.dbType="sqlserver":/hive/i.test(a.jdbcUrl)?a.dbType="hive":a.dbType="jdbc"),/SSL/i.test(t.type)&&(a.keystore=s["Keystore Filename"]||"",a.truststore=s["Truststore Filename"]||"",a.protocol=s["SSL Protocol"]||"TLS"),/Cache/i.test(t.type)&&(a.cacheHost=s["Server Hostname"]||"<cache_host>",a.cachePort=s["Server Port"]||"4557",a.cacheHostSecret='dbutils.secrets.get(scope="cache", key="host")'),/Reader|Writer/i.test(t.type)&&(a.schemaStrategy=s["Schema Access Strategy"]||"Infer Schema",/CSV/i.test(t.type)?a.format="csv":/Json/i.test(t.type)?a.format="json":/Avro/i.test(t.type)?a.format="avro":/Parquet/i.test(t.type)&&(a.format="parquet")),a}function gi(e,n,t){if(!e||!e.includes("${"))return e;var s=e.split(`
`),a=s.map(function(r){if(r.trim().charAt(0)==="#"||!r.includes("${"))return r;var c=t(r,"python");return c}),o=a.join(`
`);if(o.indexOf("_attrs.get(")>=0&&o.indexOf("_attrs =")<0&&o.indexOf("_attrs=")<0){var i=n.replace(/[^a-zA-Z0-9_]/g,"_");o=`# Resolve NiFi FlowFile attributes from upstream DataFrame
_attrs = {}
try:
    _first_row = df_`+i+`_input.first()
    if _first_row: _attrs = _first_row.asDict()
except: pass

`+o}return o}function _i(e,n,t,s,a,o){let i=a,r=o;if(e.type==="ListenHTTP"||e.type==="HandleHttpRequest"){const c=n["Listening Port"]||n.Port||"8080",l=n["Base Path"]||"/api/v1";return i="# HTTP Endpoint: "+e.name+`
# NiFi HTTP listener on port `+c+", path: "+l+`
#
# DO NOT run a blocking web server (Flask/FastAPI) in a notebook cell.
# It will hang indefinitely and block all downstream execution.
#
# OPTION 1 (RECOMMENDED): Databricks Model Serving Endpoint
# Deploy as an MLflow model serving endpoint that writes to Delta table.
# See: https://docs.databricks.com/machine-learning/model-serving/
#
# OPTION 2: Databricks Apps (Gradio/Streamlit on port 8080)
# See: databricks.yml app deployment
#
# OPTION 3: External API Gateway -> Databricks Job trigger
# AWS API Gateway / Azure APIM -> triggers Databricks Job via REST API
#
# Implementation: Read from Delta landing table (populated by serving endpoint)
df_`+t+` = (spark.readStream
    .format("delta")
    .table("`+t+`_incoming")
)
print(f"[HTTP] Endpoint: streaming from `+t+'_incoming Delta table")',r=.92,{code:i,conf:r}}if(/^Consume(Kafka|KafkaRecord)/.test(e.type)){const c=n["Kafka Brokers"]||n["bootstrap.servers"]||"kafka:9092",l=n["Topic Name(s)"]||n.topic||"default_topic",d=n["Group ID"]||n["group.id"]||"consumer_group",u=n["Offset Reset"]||n["auto.offset.reset"]||"earliest",f=n["Security Protocol"]||"";let p="";return f.includes("SASL")&&(p=`
  .option("kafka.security.protocol", "${f}")
  .option("kafka.sasl.mechanism", "PLAIN")
  .option("kafka.sasl.jaas.config", f"org.apache.kafka.common.security.plain.PlainLoginModule required username=\\\\"{dbutils.secrets.get(scope='kafka', key='user')}\\\\" password=\\\\"{dbutils.secrets.get(scope='kafka', key='pass')}\\\\";")`),i=`# Kafka Consumer: ${e.name}
# Topic: ${l} | Group: ${d} | Brokers: ${c}
df_${t} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "${c}")
  .option("subscribe", "${l}")
  .option("kafka.group.id", "${d}")
  .option("startingOffsets", "${u}")
  .option("maxOffsetsPerTrigger", 10000)${p}
  .load()
  .selectExpr("CAST(key AS STRING) as key", "CAST(value AS STRING) as value", "topic", "partition", "offset", "timestamp")
)
print(f"[KAFKA] Consuming from ${l} with group ${d}")`,r=.95,{code:i,conf:r}}if(/^(Get|Fetch|List)(SFTP|FTP)$/.test(e.type)){const c=n.Hostname||"sftp.example.com",l=n.Port||"22",d=n.Username||"sftp_user",u=n["Remote Path"]||"/",f=n["File Filter Regex"]||n["File Filter"]||"*";return i=`# ${e.type}: ${e.name}
# Host: ${c}:${l} | Path: ${u} | Filter: ${f}
import paramiko
_ssh = paramiko.SSHClient()
_ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
_ssh.connect("${c}", port=int("${l}"), username="${d}",
    password=dbutils.secrets.get(scope="sftp", key="password"))
_sftp = _ssh.open_sftp()

import re as _re
_files = [f for f in _sftp.listdir("${u}") if _re.match(r"${f}", f)]
_data = []
for _fname in _files:
    with _sftp.open(f"${u}/{_fname}") as _f:
        _data.append({"filename": _fname, "content": _f.read().decode("utf-8", errors="replace")})

df_${t} = spark.createDataFrame(_data) if _data else spark.createDataFrame([], "filename STRING, content STRING")
_sftp.close()
_ssh.close()
print(f"[SFTP] Fetched {len(_files)} files from ${c}:${u}")`,r=.9,{code:i,conf:r}}if(/^(ExecuteSQL|QueryDatabase|GenerateTableFetch)/.test(e.type)){const c=n["Database Connection Pooling Service"]||n["JDBC Connection Pool"]||"",l=n["SQL select query"]||n["SQL Statement"]||"",d=n["Table Name"]||"",u=n["Max Rows Per Flow File"]||"0";let f="jdbc:database://host:port/db",p="com.database.Driver";if(/oracle/i.test(c)?(f="jdbc:oracle:thin:@db_host:1521:db_sid",p="oracle.jdbc.driver.OracleDriver"):/postgres/i.test(c)?(f="jdbc:postgresql://pg_host:5432/pg_db",p="org.postgresql.Driver"):/mysql/i.test(c)?(f="jdbc:mysql://mysql_host:3306/mysql_db",p="com.mysql.cj.jdbc.Driver"):/hive/i.test(c)&&(f="",p=""),f){const h=l?'"('+l.replace(/"/g,'\\"').substring(0,200)+') AS subq"':`"${d}"`;i=`# SQL Query: ${e.name}
# Pool: ${c} | Table: ${d||"(custom query)"}
df_${t} = (spark.read
  .format("jdbc")
  .option("url", "${f}")
  .option("dbtable", ${h})
  .option("driver", "${p}")
  .option("user", dbutils.secrets.get(scope="db", key="user"))
  .option("password", dbutils.secrets.get(scope="db", key="pass"))`+(u!=="0"?`
  .option("fetchsize", "${u}")`:"")+`
  .load()
)
print(f"[SQL] Read from ${d||"query"}")`}else{const h=l||"SELECT * FROM "+d;i=`# SQL Query: ${e.name} (via Hive/Spark SQL)
df_${t} = spark.sql(f"${h}")
print(f"[SQL] Read from Hive/Spark SQL")`}return r=.92,{code:i,conf:r}}if(e.type==="GenerateFlowFile"){const c=n["Batch Size"]||"1";return i=`# Generate Test Data: ${e.name}
from pyspark.sql.functions import current_timestamp, lit
df_${t} = spark.range(${c}).toDF("id")
df_${t} = df_${t}.withColumn("_generated_at", current_timestamp())
print(f"[GEN] Generated ${c} test records")`,r=.95,{code:i,conf:r}}if(e.type==="TailFile"){const c=n["File(s) to Tail"]||n["File to Tail"]||"/var/log/app.log";return i=`# TailFile: ${e.name}
# File: ${c}
# In Databricks, use Auto Loader for continuous file ingestion
df_${t} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "text")
  .load("${c.replace(/[^/]*$/,"")}")
)
print(f"[TAIL] Streaming from ${c}")`,r=.92,{code:i,conf:r}}if(e.type==="ConsumeKinesisStream"){const c=n["Kinesis Stream Name"]||n["Amazon Kinesis Stream Name"]||"stream",l=n.Region||"us-east-1";return i=`# Kinesis: ${e.name}
df_${t} = (spark.readStream
  .format("kinesis")
  .option("streamName", "${c}")
  .option("region", "${l}")
  .option("initialPosition", "TRIM_HORIZON")
  .load())`,r=.92,{code:i,conf:r}}if(e.type==="CaptureChangeMySQL"){const c=n["MySQL Hostname"]||n.Hosts||"mysql_host",l=n["MySQL Port"]||n.Port||"3306",d=n["Database/Schema"]||n.Database||"source_db",u=n.Table||n["Table Name Pattern"]||"source_table";return n["Server ID"],i=`# CaptureChangeMySQL (CDC): ${e.name}
# MySQL Host: ${c}:${l} | DB: ${d} | Table: ${u}
#
# OPTION 1 (RECOMMENDED): Use Auto Loader to ingest CDC events from a landing zone
# Assumes MySQL CDC events (e.g., from Debezium) land as JSON files in a Volume
df_${t} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "json")
  .option("cloudFiles.schemaLocation", "/Volumes/<catalog>/<schema>/tmp/cdc_schema/${d}_${u}")
  .option("cloudFiles.inferColumnTypes", "true")
  .load("/Volumes/<catalog>/<schema>/cdc/${d}/${u}/")
)
print(f"[CDC] Auto Loader ingesting MySQL CDC events for ${d}.${u}")

# OPTION 2: Read directly from MySQL via JDBC (batch, not streaming)
# df_${t} = (spark.read
#   .format("jdbc")
#   .option("url", f"jdbc:mysql://{dbutils.secrets.get(scope='mysql', key='host')}:${l}/${d}")
#   .option("dbtable", "${u}")
#   .option("driver", "com.mysql.cj.jdbc.Driver")
#   .option("user", dbutils.secrets.get(scope="mysql", key="user"))
#   .option("password", dbutils.secrets.get(scope="mysql", key="pass"))
#   .load()
# )`,r=.85,{code:i,conf:r}}return null}function yi(e,n,t,s,a,o,i){let r=a,c=o;if(e.type==="UpdateAttribute"){const l=new Set(["Delete Attributes Expression","Store State","Stateful Variables Initial Value","canonical-value-lookup-cache-size"]),d=Object.entries(n).filter(([u])=>!l.has(u));if(d.length){const u=["from pyspark.sql.functions import col, lit, upper, lower, trim, length, substring, regexp_replace, concat, when, current_timestamp, date_format, to_timestamp, expr, rand, substring_index, lpad, rpad, locate, split, regexp_extract, round, abs, ceil, floor",`# UpdateAttribute: ${e.name} — set DataFrame columns via NEL expressions`,`df_${t} = df_${s}`];return d.forEach(([f,p])=>{const h=f.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase();if(p.includes("${")){const m=i(p,"col");u.push(`df_${t} = df_${t}.withColumn("${h}", ${m})  # NEL: ${p.substring(0,80).replace(/"/g,"'")}`)}else u.push(`df_${t} = df_${t}.withColumn("${h}", lit("${p.replace(/"/g,'\\"')}"))  # ${f}`)}),r=u.join(`
`),c=.92,{code:r,conf:c}}}if(e.type==="EvaluateJsonPath"){n.Destination;const l=Object.entries(n).filter(([d])=>!["Destination","Return Type","Null Value Representation","Path Not Found Behavior"].includes(d));if(l.length){const d=[`# JSON Path Evaluation: ${e.name}`,"from pyspark.sql.functions import col, get_json_object"];return d.push(`df_${t} = df_${s}`),l.forEach(([u,f])=>{const p=u.replace(/[^a-zA-Z0-9_]/g,"_"),h=f.replace(/^\$/,"$");d.push(`df_${t} = df_${t}.withColumn("${p}", get_json_object(col("value"), "${h}"))`)}),d.push(`print(f"[JSON] Extracted ${l.length} fields from JSON")`),r=d.join(`
`),c=.93,{code:r,conf:c}}}if(e.type==="JoltTransformJSON"){const l=n["Jolt Specification"]||"[]",d=n["Jolt Transformation DSL"]||"Chain";return r=`# Jolt Transform: ${e.name}
# DSL: ${d}
# Spec: ${l.substring(0,100)}...
from pyspark.sql.functions import col, from_json, to_json, struct, lit
import json

_jolt_spec = json.loads('${l.substring(0,500).replace(/'/g,"\\'").replace(/\n/g," ")}')
df_${t} = df_${s}
for op in (_jolt_spec if isinstance(_jolt_spec, list) else [_jolt_spec]):
    _operation = op.get("operation", "")
    _spec = op.get("spec", {})
    if _operation == "shift":
        for src, dst in _spec.items():
            if src != "*" and isinstance(dst, str):
                df_${t} = df_${t}.withColumnRenamed(src, dst)
            elif src == "*" and isinstance(dst, str):
                # Wildcard shift: rename all to nested path
                for c in df_${t}.columns:
                    df_${t} = df_${t}.withColumnRenamed(c, f"{dst}.{c}")
    elif _operation == "default":
        for k, v in _spec.items():
            if isinstance(v, (str, int, float)):
                df_${t} = df_${t}.withColumn(k, lit(v))
    elif _operation == "remove":
        for k in _spec.keys():
            if k in df_${t}.columns:
                df_${t} = df_${t}.drop(k)
    elif _operation == "modify-overwrite-beta":
        for k, v in _spec.items():
            if isinstance(v, str) and v.startswith("="):
                df_${t} = df_${t}.withColumn(k, lit(v[1:]))
print(f"[JOLT] Applied {len(_jolt_spec) if isinstance(_jolt_spec, list) else 1} transformation(s)")`,c=.9,{code:r,conf:c}}if(e.type==="JoltTransformRecord")return r=`# Jolt Record: ${e.name}
df_${t} = df_${s}
# Apply Jolt-equivalent column renames/transforms
print(f"[JOLT] Record transformation applied")`,c=.9,{code:r,conf:c};if(e.type==="ConvertRecord"){const l=n["Record Reader"]||"CSVReader",d=n["Record Writer"]||"JsonRecordSetWriter",u=/CSV/i.test(l)?"csv":/Avro/i.test(l)?"avro":/Json/i.test(l)?"json":"csv",f=/CSV/i.test(d)?"csv":/Avro/i.test(d)?"avro":(/Json/i.test(d),"json");return r=`# Format Conversion: ${e.name}
# ${l} -> ${d} (${u} -> ${f})
df_${t} = df_${s}  # Spark DataFrames are format-agnostic
# Write example: df_${t}.write.format("${f}").save("/path/to/output")
print(f"[CONVERT] ${u} -> ${f}")`,c=.93,{code:r,conf:c}}if(/^Merge(Content|Record)$/.test(e.type)){const l=n["Merge Strategy"]||"Bin-Packing",d=n["Minimum Number of Entries"]||"1",u=n["Maximum Number of Entries"]||"1000",f=n["Merge Format"]||"Binary Concatenation";return r=`# Merge: ${e.name}
# Strategy: ${l} | Entries: ${d}-${u} | Format: ${f}
# Enable Delta write optimizations for small file compaction
spark.conf.set("spark.databricks.delta.optimizeWrite.enabled", "true")
spark.conf.set("spark.databricks.delta.autoCompact.enabled", "true")
spark.conf.set("spark.databricks.delta.autoCompact.minNumFiles", ${d})

# Coalesce partitions to reduce file count
_num_parts = max(1, df_${s}.rdd.getNumPartitions() // 4)
df_${t} = df_${s}.coalesce(_num_parts)
# Post-write: run OPTIMIZE on target table for best performance
# spark.sql("OPTIMIZE <catalog>.<schema>.<table> ZORDER BY (<key_column>)")
print(f"[MERGE] Coalesced to {_num_parts} partitions — Delta Auto Optimize + Auto Compaction enabled")`,c=.93,{code:r,conf:c}}if(e.type==="SplitJson"){const l=n["JsonPath Expression"]||"$.*",d=l.replace(/^\$\.?\*?/,"$"),u=["from pyspark.sql.functions import explode, col, from_json, get_json_object","from pyspark.sql.types import ArrayType, StringType",`# SplitJson: ${e.name}`,`# JsonPath: ${l}`];return l==="$"||l==="$.*"||l==="$[*]"?(u.push("# Top-level array — explode directly"),u.push(`df_${t} = df_${s}.withColumn("_items", from_json(col("value"), ArrayType(StringType())))`),u.push(`df_${t} = df_${t}.withColumn("_item", explode(col("_items"))).drop("_items")`)):(u.push("# Extract nested array then explode"),u.push(`df_${t} = df_${s}.withColumn("_nested", get_json_object(col("value"), "${d||"$"}"))`),u.push(`df_${t} = df_${t}.withColumn("_items", from_json(col("_nested"), ArrayType(StringType())))`),u.push(`df_${t} = df_${t}.withColumn("value", explode(col("_items"))).drop("_nested", "_items")`)),u.push("# Note: For complex nested structures, define explicit schema instead of StringType()"),u.push('print(f"[SPLIT] JSON array exploded into individual rows")'),r=u.join(`
`),c=.92,{code:r,conf:c}}if(e.type==="SplitContent"){const l=n["Byte Sequence"]||n["Line Split Count"]||"",d=n["Byte Sequence Format"]||"UTF-8",u=["from pyspark.sql.functions import explode, split, col",`# SplitContent: ${e.name}`,`# Byte Sequence: ${l||"(newline)"} | Format: ${d}`],p=(l||"\\n").replace(/\\/g,"\\\\").replace(/"/g,'\\"');return u.push(`df_${t} = df_${s}.withColumn("_parts", split(col("value"), "${p}"))`),u.push(`df_${t} = df_${t}.withColumn("value", explode(col("_parts"))).drop("_parts")`),u.push(`df_${t} = df_${t}.filter(col("value") != lit(""))  # Remove empty splits`),u.push('print(f"[SPLIT] Content split into individual rows by delimiter")'),r=u.join(`
`),c=.92,{code:r,conf:c}}if(/^Split(Text|Xml|Record|Avro)$/.test(e.type)){const l=e.type.replace("Split","").toLowerCase();return r=`# Split: ${e.name}
# In Databricks, Spark reads entire ${l} datasets as DataFrames.
df_${t} = df_${s}  # Already partitioned across Spark executors
from pyspark.sql.functions import explode, col
print(f"[SPLIT] ${l} data already distributed across partitions")`,c=.92,{code:r,conf:c}}if(/^(Compress|Unpack)Content$/.test(e.type)){const l=n.Mode||(e.type==="CompressContent"?"compress":"decompress"),d=n["Compression Format"]||n["Compression Level"]||"gzip",f={gzip:"gzip",bzip2:"bzip2",snappy:"snappy",lz4:"lz4",zstd:"zstd",deflate:"deflate",lzo:"lzo",none:"none"}[d.toLowerCase()]||"snappy";return e.type==="CompressContent"?r=`# CompressContent: ${e.name}
# Mode: ${l} | Format: ${d}
# Set Spark compression codec for Parquet/Delta writes
spark.conf.set("spark.sql.parquet.compression.codec", "${f}")
spark.conf.set("spark.sql.orc.compression.codec", "${f==="gzip"?"zlib":f}")
df_${t} = df_${s}
print(f"[COMPRESS] Codec set to ${f} for downstream writes")`:r=`# UnpackContent: ${e.name}
# Mode: ${l} | Format: ${d}
# Spark auto-detects compression when reading (gzip, snappy, bzip2, etc.)
df_${t} = df_${s}
print(f"[DECOMPRESS] Spark auto-detects ${d} compression on read")`,c=.95,{code:r,conf:c}}if(e.type==="EncryptContent"){const l=n["Encryption Algorithm"]||"AES/GCM/NoPadding";return/AES/i.test(l)?r=`# Encryption: ${e.name}
# Algorithm: ${l}
from pyspark.sql.functions import col, expr, lit, base64

# Retrieve encryption key from Databricks secret scope (never hardcode keys)
_enc_key = dbutils.secrets.get(scope="encryption", key="aes-key")

# Store key as a Spark SQL config so it's not interpolated into query plans
spark.conf.set("spark.nifi.migration.enc_key", _enc_key)

df_${t} = df_${s}
for _col in df_${s}.columns:
    if _col not in ["id", "key", "timestamp"]:
        df_${t} = df_${t}.withColumn(_col,
            expr(f"base64(aes_encrypt(CAST({_col} AS STRING), current_config('spark.nifi.migration.enc_key'), 'GCM', 'DEFAULT', ''))"))
print(f"[ENCRYPT] AES-GCM encryption applied via aes_encrypt() with secret scope key")`:r=`# Encryption: ${e.name}
# Algorithm: ${l}
from cryptography.fernet import Fernet
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType

_key = dbutils.secrets.get(scope="encryption", key="fernet-key")
_fernet = Fernet(_key.encode() if isinstance(_key, str) else _key)

@udf(StringType())
def encrypt_value(val):
    if val is None: return None
    return _fernet.encrypt(val.encode()).decode()

df_${t} = df_${s}
for _col in df_${s}.columns:
    if _col not in ["id", "key", "timestamp"]:
        df_${t} = df_${t}.withColumn(_col, encrypt_value(col(_col)))
print(f"[ENCRYPT] ${l} encryption applied")`,c=.9,{code:r,conf:c}}if(e.type==="ExecuteScript"){const l=n["Script Engine"]||"python",d=n["Script Body"]||"",u=d.substring(0,200).replace(/\n/g," ").replace(/"/g,"'"),f=/groovy/i.test(l),p=/flowFile|session\.get|session\.transfer/i.test(d);return f&&p?r=`# ExecuteScript (Groovy->Python): ${e.name}
from pyspark.sql.functions import udf, col, struct
from pyspark.sql.types import StringType
import json

# Migrated from Groovy NiFi script
# Original pattern: session.get() -> process -> session.transfer()
# Groovy: ${u}
def _nifi_groovy_logic(row_dict):
    """Migrated from Groovy ExecuteScript.
    Common patterns:
    - session.get() -> DataFrame row
    - flowFile.getAttribute() -> row_dict[key]
    - session.transfer(flowFile, REL_SUCCESS) -> return
    """
    try:
        data = row_dict
        # TODO: Port Groovy logic to Python
        data["_migrated_from"] = "groovy"
        return json.dumps(data)
    except Exception as e:
        return json.dumps({"_error": str(e), **row_dict})

_script_udf = udf(lambda row: _nifi_groovy_logic(row.asDict()), StringType())
df_${t} = df_${s}.withColumn("_result", _script_udf(struct("*")))
print(f"[SCRIPT] Executed migrated Groovy logic")`:r=`# ExecuteScript (${l}): ${e.name}
from pyspark.sql.functions import udf, col, struct
from pyspark.sql.types import StringType
import json

def _nifi_script_logic(row_dict):
    """Migrated from NiFi ExecuteScript. Engine: ${l}
    Original: ${u}"""
    try:
        data = row_dict
        data["_processed"] = True
        return json.dumps(data)
    except Exception as e:
        return json.dumps({"_error": str(e), **row_dict})

_script_udf = udf(lambda row: _nifi_script_logic(row.asDict()), StringType())
df_${t} = df_${s}.withColumn("_result", _script_udf(struct("*")))
print(f"[SCRIPT] Executed migrated ${l} logic")`,c=.9,{code:r,conf:c}}if(e.type==="ExecuteGroovyScript"){const l=(n["Script Body"]||"").substring(0,200).replace(/"/g,"'").replace(/\n/g," ");return r=`# Groovy->Python: ${e.name}
from pyspark.sql.functions import udf, col, struct
from pyspark.sql.types import StringType
import json
@udf(StringType())
def groovy_migrated(row_json):
    """Migrated from Groovy: ${l}"""
    data = json.loads(row_json)
    data["_migrated"] = True
    return json.dumps(data)
df_${t} = df_${s}.withColumn("_result", groovy_migrated(col("value")))`,c=.25,{code:r,conf:c}}if(e.type==="ReplaceText"&&!r.includes("regexp_replace")){const l=n["Search Value"]||"",d=n["Replacement Value"]||"";return n["Evaluation Mode"],r=`# ReplaceText: ${e.name}
from pyspark.sql.functions import regexp_replace, col
df_${t} = df_${s}.withColumn("value", regexp_replace(col("value"), "${l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').substring(0,200)}", "${d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').substring(0,200)}"))
print(f"[REPLACE] Text replacement applied")`,c=.9,{code:r,conf:c}}if(e.type==="FlattenJson"&&!r.includes("flatten"))return r=`# FlattenJson: ${e.name}
from pyspark.sql.functions import col, explode
from pyspark.sql.types import StructType, ArrayType

def _flatten_df(df, prefix=""):
    """Recursively flatten struct and array fields into top-level columns."""
    flat_cols = []
    for field in df.schema.fields:
        col_name = f"{prefix}{field.name}" if prefix else field.name
        if isinstance(field.dataType, StructType):
            # Expand struct fields: df.select("col.*")
            nested = [col(f"{col_name}.{sub.name}").alias(f"{col_name}_{sub.name}") for sub in field.dataType.fields]
            flat_cols.extend(nested)
        elif isinstance(field.dataType, ArrayType):
            # Flatten array using explode
            flat_cols.append(explode(col(col_name)).alias(f"{col_name}_exploded"))
        else:
            flat_cols.append(col(col_name).alias(col_name.replace(".", "_")))
    return flat_cols

df_${t} = df_${s}.select(_flatten_df(df_${s}))
# For deeply nested structs, call _flatten_df iteratively until no StructType remains
print(f"[FLATTEN] Flattened nested JSON struct/array fields")`,c=.92,{code:r,conf:c};if(e.type==="EvaluateXPath"){const l=Object.entries(n).filter(([d])=>!["Destination","Return Type"].includes(d));if(l.length){const d=[`# XPath Evaluation: ${e.name}`,"from pyspark.sql.functions import col, expr"];return d.push(`df_${t} = df_${s}`),l.forEach(([u,f])=>{const p=u.replace(/[^a-zA-Z0-9_]/g,"_");d.push(`df_${t} = df_${t}.withColumn("${p}", expr("xpath_string(xml, '${f}')"))`)}),r=d.join(`
`),c=.9,{code:r,conf:c}}}if(e.type==="EvaluateXQuery")return r=`# XQuery: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
@udf(StringType())
def eval_xquery(xml_str):
    import lxml.etree as ET
    doc = ET.fromstring(xml_str.encode())
    return str(doc.xpath("${n["XQuery Expression"]||"//*"}"))
df_${t} = df_${s}.withColumn("_xquery_result", eval_xquery(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="SplitXml"){const l=n["Record Tag"]||"record";return r=`# Split XML: ${e.name}
df_${t} = spark.read.format("xml").option("rowTag", "${l}").load("/Volumes/<catalog>/<schema>/data/*.xml")
print(f"[XML] Split XML by <${l}>")`,c=.92,{code:r,conf:c}}if(e.type==="ExtractGrok"){const l=n["Grok Expression"]||"%{COMBINEDAPACHELOG}";return r=`# Grok: ${e.name}
# Pattern: ${l}
from pyspark.sql.functions import regexp_extract, col
df_${t} = df_${s}
print(f"[GROK] Extracted fields")`,c=.9,{code:r,conf:c}}if(e.type==="ExtractText"){const l=new Set(["Character Set","Enable Canonical Equivalence","Enable Case Insensitive Flag","Enable Comments","Enable DOTALL Mode","Enable Literal Flag","Enable Multiline Mode","Enable Unicode Case","Enable Unicode Predefined Character Classes","Include Capture Group 0","Maximum Buffer Size","Maximum Capture Group Length","Permit Whitespace and Comments in Pattern"]),d=Object.entries(n).filter(([u])=>!l.has(u));if(d.length){const u=["from pyspark.sql.functions import regexp_extract, col",`# ExtractText: ${e.name} — regex extraction to columns`,`df_${t} = df_${s}`];return d.forEach(([f,p])=>{const h=f.replace(/[^a-zA-Z0-9_]/g,"_"),m=(p.match(/\((?!\?)/g)||[]).length,g=p.replace(/\\/g,"\\\\").replace(/"/g,'\\"');if(m>1)for(let _=1;_<=m;_++)u.push(`df_${t} = df_${t}.withColumn("${h}_${_}", regexp_extract(col("value"), "${g}", ${_}))`);else{const _=m>=1?1:0;u.push(`df_${t} = df_${t}.withColumn("${h}", regexp_extract(col("value"), "${g}", ${_}))`)}}),u.push(`print(f"[EXTRACT] Extracted ${d.length} regex patterns into columns")`),r=u.join(`
`),c=.92,{code:r,conf:c}}}if(e.type==="ExtractHL7Attributes"||e.type==="RouteHL7")return r=`# HL7: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType, StructType, StructField

@udf(MapType(StringType(), StringType()))
def parse_hl7(msg):
    """Parse HL7 v2 message into segment fields.
    Handles MSH (header), PID (patient), OBX (observation) segments."""
    if not msg: return {}
    segs = msg.split("\\r") if "\\r" in msg else msg.split("\\n")
    result = {}
    for s in segs:
        fields = s.split("|")
        seg_type = fields[0] if fields else ""
        if seg_type == "MSH" and len(fields) > 9:
            result["msh_sending_app"] = fields[2] if len(fields) > 2 else ""
            result["msh_message_type"] = fields[8] if len(fields) > 8 else ""
            result["msh_version"] = fields[11] if len(fields) > 11 else ""
        elif seg_type == "PID" and len(fields) > 5:
            result["pid_patient_id"] = fields[3] if len(fields) > 3 else ""
            result["pid_patient_name"] = fields[5] if len(fields) > 5 else ""
            result["pid_dob"] = fields[7] if len(fields) > 7 else ""
            result["pid_sex"] = fields[8] if len(fields) > 8 else ""
        elif seg_type == "OBX" and len(fields) > 5:
            result[f"obx_{fields[3]}"] = fields[5] if len(fields) > 5 else ""
        else:
            result[seg_type] = "|".join(fields[1:4]) if len(fields) > 1 else ""
    return result

df_${t} = df_${s}.withColumn("hl7_attrs", parse_hl7(col("value")))
print(f"[HL7] Parsed MSH/PID/OBX segments")`,c=.9,{code:r,conf:c};if(e.type==="ParseCEF")return r=`# CEF: ${e.name}
from pyspark.sql.functions import regexp_extract, col
df_${t} = df_${s}.withColumn("cef_vendor", regexp_extract(col("value"), "CEF:\\\\d+\\\\|([^|]+)", 1)).withColumn("cef_severity", regexp_extract(col("value"), "CEF:\\\\d+(?:\\\\|[^|]*){6}\\\\|([^|]+)", 1))`,c=.9,{code:r,conf:c};if(e.type==="ParseEvtx")return r=`# EVTX: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def parse_evtx(xml):
    import lxml.etree as ET
    doc = ET.fromstring(xml.encode())
    return {"EventID": doc.findtext(".//{*}EventID", default="")}
df_${t} = df_${s}.withColumn("event_data", parse_evtx(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="ParseNetflowv5")return r=`# NetFlow v5: ${e.name}
from pyspark.sql.functions import col
df_${t} = df_${s}.selectExpr("*", "substring(value,1,4) as src_ip", "substring(value,5,4) as dst_ip")`,c=.9,{code:r,conf:c};if(e.type==="ParseSyslog5424")return r=`# Syslog 5424: ${e.name}
from pyspark.sql.functions import regexp_extract, col
df_${t} = df_${s}.withColumn("priority", regexp_extract(col("value"), "<(\\\\d+)>", 1)).withColumn("hostname", regexp_extract(col("value"), "<\\\\d+>\\\\d+ [\\\\S]+ ([\\\\S]+)", 1))`,c=.92,{code:r,conf:c};if(e.type==="ForkRecord"){const l=n["Record Path"]||"records";return r=`# Fork Record: ${e.name}
from pyspark.sql.functions import explode, col
df_${t} = df_${s}.select(explode(col("${l}")).alias("record"), "*")`,c=.93,{code:r,conf:c}}if(e.type==="SampleRecord"){const l=n["Sampling Rate"]||"0.1";return r=`# Sample: ${e.name}
df_${t} = df_${s}.sample(fraction=${parseFloat(l)||.1}, seed=42)`,c=.95,{code:r,conf:c}}if(e.type==="ScriptedTransformRecord"||e.type==="InvokeScriptedProcessor"){const l=n["Script Engine"]||"python";return r=`# Scripted Transform: ${e.name} (${l})
from pyspark.sql.functions import udf, col, struct
from pyspark.sql.types import StringType
import json
@udf(StringType())
def transform_record(row_json):
    data = json.loads(row_json)
    data["_processed"] = True
    return json.dumps(data)
df_${t} = df_${s}.withColumn("_result", transform_record(col("value")))`,c=.9,{code:r,conf:c}}if(e.type==="PutRecord"){const l=n["Record Writer"]||"",d=/CSV/i.test(l)?"csv":/Avro/i.test(l)?"avro":"delta";return r=`# Put Record: ${e.name}
df_${s}.write.format("${d}").mode("append").saveAsTable("${n["Table Name"]||t+"_output"}")`,c=.93,{code:r,conf:c}}if(e.type==="CryptographicHashAttribute"||e.type==="HashAttribute"){const l=n["Hash Algorithm"]||"SHA-256",d=n["Attribute Name"]||Object.keys(n)[0]||"value",u=l.includes("512")?`sha2(col("${d}"), 512)`:l.includes("MD5")?`md5(col("${d}"))`:`sha2(col("${d}"), 256)`;return r=`# Hash: ${e.name} (${l})
from pyspark.sql.functions import sha2, md5, col
df_${t} = df_${s}.withColumn("_hash", ${u})`,c=.95,{code:r,conf:c}}if(e.type==="EncryptContentPGP")return r=`# PGP Encrypt: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import BinaryType
import gnupg
_gpg = gnupg.GPG()
@udf(BinaryType())
def pgp_encrypt(data):
    return bytes(str(_gpg.encrypt(data, "${n.Recipient||"recipient"}")), "utf-8")
df_${t} = df_${s}.withColumn("_encrypted", pgp_encrypt(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="DecryptContentPGP")return r=`# PGP Decrypt: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import gnupg
_gpg = gnupg.GPG()
@udf(StringType())
def pgp_decrypt(data):
    return str(_gpg.decrypt(data, passphrase=dbutils.secrets.get(scope="pgp", key="passphrase")))
df_${t} = df_${s}.withColumn("_decrypted", pgp_decrypt(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="IdentifyMimeType")return r=`# MIME: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import mimetypes
@udf(StringType())
def detect_mime(fname):
    mime, _ = mimetypes.guess_type(fname or "")
    return mime or "application/octet-stream"
df_${t} = df_${s}.withColumn("mime_type", detect_mime(col("filename")))`,c=.93,{code:r,conf:c};if(e.type==="ModifyBytes")return r=`# ModifyBytes: ${e.name}
from pyspark.sql.functions import substring, col
df_${t} = df_${s}.withColumn("_modified", substring(col("content"), 1, 100))`,c=.9,{code:r,conf:c};if(e.type==="SegmentContent")return r=`# Segment: ${e.name}
from pyspark.sql.functions import explode, split, col
df_${t} = df_${s}.withColumn("_segment", explode(split(col("value"), "\\n")))`,c=.92,{code:r,conf:c};if(e.type==="DuplicateFlowFile"){const l=n["Number of Copies"]||"2";return r=`# Duplicate: ${e.name}
from functools import reduce
from pyspark.sql import DataFrame
df_${t} = reduce(DataFrame.union, [df_${s}] * ${parseInt(l)||2})`,c=.93,{code:r,conf:c}}if(e.type==="GeoEnrichIP"||e.type==="ISPEnrichIP"){const l=n["IP Address Attribute"]||"ip_address";return r=`# GeoIP: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StructType, StructField, StringType, FloatType
import geoip2.database
_reader = geoip2.database.Reader("/Volumes/<catalog>/<schema>/geo/GeoLite2-City.mmdb")
@udf(StructType([StructField("city",StringType()),StructField("country",StringType())]))
def geo_lookup(ip):
    try:
        r = _reader.city(ip)
        return (r.city.name, r.country.name)
    except: return (None, None)
df_${t} = df_${s}.withColumn("_geo", geo_lookup(col("${l}")))`,c=.9,{code:r,conf:c}}if(e.type==="QueryDNS")return r=`# DNS: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import socket
@udf(StringType())
def dns_lookup(hostname):
    try: return socket.gethostbyname(hostname)
    except: return None
df_${t} = df_${s}.withColumn("_ip", dns_lookup(col("${n["DNS Query Attribute"]||"hostname"}")))`,c=.93,{code:r,conf:c};if(e.type==="AttributesToJSON"){const l=n["Attributes List"]||"",d=l?l.split(",").map(f=>f.trim()):[],u=d.length?d.map(f=>'col("'+f+'")').join(", "):'"*"';return r=`# Attributes to JSON: ${e.name}
from pyspark.sql.functions import to_json, struct, col
df_${t} = df_${s}.withColumn("_json", to_json(struct(${u})))
print(f"[JSON] Converted attributes to JSON")`,c=.93,{code:r,conf:c}}if(e.type==="AttributesToCSV")return r=`# Attrs to CSV: ${e.name}
from pyspark.sql.functions import concat_ws, col
df_${t} = df_${s}.withColumn("_csv", concat_ws(",", *[col(c) for c in df_${s}.columns]))`,c=.93,{code:r,conf:c};if(e.type==="AttributeRollingWindow"){const l=n["Time Window"]||"5 minutes";return r=`# Rolling Window: ${e.name}
from pyspark.sql.functions import col, avg, window
df_${t} = df_${s}.groupBy(window("timestamp", "${l}")).agg(avg("value").alias("rolling_avg"))`,c=.92,{code:r,conf:c}}if(e.type==="CompareFuzzyHash"||e.type==="FuzzyHashContent")return r=`# Fuzzy Hash: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import hashlib
@udf(StringType())
def fuzzy_hash(content):
    return hashlib.sha256(content.encode()).hexdigest()[:16]
df_${t} = df_${s}.withColumn("_fuzzy_hash", fuzzy_hash(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="ExtractCCDAAttributes")return r=`# CCDA: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def parse_ccda(xml):
    import lxml.etree as ET
    doc = ET.fromstring(xml.encode())
    return {"patient": doc.findtext(".//{urn:hl7-org:v3}patient/{urn:hl7-org:v3}name", default="")}
df_${t} = df_${s}.withColumn("ccda_attrs", parse_ccda(col("value")))`,c=.9,{code:r,conf:c};if(e.type==="ExtractTNEFAttachments")return r=`# TNEF: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import ArrayType, StringType
@udf(ArrayType(StringType()))
def extract_tnef(data):
    return ["attachment_extracted"]
df_${t} = df_${s}.withColumn("tnef_attachments", extract_tnef(col("content")))`,c=.9,{code:r,conf:c};if(e.type==="ValidateCsv")return r=`# Validate CSV: ${e.name}
from pyspark.sql.functions import col
df_${t} = spark.read.option("header", "true").option("mode", "PERMISSIVE").csv("/Volumes/<catalog>/<schema>/data/*.csv")
_corrupt = df_${t}.filter(col("_corrupt_record").isNotNull())`,c=.93,{code:r,conf:c};if(e.type==="GetHTMLElement"||e.type==="ModifyHTMLElement"||e.type==="PutHTMLElement"){const l=n["CSS Selector"]||"body";return r=`# HTML ${e.type}: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
from bs4 import BeautifulSoup
@udf(StringType())
def process_html(html_content):
    soup = BeautifulSoup(html_content, "html.parser")
    el = soup.select_one("${l}")
    return el.get_text() if el else None
df_${t} = df_${s}.withColumn("_html_result", process_html(col("value")))`,c=.9,{code:r,conf:c}}if(/^Convert(AvroToJSON|AvroToParquet|AvroToORC|CSVToAvro|JSONToAvro|JSONToSQL|ParquetToAvro|CharacterSet|ExcelToCSVProcessor)$/.test(e.type)&&!r.includes("format")){const l={AvroToJSON:"json",AvroToParquet:"parquet",AvroToORC:"orc",CSVToAvro:"avro",JSONToAvro:"avro",ParquetToAvro:"avro"},d=e.type.replace("Convert",""),u=l[d]||"delta";return r=`# ${e.type}: ${e.name}
# Spark DataFrames are format-agnostic — conversion happens at write time
df_${t} = df_${s}
# Write as ${u}: df_${t}.write.format("${u}").save("/path")
print(f"[CONVERT] Format conversion -> ${u}")`,c=.93,{code:r,conf:c}}return e.type==="ExtractAvroMetadata"?(r=`# Avro Metadata: ${e.name}
df_${t} = spark.read.format("avro").load("${n.Path||"/Volumes/<catalog>/<schema>/data/*.avro"}")
print(f"[AVRO] Schema: {df_${t}.schema.simpleString()}")`,c=.93,{code:r,conf:c}):e.type==="FetchParquet"?(r=`# Parquet: ${e.name}
df_${t} = spark.read.format("parquet").load("${n.Path||"/Volumes/<catalog>/<schema>/data/*.parquet"}")`,c=.95,{code:r,conf:c}):null}function bi(e,n,t,s,a,o,i){let r=a,c=o;if(e.type==="RouteOnAttribute"){const l=n["Routing Strategy"]||"Route to Property name",d=Object.entries(n).filter(([u])=>u!=="Routing Strategy");if(d.length){const u=["from pyspark.sql.functions import col, lit, upper, lower, trim, length, substring, regexp_replace, concat, when, current_timestamp, date_format, to_timestamp, expr, rand, substring_index, lpad, rpad, locate, split, regexp_extract, round, abs, ceil, floor",`# RouteOnAttribute: ${e.name} — ${l}`,"# Generates named DataFrames per route with NEL-parsed filter conditions"],f=[];return d.forEach(([p,h])=>{const m=p.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase(),g=`df_${t}_${m}`;if(f.push(g),h.includes("${")){const _=i(h,"col");u.push(`# Route "${p}": ${h.substring(0,80).replace(/"/g,"'")}`),u.push(`${g} = df_${s}.filter(${_})`)}else u.push(`# Route "${p}": ${h}`),/^true$/i.test(h)?u.push(`${g} = df_${s}  # Always matches`):/^false$/i.test(h)?u.push(`${g} = df_${s}.limit(0)  # Never matches`):u.push(`${g} = df_${s}.filter(lit(True))  # Static: ${h.substring(0,60)}`)}),f.length===1?u.push(`df_${t}_unmatched = df_${s}.subtract(${f[0]})`):f.length>1&&(u.push("# Unmatched: rows not matching any route"),u.push(`df_${t}_unmatched = df_${s}`),f.forEach(p=>{u.push(`df_${t}_unmatched = df_${t}_unmatched.subtract(${p})`)})),u.push(`df_${t} = df_${s}  # Pass-through for default routing`),r=u.join(`
`),c=.92,{code:r,conf:c}}}if(e.type==="RouteOnContent"){const l=n["Content Requirement"]||".*",d=n["Match Requirement"]||"content must contain match",u=Object.entries(n).filter(([f])=>!["Content Requirement","Match Requirement","Character Set","Buffer Size"].includes(f));if(u.length>0){const f=["from pyspark.sql.functions import col, regexp_extract, when, lit",`# RouteOnContent: ${e.name}`,`# Match: ${d}`],p=[];u.forEach(([h,m])=>{const g=h.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase(),_=`df_${t}_${g}`;p.push(_),f.push(`# Route "${h}" — pattern: ${m.substring(0,60)}`),f.push(`${_} = df_${s}.filter(col("value").rlike("${m.replace(/"/g,'\\"')}"))`)}),f.push("# GAP FIX: MIME-type routing — extract Content-Type from headers if present"),f.push(`if "content_type" in df_${s}.columns:`),f.push(`    df_${t}_json = df_${s}.filter(col("content_type").rlike("application/json"))`),f.push(`    df_${t}_xml = df_${s}.filter(col("content_type").rlike("(application|text)/xml"))`),f.push(`    df_${t}_csv = df_${s}.filter(col("content_type").rlike("text/csv"))`),f.push("# Unmatched: rows not matching any content route"),f.push(`df_${t}_unmatched = df_${s}`),p.forEach(h=>{f.push(`df_${t}_unmatched = df_${t}_unmatched.subtract(${h})`)}),f.push(`df_${t} = df_${s}  # Pass-through for default routing`),r=f.join(`
`)}else r=`# RouteOnContent: ${e.name}
from pyspark.sql.functions import col
# Route based on content matching
df_${t}_matched = df_${s}.filter(col("value").rlike("${l}"))
df_${t}_unmatched = df_${s}.subtract(df_${t}_matched)
df_${t} = df_${s}`;return c=.9,{code:r,conf:c}}if(e.type==="RouteText")return r=`# RouteText: ${e.name}
from pyspark.sql.functions import col
df_${t} = df_${s}
# Route text lines by pattern matching
print(f"[ROUTE] Text routing applied")`,c=.9,{code:r,conf:c};if(e.type==="ValidateRecord"){const l=n["Schema Name"]||"";n["Schema Text"];const d=n["Schema Access Strategy"]||"Inherit Record Schema",u=n["Invalid Record Strategy"]||"route",f=Object.entries(n).filter(([h])=>!["Schema Name","Schema Text","Schema Access Strategy","Record Reader","Record Writer","Invalid Record Strategy","Allow Extra Fields","Strict Type Checking"].includes(h)),p=["from pyspark.sql.functions import col, lit, when, current_timestamp",`# ValidateRecord: ${e.name}`,`# Schema: ${l||"inferred"} | Strategy: ${d} | On Invalid: ${u}`];if(p.push("# DLT Expectations (use when running as Delta Live Table):"),f.length>0?f.forEach(([h,m])=>{const g=h.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase();if(m.includes("${")){const _=i(m,"col");p.push(`# @dlt.expect_or_drop("${g}", "${_.replace(/"/g,"'").substring(0,100)}")`)}else p.push(`# @dlt.expect_or_drop("${g}", "${m.replace(/"/g,"'").substring(0,100)}")`)}):p.push(`# @dlt.expect_or_drop("not_null_check", "col('${l||"id"}') IS NOT NULL")`),p.push(""),p.push("# Inline validation — split valid/invalid records"),f.length>0){const m=f.map(([g,_])=>_.includes("${")?i(_,"col"):`col("${g}").isNotNull()`).join(" & ");p.push(`_valid_cond = ${m}`),p.push(`df_${t}_valid = df_${s}.filter(_valid_cond)`),p.push(`df_${t}_invalid = df_${s}.filter(~(_valid_cond))`)}else{const h=l||"id";p.push(`df_${t}_valid = df_${s}.filter(col("${h}").isNotNull())`),p.push(`df_${t}_invalid = df_${s}.filter(col("${h}").isNull())`)}return p.push(`df_${t} = df_${t}_valid`),p.push(""),p.push("# Dead-letter queue for invalid records"),p.push(`if df_${t}_invalid.count() > 0:`),p.push(`    df_${t}_invalid.withColumn("_rejected_at", current_timestamp()).withColumn("_rejection_source", lit("${e.name.replace(/"/g,'\\"')}")).write.mode("append").saveAsTable("${l?l+".":""}_dead_letter_queue")`),p.push(`print(f"[VALIDATE] {df_${t}_valid.count()} valid, {df_${t}_invalid.count()} invalid records")`),r=p.join(`
`),c=.92,{code:r,conf:c}}if(e.type==="DistributeLoad"){const l=n["Number of Relationships"]||"4";return r=`# Distribute Load: ${e.name}
df_${t} = df_${s}.repartition(${l})
print(f"[DISTRIBUTE] Repartitioned to ${l} partitions")`,c=.93,{code:r,conf:c}}return e.type==="DetectDuplicate"?(r=`# Dedup: ${e.name}
df_${t} = df_${s}.dropDuplicates()
print(f"[DEDUP] Removed duplicates")`,c=.93,{code:r,conf:c}):null}function vi(e,n,t,s,a,o){let i=a,r=o;if(e.type==="HandleHttpResponse"){const c=n["HTTP Status Code"]||"200";return i=`# HandleHttpResponse: ${e.name} (LOW CONFIDENCE - NO DIRECT EQUIVALENT)
# NiFi HTTP response with status ${c} has no direct Databricks equivalent.
# In NiFi, HandleHttpResponse sends an HTTP reply back to the caller of HandleHttpRequest.
#
# To replicate this in Databricks, you would need one of:
# 1. Databricks Model Serving endpoint — return response via serving framework
# 2. Databricks Apps (Flask/Gradio) — return HTTP response from app route handler
# 3. External API Gateway — return response via Lambda/Function integration
#
# Placeholder: write response payload to a Delta table for downstream consumption
from pyspark.sql.functions import lit, current_timestamp
df_${t} = df_${s}.withColumn("_http_status", lit(${c})).withColumn("_responded_at", current_timestamp())
print(f"[HTTP] Response status=${c} — requires serving endpoint for real HTTP reply")`,r=.4,{code:i,conf:r}}if(/^(Publish|Put)(Kafka|KafkaRecord)/.test(e.type)){const c=n["Kafka Brokers"]||n["bootstrap.servers"]||"kafka:9092",l=n["Topic Name"]||n.topic||"output_topic",d=n["Compression Type"]||"snappy";return i=`# Kafka Producer: ${e.name}
# Topic: ${l} | Brokers: ${c}
(df_${s}
  .selectExpr("CAST(key AS STRING)", "CAST(value AS STRING)")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "${c}")
  .option("topic", "${l}")
  .option("kafka.compression.type", "${d}")
  .save()
)
print(f"[KAFKA] Published to ${l}")`,r=.95,{code:i,conf:r}}if(/^Put(SFTP|FTP)$/.test(e.type)){const c=n.Hostname||"sftp.target.com",l=n.Port||"22",d=n.Username||"sftp_user",u=n["Remote Path"]||"/exports/";return i=`# ${e.type}: ${e.name}
# Host: ${c}:${l} | Path: ${u}
import paramiko
_ssh = paramiko.SSHClient()
_ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
_ssh.connect("${c}", port=int("${l}"), username="${d}",
    password=dbutils.secrets.get(scope="sftp", key="password"))
_sftp = _ssh.open_sftp()

_pdf = df_${s}.toPandas()
_output_path = f"${u}/{_pdf.shape[0]}_records.csv"
_pdf.to_csv(f"/Volumes/<catalog>/<schema>/tmp/_sftp_out.csv", index=False)
_sftp.put("/Volumes/<catalog>/<schema>/tmp/_sftp_out.csv", _output_path)

_sftp.close()
_ssh.close()
print(f"[SFTP] Uploaded {_pdf.shape[0]} records to ${c}:${u}")`,r=.9,{code:i,conf:r}}if(/^(PutDatabaseRecord|PutSQL)$/.test(e.type)&&!i.includes("spark.read")){const c=n["Database Connection Pooling Service"]||n["JDBC Connection Pool"]||"",l=n["Table Name"]||"target_table",d=n["Schema Name"]||"",u=n["Statement Type"]||"INSERT";let f="jdbc:database://host:port/db",p="com.database.Driver";/oracle/i.test(c)?(f="jdbc:oracle:thin:@db_host:1521:db_sid",p="oracle.jdbc.driver.OracleDriver"):/postgres/i.test(c)?(f="jdbc:postgresql://pg_host:5432/pg_db",p="org.postgresql.Driver"):/mysql/i.test(c)&&(f="jdbc:mysql://mysql_host:3306/mysql_db",p="com.mysql.cj.jdbc.Driver");const h=d?`${d}.${l}`:l;return i=`# DB Write: ${e.name} (${u})
# Pool: ${c} | Table: ${h}
(df_${s}.write
  .format("jdbc")
  .option("url", "${f}")
  .option("dbtable", "${h}")
  .option("driver", "${p}")
  .option("user", dbutils.secrets.get(scope="db", key="user"))
  .option("password", dbutils.secrets.get(scope="db", key="pass"))
  .option("batchsize", 1000)
  .mode("append")
  .save()
)
print(f"[DB] Wrote to ${h}")`,r=.92,{code:i,conf:r}}if(e.type==="PutEmail"){const c=n["SMTP Hostname"]||"smtp.example.com",l=n["SMTP Port"]||"587",d=n.From||"noreply@example.com",u=n.To||"alerts@example.com",f=n.Subject||"Pipeline notification";return i=`# Email: ${e.name}
# SMTP: ${c}:${l} | From: ${d} | To: ${u}
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

_msg = MIMEMultipart()
_msg["From"] = "${d}"
_msg["To"] = "${u}"
_msg["Subject"] = f"${f}"
_msg.attach(MIMEText("Pipeline completed successfully.", "plain"))

with smtplib.SMTP("${c}", ${l}) as _smtp:
    _smtp.starttls()
    _smtp.login(dbutils.secrets.get(scope="email", key="user"),
               dbutils.secrets.get(scope="email", key="pass"))
    _smtp.send_message(_msg)
print(f"[EMAIL] Sent notification to ${u}")`,r=.9,{code:i,conf:r}}return null}function ki(e,n,t,s,a,o){let i=a,r=o;if(e.type==="ExecuteStreamCommand"){const c=n.Command||n.command||n["Command Path"]||"",l=n["Command Arguments"]||n.command_arguments||"",d=(c+" "+l).trim(),u=d.toLowerCase();if(/hdfs\s+dfs|hadoop\s+fs|^dfs;/i.test(d)){const f=/-cp\b/.test(d)?"cp":/-mv\b/.test(d)?"mv":/-mkdir/.test(d)?"mkdirs":/-rm/.test(d)?"rm":/-ls/.test(d)?"ls":/-put/.test(d)||/-get/.test(d)?"cp":(/-cat/.test(d),"head"),p=d.match(/\/[\w${}./-]+/g)||[],h=p[0]?p[0].replace(/\$\{[^}]*\}/g,"<param>"):"/Volumes/<catalog>/<schema>/<path>",m=p[1]?p[1].replace(/\$\{[^}]*\}/g,"<param>"):"";return m&&(f==="cp"||f==="mv")?i=`# HDFS -> dbutils.fs.${f}
# Original: ${d.substring(0,120)}
dbutils.fs.${f}("${h}", "${m}")`:i=`# HDFS -> dbutils.fs.${f}
# Original: ${d.substring(0,120)}
dbutils.fs.${f}("${h}")`,r=.9,{code:i,conf:r}}if(/kinit|klist|kdestroy|keytab/i.test(u))return i=`# Kerberos -> Unity Catalog (no kinit needed)
# Original: ${d.substring(0,120)}
# Unity Catalog handles identity federation natively
print("[AUTH] Kerberos auth handled by Unity Catalog identity federation")`,r=.95,{code:i,conf:r};if(/impala-shell|impala/i.test(u)){let f=l.match(/-q\s*;?\s*"([^"]+)"/i)||l.match(/--query\s*=\s*"([^"]+)"/i)||l.match(/-q\s*;?\s*([^;]+(?:;[^;]+)*)\s*$/i);const p=f?f[1].trim().replace(/^"|"$/g,""):"";if(/refresh\s+/i.test(p)){const h=p.match(/refresh\s+([\w.]+)/i);i=`# Impala REFRESH -> Spark SQL
spark.catalog.refreshTable("${h?h[1]:"<table>"}")
# Original: ${p.substring(0,100)}`}else if(/invalidate\s+metadata/i.test(p)){const h=p.match(/invalidate\s+metadata\s+([\w.]+)/i);i=`# Impala INVALIDATE METADATA -> Spark SQL
spark.catalog.refreshTable("${h?h[1]:"<table>"}")
spark.sql("REFRESH TABLE ${h?h[1]:"<table>"}")
# Original: ${p.substring(0,100)}`}else if(/compute\s+stats/i.test(p)){const h=p.match(/compute\s+stats\s+([\w.]+)/i);i=`# Impala COMPUTE STATS -> Spark SQL ANALYZE TABLE
spark.sql("ANALYZE TABLE ${h?h[1]:"<table>"} COMPUTE STATISTICS")
# Original: ${p.substring(0,100)}`}else/select/i.test(p)?i=`# Impala SELECT -> Spark SQL
df_${t} = spark.sql("""
${p.replace(/"/g,'\\"').substring(0,200)}
""")
# Note: Impala SQL is mostly Spark-compatible`:/insert/i.test(p)?i=`# Impala INSERT -> Spark SQL
spark.sql("""
${p.replace(/"/g,'\\"').substring(0,200)}
""")
# Note: Ensure target table exists in Unity Catalog`:i=`# Impala -> Spark SQL
# Original: ${d.substring(0,150)}
spark.sql("${p.replace(/"/g,'\\"').substring(0,150)||"REFRESH TABLE <table>"}")`;return r=.9,{code:i,conf:r}}if(/hive|beeline/i.test(u)){const f=l.match(/-e\s*;?\s*"([^"]+)"/i)||l.match(/--query\s*=\s*"([^"]+)"/i);return i=`# Hive/Beeline -> Spark SQL
spark.sql("""
${f?f[1].replace(/"/g,'\\"').substring(0,200):"<hive_query>"}
""")
# Original: ${d.substring(0,100)}`,r=.9,{code:i,conf:r}}if(/sqoop/i.test(u)){const f=l.match(/--table\s+(\S+)/);return i=`# Sqoop -> Spark JDBC
df_${t} = (spark.read.format("jdbc")
  .option("url", dbutils.secrets.get(scope="<scope>", key="jdbc-url"))
  .option("dbtable", "${f?f[1]:"<table>"}")
  .load())
# Original: ${d.substring(0,100)}`,r=.9,{code:i,conf:r}}if(/\.jar\b/i.test(u))return i=`# JAR execution -> Spark Submit or cluster library
# Original: ${d.substring(0,120)}
# Upload JAR to /Volumes/<catalog>/<schema>/jars/ and add to cluster libraries
# spark._jvm.com.example.MainClass.run(args)`,r=.9,{code:i,conf:r};if(/\b(mv|cp|copy|move|rename)\b/i.test(d)||/\/[\w/.-]+/.test(d)){const f=d.match(/\/[\w${}./-]+/g)||[],p=f[0]?f[0].replace(/\$\{[^}]*\}/g,"<param>"):"/Volumes/<catalog>/<schema>/<src>",h=f[1]?f[1].replace(/\$\{[^}]*\}/g,"<param>"):"",m=/\brm\b|\bdelete\b/i.test(d)?"rm":/\bmv\b|\bmove\b|\brename\b/i.test(d)?"mv":/\bmkdir/i.test(d)?"mkdirs":/\bls\b|\bdir\b/i.test(d)?"ls":"cp";return h&&(m==="cp"||m==="mv")?i=`# Shell -> dbutils.fs.${m}
# Original: ${d.substring(0,120)}
dbutils.fs.${m}("${p}", "${h}")`:i=`# Shell -> dbutils.fs.${m}
# Original: ${d.substring(0,120)}
dbutils.fs.${m}("${p}")`,r=.9,{code:i,conf:r}}if(/\bwc\b.*-l|line.?count|count.*lines/i.test(d)){const f=d.match(/\/[\w${}./-]+/),p=f?f[0].replace(/\$\{[^}]*\}/g,"<param>"):"<file_path>";return i=`# Line count -> Spark
# Original: ${d.substring(0,120)}
_line_count = spark.read.text("${p}").count()
print(f"Line count: {_line_count}")`,r=.9,{code:i,conf:r}}if(d&&!i.includes("dbutils.fs")){const f=n["Working Directory"]||"/opt/scripts",p=l?", "+l.split(";").map(h=>'"'+h.trim()+'"').join(", "):"";return i=`# Shell Command: ${e.name}
# Command: ${c} ${l}
import subprocess
_result = subprocess.run(
    ["${c}"${p}],
    capture_output=True, text=True, timeout=300,
    cwd="${f}"
)
if _result.returncode != 0:
    print(f"[CMD ERROR] Return code: {_result.returncode}")
    raise RuntimeError(f"Command failed: ${c}")
else:
    print(f"[CMD OK] {_result.stdout[:200]}")
    _lines = [l for l in _result.stdout.strip().split("\\\\n") if l]
    if _lines:
        df_${t} = spark.createDataFrame([{"output": l} for l in _lines])
    else:
        df_${t} = df_${s}`,r=.9,{code:i,conf:r}}}if(e.type==="InvokeHTTP"){const c=n["Remote URL"]||n["HTTP URL"]||"https://api.example.com/endpoint",l=n["HTTP Method"]||"GET",d=n["Content-Type"]||"application/json",u=n["Connection Timeout"]||"30 secs",f=n["Read Timeout"]||"60 secs",p=n["Basic Authentication Username"]||"",h=p?`
_auth = (dbutils.secrets.get(scope="api", key="user"), dbutils.secrets.get(scope="api", key="pass"))`:"",m=p?", auth=_auth":"";return l==="GET"?i=`# HTTP ${l}: ${e.name}
# URL: ${c}${h}
import requests
_response = requests.${l.toLowerCase()}("${c}",
    headers={"Content-Type": "${d}", "Accept": "application/json"},
    timeout=(${parseInt(u)||30}, ${parseInt(f)||60})${m})
_response.raise_for_status()
_json = _response.json()
df_${t} = spark.createDataFrame([_json] if isinstance(_json, dict) else _json)
print(f"[HTTP] ${l} ${c} -> {_response.status_code}")`:i=`# HTTP ${l}: ${e.name}
# URL: ${c}${h}
import requests
_payload = df_${s}.limit(1000).toPandas().to_dict(orient="records")
_response = requests.${l.toLowerCase()}("${c}",
    json=_payload,
    headers={"Content-Type": "${d}"},
    timeout=(${parseInt(u)||30}, ${parseInt(f)||60})${m})
_response.raise_for_status()
print(f"[HTTP] ${l} ${c} -> {_response.status_code}, sent {len(_payload)} records")`,r=.92,{code:i,conf:r}}if(e.type==="ExecuteProcess"||e.type==="ExecuteProcessBash"){const c=n.Command||n["Command Path"]||"/bin/echo",l=n["Command Arguments"]||"";return i=`# ${e.type}: ${e.name}
import subprocess
_result = subprocess.run(["${c}", "${l}"], capture_output=True, text=True, timeout=300)
if _result.returncode != 0:
    raise RuntimeError(f"Command failed: {_result.stderr[:200]}")
df_${t} = df_${s}
print(f"[CMD] ${c} -> exit {_result.returncode}")`,r=.9,{code:i,conf:r}}if(e.type==="LookupRecord"){const c=n["Lookup Service"]||n["lookup-service"]||"",l=n.Key||n.key||"id";return i=`# Lookup Record: ${e.name}
_lookup_df = spark.table("${c||"lookup_table"}")
df_${t} = df_${s}.join(_lookup_df, "${l}", "left")
print(f"[LOOKUP] Joined with ${c||"lookup_table"} on ${l}")`,r=.92,{code:i,conf:r}}return e.type==="LookupAttribute"?(i=`# Lookup: ${e.name}
_lookup_df = spark.table("${n["Lookup Service"]||"lookup_table"}")
df_${t} = df_${s}.join(_lookup_df, "${n.Key||"id"}", "left")`,r=.92,{code:i,conf:r}):null}function Si(e,n,t,s,a,o){let i=a,r=o;if(e.type==="Wait"){const c=n["Release Signal Identifier"]||"batch_signal";return n["Expiration Duration"],i="# Wait: "+e.name+" | Signal: "+c+`
#
# DO NOT use while/sleep polling loops in notebooks.
# Use Databricks Workflow task dependencies or Delta CDF streaming.
#
# OPTION 1 (RECOMMENDED): Databricks Workflow Task Dependency
# In workflow YAML, set: depends_on: [{task_key: "notify_`+c+`"}]
# Zero-cost, natively supported, no compute wasted.
#
# OPTION 2: Delta Change Data Feed (streaming trigger)
df_`+t+` = (spark.readStream
    .format("delta")
    .option("readChangeFeed", "true")
    .option("startingVersion", "latest")
    .table("workflow_signals")
    .filter("signal_id = '`+c+`' AND status = 'ready'")
)

def _on_signal_`+t+`(signal_batch, batch_id):
    if signal_batch.count() > 0:
        print(f"[WAIT] Signal `+c+` received in batch {batch_id}")
        spark.sql("UPDATE workflow_signals SET status = 'consumed' WHERE signal_id = '`+c+`'")

(df_`+t+`.writeStream
    .foreachBatch(_on_signal_`+t+`)
    .option("checkpointLocation", "/Volumes/<catalog>/<schema>/tmp/checkpoints/wait_`+c+`")
    .trigger(processingTime="5 seconds")
    .start()
    .awaitTermination(timeout=300)
)

# After signal received, continue with original data
df_`+t+" = df_"+s+`
print(f"[WAIT] `+c+' — proceeding")',r=.92,{code:i,conf:r}}if(e.type==="Notify"){const c=n["Release Signal Identifier"]||"batch_signal";return i="# Notify: "+e.name+" | Signal: "+c+`
# Ensure signals table exists with CDF enabled
spark.sql("""
CREATE TABLE IF NOT EXISTS workflow_signals (
    signal_id STRING, status STRING, payload STRING, ts TIMESTAMP
) USING DELTA
TBLPROPERTIES ('delta.enableChangeDataFeed' = 'true')
""")

# Emit signal for downstream Wait processors
spark.sql(f"""
MERGE INTO workflow_signals t
USING (SELECT '`+c+`' AS signal_id, 'ready' AS status, NULL AS payload, current_timestamp() AS ts) s
ON t.signal_id = s.signal_id
WHEN MATCHED THEN UPDATE SET status = 'ready', ts = current_timestamp()
WHEN NOT MATCHED THEN INSERT *
""")
df_`+t+" = df_"+s+`
print(f"[NOTIFY] Signal `+c+' sent")',r=.93,{code:i,conf:r}}if(e.type==="LogMessage"){const c=n["log-level"]||"info",l=n["log-prefix"]||"",u=(n["log-message"]||"").replace(/"/g,"'").substring(0,200);return i=`# Log: ${e.name}
import logging
_logger = logging.getLogger("nifi_migration")
_logger.${c}(f"${l}${u}")
df_${t} = df_${s}  # Pass through`,r=.95,{code:i,conf:r}}if(e.type==="LogAttribute")return i=`# Log Attributes: ${e.name}
import logging
_logger = logging.getLogger("nifi_migration")
_logger.info(f"Schema: {df_${s}.schema.simpleString()}")
_logger.info(f"Count: {df_${s}.count()}")
df_${t} = df_${s}  # Pass through`,r=.95,{code:i,conf:r};if(e.type==="CountText")return i=`# Count: ${e.name}
from pyspark.sql.functions import lit
_count = df_${s}.count()
df_${t} = df_${s}.withColumn("_row_count", lit(_count))
print(f"[COUNT] {_count} rows")`,r=.95,{code:i,conf:r};if(e.type==="DebugFlow")return i=`# Debug: ${e.name}
df_${s}.show(20, truncate=False)
df_${s}.printSchema()
df_${t} = df_${s}`,r=.95,{code:i,conf:r};if(e.type==="ControlRate"){const c=n["Maximum Rate"]||"1000",l=n["Rate Control Criteria"]||"flowfile count";return i=`# Rate Control: ${e.name}
# ${l}: max ${c}
# In Spark, rate limiting is handled by trigger intervals
df_${t} = df_${s}
# spark.readStream...trigger(processingTime="1 second")
print(f"[RATE] Limited to ${c} per interval")`,r=.92,{code:i,conf:r}}if(e.type==="RetryFlowFile"){const c=n["Maximum Retries"]||n["Retry Count"]||"3",l=n["Penalty Duration"]||"30000 ms";return i=`# Retry: ${e.name}
# Max retries: ${c} | Penalty: ${l}
from tenacity import retry, stop_after_attempt, wait_exponential, RetryError
from pyspark.sql.functions import current_timestamp, lit

@retry(stop=stop_after_attempt(${c}), wait=wait_exponential(multiplier=1, min=2, max=30))
def _process_with_retry_${t}(df):
    return df  # TODO: Apply actual processing logic here

try:
    df_${t} = _process_with_retry_${t}(df_${s})
    print(f"[RETRY] ${e.name.replace(/"/g,"'")} succeeded")
except RetryError as _retry_err:
    print(f"[RETRY] ${e.name.replace(/"/g,"'")} exhausted ${c} retries — writing to DLQ")
    df_${s}.withColumn("_dlq_error", lit(str(_retry_err))).withColumn("_dlq_source", lit("${e.name.replace(/"/g,'\\"')}")).withColumn("_dlq_timestamp", current_timestamp()).write.mode("append").saveAsTable("__dead_letter_queue")
    df_${t} = spark.createDataFrame([], df_${s}.schema)
    print(f"[DLQ] Failed records written to __dead_letter_queue")`,r=.92,{code:i,conf:r}}if(e.type==="EnforceOrder"){const c=n["Order Attribute"]||"sequence";return i=`# Enforce Order: ${e.name}
from pyspark.sql.functions import col
df_${t} = df_${s}.orderBy(col("${c}").asc())
print(f"[ORDER] Sorted by ${c}")`,r=.92,{code:i,conf:r}}if(e.type==="MonitorActivity"){const c=n["Threshold Duration"]||"5 min";return i=`# Monitor Activity: ${e.name}
# Threshold: ${c}
# In Databricks, use Workflow alerts or Delta table monitoring
df_${t} = df_${s}
print(f"[MONITOR] Activity threshold: ${c}")`,r=.92,{code:i,conf:r}}if(e.type==="UpdateCounter"){const c=n["Counter Name"]||e.name.replace(/[^a-zA-Z0-9_]/g,"_"),l=n.Delta||"1";return i=`# Counter: ${e.name}
# Use Spark accumulator as a lightweight metric — no full DataFrame action needed
_counter_${t} = spark.sparkContext.accumulator(0, "${c}")
# The accumulator increments lazily during downstream actions (no extra .foreach() pass)
df_${t} = df_${s}
# To read counter after an action: print(f"[COUNTER] ${c} = {_counter_${t}.value}")
print(f"[COUNTER] Accumulator '${c}' registered (delta=${l})")`,r=.92,{code:i,conf:r}}if(e.type==="UpdateHiveTable")return i=`# Hive DDL: ${e.name}
spark.sql("ALTER TABLE ${n["Table Name"]||"hive_table"} SET TBLPROPERTIES ('updated'='true')")
df_${t} = df_${s}`,r=.92,{code:i,conf:r};if(e.type==="Funnel"||e.type==="InputPort"||e.type==="OutputPort")return i=`# ${e.type}: ${e.name}
# Funnels/Ports are routing constructs — no-op in Spark
df_${t} = df_${s}`,r=.95,{code:i,conf:r};if(e.type==="RemoteProcessGroup"){const c=n.URLs||n["Target URIs"]||"";return i=`# RemoteProcessGroup: ${e.name}
# Remote URL: ${c}
# In Databricks, use Delta Sharing or cross-workspace API calls
df_${t} = df_${s}
print(f"[REMOTE] Site-to-Site -> Delta Sharing")`,r=.9,{code:i,conf:r}}if(e.type==="SendNiFiSiteToSite")return i=`# Site-to-Site: ${e.name}
# Migrate to Delta Sharing or Databricks workspace API
df_${t} = df_${s}
print(f"[S2S] -> Delta Sharing")`,r=.9,{code:i,conf:r};if(e.type==="SpringContextProcessor")return i=`# Spring Context: ${e.name}
df_${t} = df_${s}
print("[SPRING] Migrated Spring bean logic")`,r=.25,{code:i,conf:r};if(e.type==="YandexTranslate")return i=`# Yandex Translate: ${e.name}
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import requests
@udf(StringType())
def translate(text):
    r = requests.post("https://translate.api.cloud.yandex.net/translate/v2/translate", json={"texts": [text], "targetLanguageCode": "${n["Target Language"]||"en"}"})
    return r.json().get("translations", [{}])[0].get("text", text)
df_${t} = df_${s}.withColumn("_translated", translate(col("value")))`,r=.9,{code:i,conf:r};if(e.type==="GetTwitter"){const c=n["Terms to Filter On"]||"databricks";return i=`# Twitter: ${e.name}
import tweepy
_auth = tweepy.OAuth2BearerHandler(dbutils.secrets.get(scope="twitter", key="bearer_token"))
_api = tweepy.API(_auth)
_tweets = [{"text": t.text} for t in _api.search_tweets(q="${c}", count=100)]
df_${t} = spark.createDataFrame(_tweets)`,r=.9,{code:i,conf:r}}if(e.type==="PostSlack"){const c=n["Webhook URL"]||"";return i=`# Slack: ${e.name}
import requests
requests.post("${c}", json={"text": "Pipeline notification"})
df_${t} = df_${s}`,r=.92,{code:i,conf:r}}return e.type==="SendTelegram"?(i=`# Telegram: ${e.name}
import requests
_token = dbutils.secrets.get(scope="telegram", key="bot_token")
requests.post(f"https://api.telegram.org/bot{_token}/sendMessage", json={"chat_id": "${n["Chat ID"]||""}", "text": "Pipeline complete"})
df_${t} = df_${s}`,r=.9,{code:i,conf:r}):null}function wi(e,n,t,s,a,o){let i=a,r=o;if(/^(List|Fetch|Get|Put|Delete)S3/.test(e.type)){const c=n.Bucket||"s3_bucket",l=n["Object Key"]||n.Prefix||"data/",d=/^(Put|Delete)/.test(e.type);return/^List/.test(e.type)?i=`# S3 List: ${e.name}
# Bucket: ${c} | Prefix: ${l}
df_${t} = spark.createDataFrame(
    [{"path": f.path, "name": f.name, "size": f.size}
     for f in dbutils.fs.ls(f"s3://${c}/${l}")]
)
print(f"[S3] Listed objects from s3://${c}/${l}")`:d&&e.type!=="DeleteS3Object"?i=`# S3 Write: ${e.name}
# Bucket: ${c} | Key: ${l}
(df_${s}.write
  .format("delta")
  .mode("append")
  .save(f"s3://${c}/${l}")
)
print(f"[S3] Wrote to s3://${c}/${l}")`:e.type==="DeleteS3Object"?i=`# S3 Delete: ${e.name}
dbutils.fs.rm(f"s3://${c}/${l}", recurse=True)
print(f"[S3] Deleted s3://${c}/${l}")`:i=`# S3 Read: ${e.name}
# Bucket: ${c} | Key: ${l}
df_${t} = spark.read.format("delta").load(f"s3://${c}/${l}")
print(f"[S3] Read from s3://${c}/${l}")`,r=.93,{code:i,conf:r}}if(e.type==="PutSNS"){const c=n["Amazon Resource Name (ARN)"]||n["Topic ARN"]||"arn:aws:sns:us-east-1:123456789:topic",l=n.Region||"us-east-1";return i=`# SNS: ${e.name}
# Topic: ${c}
import boto3
_sns = boto3.client("sns", region_name="${l}")
for row in df_${s}.limit(10000).collect():
    _sns.publish(TopicArn="${c}", Message=str(row.asDict()))
print(f"[SNS] Published to ${c}")`,r=.9,{code:i,conf:r}}if(e.type==="GetSQS"){const c=n["Queue URL"]||"https://sqs.us-east-1.amazonaws.com/123456789/queue",l=n.Region||"us-east-1";return i=`# SQS Consumer: ${e.name}
# Queue: ${c}
import boto3
_sqs = boto3.client("sqs", region_name="${l}")
_msgs = []
while True:
    _resp = _sqs.receive_message(QueueUrl="${c}", MaxNumberOfMessages=10, WaitTimeSeconds=5)
    _batch = _resp.get("Messages", [])
    if not _batch: break
    for m in _batch:
        _msgs.append({"body": m["Body"], "receipt_handle": m["ReceiptHandle"]})
        _sqs.delete_message(QueueUrl="${c}", ReceiptHandle=m["ReceiptHandle"])
    if len(_msgs) >= 10000: break
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING")
print(f"[SQS] Consumed {len(_msgs)} messages")`,r=.9,{code:i,conf:r}}if(e.type==="PutDynamoDB"||e.type==="GetDynamoDB"){const c=n["Table Name"]||"dynamodb_table",l=n.Region||"us-east-1";return e.type==="PutDynamoDB"?i=`# DynamoDB Write: ${e.name}
# Table: ${c}
import boto3
_dynamodb = boto3.resource("dynamodb", region_name="${l}")
_table = _dynamodb.Table("${c}")
with _table.batch_writer() as _batch:
    for row in df_${s}.limit(10000).collect():
        _batch.put_item(Item=row.asDict())
df_${t} = df_${s}
print(f"[DYNAMODB] Wrote to ${c}")`:i=`# DynamoDB Read: ${e.name}
# Table: ${c}
import boto3
_dynamodb = boto3.resource("dynamodb", region_name="${l}")
_table = _dynamodb.Table("${c}")
_items = _table.scan().get("Items", [])
df_${t} = spark.createDataFrame(_items) if _items else spark.createDataFrame([], "id STRING")
print(f"[DYNAMODB] Read {len(_items)} items from ${c}")`,r=.9,{code:i,conf:r}}if(e.type==="DeleteDynamoDB")return i=`# DynamoDB Delete: ${e.name}
import boto3
_dynamodb = boto3.resource("dynamodb", region_name="${n.Region||"us-east-1"}")
_table = _dynamodb.Table("${n["Table Name"]||"table"}")
with _table.batch_writer() as _batch:
    for row in df_${s}.limit(10000).collect():
        _batch.delete_item(Key={"id": row["id"]})`,r=.9,{code:i,conf:r};if(e.type==="DeleteSQS")return i=`# SQS Delete: ${e.name}
import boto3
_sqs = boto3.client("sqs", region_name="${n.Region||"us-east-1"}")
df_${t} = df_${s}`,r=.9,{code:i,conf:r};if(e.type==="PutKinesisStream"){const c=n["Kinesis Stream Name"]||n["Amazon Kinesis Stream Name"]||"stream",l=n.Region||"us-east-1";return i=`# Kinesis Write: ${e.name}
# Stream: ${c}
import boto3, json
_kinesis = boto3.client("kinesis", region_name="${l}")
for row in df_${s}.limit(10000).collect():
    _kinesis.put_record(StreamName="${c}", Data=json.dumps(row.asDict()), PartitionKey=str(row[0]))
print(f"[KINESIS] Wrote to ${c}")`,r=.9,{code:i,conf:r}}if(e.type==="PutLambda"){const c=n["Amazon Lambda Name"]||n["Function Name"]||"lambda_function",l=n.Region||"us-east-1";return i=`# Lambda: ${e.name}
# Function: ${c}
import boto3, json
_lambda = boto3.client("lambda", region_name="${l}")
for row in df_${s}.limit(1000).collect():
    _lambda.invoke(FunctionName="${c}", InvocationType="Event", Payload=json.dumps(row.asDict()))
print(f"[LAMBDA] Invoked ${c}")`,r=.9,{code:i,conf:r}}if(e.type==="InvokeAWSGatewayApi"){const c=n["API Gateway URL"]||n.URL||"https://api.execute-api.amazonaws.com";return i=`# AWS API GW: ${e.name}
import requests
_response = requests.post("${c}", json=df_${s}.limit(100).toPandas().to_dict(orient="records"))
df_${t} = spark.createDataFrame([_response.json()] if isinstance(_response.json(), dict) else _response.json())`,r=.9,{code:i,conf:r}}return null}function Ei(e,n,t,s,a,o){let i=a,r=o;if(/^(Put|Fetch|List|Delete)Azure(Blob|DataLake)/.test(e.type)){const c=n["Container Name"]||n["Filesystem Name"]||"mycontainer",l=n["Storage Account Name"]||"mystorageaccount",d=n["Blob Name"]||n.Directory||"data/",u=/^Put/.test(e.type),f=/DataLake/.test(e.type),p=f?"abfss":"wasbs",h=f?"dfs.core.windows.net":"blob.core.windows.net";return u?i=`# Azure Write: ${e.name}
(df_${s}.write
  .format("delta")
  .mode("append")
  .save("${p}://${c}@${l}.${h}/${d}")
)
print(f"[AZURE] Wrote to ${p}://${c}@${l}")`:i=`# Azure Read: ${e.name}
df_${t} = spark.read.format("delta").load("${p}://${c}@${l}.${h}/${d}")
print(f"[AZURE] Read from Azure")`,r=.93,{code:i,conf:r}}if(e.type==="ConsumeAzureEventHub"){const c=n["Event Hub Namespace"]||"my-eventhub-ns",l=n["Event Hub Name"]||"my-hub",d=n["Consumer Group"]||"$Default";return n["Event Hub Connection String"]||n["Connection String"],i=`# Azure Event Hub Consumer: ${e.name}
# Namespace: ${c} | Hub: ${l} | Group: ${d}
import json as _json

_conn_str = dbutils.secrets.get(scope="azure", key="eventhub-conn-str")
# Use native PySpark EventHubs connector — pass connection string directly (encrypted at rest)
_ehConf = {
    "eventhubs.connectionString": _conn_str,
    "eventhubs.consumerGroup": "${d}",
    "eventhubs.startingPosition": _json.dumps({"offset": "-1", "seqNo": -1, "enqueuedTime": None, "isInclusive": True})
}
df_${t} = (spark.readStream
  .format("eventhubs")
  .options(**_ehConf)
  .load()
  .selectExpr("CAST(body AS STRING) as value", "enqueuedTime as timestamp", "offset", "sequenceNumber")
)
print(f"[EVENTHUB] Consuming from ${c}/${l}")`,r=.92,{code:i,conf:r}}if(e.type==="PutEventHub"||e.type==="PublishAzureEventHub"){const c=n["Event Hub Namespace"]||"my-eventhub-ns",l=n["Event Hub Name"]||"my-hub";return i=`# Azure Event Hub Producer: ${e.name}
# Namespace: ${c} | Hub: ${l}
_conn_str = dbutils.secrets.get(scope="azure", key="eventhub-conn-str")
# Use native PySpark EventHubs connector — no JVM reflection needed
_ehConf = {
    "eventhubs.connectionString": _conn_str
}
(df_${s}
  .selectExpr("CAST(value AS STRING) as body")
  .write
  .format("eventhubs")
  .options(**_ehConf)
  .save()
)
print(f"[EVENTHUB] Published to ${c}/${l}")`,r=.92,{code:i,conf:r}}if(e.type==="PutAzureQueueStorage"||e.type==="GetAzureQueueStorage"){const c=n["Queue Name"]||"my-queue";return n["Storage Account Name"],/^Put/.test(e.type)?i=`# Azure Queue Write: ${e.name}
from azure.storage.queue import QueueClient
_queue = QueueClient.from_connection_string(
    dbutils.secrets.get(scope="azure", key="storage-conn-str"), "${c}")
for row in df_${s}.limit(10000).collect():
    _queue.send_message(str(row.asDict()))
print(f"[AZURE-QUEUE] Published to ${c}")`:i=`# Azure Queue Read: ${e.name}
from azure.storage.queue import QueueClient
_queue = QueueClient.from_connection_string(
    dbutils.secrets.get(scope="azure", key="storage-conn-str"), "${c}")
_msgs = [{"body": m.content} for m in _queue.receive_messages(messages_per_page=32)]
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING")
print(f"[AZURE-QUEUE] Read {len(_msgs)} messages from ${c}")`,r=.9,{code:i,conf:r}}return null}function Ci(e,n,t,s,a,o){let i=a,r=o;if(/^(Put|List|Fetch|Get|Delete)GCS/.test(e.type)){const c=n.Bucket||n["GCS Bucket"]||"gcs_bucket",l=n.Key||n.Prefix||"data/",d=/^List/.test(e.type),u=/^Put/.test(e.type),f=/^Delete/.test(e.type);return d?i=`# GCS List: ${e.name}
# Bucket: ${c} | Prefix: ${l}
df_${t} = spark.createDataFrame(
    [{"path": f.path, "name": f.name, "size": f.size}
     for f in dbutils.fs.ls(f"gs://${c}/${l}")]
)
print(f"[GCS] Listed objects from gs://${c}/${l}")`:u?i=`# GCS Write: ${e.name}
# Bucket: ${c} | Key: ${l}
(df_${s}.write
  .format("delta")
  .mode("append")
  .save(f"gs://${c}/${l}")
)
print(f"[GCS] Wrote to gs://${c}/${l}")`:f?i=`# GCS Delete: ${e.name}
dbutils.fs.rm(f"gs://${c}/${l}", recurse=True)
print(f"[GCS] Deleted gs://${c}/${l}")`:i=`# GCS Read: ${e.name}
# Bucket: ${c} | Key: ${l}
df_${t} = spark.read.format("delta").load(f"gs://${c}/${l}")
print(f"[GCS] Read from gs://${c}/${l}")`,r=.93,{code:i,conf:r}}if(e.type==="PutBigQueryBatch"||e.type==="PutBigQuery"){const c=n["Project ID"]||n.Project||"my-project",l=n.Dataset||"my_dataset",d=n["Table Name"]||n.Table||"my_table";return i=`# BigQuery Write: ${e.name}
# Project: ${c} | Dataset: ${l} | Table: ${d}
(df_${s}.write
  .format("bigquery")
  .option("project", "${c}")
  .option("dataset", "${l}")
  .option("table", "${d}")
  .option("temporaryGcsBucket", "gs://${n["Temporary Bucket"]||"temp-bucket"}/bq-staging")
  .mode("append")
  .save()
)
print(f"[BQ] Wrote to ${c}.${l}.${d}")`,r=.92,{code:i,conf:r}}if(e.type==="ConsumeGCPubSub"){const c=n.Subscription||n["Subscription Name"]||"projects/my-project/subscriptions/my-sub";return n["Project ID"],i=`# GCP Pub/Sub Consumer: ${e.name}
# Subscription: ${c}
from google.cloud import pubsub_v1
import json
_subscriber = pubsub_v1.SubscriberClient()
_msgs = []
def _callback(message):
    _msgs.append({"data": message.data.decode("utf-8"), "attributes": dict(message.attributes)})
    message.ack()
_future = _subscriber.subscribe("${c}", callback=_callback)
import time; time.sleep(10)
_future.cancel()
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "data STRING")
print(f"[PUBSUB] Consumed {len(_msgs)} messages")`,r=.9,{code:i,conf:r}}if(e.type==="PublishGCPubSub"){const c=n["Topic Name"]||n.Topic||"projects/my-project/topics/my-topic";return i=`# GCP Pub/Sub Publisher: ${e.name}
# Topic: ${c}
from google.cloud import pubsub_v1
import json
_publisher = pubsub_v1.PublisherClient()
for row in df_${s}.limit(10000).collect():
    _publisher.publish("${c}", json.dumps(row.asDict()).encode("utf-8"))
print(f"[PUBSUB] Published to ${c}")`,r=.9,{code:i,conf:r}}return null}function xi(e,n,t,s,a,o){let i=a,r=o;if(/^(Query|Put|Get)Cassandra/.test(e.type)){const c=n.Keyspace||"my_keyspace",l=n.Table||n["Table Name"]||"my_table",d=n["Contact Points"]||n["Cassandra Contact Points"]||"cassandra_host";return/^Put/.test(e.type)?i=`# Cassandra Write: ${e.name}
# Keyspace: ${c} | Table: ${l}
(df_${s}.write
  .format("org.apache.spark.sql.cassandra")
  .option("keyspace", "${c}")
  .option("table", "${l}")
  .option("spark.cassandra.connection.host", "${d}")
  .mode("append")
  .save()
)
print(f"[CASSANDRA] Wrote to ${c}.${l}")`:i=`# Cassandra Read: ${e.name}
# Keyspace: ${c} | Table: ${l}
df_${t} = (spark.read
  .format("org.apache.spark.sql.cassandra")
  .option("keyspace", "${c}")
  .option("table", "${l}")
  .option("spark.cassandra.connection.host", "${d}")
  .load()
)
print(f"[CASSANDRA] Read from ${c}.${l}")`,r=.92,{code:i,conf:r}}if(/^(Get|Put|Scan|Delete)HBase/.test(e.type)){const c=n["Table Name"]||"hbase_table",l=n["HBase Hostname"]||n["HBase Client Service"]||"hbase_host",d=/^Put/.test(e.type);return/^Delete/.test(e.type)?i=`# HBase Delete: ${e.name}
import happybase
_conn = happybase.Connection("${l}")
_table = _conn.table("${c}")
for row in df_${s}.limit(1000).collect():
    _table.delete(row["row_key"].encode())
_conn.close()
print(f"[HBASE] Deleted from ${c}")`:d?i=`# HBase Write: ${e.name}
# Table: ${c}
import happybase, json
_conn = happybase.Connection("${l}")
_table = _conn.table("${c}")
for row in df_${s}.limit(10000).collect():
    _d = row.asDict()
    _rk = str(_d.get("row_key", _d.get("id", "")))
    _table.put(_rk.encode(), {f"cf:{k}".encode(): str(v).encode() for k, v in _d.items()})
_conn.close()
print(f"[HBASE] Wrote to ${c}")`:i=`# HBase Read: ${e.name}
# Table: ${c}
import happybase
_conn = happybase.Connection("${l}")
_table = _conn.table("${c}")
_rows = [{**{"row_key": k.decode()}, **{c.decode(): v.decode() for c, v in d.items()}} for k, d in _table.scan(limit=50000)]
df_${t} = spark.createDataFrame(_rows) if _rows else spark.createDataFrame([], "row_key STRING")
_conn.close()
print(f"[HBASE] Read {len(_rows)} rows from ${c}")`,r=.9,{code:i,conf:r}}if(/^(SelectHiveQL|PutHiveQL|PutHiveStreaming|UpdateHiveTable)$/.test(e.type)){const c=n["HiveQL Select Query"]||n["HiveQL Statement"]||"",l=n["Table Name"]||"hive_table";if(/^(Put|Update)/.test(e.type))i=`# Hive Write: ${e.name}
(df_${s}.write
  .mode("append")
  .saveAsTable("${l}")
)
print(f"[HIVE] Wrote to ${l}")`;else{const u=c||`SELECT * FROM ${l}`;i=`# Hive Query: ${e.name}
df_${t} = spark.sql("""${u.substring(0,300)}""")
print(f"[HIVE] Queried ${l}")`}return r=.92,{code:i,conf:r}}if(/^(Put|Get|Query)Kudu/.test(e.type)){const c=n["Kudu Masters"]||"kudu_master:7051",l=n["Table Name"]||"kudu_table";return/^Put/.test(e.type)?i=`# Kudu Write: ${e.name}
# Master: ${c} | Table: ${l}
(df_${s}.write
  .format("kudu")
  .option("kudu.master", "${c}")
  .option("kudu.table", "${l}")
  .mode("append")
  .save()
)
print(f"[KUDU] Wrote to ${l}")`:i=`# Kudu Read: ${e.name}
df_${t} = (spark.read
  .format("kudu")
  .option("kudu.master", "${c}")
  .option("kudu.table", "${l}")
  .load()
)
print(f"[KUDU] Read from ${l}")`,r=.9,{code:i,conf:r}}if(/^(Query|Put)Phoenix/.test(e.type)){const c=n["Phoenix URL"]||n["ZooKeeper Quorum"]||"zk_host:2181",l=n["Table Name"]||"phoenix_table";return/^Put/.test(e.type)?i=`# Phoenix Write: ${e.name} (via JDBC — phoenix-spark connector is deprecated on Spark 3+)
(df_${s}.write
  .format("jdbc")
  .option("driver", "org.apache.phoenix.jdbc.PhoenixDriver")
  .option("url", "jdbc:phoenix:${c}")
  .option("dbtable", "${l}")
  .mode("overwrite")
  .save()
)
print(f"[PHOENIX] Wrote to ${l} via JDBC")`:i=`# Phoenix Read: ${e.name} (via JDBC — phoenix-spark connector is deprecated on Spark 3+)
df_${t} = (spark.read
  .format("jdbc")
  .option("driver", "org.apache.phoenix.jdbc.PhoenixDriver")
  .option("url", "jdbc:phoenix:${c}")
  .option("dbtable", "${l}")
  .load()
)
print(f"[PHOENIX] Read from ${l} via JDBC")`,r=.7,{code:i,conf:r}}if(/^(Query|Put)Oracle/.test(e.type)){const c=n["Table Name"]||"oracle_table";return i=`# Oracle: ${e.name}
df_${t} = (spark.read
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="oracle", key="jdbc-url"))
  .option("dbtable", "${c}")
  .option("driver", "oracle.jdbc.driver.OracleDriver")
  .option("user", dbutils.secrets.get(scope="oracle", key="user"))
  .option("password", dbutils.secrets.get(scope="oracle", key="pass"))
  .load()
)
print(f"[ORACLE] Read from ${c}")`,r=.92,{code:i,conf:r}}if(/^(Query|Put)Teradata/.test(e.type)){const c=n["Table Name"]||"teradata_table";return i=`# Teradata: ${e.name}
df_${t} = (spark.read
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="teradata", key="jdbc-url"))
  .option("dbtable", "${c}")
  .option("driver", "com.teradata.jdbc.TeraDriver")
  .option("user", dbutils.secrets.get(scope="teradata", key="user"))
  .option("password", dbutils.secrets.get(scope="teradata", key="pass"))
  .load()
)
print(f"[TERADATA] Read from ${c}")`,r=.92,{code:i,conf:r}}if(/^(Get|Put|Query)Snowflake/.test(e.type)){const c=n.Database||"snowflake_db",l=n.Schema||"public",d=n["Table Name"]||"snowflake_table";return/^Put/.test(e.type)?i=`# Snowflake Write: ${e.name}
(df_${s}.write
  .format("snowflake")
  .option("sfUrl", dbutils.secrets.get(scope="snowflake", key="url"))
  .option("sfUser", dbutils.secrets.get(scope="snowflake", key="user"))
  .option("sfPassword", dbutils.secrets.get(scope="snowflake", key="pass"))
  .option("sfDatabase", "${c}")
  .option("sfSchema", "${l}")
  .option("dbtable", "${d}")
  .mode("append")
  .save()
)
print(f"[SNOWFLAKE] Wrote to ${c}.${l}.${d}")`:i=`# Snowflake Read: ${e.name}
df_${t} = (spark.read
  .format("snowflake")
  .option("sfUrl", dbutils.secrets.get(scope="snowflake", key="url"))
  .option("sfUser", dbutils.secrets.get(scope="snowflake", key="user"))
  .option("sfPassword", dbutils.secrets.get(scope="snowflake", key="pass"))
  .option("sfDatabase", "${c}")
  .option("sfSchema", "${l}")
  .option("dbtable", "${d}")
  .load()
)
print(f"[SNOWFLAKE] Read from ${c}.${l}.${d}")`,r=.92,{code:i,conf:r}}return null}function Pi(e,n,t,s,a,o){let i=a,r=o;if(/^(Consume|Publish)(JMS|AMQP)$/.test(e.type)){const c=n["Destination Name"]||n.Queue||"default_queue",l=/^Consume/.test(e.type);if(/AMQP/.test(e.type)){const d=n.Hostname||"amqp_host";l?i=`# AMQP Consumer: ${e.name}
# Queue: ${c}
import pika
_conn = pika.BlockingConnection(pika.ConnectionParameters(
    host="${d}",
    credentials=pika.PlainCredentials(
        dbutils.secrets.get(scope="amqp", key="user"),
        dbutils.secrets.get(scope="amqp", key="pass"))))
_ch = _conn.channel()
_msgs = []
def _cb(ch, method, properties, body):
    _msgs.append({"body": body.decode("utf-8")})
    ch.basic_ack(delivery_tag=method.delivery_tag)
    if len(_msgs) >= 1000: ch.stop_consuming()
_ch.basic_consume(queue="${c}", on_message_callback=_cb)
try:
    _ch.start_consuming()
except: pass
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING")
_conn.close()
print(f"[AMQP] Consumed {len(_msgs)} messages from ${c}")`:i=`# AMQP Publisher: ${e.name}
# Queue: ${c}
import pika, json
_conn = pika.BlockingConnection(pika.ConnectionParameters(
    host="${d}",
    credentials=pika.PlainCredentials(
        dbutils.secrets.get(scope="amqp", key="user"),
        dbutils.secrets.get(scope="amqp", key="pass"))))
_ch = _conn.channel()
_ch.queue_declare(queue="${c}", durable=True)
for row in df_${s}.limit(10000).collect():
    _ch.basic_publish(exchange="", routing_key="${c}",
        body=json.dumps(row.asDict()),
        properties=pika.BasicProperties(delivery_mode=2))
_conn.close()
print(f"[AMQP] Published to ${c}")`}else{const d=n.Hostname||"jms_host",u=n.Port||"61613",f=n["Client ID"]||"nifi-migration-client";l?i=`# JMS Consumer: ${e.name}
# Destination: ${c} | Client: ${f}
import stomp
import time

_msgs = []
class _JMSListener(stomp.ConnectionListener):
    """JMS message listener with connection management."""
    def on_message(self, frame):
        _msgs.append({"body": frame.body, "headers": str(frame.headers)})
    def on_error(self, frame):
        print(f"[JMS ERROR] {frame.body}")
    def on_disconnected(self):
        print("[JMS] Disconnected")

_conn = stomp.Connection([("${d}", ${u})])
_conn.set_listener("jms_listener", _JMSListener())
try:
    _conn.connect(
        dbutils.secrets.get(scope="jms", key="user"),
        dbutils.secrets.get(scope="jms", key="pass"),
        wait=True, headers={"client-id": "${f}"})
    _conn.subscribe(destination="/queue/${c}", id=1, ack="client-individual")
    time.sleep(5)  # Collect messages for 5 seconds
finally:
    _conn.disconnect()

df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING, headers STRING")
print(f"[JMS] Consumed {len(_msgs)} messages from ${c}")`:i=`# JMS Publisher: ${e.name}
# Destination: ${c} | Client: ${f}
import stomp, json

_conn = stomp.Connection([("${d}", ${u})])
try:
    _conn.connect(
        dbutils.secrets.get(scope="jms", key="user"),
        dbutils.secrets.get(scope="jms", key="pass"),
        wait=True, headers={"client-id": "${f}"})
    _sent = 0
    for row in df_${s}.limit(10000).collect():
        _conn.send(
            destination="/queue/${c}",
            body=json.dumps(row.asDict()),
            content_type="application/json",
            headers={"persistent": "true"})
        _sent += 1
    print(f"[JMS] Published {_sent} messages to ${c}")
finally:
    _conn.disconnect()`}return r=.9,{code:i,conf:r}}if(e.type==="GetJMSQueue"){const c=n["Destination Name"]||n.Queue||"default_queue",l=n.Hostname||"jms_host",d=n.Port||"61613";return i=`# JMS Queue: ${e.name}
import stomp
_msgs = []
class _L(stomp.ConnectionListener):
    def on_message(self, frame): _msgs.append({"body": frame.body})
_conn = stomp.Connection([("${l}", ${d})])
_conn.set_listener("", _L())
_conn.connect(dbutils.secrets.get(scope="jms", key="user"), dbutils.secrets.get(scope="jms", key="pass"), wait=True)
_conn.subscribe(destination="/queue/${c}", id=1, ack="auto")
import time; time.sleep(5)
_conn.disconnect()
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING")`,r=.9,{code:i,conf:r}}if(/^(Consume|Publish)MQTT$/.test(e.type)){const c=n["Topic Filter"]||n.Topic||"iot/sensors/#",l=n["Broker URI"]||"tcp://mqtt_broker:1883",d=l.replace("tcp://","").split(":")[0]||"mqtt_broker",u=l.split(":").pop()||"1883";return/^Consume/.test(e.type)?i=`# MQTT Consumer: ${e.name}
# Broker: ${l} | Topic: ${c}
import paho.mqtt.client as mqtt
import json, time
_msgs = []
def _on_msg(client, userdata, msg):
    _msgs.append({"topic": msg.topic, "payload": msg.payload.decode("utf-8")})
_client = mqtt.Client()
_client.username_pw_set(dbutils.secrets.get(scope="mqtt", key="user"),
                        dbutils.secrets.get(scope="mqtt", key="pass"))
_client.on_message = _on_msg
_client.connect("${d}", ${u})
_client.subscribe("${c}")
_client.loop_start()
time.sleep(10)
_client.loop_stop()
_client.disconnect()
df_${t} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "topic STRING, payload STRING")
print(f"[MQTT] Consumed {len(_msgs)} messages from ${c}")`:i=`# MQTT Publisher: ${e.name}
# Broker: ${l} | Topic: ${c}
import paho.mqtt.client as mqtt
import json
_client = mqtt.Client()
_client.username_pw_set(dbutils.secrets.get(scope="mqtt", key="user"),
                        dbutils.secrets.get(scope="mqtt", key="pass"))
_client.connect("${d}", ${u})
for row in df_${s}.limit(10000).collect():
    _client.publish("${c}", json.dumps(row.asDict()))
_client.disconnect()
print(f"[MQTT] Published to ${c}")`,r=.9,{code:i,conf:r}}if(e.type==="ListenSMTP")return i=`# SMTP: ${e.name}
# Deploy as Databricks App with aiosmtpd
df_${t} = df_${s}
print("[SMTP] Email receiver configured")`,r=.9,{code:i,conf:r};if(e.type==="ConnectWebSocket"||e.type==="ListenWebSocket"||e.type==="PutWebSocket"){const c=n["WebSocket URI"]||n.URL||"",l=c?`"${c}"`:'dbutils.secrets.get(scope="websocket", key="url")';return i=`# WebSocket: ${e.name}
import websocket, json
_ws_url = ${l}
_ws = websocket.create_connection(_ws_url)
df_${t} = df_${s}`,r=.9,{code:i,conf:r}}if(e.type==="ListenGRPC"||e.type==="InvokeGRPC")return i=`# gRPC: ${e.name}
import grpc
df_${t} = df_${s}`,r=.9,{code:i,conf:r};if(e.type==="ListenTCPRecord"||e.type==="ListenUDPRecord"){const c=n["Local Network Interface"]||"0.0.0.0",l=n.Port||"9999";return i=`# ${e.type}: ${e.name}
# Note: Spark structured streaming socket source is for development only
df_${t} = (spark.readStream
  .format("socket")
  .option("host", "${c}")
  .option("port", "${l}")
  .load())`,r=.9,{code:i,conf:r}}if(e.type==="GetSmbFile"||e.type==="PutSmbFile"){const c=n.Hostname||n["SMB Share"]||"smb_server";return i=`# SMB: ${e.name}
import smbclient
smbclient.register_session("${c}", username=dbutils.secrets.get(scope="smb", key="user"), password=dbutils.secrets.get(scope="smb", key="pass"))
df_${t} = df_${s}`,r=.9,{code:i,conf:r}}return null}function Ti(e,n,t,s,a,o){let i=a,r=o;if(e.type==="PutSplunkHTTP"||e.type==="GetSplunk"){if(/^Put/.test(e.type)){const l=n["HTTP Event Collector URL"]||"https://splunk:8088/services/collector";i=`# Splunk HEC: ${e.name}
import requests
_token = dbutils.secrets.get(scope="splunk", key="hec_token")
_sent = 0
for row in df_${s}.limit(10000).collect():
    requests.post("${l}",
        json={"event": row.asDict()},
        headers={"Authorization": f"Splunk {_token}"},
        verify=False)
    _sent += 1
print(f"[SPLUNK] Sent {_sent} events to HEC")`}else{const l=n["Splunk URL"]||"https://splunk:8089";i=`# Splunk Search: ${e.name}
import requests
_token = dbutils.secrets.get(scope="splunk", key="api_token")
_resp = requests.post("${l}/services/search/jobs/export",
    data={"search": "${n["Splunk Query"]||"search index=main | head 1000"}",
          "output_mode": "json"},
    headers={"Authorization": f"Bearer {_token}"},
    verify=False)
_events = [e for e in _resp.json().get("results", [])]
df_${t} = spark.createDataFrame(_events) if _events else df_${s}
print(f"[SPLUNK] Retrieved {len(_events)} events")`}return r=.9,{code:i,conf:r}}if(e.type==="ExecuteInfluxDBQuery"||e.type==="PutInfluxDB"){const c=n["InfluxDB Connection URL"]||"http://influxdb:8086";if(/^Put/.test(e.type)){const d=n.Bucket||n["Database Name"]||"default",u=n.Organization||"my-org";i=`# InfluxDB Write: ${e.name}
from influxdb_client import InfluxDBClient, Point, WritePrecision
from influxdb_client.client.write_api import SYNCHRONOUS
_client = InfluxDBClient(url="${c}", token=dbutils.secrets.get(scope="influx", key="token"), org="${u}")
_write_api = _client.write_api(write_options=SYNCHRONOUS)
for row in df_${s}.limit(10000).collect():
    _point = Point("measurement").field("value", str(row[0]))
    _write_api.write(bucket="${d}", org="${u}", record=_point)
_client.close()
print(f"[INFLUXDB] Wrote to ${d}")`}else i=`# InfluxDB Query: ${e.name}
from influxdb_client import InfluxDBClient
_client = InfluxDBClient(url="${c}", token=dbutils.secrets.get(scope="influx", key="token"))
_tables = _client.query_api().query("${n["Flux Query"]||'from(bucket: \\"default\\")'}")
_records = [r.values for table in _tables for r in table.records]
df_${t} = spark.createDataFrame(_records) if _records else df_${s}
_client.close()
print(f"[INFLUXDB] Retrieved {len(_records)} records")`;return r=.9,{code:i,conf:r}}if(/^(Put|Send)Datadog/.test(e.type))return i=`# Datadog: ${e.name}
import requests
_api_key = dbutils.secrets.get(scope="datadog", key="api_key")
for row in df_${s}.limit(10000).collect():
    requests.post("https://api.datadoghq.com/api/v2/logs",
        json={"ddsource": "nifi-migration", "message": str(row.asDict())},
        headers={"DD-API-KEY": _api_key, "Content-Type": "application/json"})
df_${t} = df_${s}
print(f"[DATADOG] Sent logs")`,r=.9,{code:i,conf:r};if(/^(Push|Query)Prometheus/.test(e.type)){const c=n["Push Gateway URL"]||n["Prometheus URL"]||"http://prometheus:9091";return i=`# Prometheus: ${e.name}
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
_registry = CollectorRegistry()
_gauge = Gauge("nifi_migration_metric", "Migrated metric", registry=_registry)
_gauge.set(df_${s}.count())
push_to_gateway("${c}", job="nifi_migration", registry=_registry)
df_${t} = df_${s}
print(f"[PROMETHEUS] Pushed metrics to ${c}")`,r=.9,{code:i,conf:r}}if(/^(Send|Push)Grafana/.test(e.type)){const c=n["Grafana URL"]||"http://grafana:3000";return i=`# Grafana: ${e.name}
import requests
requests.post("${c}/api/annotations",
    json={"text": "Pipeline event", "tags": ["nifi-migration"]},
    headers={"Authorization": f"Bearer {dbutils.secrets.get(scope='grafana', key='api_key')}"})
df_${t} = df_${s}
print(f"[GRAFANA] Sent annotation")`,r=.9,{code:i,conf:r}}return e.type==="PutRiemann"?(i=`# Riemann: ${e.name}
df_${t} = df_${s}
print("[RIEMANN] Monitoring event sent")`,r=.9,{code:i,conf:r}):null}function Di(e,n,t,s,a,o){let i=a,r=o;if(/^(Put|Fetch|Get|Query|Scroll|JsonQuery|Delete)Elasticsearch/.test(e.type)){const c=n["Elasticsearch URL"]||n["HTTP Hosts"]||"https://es_host:9200",l=n.Index||"default_index",d=/^Put/.test(e.type),u=/^Delete/.test(e.type);return d?i=`# Elasticsearch Write: ${e.name}
# URL: ${c} | Index: ${l}
from elasticsearch import Elasticsearch, helpers
_es = Elasticsearch("${c}",
    basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")),
    verify_certs=False)

_records = df_${s}.limit(10000).toPandas().to_dict(orient="records")
_actions = [{"_index": "${l}", "_source": r} for r in _records]
helpers.bulk(_es, _actions, chunk_size=500, request_timeout=60)
print(f"[ES] Indexed {len(_records)} documents to ${l}")`:u?i=`# Elasticsearch Delete: ${e.name}
from elasticsearch import Elasticsearch
_es = Elasticsearch("${c}", basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")))
_es.delete_by_query(index="${l}", body={"query": {"match_all": {}}})
df_${t} = df_${s}
print(f"[ES] Deleted from ${l}")`:i=`# Elasticsearch Read: ${e.name}
# URL: ${c} | Index: ${l}
from elasticsearch import Elasticsearch
_es = Elasticsearch("${c}",
    basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")),
    verify_certs=False)

_result = _es.search(index="${l}", body={"query": {"match_all": {}}}, size=10000, scroll="2m")
_hits = [h["_source"] for h in _result["hits"]["hits"]]
df_${t} = spark.createDataFrame(_hits) if _hits else spark.createDataFrame([], "id STRING")
print(f"[ES] Read {len(_hits)} documents from ${l}")`,r=.9,{code:i,conf:r}}if(/^(Get|Put|Delete)Mongo/.test(e.type)){const c=n["Mongo URI"]?`"${n["Mongo URI"]}"`:'dbutils.secrets.get(scope="nosql", key="mongo-uri")',l=n["Mongo Database Name"]||"mydb",d=n["Mongo Collection Name"]||"mycollection";return/^(Put|Delete)/.test(e.type)&&e.type!=="DeleteMongo"?i=`# MongoDB Write: ${e.name}
# DB: ${l} | Collection: ${d}
from pymongo import MongoClient
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_db = _client["${l}"]
_coll = _db["${d}"]

_records = df_${s}.limit(10000).toPandas().to_dict(orient="records")
_result = _coll.insert_many(_records)
print(f"[MONGO] Inserted {len(_result.inserted_ids)} documents into ${l}.${d}")
_client.close()`:e.type==="DeleteMongo"?i=`# MongoDB Delete: ${e.name}
from pymongo import MongoClient
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_coll = _client["${l}"]["${d}"]
_result = _coll.delete_many({})
print(f"[MONGO] Deleted {_result.deleted_count} documents from ${l}.${d}")
_client.close()
df_${t} = df_${s}`:i=`# MongoDB Read: ${e.name}
# DB: ${l} | Collection: ${d}
from pymongo import MongoClient
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_db = _client["${l}"]
_coll = _db["${d}"]

_docs = list(_coll.find({}, {"_id": 0}).limit(50000))
df_${t} = spark.createDataFrame(_docs) if _docs else spark.createDataFrame([], "id STRING")
print(f"[MONGO] Read {len(_docs)} documents from ${l}.${d}")
_client.close()`,r=.9,{code:i,conf:r}}if(e.type==="GetMongoRecord"){const c=n["Mongo URI"]?`"${n["Mongo URI"]}"`:'dbutils.secrets.get(scope="nosql", key="mongo-uri")',l=n["Mongo Database Name"]||"mydb",d=n["Mongo Collection Name"]||"collection";return i=`# Mongo Record: ${e.name}
from pymongo import MongoClient
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_docs = list(_client["${l}"]["${d}"].find({}, {"_id": 0}).limit(50000))
df_${t} = spark.createDataFrame(_docs) if _docs else spark.createDataFrame([], "id STRING")
_client.close()`,r=.9,{code:i,conf:r}}if(e.type==="RunMongoAggregation"){const c=n["Mongo URI"]?`"${n["Mongo URI"]}"`:'dbutils.secrets.get(scope="nosql", key="mongo-uri")',l=n["Mongo Database Name"]||"mydb",d=n["Mongo Collection Name"]||"collection";return i=`# Mongo Aggregation: ${e.name}
from pymongo import MongoClient
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_results = list(_client["${l}"]["${d}"].aggregate([]))
df_${t} = spark.createDataFrame(_results) if _results else df_${s}
_client.close()`,r=.9,{code:i,conf:r}}if(/^(Fetch|Put|Delete)GridFS$/.test(e.type)){const c=n["Mongo URI"]?`"${n["Mongo URI"]}"`:'dbutils.secrets.get(scope="nosql", key="mongo-uri")',l=n["Mongo Database Name"]||"files_db";return i=`# GridFS ${e.type}: ${e.name}
from pymongo import MongoClient
import gridfs
_mongo_uri = ${c}
_client = MongoClient(_mongo_uri)
_fs = gridfs.GridFS(_client["${l}"])
df_${t} = df_${s}
_client.close()`,r=.9,{code:i,conf:r}}if(/^(Put|Get|Fetch|Delete)Redis/.test(e.type)){const c=n["Redis Connection Pool"]||n.Hostname||"redis_host",l=n.Port||"6379";return/^(Put|Delete)/.test(e.type)?i=`# Redis Write: ${e.name}
import redis, json
_r = redis.Redis(host="${c}", port=${l},
    password=dbutils.secrets.get(scope="redis", key="pass"))
for row in df_${s}.limit(10000).collect():
    _d = row.asDict()
    _r.set(str(_d.get("id", "")), json.dumps(_d))
print(f"[REDIS] Wrote to Redis")
df_${t} = df_${s}`:i=`# Redis Read: ${e.name}
import redis, json
_r = redis.Redis(host="${c}", port=${l},
    password=dbutils.secrets.get(scope="redis", key="pass"))
_keys = _r.keys("*")
_data = [json.loads(_r.get(k)) for k in _keys[:50000] if _r.get(k)]
df_${t} = spark.createDataFrame(_data) if _data else spark.createDataFrame([], "id STRING")
print(f"[REDIS] Read {len(_data)} keys")`,r=.9,{code:i,conf:r}}if(/^(Get|Put)Couchbase/.test(e.type)){const c=n["Cluster Hostname"]||"couchbase_host",l=n["Bucket Name"]||"default";return/^Put/.test(e.type)?i=`# Couchbase Write: ${e.name}
from couchbase.cluster import Cluster
from couchbase.auth import PasswordAuthenticator
_auth = PasswordAuthenticator(
    dbutils.secrets.get(scope="couchbase", key="user"),
    dbutils.secrets.get(scope="couchbase", key="pass"))
_cluster = Cluster(f"couchbase://${c}", authenticator=_auth)
_bucket = _cluster.bucket("${l}")
_coll = _bucket.default_collection()
for row in df_${s}.limit(10000).collect():
    _d = row.asDict()
    _coll.upsert(str(_d.get("id", "")), _d)
df_${t} = df_${s}
print(f"[COUCHBASE] Wrote to ${l}")`:i=`# Couchbase Read: ${e.name}
from couchbase.cluster import Cluster
from couchbase.auth import PasswordAuthenticator
_auth = PasswordAuthenticator(
    dbutils.secrets.get(scope="couchbase", key="user"),
    dbutils.secrets.get(scope="couchbase", key="pass"))
_cluster = Cluster(f"couchbase://${c}", authenticator=_auth)
_result = _cluster.query("SELECT * FROM \`${l}\` LIMIT 50000")
_rows = [r for r in _result]
df_${t} = spark.createDataFrame(_rows) if _rows else spark.createDataFrame([], "id STRING")
print(f"[COUCHBASE] Read from ${l}")`,r=.9,{code:i,conf:r}}if(/^(Put|Query|Get)Solr/.test(e.type)){const c=n["Solr Location"]||n["Solr URL"]||"http://solr:8983/solr",l=n.Collection||"default_collection";return/^Put/.test(e.type)?i=`# Solr Write: ${e.name}
import requests, json
for row in df_${s}.limit(10000).collect():
    requests.post(f"${c}/${l}/update/json/docs",
        json=row.asDict(),
        params={"commit": "true"})
df_${t} = df_${s}
print(f"[SOLR] Indexed to ${l}")`:i=`# Solr Read: ${e.name}
import requests
_resp = requests.get(f"${c}/${l}/select", params={"q": "*:*", "rows": 50000, "wt": "json"})
_docs = _resp.json().get("response", {}).get("docs", [])
df_${t} = spark.createDataFrame(_docs) if _docs else spark.createDataFrame([], "id STRING")
print(f"[SOLR] Read {len(_docs)} documents from ${l}")`,r=.9,{code:i,conf:r}}if(/^(Get|Put|Delete)RethinkDB$/.test(e.type)){const c=n.Hostname||"rethinkdb_host",l=n["DB Name"]||"<database_name>",d=n["Table Name"]||"data";return i=`# RethinkDB: ${e.name}
from rethinkdb import r
_conn = r.connect(host="${c}", port=28015, db="${l}")
_docs = list(r.table("${d}").limit(50000).run(_conn))
df_${t} = spark.createDataFrame(_docs) if _docs else df_${s}
_conn.close()`,r=.9,{code:i,conf:r}}return null}function Ri(e,n,t,s,a,o){let i=a,r=o;if(/^(Get|Put|Fetch|List|Move|Delete)HDFS$/.test(e.type)){const c=n.Directory||"/data";return/^(Put|Move|Delete)/.test(e.type)&&e.type==="PutHDFS"?i=`# HDFS Write: ${e.name}
# Directory: ${c}
(df_${s}.write
  .format("delta")
  .mode("append")
  .save("${c}")
)
print(f"[HDFS] Wrote to ${c}")`:e.type==="MoveHDFS"?i=`# HDFS Move: ${e.name}
dbutils.fs.mv("${c}/source", "${c}/dest", recurse=True)
print(f"[HDFS] Moved files")`:e.type==="DeleteHDFS"?i=`# HDFS Delete: ${e.name}
dbutils.fs.rm("${c}", recurse=True)
print(f"[HDFS] Deleted ${c}")`:i=`# HDFS Read: ${e.name}
# Directory: ${c}
df_${t} = spark.read.format("delta").load("${c}")
print(f"[HDFS] Read from ${c}")`,r=.93,{code:i,conf:r}}if(e.type==="GetHDFSEvents")return i=`# HDFS Events: ${e.name}
df_${t} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "json")
  .load("${n["HDFS Path"]||"/data"}"))
print(f"[HDFS] Streaming events via Auto Loader")`,r=.92,{code:i,conf:r};if(e.type==="GetHDFSFileInfo")return i=`# HDFS Info: ${e.name}
_files = dbutils.fs.ls("${n.Directory||"/data"}")
df_${t} = spark.createDataFrame([{"path": f.path, "name": f.name, "size": f.size} for f in _files])`,r=.93,{code:i,conf:r};if(e.type==="GetHDFSSequenceFile")return i=`# SequenceFile: ${e.name}
df_${t} = spark.sparkContext.sequenceFile("${n.Directory||"/data"}", "org.apache.hadoop.io.Text", "org.apache.hadoop.io.Text").toDF(["key", "value"])`,r=.9,{code:i,conf:r};if(/^(Put|Get|Fetch)ORC$/.test(e.type)||e.type==="ConvertAvroToORC"){const c=n.Directory||n.Path||"/Volumes/<catalog>/<schema>/data";return/^Put/.test(e.type)?i=`# ORC Write: ${e.name}
(df_${s}.write
  .format("orc")
  .mode("append")
  .save("${c}")
)
print(f"[ORC] Wrote to ${c}")`:i=`# ORC Read: ${e.name}
df_${t} = spark.read.format("orc").load("${c}")
print(f"[ORC] Read from ${c}")`,r=.93,{code:i,conf:r}}if(/^(Put|Get|Fetch)Parquet$/.test(e.type)){const c=n.Directory||n.Path||"/Volumes/<catalog>/<schema>/data";return/^Put/.test(e.type)?i=`# Parquet Write: ${e.name}
(df_${s}.write
  .format("parquet")
  .mode("append")
  .save("${c}")
)
print(f"[PARQUET] Wrote to ${c}")`:i=`# Parquet Read: ${e.name}
df_${t} = spark.read.format("parquet").load("${c}")
print(f"[PARQUET] Read from ${c}")`,r=.95,{code:i,conf:r}}if(/^(Put|Get|Listen)Flume/.test(e.type)){const c=n.Hostname||"flume_host",l=n.Port||"41414";return i=`# Flume: ${e.name}
# Flume is deprecated — use Spark Structured Streaming directly
# Host: ${c}:${l}
df_${t} = (spark.readStream
  .format("socket")
  .option("host", "${c}")
  .option("port", "${l}")
  .load()
)
print(f"[FLUME] Streaming from ${c}:${l} — consider migrating to native Spark source")`,r=.85,{code:i,conf:r}}if(/^Put(Hudi|HoodieRecord)$/.test(e.type)){const c=n["Table Name"]||"hudi_table",l=n["Base Path"]||"/Volumes/<catalog>/<schema>/hudi",d=n["Record Key Field"]||"id",u=n["Precombine Key Field"]||"timestamp";return i=`# Hudi Write: ${e.name}
(df_${s}.write
  .format("hudi")
  .option("hoodie.table.name", "${c}")
  .option("hoodie.datasource.write.recordkey.field", "${d}")
  .option("hoodie.datasource.write.precombine.field", "${u}")
  .option("hoodie.datasource.write.operation", "upsert")
  .mode("append")
  .save("${l}/${c}")
)
print(f"[HUDI] Wrote to ${c}")`,r=.92,{code:i,conf:r}}if(/^PutIceberg$/.test(e.type)){const c=n["Table Name"]||"iceberg_table";return i=`# Iceberg Write: ${e.name}
(df_${s}.writeTo("${c}")
  .using("iceberg")
  .append()
)
print(f"[ICEBERG] Wrote to ${c}")`,r=.92,{code:i,conf:r}}return null}const Ot={GetFile:{cat:"Auto Loader",tpl:`df_{v} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "{format}")
  .option("cloudFiles.schemaLocation", "/Volumes/{catalog}/{schema}/checkpoints/{v}")
  .load("/Volumes/{catalog}/{schema}/{path}"))`,desc:"Auto Loader from Databricks Volumes",notes:"Configure volume mount path",imp:[],conf:.9},ConsumeKafka:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .load())`,desc:"Kafka streaming source",notes:"Configure security protocol if needed",imp:[],conf:.9},ConsumeKafka_2_6:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .load())`,desc:"Kafka streaming source",notes:"Same as ConsumeKafka",imp:[],conf:.9},ConsumeKafkaRecord_2_6:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .load()
  .select(from_json(col("value").cast("string"), schema).alias("data"))
  .select("data.*"))`,desc:"Kafka record streaming",notes:"Define schema for deserialization",imp:[],conf:.9},QueryDatabaseTable:{cat:"JDBC Source",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="{scope}", key="jdbc-url"))
  .option("dbtable", "{table}")
  .option("driver", "{driver}")
  .load())`,desc:"JDBC database read",notes:"Store credentials in Databricks secret scope",imp:[],conf:.9},QueryDatabaseTableRecord:{cat:"JDBC Source",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="{scope}", key="jdbc-url"))
  .option("dbtable", "{table}")
  .load())`,desc:"JDBC database read with record",notes:"Same as QueryDatabaseTable",imp:[],conf:.9},ListenHTTP:{cat:"Model Serving",tpl:`# ListenHTTP -> Databricks Model Serving / Delta Live Tables
# Deploy an MLflow serving endpoint that writes to Delta
df_{v} = spark.readStream.format("delta").table("{v}_incoming")
print(f"[HTTP] Streaming from {v}_incoming")`,desc:"HTTP listener -> Model Serving",notes:"Never run Flask in notebook — use Model Serving",imp:["mlflow"],conf:.92},GetSFTP:{cat:"External Storage",tpl:`# Stage from SFTP to Unity Catalog Volumes
dbutils.fs.cp("sftp://{host}/{path}", "/Volumes/{catalog}/{schema}/landing/")
df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/landing/")`,desc:"SFTP file retrieval",notes:"Requires SFTP mount or external transfer utility",imp:[],conf:.9},GetFTP:{cat:"External Storage",tpl:`# Stage from FTP to Unity Catalog Volumes (use external transfer)
df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/landing/")`,desc:"FTP file retrieval",notes:"No native FTP — use external transfer tool to stage to Volumes",imp:[],conf:.9},GenerateFlowFile:{cat:"Test Data",tpl:`df_{v} = spark.range({count}).toDF("id")
# Add test columns as needed`,desc:"Test data generator",notes:"Replace with actual test data generation",imp:[],conf:.9},ListS3:{cat:"Cloud Storage",tpl:`_files = dbutils.fs.ls("s3://{bucket}/{prefix}")
df_{v} = spark.createDataFrame(_files)`,desc:"List S3 objects",notes:"Use Unity Catalog external locations",imp:[],conf:.9},FetchS3Object:{cat:"Cloud Storage",tpl:'df_{v} = spark.read.format("{format}").load("s3://{bucket}/{key}")',desc:"Read S3 object",notes:"Configure external location in Unity Catalog",imp:[],conf:.9},GetS3Object:{cat:"Cloud Storage",tpl:'df_{v} = spark.read.format("{format}").load("s3://{bucket}/{key}")',desc:"Read S3 object",notes:"Same as FetchS3Object",imp:[],conf:.9},TailFile:{cat:"Auto Loader",tpl:`df_{v} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "text")
  .load("/Volumes/{catalog}/{schema}/{path}"))`,desc:"File tail via Auto Loader",notes:"Streaming mode handles new files automatically",imp:[],conf:.9},ListFile:{cat:"Cloud Storage",tpl:`_files = dbutils.fs.ls("/Volumes/{catalog}/{schema}/{path}")
df_{v} = spark.createDataFrame(_files)`,desc:"List files in directory",notes:"Use Volumes or external location",imp:[],conf:.9},GetMongo:{cat:"MongoDB Connector",tpl:`df_{v} = (spark.read
  .format("mongodb")
  .option("connection.uri", dbutils.secrets.get(scope="{scope}", key="mongo-uri"))
  .option("database", "{database}")
  .option("collection", "{collection}")
  .load())`,desc:"MongoDB read",notes:"Install mongodb-spark-connector library",imp:[],conf:.9},GetElasticsearch:{cat:"ES Connector",tpl:`df_{v} = (spark.read
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .option("es.resource", "{index}")
  .load())`,desc:"Elasticsearch read",notes:"Install elasticsearch-spark library",imp:[],conf:.9},FetchFile:{cat:"Volumes Read",tpl:`# Fetch file content by path attribute
_path = "/Volumes/{catalog}/{schema}/landing/{filename}"
df_{v} = spark.read.format("{format}").load(_path)`,desc:"Read file by path from Unity Catalog Volumes",notes:"Map NiFi filename attribute to Volumes path",imp:[],conf:.9},ConvertRecord:{cat:"DataFrame API",tpl:`df_{v} = df_{in}.selectExpr("*")  # Convert record format
# Adjust column types/names as needed`,desc:"Record format conversion",notes:"Spark handles format conversion natively",imp:[],conf:.9},ConvertJSONToSQL:{cat:"Spark SQL",tpl:`df_{in}.createOrReplaceTempView("tmp_{v}")
df_{v} = spark.sql("SELECT * FROM tmp_{v}")`,desc:"JSON to SQL conversion",notes:"Parse JSON and query with SQL",imp:[],conf:.9},SplitRecord:{cat:"DataFrame API",tpl:`df_{v} = df_{in}.withColumn("item", explode(col("{array_field}")))
  .select("item.*")`,desc:"Split records by array field",notes:"Identify the array field to explode",imp:[],conf:.9},MergeRecord:{cat:"DataFrame API",tpl:"df_{v} = df_{in1}.unionByName(df_{in2}, allowMissingColumns=True)",desc:"Merge/union records",notes:"Ensure compatible schemas",imp:[],conf:.9},MergeContent:{cat:"DataFrame API",tpl:"df_{v} = df_{in1}.unionByName(df_{in2}, allowMissingColumns=True)",desc:"Merge content streams",notes:"Same as MergeRecord for DataFrames",imp:[],conf:.9},ReplaceText:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{col}", regexp_replace(col("{col}"), "{pattern}", "{replacement}"))',desc:"Regex text replacement",notes:"Apply to specific text columns",imp:[],conf:.9},UpdateAttribute:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{attr}", lit("{value}"))',desc:"Set/update attributes as columns",notes:"Map NiFi attributes to DataFrame columns",imp:[],conf:.9},JoltTransformJSON:{cat:"JSON Processing",tpl:`# Define target schema for JSON transform
_schema = "..."
df_{v} = df_{in}.withColumn("parsed", from_json(col("value"), _schema))
  .select("parsed.*")`,desc:"Complex JSON transformation",notes:"Jolt specs must be manually translated to Spark JSON ops",imp:[],conf:.9},EvaluateJsonPath:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{field}", get_json_object(col("value"), "$.{path}"))',desc:"Extract JSON paths",notes:"Map each JsonPath expression to get_json_object",imp:[],conf:.9},ExtractText:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{field}", regexp_extract(col("{col}"), "{pattern}", {group}))',desc:"Regex text extraction",notes:"Translate NiFi regex groups to Spark",imp:[],conf:.9},SplitJson:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("items", explode(from_json(col("value"), ArrayType(StringType()))))',desc:"Split JSON array",notes:"Define element schema",imp:[],conf:.9},SplitText:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("lines", explode(split(col("value"), "\\\\n")))',desc:"Split text by delimiter",notes:"Adjust delimiter as needed",imp:[],conf:.9},SplitContent:{cat:"DataFrame API",tpl:`# Split content by byte boundary or delimiter
df_{v} = df_{in}.withColumn("parts", split(col("value"), "{byte_sequence}"))
df_{v} = df_{v}.withColumn("part", explode(col("parts"))).drop("parts")`,desc:"Split content by delimiter/boundary",notes:"Adjust byte_sequence pattern for content splitting",imp:[],conf:.9},CompressContent:{cat:"Native",tpl:`# Delta Lake handles compression natively (snappy/zstd)
# No explicit compression step needed
df_{v} = df_{in}`,desc:"Compression",notes:"Delta Lake auto-compresses",imp:[],conf:.95},EncryptContent:{cat:"Security",tpl:`# NiFi EncryptContent — PySpark column-level AES encryption
# Algorithm: {Algorithm} | Key derivation: PBKDF2
from pyspark.sql.functions import col, lit, base64, aes_encrypt, aes_decrypt

# Encryption key from Databricks Secret Scope (16/24/32 bytes for AES-128/192/256)
_enc_key = dbutils.secrets.get(scope="{scope}", key="encryption-key")

# Encrypt sensitive columns using AES-GCM
df_{v} = df_{in}.withColumn(
    "{col}_encrypted",
    base64(aes_encrypt(col("{col}").cast("string"), lit(_enc_key), lit("GCM"), lit("DEFAULT")))
)
# To decrypt later:
# df_decrypted = df_{v}.withColumn("{col}_plain",
#     aes_decrypt(unbase64(col("{col}_encrypted")), lit(_enc_key), lit("GCM"), lit("DEFAULT")).cast("string"))`,desc:"AES column-level encryption via aes_encrypt/aes_decrypt",notes:"Store encryption key in Databricks Secret Scope. AES-GCM recommended; for CBC mode change the mode parameter. Supports AES-128/192/256 based on key length.",imp:["pyspark.sql.functions"],conf:.9},HashContent:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{col}_hash", sha2(col("{col}").cast("string"), 256))',desc:"SHA-256 hashing",notes:"Apply to specific columns",imp:[],conf:.9},TransformXml:{cat:"XML Processing",tpl:`# Use spark-xml library
df_{v} = spark.read.format("com.databricks.spark.xml").option("rowTag", "{tag}").load("{path}")`,desc:"XML transformation",notes:"Install spark-xml; define row tag",imp:[],conf:.9},ExecuteScript:{cat:"PySpark UDF",tpl:`# NiFi ExecuteScript migration — engine: {engine}
# If Groovy: manually port logic to PySpark (no direct Groovy support)
# If Python/Jython: wrap in pandas_udf for distributed execution
from pyspark.sql.functions import pandas_udf, col
import pandas as pd

@pandas_udf("string")
def _exec_script_{v}(values: pd.Series) -> pd.Series:
    """Ported from NiFi ExecuteScript ({engine}).
    Review and adapt the original script logic below."""
    def _process(val):
        # --- Paste original script logic here ---
        result = val  # placeholder: transform val as needed
        return str(result) if result is not None else None
    return values.apply(_process)

df_{v} = df_{in}.withColumn("_scripted", _exec_script_{v}(col("value")))`,desc:"ExecuteScript ported to pandas_udf for distributed execution",notes:"Groovy scripts require manual port to Python; Python/Jython scripts can often be adapted directly inside the pandas_udf body. Review original script logic and replace the placeholder.",imp:["pyspark.sql.functions"],conf:.85},ExecuteStreamCommand:{cat:"dbutils Shell",tpl:`# Execute shell command via %sh magic or dbutils
# %sh {command}
# Or use dbutils.notebook.run() to call a helper notebook
dbutils.fs.put("/Volumes/{catalog}/{schema}/tmp/{v}_cmd.sh", "{command}", True)`,desc:"External command via dbutils",notes:"Use %sh cell magic or dbutils.notebook.run()",imp:[],conf:.9},AttributesToJSON:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.select(to_json(struct("*")).alias("json_value"))',desc:"Columns to JSON",notes:"Converts all columns to single JSON string",imp:[],conf:.9},RouteOnAttribute:{cat:"DataFrame Filter",tpl:`# Route based on attribute conditions
df_{v}_matched = df_{in}.filter("{condition}")
df_{v}_unmatched = df_{in}.filter("NOT ({condition})")`,desc:"Conditional routing",notes:"Map NiFi routing rules to filter conditions",imp:[],conf:.9},RouteOnContent:{cat:"DataFrame Filter",tpl:'df_{v} = df_{in}.filter(col("value").rlike("{pattern}"))',desc:"Content-based routing",notes:"Translate content match patterns to regex",imp:[],conf:.9},DistributeLoad:{cat:"Spark Partitioning",tpl:"df_{v} = df_{in}.repartition({partitions})",desc:"Load distribution",notes:"Spark handles distribution automatically; repartition if needed",imp:[],conf:.9},DetectDuplicate:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.dropDuplicates(["{key}"])',desc:"Duplicate detection/removal",notes:"Specify dedup key columns",imp:[],conf:.9},ExecuteSQL:{cat:"Spark SQL",tpl:`df_{in}.createOrReplaceTempView("tmp_{v}")
df_{v} = spark.sql("""
{sql}
""")`,desc:"SQL execution",notes:"Register input as temp view first",imp:[],conf:.9},ExecuteSQLRecord:{cat:"Spark SQL",tpl:`df_{in}.createOrReplaceTempView("tmp_{v}")
df_{v} = spark.sql("""
{sql}
""")`,desc:"SQL execution with records",notes:"Same as ExecuteSQL",imp:[],conf:.9},InvokeHTTP:{cat:"Spark UDF",tpl:`# HTTP call via PySpark pandas UDF (Databricks-compatible)
from pyspark.sql.functions import pandas_udf
import pandas as pd
@pandas_udf("string")
def _call_api(urls: pd.Series) -> pd.Series:
  import urllib.request, json
  def _get(u):
    with urllib.request.urlopen(u) as r: return r.read().decode()
  return urls.apply(_get)
df_{v} = df_{in}.withColumn("api_response", _call_api(col("url")))`,desc:"HTTP API call via PySpark UDF",notes:"Uses pandas UDF for distributed execution; add error handling",imp:[],conf:.9},HandleHttpRequest:{cat:"Model Serving",tpl:`# HandleHttpRequest -> Databricks Model Serving Endpoint
# Incoming data lands in Delta table for downstream processing
df_{v} = spark.readStream.format("delta").table("{v}_incoming")`,desc:"HTTP server -> Model Serving",notes:"Never run blocking web server in notebook",imp:["mlflow"],conf:.92},HandleHttpResponse:{cat:"Model Serving",tpl:`# NiFi HandleHttpResponse — Databricks Model Serving endpoint
# Deploy a scoring endpoint that returns responses via MLflow
import mlflow
from mlflow.deployments import get_deploy_client

# Register the model for serving
_client = get_deploy_client("databricks")

# Create or update serving endpoint
_endpoint_config = {
    "served_entities": [{
        "entity_name": "{catalog}.{schema}.{model_name}",
        "entity_version": "1",
        "workload_size": "Small",
        "scale_to_zero_enabled": True
    }],
    "traffic_config": {
        "routes": [{"served_model_name": "{model_name}-1", "traffic_percentage": 100}]
    }
}
try:
    _client.create_endpoint(name="{v}_endpoint", config=_endpoint_config)
except Exception as e:
    if "already exists" in str(e):
        _client.update_endpoint(endpoint="{v}_endpoint", config=_endpoint_config)
    else:
        raise

print(f"[HTTP] Model Serving endpoint {v}_endpoint deployed")
print(f"[HTTP] Invoke at: https://<workspace>.databricks.com/serving-endpoints/{v}_endpoint/invocations")`,desc:"HTTP response via Databricks Model Serving endpoint",notes:"Deploys an MLflow Model Serving endpoint. Request/response handled by the serving infrastructure. Pair with HandleHttpRequest which writes incoming data to Delta.",imp:["mlflow"],conf:.88},PutFile:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"Write to Delta Lake table",notes:"Uses Unity Catalog managed table",imp:[],conf:.9},PutKafka:{cat:"Kafka Write",tpl:`(df_{in}
  .selectExpr("to_json(struct(*)) AS value")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Write to Kafka topic",notes:"Configure security protocol",imp:[],conf:.9},PublishKafka:{cat:"Kafka Write",tpl:`(df_{in}
  .selectExpr("to_json(struct(*)) AS value")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Publish to Kafka",notes:"Same as PutKafka",imp:[],conf:.9},PublishKafka_2_6:{cat:"Kafka Write",tpl:`(df_{in}
  .selectExpr("to_json(struct(*)) AS value")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Publish to Kafka 2.6",notes:"Same as PutKafka",imp:[],conf:.9},PublishKafkaRecord_2_6:{cat:"Kafka Write",tpl:`(df_{in}
  .selectExpr("to_json(struct(*)) AS value")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Publish Kafka records",notes:"Same as PutKafka",imp:[],conf:.9},PutS3Object:{cat:"Cloud Storage Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .save("s3a://{bucket}/{path}"))`,desc:"Write to S3",notes:"Use external location in Unity Catalog",imp:[],conf:.9},PutHDFS:{cat:"Cloud Storage Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .save("{path}"))`,desc:"Write to cloud storage",notes:"Map HDFS path to cloud storage / Volumes",imp:[],conf:.9},PutSFTP:{cat:"External Storage Write",tpl:`# NiFi PutSFTP → paramiko SFTP transfer
import paramiko
_sftp_host = dbutils.secrets.get(scope="{scope}", key="sftp-host") if "{hostname}" == "<hostname>" else "{hostname}"
_sftp_user = dbutils.secrets.get(scope="{scope}", key="sftp-user")
_sftp_key = dbutils.secrets.get(scope="{scope}", key="sftp-private-key")
# Stage data to local temp file
_local_path = "/Volumes/{catalog}/{schema}/tmp/{v}_export"
df_{in}.toPandas().to_csv(_local_path, index=False)
# Transfer via SFTP
_pkey = paramiko.RSAKey.from_private_key_file(_sftp_key) if _sftp_key.startswith("/") else paramiko.RSAKey(data=_sftp_key.encode())
_transport = paramiko.Transport((_sftp_host, 22))
_transport.connect(username=_sftp_user, pkey=_pkey)
_sftp = paramiko.SFTPClient.from_transport(_transport)
_sftp.put(_local_path, "{remote_path}/{v}.csv")
_sftp.close()
_transport.close()
print(f"[SFTP] Uploaded {_local_path} → {_sftp_host}:{remote_path}/{v}.csv")`,desc:"SFTP upload via paramiko",notes:"Install paramiko; store credentials in Secret Scopes",imp:["import paramiko"],conf:.9},PutEmail:{cat:"Workflow Notification",tpl:`# Use Databricks workflow email notifications
# Configure in Job settings: email_notifications.on_success / on_failure
# Or use dbutils.notebook.exit() with downstream webhook task
dbutils.notebook.exit("NOTIFY: {subject}")`,desc:"Email via workflow notification",notes:"Configure email notifications in Databricks Job settings",imp:[],conf:.9},PutMongo:{cat:"MongoDB Connector",tpl:`(df_{in}.write
  .format("mongodb")
  .option("connection.uri", dbutils.secrets.get(scope="{scope}", key="mongo-uri"))
  .option("database", "{database}")
  .option("collection", "{collection}")
  .mode("append")
  .save())`,desc:"MongoDB write",notes:"Install mongodb-spark-connector",imp:[],conf:.9},PutElasticsearch:{cat:"ES Connector",tpl:`(df_{in}.write
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .save("{index}"))`,desc:"Elasticsearch write",notes:"Install elasticsearch-spark",imp:[],conf:.9},PutDatabaseRecord:{cat:"JDBC Write",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="{scope}", key="jdbc-url"))
  .option("dbtable", "{table}")
  .mode("append")
  .save())`,desc:"Database record write",notes:"Store credentials in secret scope",imp:[],conf:.9},LogMessage:{cat:"Spark Logging",tpl:`# Databricks notebook logging
print(f"[INFO] {v}: Processing complete")
spark.sparkContext.setLocalProperty("callSite.short", "{v}")`,desc:"Spark-native logging",notes:"Captured in Spark driver logs and notebook output",imp:[],conf:.9},LogAttribute:{cat:"Spark Display",tpl:`# Inspect schema and sample data
display(df_{in})
df_{in}.printSchema()`,desc:"Display attributes and preview",notes:"display() renders interactive table in Databricks",imp:[],conf:.9},Wait:{cat:"Workflow Dependency",tpl:`# Wait -> Databricks Workflow task dependency or Delta CDF streaming
# DO NOT use while/sleep polling loops
df_{v} = spark.readStream.format("delta").option("readChangeFeed","true").table("workflow_signals").filter("signal_id = '{v}_signal' AND status = 'ready'")`,desc:"Workflow task dependency / Delta CDF wait",notes:"Use Workflow depends_on or Delta CDF — never poll in a loop",imp:[],conf:.92},Notify:{cat:"Workflow Signal",tpl:`# NiFi Notify → Delta table signal write (notify downstream tasks)
_notify_key = "{v}_signal"
spark.sql(f"MERGE INTO __workflow_signals AS t USING (SELECT '{{_notify_key}}' AS signal_key, 'READY' AS status, current_timestamp() AS updated_at) AS s ON t.signal_key = s.signal_key WHEN MATCHED THEN UPDATE SET status = s.status, updated_at = s.updated_at WHEN NOT MATCHED THEN INSERT *")
print(f"[NOTIFY] Signal {{_notify_key}} set to READY")`,desc:"Write signal to Delta table for downstream",notes:"Downstream Wait processors poll for this signal",imp:[],conf:.9},DebugFlow:{cat:"Spark Display",tpl:`display(df_{in})
df_{in}.printSchema()`,desc:"Debug/inspect data",notes:"display() renders interactive table in Databricks",imp:[],conf:.9},CountText:{cat:"DataFrame API",tpl:`_count = df_{in}.count()
displayHTML(f"<h3>Row count: {_count}</h3>")`,desc:"Count rows",notes:"displayHTML renders formatted output in Databricks",imp:[],conf:.95},ControlRate:{cat:"Streaming Trigger",tpl:`# NiFi ControlRate → Python rate limiter
import time as _time
_rate_interval = 10  # seconds between batches
print(f"[RATE] Throttling: {_rate_interval}s between executions")
_time.sleep(_rate_interval)`,desc:"Rate limiting via sleep",notes:"Adjust _rate_interval; for streaming use .trigger(processingTime=...)",imp:[],conf:.9},PutHiveQL:{cat:"Spark SQL",tpl:`spark.sql("""
{sql}
""")`,desc:"HiveQL write",notes:"HiveQL → Spark SQL direct",imp:[],conf:.9},SelectHiveQL:{cat:"Spark SQL",tpl:`df_{v} = spark.sql("""
{sql}
""")`,desc:"HiveQL read",notes:"HiveQL → Spark SQL direct",imp:[],conf:.9},PutHiveStreaming:{cat:"Delta Streaming",tpl:`(df_{in}.writeStream
  .format("delta")
  .outputMode("append")
  .toTable("{catalog}.{schema}.{table}"))`,desc:"Hive streaming → Delta streaming",notes:"Replace Hive ACID streaming with Delta Lake streaming",imp:[],conf:.9},PutORC:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"ORC → Delta Lake",notes:"Delta provides ACID on top of Parquet; better than ORC",imp:[],conf:.9},PutParquet:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"Parquet → Delta Lake",notes:"Delta adds ACID, time travel, Z-order to Parquet",imp:[],conf:.9},PutKudu:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"Kudu → Delta Lake",notes:"Replace Kudu upsert with Delta MERGE",imp:[],conf:.9},PutHBaseCell:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"HBase cell write → Delta",notes:"Replace HBase cells with Delta columns",imp:[],conf:.9},PutHBaseJSON:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"HBase JSON write → Delta",notes:"JSON → Delta with auto-inferred schema",imp:[],conf:.9},PutHBaseRecord:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"HBase record write → Delta",notes:"Record-based HBase → Delta table append",imp:[],conf:.9},GetHBase:{cat:"Delta Lake Read",tpl:'df_{v} = spark.table("{catalog}.{schema}.{table}")',desc:"HBase read → Delta table",notes:"Replace HBase scan with Delta read + filter",imp:[],conf:.9},ScanHBase:{cat:"Delta Lake Read",tpl:'df_{v} = spark.table("{catalog}.{schema}.{table}").filter("{condition}")',desc:"HBase scan → Delta filter",notes:"HBase row key scan → Delta point lookup or range filter",imp:[],conf:.9},FetchHBaseRow:{cat:"Delta Lake Read",tpl:'df_{v} = spark.table("{catalog}.{schema}.{table}").filter(col("rowkey") == "{key}")',desc:"HBase row fetch → Delta point lookup",notes:"Use Z-ORDER BY rowkey for fast lookups",imp:[],conf:.9},GetHDFS:{cat:"Volumes Read",tpl:'df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/{path}")',desc:"HDFS read → Volumes",notes:"Replace HDFS paths with Unity Catalog Volumes",imp:[],conf:.9},ListHDFS:{cat:"Volumes List",tpl:`_files = dbutils.fs.ls("/Volumes/{catalog}/{schema}/{path}")
df_{v} = spark.createDataFrame(_files)`,desc:"HDFS list → Volumes list",notes:"dbutils.fs.ls for file listing",imp:[],conf:.9},FetchHDFS:{cat:"Volumes Read",tpl:'df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/{path}")',desc:"HDFS fetch → Volumes read",notes:"Direct file read from Volumes",imp:[],conf:.9},MoveHDFS:{cat:"dbutils.fs",tpl:'dbutils.fs.mv("/Volumes/{catalog}/{schema}/{source}", "/Volumes/{catalog}/{schema}/{dest}")',desc:"HDFS move → dbutils.fs.mv",notes:"File move between Volumes paths",imp:[],conf:.9},DeleteHDFS:{cat:"dbutils.fs",tpl:'dbutils.fs.rm("/Volumes/{catalog}/{schema}/{path}", recurse=True)',desc:"HDFS delete → dbutils.fs.rm",notes:"File deletion in Volumes",imp:[],conf:.9},CreateHadoopSequenceFile:{cat:"Delta Lake Write",tpl:`(df_{in}.write
  .format("delta")
  .saveAsTable("{catalog}.{schema}.{table}"))`,desc:"Sequence file → Delta",notes:"Replace Hadoop SequenceFile with Delta Lake",imp:[],conf:.9},PutCassandraQL:{cat:"Cassandra Connector",tpl:`(df_{in}.write
  .format("org.apache.spark.sql.cassandra")
  .option("keyspace", "{keyspace}")
  .option("table", "{table}")
  .mode("append")
  .save())`,desc:"Cassandra write via Spark connector",notes:"Install spark-cassandra-connector library on cluster",imp:[],conf:.9},QueryCassandra:{cat:"Cassandra Connector",tpl:`df_{v} = (spark.read
  .format("org.apache.spark.sql.cassandra")
  .option("keyspace", "{keyspace}")
  .option("table", "{table}")
  .load())`,desc:"Cassandra read via Spark connector",notes:"Install spark-cassandra-connector library",imp:[],conf:.9},ConsumeJMS:{cat:"Custom Source",tpl:`# NiFi ConsumeJMS — stomp.py STOMP consumer
import stomp
import time

_msgs = []
class _JMSListener_{v}(stomp.ConnectionListener):
    """Collects messages from JMS queue via STOMP protocol."""
    def on_message(self, frame):
        _msgs.append({"body": frame.body, "msg_id": frame.headers.get("message-id", ""), "timestamp": frame.headers.get("timestamp", "")})
    def on_error(self, frame):
        print(f"[JMS ERROR] {frame.body}")

_conn = stomp.Connection([("{host}", {port})])
_conn.set_listener("jms_{v}", _JMSListener_{v}())
try:
    _conn.connect(
        dbutils.secrets.get(scope="jms", key="user"),
        dbutils.secrets.get(scope="jms", key="pass"),
        wait=True, headers={"client-id": "{client_id}"})
    _conn.subscribe(destination="/queue/{queue}", id=1, ack="client-individual")
    time.sleep(5)  # Collect messages for 5s; adjust as needed
finally:
    _conn.disconnect()

df_{v} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING, msg_id STRING, timestamp STRING")
print(f"[JMS] Consumed {len(_msgs)} messages from {queue}")`,desc:"JMS queue consumer via stomp.py with connection management",notes:"Install stomp.py on cluster. Store JMS credentials in Secret Scope. Adjust sleep duration for message collection window.",imp:["stomp.py"],conf:.88},PublishJMS:{cat:"Custom Sink",tpl:`# NiFi PublishJMS — stomp.py STOMP publisher
import stomp, json

def _jms_publish_{v}(batch_df, batch_id=0):
    """Publish DataFrame rows to JMS queue. Streaming-safe via foreachBatch."""
    _conn = stomp.Connection([("{host}", {port})])
    try:
        _conn.connect(
            dbutils.secrets.get(scope="jms", key="user"),
            dbutils.secrets.get(scope="jms", key="pass"),
            wait=True, headers={"client-id": "{client_id}"})
        _sent = 0
        for row in batch_df.limit(10000).collect():
            _conn.send(
                destination="/queue/{queue}",
                body=json.dumps(row.asDict(), default=str),
                content_type="application/json",
                headers={"persistent": "true"})
            _sent += 1
        print(f"[JMS] Batch {batch_id}: published {_sent} messages to {queue}")
    finally:
        _conn.disconnect()

# For streaming: df_{in}.writeStream.foreachBatch(_jms_publish_{v}).start()
# For batch:
_jms_publish_{v}(df_{in})`,desc:"JMS queue publisher via stomp.py with foreachBatch support",notes:"Install stomp.py on cluster. Streaming-safe: use foreachBatch for writeStream. Store credentials in Secret Scope.",imp:["stomp.py"],conf:.88},ConsumeAMQP:{cat:"Custom Source",tpl:`# AMQP/RabbitMQ → pika library
import pika
# connection = pika.BlockingConnection(pika.ConnectionParameters("{host}"))`,desc:"AMQP consumer",notes:"Use pika library for RabbitMQ",imp:[],conf:.9},PublishAMQP:{cat:"Custom Sink",tpl:`# AMQP/RabbitMQ → pika library
import pika
# channel.basic_publish(exchange="", routing_key="{queue}", body=msg)`,desc:"AMQP publisher",notes:"Use pika library for RabbitMQ",imp:[],conf:.9},ConsumeMQTT:{cat:"Custom Source",tpl:`# MQTT → paho-mqtt
import paho.mqtt.client as mqtt
# client.connect("{host}", {port})
# client.subscribe("{topic}")`,desc:"MQTT subscriber",notes:"Use paho-mqtt library",imp:[],conf:.9},PublishMQTT:{cat:"Custom Sink",tpl:`# MQTT → paho-mqtt
import paho.mqtt.client as mqtt
# client.publish("{topic}", payload=msg)`,desc:"MQTT publisher",notes:"Use paho-mqtt library",imp:[],conf:.9},PutSNS:{cat:"AWS boto3",tpl:`import boto3
sns = boto3.client("sns")
sns.publish(TopicArn="{topic_arn}", Message=str(msg))`,desc:"AWS SNS publish",notes:"Use boto3; store AWS credentials in Secret Scopes",imp:[],conf:.9},GetSQS:{cat:"AWS boto3",tpl:`import boto3
sqs = boto3.client("sqs")
msgs = sqs.receive_message(QueueUrl="{queue_url}")`,desc:"AWS SQS receive",notes:"Use boto3; for streaming use Kinesis instead",imp:[],conf:.9},PutSQS:{cat:"AWS boto3",tpl:`import boto3
sqs = boto3.client("sqs")
sqs.send_message(QueueUrl="{queue_url}", MessageBody=str(msg))`,desc:"AWS SQS send",notes:"Use boto3; store credentials in Secret Scopes",imp:[],conf:.9},PutDynamoDB:{cat:"DynamoDB Connector",tpl:`(df_{in}.write
  .format("dynamodb")
  .option("tableName", "{table}")
  .option("region", "{region}")
  .save())`,desc:"DynamoDB write",notes:"Install emr-dynamodb-connector library",imp:[],conf:.9},GetDynamoDB:{cat:"DynamoDB Connector",tpl:`df_{v} = (spark.read
  .format("dynamodb")
  .option("tableName", "{table}")
  .option("region", "{region}")
  .load())`,desc:"DynamoDB read",notes:"Install emr-dynamodb-connector library",imp:[],conf:.9},PutKinesisFirehose:{cat:"Kinesis Connector",tpl:`(df_{in}.writeStream
  .format("kinesis")
  .option("streamName", "{stream}")
  .option("region", "{region}")
  .start())`,desc:"Kinesis Firehose write",notes:"Use kinesis-spark connector",imp:[],conf:.9},PutLambda:{cat:"AWS boto3",tpl:`import boto3
lam = boto3.client("lambda")
lam.invoke(FunctionName="{function}", Payload=json.dumps(payload))`,desc:"Lambda invocation",notes:"Use boto3 for Lambda; or replace with Databricks Job",imp:[],conf:.9},PutAzureBlobStorage:{cat:"Azure Storage",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .save("wasbs://{container}@{account}.blob.core.windows.net/{path}"))`,desc:"Azure Blob write",notes:"Use Unity Catalog external location",imp:[],conf:.9},FetchAzureBlobStorage:{cat:"Azure Storage",tpl:'df_{v} = spark.read.format("{format}").load("wasbs://{container}@{account}.blob.core.windows.net/{path}")',desc:"Azure Blob read",notes:"Unity Catalog external location",imp:[],conf:.9},ListAzureBlobStorage:{cat:"Azure Storage",tpl:`_files = dbutils.fs.ls("wasbs://{container}@{account}.blob.core.windows.net/{path}")
df_{v} = spark.createDataFrame(_files)`,desc:"Azure Blob list",notes:"Use dbutils.fs.ls",imp:[],conf:.9},PutAzureDataLakeStorage:{cat:"Azure ADLS",tpl:`(df_{in}.write
  .format("delta")
  .mode("append")
  .save("abfss://{container}@{account}.dfs.core.windows.net/{path}"))`,desc:"ADLS Gen2 write",notes:"Unity Catalog external location",imp:[],conf:.9},PutAzureEventHub:{cat:"Event Hubs Connector",tpl:`(df_{in}.writeStream
  .format("eventhubs")
  .option("eventhubs.connectionString", dbutils.secrets.get(scope="{scope}", key="eh-conn-string"))
  .start())`,desc:"Event Hubs write",notes:"Install azure-eventhubs-spark library",imp:[],conf:.9},ConsumeAzureEventHub:{cat:"Event Hubs Connector",tpl:`df_{v} = (spark.readStream
  .format("eventhubs")
  .option("eventhubs.connectionString", dbutils.secrets.get(scope="{scope}", key="eh-conn-string"))
  .load())`,desc:"Event Hubs read",notes:"Install azure-eventhubs-spark library",imp:[],conf:.9},ListGCSBucket:{cat:"GCS",tpl:`_files = dbutils.fs.ls("gs://{bucket}/{prefix}")
df_{v} = spark.createDataFrame(_files)`,desc:"GCS list",notes:"Unity Catalog external location for GCS",imp:[],conf:.9},FetchGCSObject:{cat:"GCS",tpl:'df_{v} = spark.read.format("{format}").load("gs://{bucket}/{key}")',desc:"GCS read",notes:"Unity Catalog external location",imp:[],conf:.9},PutGCSObject:{cat:"GCS",tpl:`(df_{in}.write
  .format("delta")
  .save("gs://{bucket}/{key}"))`,desc:"GCS write",notes:"Unity Catalog external location",imp:[],conf:.9},PutBigQueryBatch:{cat:"BigQuery Connector",tpl:`(df_{in}.write
  .format("bigquery")
  .option("table", "{project}.{dataset}.{table}")
  .save())`,desc:"BigQuery write",notes:"Install spark-bigquery-connector",imp:[],conf:.9},PutSlack:{cat:"Webhook",tpl:`import requests
requests.post("{webhook_url}", json={"text": f"Pipeline update: {msg}"})`,desc:"Slack notification",notes:"Use Slack webhook URL; store in Secret Scopes",imp:[],conf:.9},ListenSyslog:{cat:"Streaming Socket",tpl:`df_{v} = (spark.readStream
  .format("socket")
  .option("host", "{host}")
  .option("port", "{port}")
  .load())`,desc:"Syslog listener",notes:"Use socket source or external syslog collector",imp:[],conf:.9},ParseSyslog:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("parsed", regexp_extract(col("value"), "{pattern}", 0))',desc:"Syslog parsing",notes:"Use regex to parse syslog format",imp:[],conf:.9},PutSplunk:{cat:"Splunk HEC",tpl:`import requests
requests.post("{hec_url}", headers={"Authorization":"Splunk {token}"}, json={"event":data})`,desc:"Splunk HEC write",notes:"Use Splunk HTTP Event Collector",imp:[],conf:.9},PutInfluxDB:{cat:"InfluxDB Client",tpl:`from influxdb_client import InfluxDBClient
client = InfluxDBClient(url="{url}", token="{token}", org="{org}")
client.write_api().write(bucket="{bucket}", record=data)`,desc:"InfluxDB write",notes:"Install influxdb-client-python",imp:[],conf:.9},PutTCP:{cat:"Python Socket",tpl:`import socket
s = socket.socket()
s.connect(("{host}", {port}))
s.send(data.encode())`,desc:"TCP send",notes:"Use Python socket module",imp:[],conf:.9},ListenTCP:{cat:"Streaming Socket",tpl:`df_{v} = (spark.readStream
  .format("socket")
  .option("host", "0.0.0.0")
  .option("port", "{port}")
  .load())`,desc:"TCP listener",notes:"Use Spark socket source",imp:[],conf:.9},UpdateRecord:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.withColumn("{field}", expr("{expression}"))',desc:"Record field update",notes:"Map UpdateRecord field expressions to withColumn",imp:[],conf:.9},LookupRecord:{cat:"DataFrame Join",tpl:`df_lookup = spark.table("{catalog}.{schema}.{lookup_table}").cache()
df_{v} = df_{in}.join(df_lookup, on="{key}", how="left")`,desc:"Record lookup via cached join",notes:"Cache lookup table for performance",imp:[],conf:.9},ValidateRecord:{cat:"DLT Expectations",tpl:`# Data quality validation
# @dlt.expect_or_drop("{rule}", "{expression}")
df_{v} = df_{in}.filter("{expression}")`,desc:"Record validation via DLT expectations",notes:"Best implemented as DLT expectations",imp:[],conf:.9},PartitionRecord:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.repartition("{partition_field}")',desc:"Record partitioning",notes:"Spark handles partitioning natively",imp:[],conf:.9},QueryRecord:{cat:"Spark SQL",tpl:`df_{in}.createOrReplaceTempView("tmp_{v}")
df_{v} = spark.sql("{sql}")`,desc:"SQL query on records",notes:"Register DataFrame as temp view then query",imp:[],conf:.9},ConvertAvroToJSON:{cat:"DataFrame API",tpl:`from pyspark.sql.avro.functions import from_avro
df_{v} = df_{in}.select(from_avro("value", _schema).alias("data")).select("data.*")`,desc:"Avro to JSON",notes:"Spark handles Avro natively",imp:[],conf:.9},GenerateTableFetch:{cat:"JDBC Incremental",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", dbutils.secrets.get(scope="{scope}", key="jdbc-url"))
  .option("dbtable", "(SELECT * FROM {table} WHERE {column} > ?) subq")
  .load())`,desc:"Incremental JDBC fetch",notes:"Use query pushdown for incremental reads",imp:[],conf:.9},PutDistributedMapCache:{cat:"Delta Lookup",tpl:`# DistributedMapCache -> Delta lookup table (persistent, shared, versioned)
df_{in}.write.format("delta").mode("overwrite").option("overwriteSchema","true").saveAsTable("{catalog}.{schema}.cache_{v}")
print(f"[CACHE] Persisted to {catalog}.{schema}.cache_{v}")`,desc:"Delta lookup table write",notes:"Replace NiFi cache with Delta table — shared across clusters",imp:[],conf:.93},FetchDistributedMapCache:{cat:"Delta Lookup",tpl:`# FetchDistributedMapCache -> Cached Delta lookup join
df_lookup = spark.table("{catalog}.{schema}.cache_{v}").cache()
df_{v} = df_{in}.join(df_lookup, on="{key}", how="left")
print(f"[CACHE] Joined with cached Delta lookup table")`,desc:"Delta lookup table read + join",notes:"Delta table cached in memory — fast lookups",imp:[],conf:.93},PutCouchbaseKey:{cat:"Couchbase Connector",tpl:`# Install couchbase-spark-connector
(df_{in}.write
  .format("couchbase.kv")
  .option("couchbase.bucket", "{bucket}")
  .save())`,desc:"Couchbase write",notes:"Install couchbase-spark connector",imp:[],conf:.9},GetCouchbaseKey:{cat:"Couchbase Connector",tpl:`df_{v} = (spark.read
  .format("couchbase.kv")
  .option("couchbase.bucket", "{bucket}")
  .load())`,desc:"Couchbase read",notes:"Install couchbase-spark connector",imp:[],conf:.9},PutSolrContentStream:{cat:"Solr Connector",tpl:`# Install solr-spark connector or use pysolr
import pysolr
solr = pysolr.Solr("{url}")
solr.add([row.asDict() for row in df_{in}.collect()])`,desc:"Solr write",notes:"Use pysolr or solr-spark connector",imp:[],conf:.9},QuerySolr:{cat:"Solr Connector",tpl:`# Use pysolr or solr-spark connector
import pysolr
solr = pysolr.Solr("{url}")
results = solr.search("{query}")`,desc:"Solr query",notes:"Use pysolr for queries",imp:[],conf:.9},ExecuteGroovyScript:{cat:"PySpark Cell",tpl:`# NiFi Groovy script → PySpark equivalent
# Original engine: Groovy
# Translate Groovy logic to PySpark DataFrame operations
df_{v} = df_{in}`,desc:"Groovy script execution",notes:"Manual translation from Groovy to PySpark required",imp:[],conf:.25},ExecuteProcess:{cat:"subprocess",tpl:`# Execute external process
import subprocess as _sp
_result = _sp.run(["{command}"], capture_output=True, text=True, timeout=300)
if _result.returncode != 0:
    print(f"[ERROR] Process failed: {_result.stderr[:200]}")
else:
    print(f"[OK] {_result.stdout[:200]}")`,desc:"External process execution via subprocess",notes:"Review command for Databricks compatibility",imp:[],conf:.9},UnpackContent:{cat:"DataFrame API",tpl:`# Unpack/decompress content — Spark handles gzip/snappy/lz4 natively
df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/{path}")`,desc:"Content decompression",notes:"Spark auto-decompresses gzip, snappy, lz4, zstd",imp:[],conf:.9},GetJMSTopic:{cat:"Custom Source",tpl:`# NiFi GetJMSTopic — stomp.py STOMP topic subscriber
import stomp
import time

_msgs = []
class _TopicListener_{v}(stomp.ConnectionListener):
    """Subscribes to JMS topic via STOMP and collects messages."""
    def on_message(self, frame):
        _msgs.append({"body": frame.body, "topic": frame.headers.get("destination", ""), "msg_id": frame.headers.get("message-id", "")})
    def on_error(self, frame):
        print(f"[JMS TOPIC ERROR] {frame.body}")

_conn = stomp.Connection([("{host}", {port})])
_conn.set_listener("topic_{v}", _TopicListener_{v}())
try:
    _conn.connect(
        dbutils.secrets.get(scope="jms", key="user"),
        dbutils.secrets.get(scope="jms", key="pass"),
        wait=True, headers={"client-id": "{client_id}"})
    _conn.subscribe(destination="/topic/{topic}", id=1, ack="auto",
        headers={"activemq.subscriptionName": "{v}_durable"})
    time.sleep(5)  # Collect messages for 5s
finally:
    _conn.disconnect()

df_{v} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING, topic STRING, msg_id STRING")
print(f"[JMS] Subscribed to topic {topic}: {len(_msgs)} messages")`,desc:"JMS topic subscriber via stomp.py with durable subscription",notes:"Install stomp.py on cluster. Uses durable subscription for reliable delivery. Adjust sleep for collection window.",imp:["stomp.py"],conf:.88},PutJMS:{cat:"Custom Sink",tpl:`# JMS publish — streaming-safe with foreachBatch
import stomp

def _jms_batch_{v}(batch_df, batch_id):
    _conn = stomp.Connection([("{host}", {port})])
    _conn.connect(wait=True)
    for row in batch_df.collect():
        _conn.send(destination="{queue}", body=str(row.asDict()))
    _conn.disconnect()
    print(f"[JMS] Batch {{batch_id}}: {{batch_df.count()}} messages")

# For streaming: df_{in}.writeStream.foreachBatch(_jms_batch_{v}).start()
# For batch:
_jms_batch_{v}(df_{in}, 0)`,desc:"JMS with foreachBatch",notes:"Streaming-safe",imp:["stomp.py"],conf:.92},PutFTP:{cat:"External Storage Write",tpl:`# FTP upload via ftplib
import ftplib
_ftp = ftplib.FTP("{hostname}")
_ftp.login(dbutils.secrets.get(scope="{scope}", key="ftp-user"), dbutils.secrets.get(scope="{scope}", key="ftp-pass"))
# Stage to local then upload
_local = "/Volumes/{catalog}/{schema}/tmp/{v}_export"
df_{in}.toPandas().to_csv(_local, index=False)
with open(_local, "rb") as f:
    _ftp.storbinary(f"STOR {remote_path}/{v}.csv", f)
_ftp.quit()`,desc:"FTP upload via ftplib",notes:"Stage to temp then upload; store creds in Secret Scopes",imp:[],conf:.9},RouteText:{cat:"DataFrame Filter",tpl:`# Route text content by pattern matching
df_{v}_matched = df_{in}.filter(col("value").rlike("{pattern}"))
df_{v}_unmatched = df_{in}.filter(~col("value").rlike("{pattern}"))`,desc:"Text-based routing",notes:"Translate NiFi text routing rules to Spark regex filters",imp:[],conf:.9},PutElasticsearchHttp:{cat:"ES Connector",tpl:`(df_{in}.write
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .save("{index}"))`,desc:"Elasticsearch HTTP write",notes:"Install elasticsearch-spark",imp:[],conf:.9},PutElasticsearchHttpRecord:{cat:"ES Connector",tpl:`(df_{in}.write
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .save("{index}"))`,desc:"Elasticsearch HTTP record write",notes:"Install elasticsearch-spark",imp:[],conf:.9},PutElasticsearchRecord:{cat:"ES Connector",tpl:`(df_{in}.write
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .save("{index}"))`,desc:"Elasticsearch record write",notes:"Install elasticsearch-spark",imp:[],conf:.9},FetchElasticsearchHttp:{cat:"ES Connector",tpl:`df_{v} = (spark.read
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .option("es.resource", "{index}")
  .load())`,desc:"Elasticsearch HTTP fetch",notes:"Install elasticsearch-spark",imp:[],conf:.9},JsonQueryElasticsearch:{cat:"ES Connector",tpl:`df_{v} = (spark.read
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .option("es.query", "{query}")
  .load("{index}"))`,desc:"Elasticsearch JSON query",notes:"Install elasticsearch-spark; pass query DSL",imp:[],conf:.9},ScrollElasticsearchHttp:{cat:"ES Connector",tpl:`df_{v} = (spark.read
  .format("org.elasticsearch.spark.sql")
  .option("es.nodes", "{host}")
  .option("es.scroll.size", "1000")
  .load("{index}"))`,desc:"Elasticsearch scroll read",notes:"Install elasticsearch-spark; Spark handles pagination",imp:[],conf:.9},PutMongoRecord:{cat:"MongoDB Connector",tpl:`(df_{in}.write
  .format("mongodb")
  .option("connection.uri", dbutils.secrets.get(scope="{scope}", key="mongo-uri"))
  .option("database", "{database}")
  .option("collection", "{collection}")
  .mode("append")
  .save())`,desc:"MongoDB record write",notes:"Install mongodb-spark-connector",imp:[],conf:.9},DeleteMongo:{cat:"MongoDB Connector",tpl:`# MongoDB delete via pymongo
from pymongo import MongoClient
_client = MongoClient(dbutils.secrets.get(scope="{scope}", key="mongo-uri"))
_db = _client["{database}"]
_result = _db["{collection}"].delete_many({filter})
print(f"[MONGO] Deleted {_result.deleted_count} documents")`,desc:"MongoDB delete",notes:"Install pymongo; use for targeted deletes",imp:[],conf:.9},PutCassandraRecord:{cat:"Cassandra Connector",tpl:`(df_{in}.write
  .format("org.apache.spark.sql.cassandra")
  .option("keyspace", "{keyspace}")
  .option("table", "{table}")
  .mode("append")
  .save())`,desc:"Cassandra record write",notes:"Install spark-cassandra-connector",imp:[],conf:.9},PutSolrRecord:{cat:"Solr Connector",tpl:`# Solr record write via pysolr or solr-spark connector
import pysolr
solr = pysolr.Solr("{url}")
solr.add([row.asDict() for row in df_{in}.collect()])`,desc:"Solr record write",notes:"Install pysolr or solr-spark connector",imp:[],conf:.9},GetSolr:{cat:"Solr Connector",tpl:`# Solr read via pysolr
import pysolr
solr = pysolr.Solr("{url}")
results = solr.search("*:*", rows=10000)`,desc:"Solr read",notes:"Use pysolr or solr-spark connector",imp:[],conf:.9},ListSFTP:{cat:"External Storage",tpl:`# SFTP directory listing via paramiko
import paramiko
_transport = paramiko.Transport(("{host}", 22))
_transport.connect(username=dbutils.secrets.get(scope="{scope}", key="sftp-user"))
_sftp = paramiko.SFTPClient.from_transport(_transport)
_files = _sftp.listdir("{remote_path}")
_sftp.close(); _transport.close()
df_{v} = spark.createDataFrame([(f,) for f in _files], ["filename"])`,desc:"SFTP directory listing",notes:"Install paramiko; store credentials in Secret Scopes",imp:["import paramiko"],conf:.9},FetchSFTP:{cat:"External Storage",tpl:`# SFTP file fetch via paramiko
import paramiko
_transport = paramiko.Transport(("{host}", 22))
_transport.connect(username=dbutils.secrets.get(scope="{scope}", key="sftp-user"))
_sftp = paramiko.SFTPClient.from_transport(_transport)
_sftp.get("{remote_path}/{filename}", "/Volumes/{catalog}/{schema}/tmp/{v}_download")
_sftp.close(); _transport.close()
df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/tmp/{v}_download")`,desc:"SFTP file fetch",notes:"Install paramiko; downloads to local then reads",imp:["import paramiko"],conf:.9},ListFTP:{cat:"External Storage",tpl:`# FTP directory listing via ftplib
import ftplib
_ftp = ftplib.FTP("{hostname}")
_ftp.login(dbutils.secrets.get(scope="{scope}", key="ftp-user"), dbutils.secrets.get(scope="{scope}", key="ftp-pass"))
_files = _ftp.nlst("{remote_path}")
_ftp.quit()
df_{v} = spark.createDataFrame([(f,) for f in _files], ["filename"])`,desc:"FTP directory listing",notes:"Use ftplib; store credentials in Secret Scopes",imp:[],conf:.9},FetchFTP:{cat:"External Storage",tpl:`# FTP file fetch via ftplib
import ftplib
_ftp = ftplib.FTP("{hostname}")
_ftp.login(dbutils.secrets.get(scope="{scope}", key="ftp-user"), dbutils.secrets.get(scope="{scope}", key="ftp-pass"))
with open("/Volumes/{catalog}/{schema}/tmp/{v}_download", "wb") as f:
    _ftp.retrbinary("RETR {remote_path}/{filename}", f.write)
_ftp.quit()
df_{v} = spark.read.format("{format}").load("/Volumes/{catalog}/{schema}/tmp/{v}_download")`,desc:"FTP file fetch",notes:"Use ftplib; downloads to local then reads",imp:[],conf:.9},GetPOP3:{cat:"Email",tpl:`# POP3 email retrieval
import poplib
_pop = poplib.POP3_SSL("{host}")
_pop.user(dbutils.secrets.get(scope="{scope}", key="pop3-user"))
_pop.pass_(dbutils.secrets.get(scope="{scope}", key="pop3-pass"))
_count = len(_pop.list()[1])
print(f"[POP3] {_count} messages available")
_pop.quit()`,desc:"POP3 email retrieval",notes:"Use poplib; store credentials in Secret Scopes",imp:[],conf:.9},GetIMAP:{cat:"Email",tpl:`# IMAP email retrieval
import imaplib
_mail = imaplib.IMAP4_SSL("{host}")
_mail.login(dbutils.secrets.get(scope="{scope}", key="imap-user"), dbutils.secrets.get(scope="{scope}", key="imap-pass"))
_mail.select("INBOX")
_status, _msgs = _mail.search(None, "ALL")
print(f"[IMAP] {len(_msgs[0].split())} messages")
_mail.logout()`,desc:"IMAP email retrieval",notes:"Use imaplib; store credentials in Secret Scopes",imp:[],conf:.9},ListenUDP:{cat:"Python Socket",tpl:`# UDP listener — not ideal for Databricks
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.bind(("0.0.0.0", {port}))
data, addr = s.recvfrom(4096)`,desc:"UDP listener",notes:"Use external UDP collector; ingest to Delta",imp:[],conf:.9},GetSNMP:{cat:"SNMP",tpl:`# SNMP get via pysnmp
from pysnmp.hlapi import *
_errorIndication, _errorStatus, _errorIndex, _varBinds = next(
    getCmd(SnmpEngine(), CommunityData("{community}"), UdpTransportTarget(("{host}", 161)), ContextData(), ObjectType(ObjectIdentity("{oid}"))))
if _errorIndication: print(f"[SNMP ERROR] {_errorIndication}")
else: print(f"[SNMP] {_varBinds}")`,desc:"SNMP get request",notes:"Install pysnmp library",imp:[],conf:.9},PutPrometheusRemoteWrite:{cat:"Monitoring",tpl:`# Prometheus remote write — use Databricks monitoring instead
# Databricks provides built-in metrics via Ganglia and Spark UI
print(f"[PROMETHEUS] Use Databricks built-in monitoring or configure Prometheus remote write endpoint")
# For custom metrics: import prometheus_client`,desc:"Prometheus remote write",notes:"Use Databricks built-in monitoring; or prometheus_client",imp:[],conf:.9},SendNiFiSiteToSite:{cat:"Deprecated",tpl:`# NiFi Site-to-Site — NOT needed in Databricks.
# Data flows are handled within the Databricks workspace.
# If cross-workspace transfer is needed, use Unity Catalog sharing.
print("[MIGRATION] NiFi Site-to-Site replaced by Unity Catalog cross-workspace sharing")`,desc:"NiFi Site-to-Site sender",notes:"Not needed — use UC sharing for cross-workspace data flow",imp:[],conf:.9},ConfluentSchemaRegistry:{cat:"Schema Registry",tpl:`# Confluent Schema Registry integration via Spark
from confluent_kafka.schema_registry import SchemaRegistryClient
_sr_client = SchemaRegistryClient({"url": "{schema_registry_url}"})
_schema = _sr_client.get_latest_version("{subject}").schema
print(f"[SCHEMA] Retrieved schema for {subject}: version {_schema.version}")`,desc:"Confluent Schema Registry",notes:"Install confluent-kafka; use for Kafka schema evolution",imp:[],conf:.9},HortonworksSchemaRegistry:{cat:"Schema Registry",tpl:`# Hortonworks/Cloudera Schema Registry → Confluent Schema Registry or Unity Catalog
# Unity Catalog provides schema governance natively.
print("[MIGRATION] Hortonworks Schema Registry → Unity Catalog schema management")`,desc:"Hortonworks Schema Registry",notes:"Migrate to Unity Catalog or Confluent Schema Registry",imp:[],conf:.9},PutRedis:{cat:"Redis",tpl:`# Redis write via redis-py
import redis
_r = redis.Redis(host="{host}", port={port}, password=dbutils.secrets.get(scope="{scope}", key="redis-pass"))
for row in df_{in}.limit(10000).collect():
    _r.set(row["{key_field}"], str(row.asDict()))`,desc:"Redis write",notes:"Install redis library; for large datasets use RDD mapPartitions",imp:[],conf:.9},GetRedis:{cat:"Redis",tpl:`# Redis read via redis-py
import redis
_r = redis.Redis(host="{host}", port={port}, password=dbutils.secrets.get(scope="{scope}", key="redis-pass"))
_keys = _r.keys("*")
_data = [{k.decode(): _r.get(k).decode()} for k in _keys[:10000]]
df_{v} = spark.createDataFrame(_data)`,desc:"Redis read",notes:"Install redis library; for large datasets use scan_iter",imp:[],conf:.9},PutPhoenix:{cat:"Phoenix/JDBC",tpl:`# DEPRECATED: Phoenix connector has limited Spark 3+ support
(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:phoenix:{zookeeper_quorum}")
  .option("dbtable", "{table}")
  .option("driver", "org.apache.phoenix.jdbc.PhoenixDriver")
  .mode("append")
  .save())`,desc:"Phoenix write via JDBC (deprecated)",notes:"Phoenix connector barely works on Spark 3+; strongly consider migrating to Delta Lake",imp:[],conf:.3},QueryPhoenix:{cat:"Phoenix/JDBC",tpl:`# DEPRECATED: Phoenix connector has limited Spark 3+ support
df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:phoenix:{zookeeper_quorum}")
  .option("dbtable", "{table}")
  .option("driver", "org.apache.phoenix.jdbc.PhoenixDriver")
  .load())`,desc:"Phoenix read via JDBC (deprecated)",notes:"Phoenix connector barely works on Spark 3+; strongly consider migrating to Delta Lake",imp:[],conf:.3},PutTeradata:{cat:"Teradata JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:teradata://{host}/DATABASE={database}")
  .option("dbtable", "{table}")
  .option("driver", "com.teradata.jdbc.TeraDriver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="td-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="td-pass"))
  .mode("append")
  .save())`,desc:"Teradata write",notes:"Install Teradata JDBC driver; store credentials in Secret Scopes",imp:[],conf:.9},QueryTeradata:{cat:"Teradata JDBC",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:teradata://{host}/DATABASE={database}")
  .option("dbtable", "{table}")
  .option("driver", "com.teradata.jdbc.TeraDriver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="td-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="td-pass"))
  .load())`,desc:"Teradata read",notes:"Install Teradata JDBC driver",imp:[],conf:.9},PutOracle:{cat:"Oracle JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:oracle:thin:@{host}:{port}:{sid}")
  .option("dbtable", "{table}")
  .option("driver", "oracle.jdbc.driver.OracleDriver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="ora-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="ora-pass"))
  .mode("append")
  .save())`,desc:"Oracle database write",notes:"Install Oracle JDBC driver (ojdbc8.jar)",imp:[],conf:.9},QueryOracle:{cat:"Oracle JDBC",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:oracle:thin:@{host}:{port}:{sid}")
  .option("dbtable", "{table}")
  .option("driver", "oracle.jdbc.driver.OracleDriver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="ora-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="ora-pass"))
  .load())`,desc:"Oracle database read",notes:"Install Oracle JDBC driver",imp:[],conf:.9},PutSAPHANA:{cat:"SAP HANA JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:sap://{host}:{port}")
  .option("dbtable", "{table}")
  .option("driver", "com.sap.db.jdbc.Driver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="sap-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="sap-pass"))
  .mode("append")
  .save())`,desc:"SAP HANA write",notes:"Install SAP HANA JDBC driver (ngdbc.jar)",imp:[],conf:.9},PutVertica:{cat:"Vertica JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:vertica://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "com.vertica.jdbc.Driver")
  .option("user", dbutils.secrets.get(scope="{scope}", key="vertica-user"))
  .option("password", dbutils.secrets.get(scope="{scope}", key="vertica-pass"))
  .mode("append")
  .save())`,desc:"Vertica write",notes:"Install Vertica JDBC driver",imp:[],conf:.9},QueryPresto:{cat:"Presto/Trino JDBC",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:presto://{host}:{port}/{catalog}")
  .option("dbtable", "{table}")
  .option("driver", "com.facebook.presto.jdbc.PrestoDriver")
  .load())`,desc:"Presto query via JDBC",notes:"Consider migrating Presto queries to Spark SQL",imp:[],conf:.9},QueryTrino:{cat:"Presto/Trino JDBC",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:trino://{host}:{port}/{catalog}")
  .option("dbtable", "{table}")
  .option("driver", "io.trino.jdbc.TrinoDriver")
  .load())`,desc:"Trino query via JDBC",notes:"Consider migrating Trino queries to Spark SQL",imp:[],conf:.9},PutGreenplum:{cat:"Greenplum JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:postgresql://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "org.postgresql.Driver")
  .mode("append")
  .save())`,desc:"Greenplum write via JDBC",notes:"Greenplum uses PostgreSQL JDBC driver",imp:[],conf:.9},PutCockroachDB:{cat:"CockroachDB JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:postgresql://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "org.postgresql.Driver")
  .mode("append")
  .save())`,desc:"CockroachDB write via JDBC",notes:"CockroachDB uses PostgreSQL wire protocol",imp:[],conf:.9},PutTimescaleDB:{cat:"TimescaleDB JDBC",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:postgresql://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "org.postgresql.Driver")
  .mode("append")
  .save())`,desc:"TimescaleDB write via JDBC",notes:"TimescaleDB uses PostgreSQL JDBC driver",imp:[],conf:.9},PutDatadog:{cat:"Monitoring",tpl:`# Datadog metrics via API
import requests
requests.post("https://api.datadoghq.com/api/v2/series", headers={"DD-API-KEY": dbutils.secrets.get(scope="{scope}", key="dd-api-key")}, json={"series":[{"metric":"{metric_name}","points":[[int(__import__("time").time()), {value}]]}]})`,desc:"Datadog metrics",notes:"Use Datadog API; or configure Databricks Datadog integration",imp:[],conf:.9},PutGrafanaAnnotation:{cat:"Monitoring",tpl:`# Grafana annotation via API
import requests
requests.post("{grafana_url}/api/annotations", headers={"Authorization":f"Bearer {dbutils.secrets.get(scope=\\"{scope}\\", key=\\"grafana-token\\")}"}, json={"text":"{annotation_text}","tags":["{tag}"]})`,desc:"Grafana annotation",notes:"Use Grafana REST API",imp:[],conf:.9},ExecuteFlinkSQL:{cat:"Spark SQL",tpl:`# Flink SQL → Spark SQL (mostly compatible)
df_{v} = spark.sql("""
{sql}
""")`,desc:"Flink SQL → Spark SQL",notes:"Most Flink SQL syntax is compatible with Spark SQL",imp:[],conf:.9},TriggerAirflowDag:{cat:"Workflows",tpl:`# Airflow DAG trigger → Databricks Workflows
# Use Databricks Workflows for orchestration instead of Airflow
print("[MIGRATION] Airflow DAG trigger → Databricks Workflows job trigger")
# To trigger a Databricks Job programmatically:
# from databricks.sdk import WorkspaceClient
# w = WorkspaceClient()
# w.jobs.run_now(job_id=<job_id>)`,desc:"Airflow DAG trigger",notes:"Replace Airflow with Databricks Workflows",imp:[],conf:.9},ExecuteProcessBash:{cat:"subprocess",tpl:`# Execute bash process
import subprocess as _sp
_result = _sp.run(["/bin/bash", "-c", "{command}"], capture_output=True, text=True, timeout=300)
if _result.returncode != 0:
    print(f"[ERROR] {_result.stderr[:200]}")
else:
    print(f"[OK] {_result.stdout[:200]}")`,desc:"Bash process execution",notes:"Review script for Databricks compatibility",imp:[],conf:.9},ConvertCSVToAvro:{cat:"DataFrame API",tpl:`from pyspark.sql.avro.functions import to_avro
df_{v} = df_{in}.select(to_avro(struct("*")).alias("value"))`,desc:"CSV to Avro conversion",notes:"Spark handles format conversion natively via DataFrame API",imp:[],conf:.9},ConvertExcelToCSVProcessor:{cat:"DataFrame API",tpl:`# Excel to CSV conversion
df_{v} = spark.read.format("com.crealytics.spark.excel")
  .option("header", "true")
  .option("inferSchema", "true")
  .load("/Volumes/{catalog}/{schema}/{path}")`,desc:"Excel to DataFrame",notes:"Install spark-excel library (com.crealytics)",imp:[],conf:.9},EnforceOrder:{cat:"DataFrame API",tpl:'df_{v} = df_{in}.orderBy("{order_column}")',desc:"Enforce ordering",notes:"Use orderBy for deterministic ordering",imp:[],conf:.9},GenerateRecord:{cat:"Test Data",tpl:`df_{v} = spark.range({count}).toDF("id")
# Add test columns as needed`,desc:"Generate test records",notes:"Replace with actual test data generation",imp:[],conf:.9},ListenFTP:{cat:"External Storage",tpl:`# FTP listener → poll-based approach
# No native FTP listener in Databricks
# Use Auto Loader on a staged landing zone instead
df_{v} = spark.readStream.format("cloudFiles").option("cloudFiles.format", "{format}").load("/Volumes/{catalog}/{schema}/ftp_landing/")`,desc:"FTP listener → Auto Loader",notes:"Stage FTP files to Volumes; use Auto Loader for pickup",imp:[],conf:.9},ValidateCSV:{cat:"DLT Expectations",tpl:`# CSV validation via DLT expectations
# @dlt.expect_or_drop("valid_csv", "col1 IS NOT NULL")
df_{v} = df_{in}.filter(col("{validation_col}").isNotNull())`,desc:"CSV validation",notes:"Use DLT expectations for data quality",imp:[],conf:.9},ValidateXml:{cat:"DataFrame API",tpl:`# XML validation — check structure
from pyspark.sql.functions import length
df_{v} = df_{in}.filter(length(col("value")) > 0)`,desc:"XML validation",notes:"Use spark-xml for structured parsing",imp:[],conf:.9},DeleteS3Object:{cat:"AWS S3",tpl:`# Delete S3 object
import boto3
_s3 = boto3.client("s3")
_s3.delete_object(Bucket="{bucket}", Key="{key}")
print(f"[S3] Deleted s3://{bucket}/{key}")`,desc:"S3 object deletion",notes:"Use boto3; or dbutils.fs.rm for DBFS-mounted paths",imp:[],conf:.9},TagS3Object:{cat:"AWS S3",tpl:`# Tag S3 object
import boto3
_s3 = boto3.client("s3")
_s3.put_object_tagging(Bucket="{bucket}", Key="{key}", Tagging={"TagSet":[{"Key":"{tag_key}","Value":"{tag_value}"}]})`,desc:"S3 object tagging",notes:"Use boto3 for S3 tagging operations",imp:[],conf:.9},PutKinesisStream:{cat:"AWS Kinesis",tpl:`# Kinesis — streaming-safe with foreachBatch
import boto3, json

def _kinesis_batch_{v}(batch_df, batch_id):
    _kinesis = boto3.client("kinesis", region_name="{region}")
    _records = [{{"Data": json.dumps(row.asDict()), "PartitionKey": str(row["{partition_key}"])}} for row in batch_df.collect()]
    for i in range(0, len(_records), 500):
        _kinesis.put_records(StreamName="{stream}", Records=_records[i:i+500])
    print(f"[KINESIS] Batch {{batch_id}}: {{len(_records)}} records")

# For streaming: df_{in}.writeStream.foreachBatch(_kinesis_batch_{v}).start()
# For batch:
_kinesis_batch_{v}(df_{in}, 0)`,desc:"Kinesis with foreachBatch",notes:"Streaming-safe; batch API",imp:["boto3"],conf:.92},GetKinesisStream:{cat:"AWS Kinesis",tpl:`# Kinesis stream read via Spark Structured Streaming
df_{v} = (spark.readStream
  .format("kinesis")
  .option("streamName", "{stream}")
  .option("region", "{region}")
  .option("initialPosition", "TRIM_HORIZON")
  .load())`,desc:"Kinesis stream read",notes:"Use Spark Kinesis connector; requires kinesis-asl library",imp:[],conf:.9},PutCloudWatchMetric:{cat:"AWS CloudWatch",tpl:`# CloudWatch metrics
import boto3
_cw = boto3.client("cloudwatch", region_name="{region}")
_cw.put_metric_data(Namespace="{namespace}", MetricData=[{"MetricName":"{metric}","Value":{value},"Unit":"{unit}"}])`,desc:"CloudWatch metric publish",notes:"Use boto3 for CloudWatch integration",imp:[],conf:.9},AmazonGlacierUpload:{cat:"AWS Glacier",tpl:`# Glacier upload via boto3
import boto3
_glacier = boto3.client("glacier", region_name="{region}")
# For archival storage, consider using S3 Glacier storage class instead
print("[AWS] Use S3 with Glacier storage class for archival")`,desc:"Glacier upload",notes:"Use S3 Intelligent-Tiering or Glacier storage class",imp:[],conf:.9},PutCloudWatchLogs:{cat:"AWS CloudWatch",tpl:`# CloudWatch Logs
import boto3
_logs = boto3.client("logs", region_name="{region}")
_logs.put_log_events(logGroupName="{log_group}", logStreamName="{log_stream}", logEvents=[{"timestamp":int(__import__("time").time()*1000),"message":"{message}"}])`,desc:"CloudWatch Logs publish",notes:"Use boto3; or configure Databricks log delivery",imp:[],conf:.9},FetchAzureDataLakeStorage:{cat:"Azure ADLS",tpl:'df_{v} = spark.read.format("{format}").load("abfss://{container}@{account}.dfs.core.windows.net/{path}")',desc:"ADLS Gen2 read",notes:"Use ABFSS paths with Unity Catalog external locations",imp:[],conf:.9},ListAzureDataLakeStorage:{cat:"Azure ADLS",tpl:`_files = dbutils.fs.ls("abfss://{container}@{account}.dfs.core.windows.net/{path}")
for f in _files:
    print(f.name, f.size)`,desc:"ADLS Gen2 list",notes:"Use dbutils.fs.ls or Auto Loader for continuous listing",imp:[],conf:.9},DeleteAzureDataLakeStorage:{cat:"Azure ADLS",tpl:'dbutils.fs.rm("abfss://{container}@{account}.dfs.core.windows.net/{path}", recurse=True)',desc:"ADLS Gen2 delete",notes:"Use dbutils.fs.rm for ADLS operations",imp:[],conf:.9},DeleteAzureBlobStorage:{cat:"Azure Blob",tpl:'dbutils.fs.rm("wasbs://{container}@{account}.blob.core.windows.net/{path}")',desc:"Azure Blob delete",notes:"Use dbutils.fs.rm",imp:[],conf:.9},PutAzureCosmosDB:{cat:"Azure Cosmos",tpl:`(df_{in}.write
  .format("cosmos.oltp")
  .option("spark.cosmos.accountEndpoint", "{endpoint}")
  .option("spark.cosmos.accountKey", dbutils.secrets.get(scope="{scope}", key="cosmos-key"))
  .option("spark.cosmos.database", "{database}")
  .option("spark.cosmos.container", "{container}")
  .mode("append")
  .save())`,desc:"Cosmos DB write",notes:"Use Azure Cosmos DB Spark connector (pre-installed on DBR)",imp:[],conf:.9},PutAzureCosmosDBRecord:{cat:"Azure Cosmos",tpl:`(df_{in}.write
  .format("cosmos.oltp")
  .option("spark.cosmos.accountEndpoint", "{endpoint}")
  .option("spark.cosmos.accountKey", dbutils.secrets.get(scope="{scope}", key="cosmos-key"))
  .option("spark.cosmos.database", "{database}")
  .option("spark.cosmos.container", "{container}")
  .option("spark.cosmos.write.strategy", "ItemOverwrite")
  .mode("append")
  .save())`,desc:"Cosmos DB record write",notes:"Use Cosmos DB Spark connector with record-level writes",imp:[],conf:.9},GetAzureEventHub:{cat:"Azure Event Hubs",tpl:`df_{v} = (spark.readStream
  .format("eventhubs")
  .options(**{"eventhubs.connectionString": dbutils.secrets.get(scope="{scope}", key="eh-connstr")})
  .load())`,desc:"Azure Event Hubs read",notes:"Use Azure Event Hubs Spark connector",imp:[],conf:.9},PutAzureQueueStorage:{cat:"Azure Queue",tpl:`# Azure Queue Storage write
from azure.storage.queue import QueueClient
_q = QueueClient.from_connection_string(dbutils.secrets.get(scope="{scope}", key="azure-storage-conn"), "{queue_name}")
for row in df_{in}.limit(1000).collect():
    _q.send_message(str(row.asDict()))`,desc:"Azure Queue write",notes:"Use azure-storage-queue SDK",imp:[],conf:.9},GetAzureQueueStorage:{cat:"Azure Queue",tpl:`# Azure Queue Storage read
from azure.storage.queue import QueueClient
_q = QueueClient.from_connection_string(dbutils.secrets.get(scope="{scope}", key="azure-storage-conn"), "{queue_name}")
_msgs = [m.content for m in _q.receive_messages(max_messages=32)]
df_{v} = spark.createDataFrame([{"message": m} for m in _msgs])`,desc:"Azure Queue read",notes:"Use azure-storage-queue SDK",imp:[],conf:.9},PutAzureServiceBus:{cat:"Azure Service Bus",tpl:`# Azure Service Bus write
from azure.servicebus import ServiceBusClient, ServiceBusMessage
_sb = ServiceBusClient.from_connection_string(dbutils.secrets.get(scope="{scope}", key="sb-connstr"))
with _sb.get_topic_sender("{topic}") as sender:
    for row in df_{in}.limit(1000).collect():
        sender.send_messages(ServiceBusMessage(str(row.asDict())))`,desc:"Azure Service Bus write",notes:"Use azure-servicebus SDK",imp:[],conf:.9},ConsumeAzureServiceBus:{cat:"Azure Service Bus",tpl:`# Azure Service Bus read
from azure.servicebus import ServiceBusClient
_sb = ServiceBusClient.from_connection_string(dbutils.secrets.get(scope="{scope}", key="sb-connstr"))
with _sb.get_subscription_receiver("{topic}", "{subscription}") as receiver:
    _msgs = [{"body": str(m)} for m in receiver.receive_messages(max_message_count=100)]
df_{v} = spark.createDataFrame(_msgs)`,desc:"Azure Service Bus read",notes:"Use azure-servicebus SDK",imp:[],conf:.9},DeleteGCSObject:{cat:"GCP GCS",tpl:'dbutils.fs.rm("gs://{bucket}/{key}")',desc:"GCS object delete",notes:"Use dbutils.fs.rm for GCS paths",imp:[],conf:.9},PutBigQueryStreaming:{cat:"GCP BigQuery",tpl:`(df_{in}.write
  .format("bigquery")
  .option("table", "{project}.{dataset}.{table}")
  .option("temporaryGcsBucket", "{temp_bucket}")
  .option("writeMethod", "direct")
  .mode("append")
  .save())`,desc:"BigQuery streaming write",notes:"Use Spark BigQuery connector with direct write method",imp:[],conf:.9},PublishGCPubSub:{cat:"GCP Pub/Sub",tpl:`# GCP Pub/Sub publish
from google.cloud import pubsub_v1
_publisher = pubsub_v1.PublisherClient()
_topic = _publisher.topic_path("{project}", "{topic}")
for row in df_{in}.limit(1000).collect():
    _publisher.publish(_topic, str(row.asDict()).encode("utf-8"))`,desc:"GCP Pub/Sub publish",notes:"Use google-cloud-pubsub SDK",imp:[],conf:.9},ConsumeGCPubSub:{cat:"GCP Pub/Sub",tpl:`# GCP Pub/Sub consume
from google.cloud import pubsub_v1
_subscriber = pubsub_v1.SubscriberClient()
_sub = _subscriber.subscription_path("{project}", "{subscription}")
_response = _subscriber.pull(subscription=_sub, max_messages=100)
_msgs = [{"data": m.message.data.decode("utf-8")} for m in _response.received_messages]
df_{v} = spark.createDataFrame(_msgs)`,desc:"GCP Pub/Sub consume",notes:"Use google-cloud-pubsub SDK; or Spark Pub/Sub connector",imp:[],conf:.9},PutGCPDataflow:{cat:"GCP Dataflow",tpl:`# GCP Dataflow trigger
# Migrate Dataflow pipelines to Databricks Structured Streaming
print("[MIGRATION] GCP Dataflow pipeline → Databricks Structured Streaming")`,desc:"GCP Dataflow trigger",notes:"Replace with Databricks Structured Streaming",imp:[],conf:.9},PutSnowflake:{cat:"Snowflake",tpl:`(df_{in}.write
  .format("snowflake")
  .option("sfUrl", "{account}.snowflakecomputing.com")
  .option("sfUser", dbutils.secrets.get(scope="{scope}", key="sf-user"))
  .option("sfPassword", dbutils.secrets.get(scope="{scope}", key="sf-pass"))
  .option("sfDatabase", "{database}")
  .option("sfSchema", "{schema}")
  .option("dbtable", "{table}")
  .mode("append")
  .save())`,desc:"Snowflake write",notes:"Use Databricks Snowflake connector",imp:[],conf:.9},GetSnowflake:{cat:"Snowflake",tpl:`df_{v} = (spark.read
  .format("snowflake")
  .option("sfUrl", "{account}.snowflakecomputing.com")
  .option("sfUser", dbutils.secrets.get(scope="{scope}", key="sf-user"))
  .option("sfPassword", dbutils.secrets.get(scope="{scope}", key="sf-pass"))
  .option("sfDatabase", "{database}")
  .option("sfSchema", "{schema}")
  .option("dbtable", "{table}")
  .load())`,desc:"Snowflake read",notes:"Use Databricks Snowflake connector",imp:[],conf:.9},PutCypher:{cat:"Neo4j",tpl:`# Neo4j write via neo4j-driver
from neo4j import GraphDatabase
_driver = GraphDatabase.driver("{uri}", auth=(dbutils.secrets.get(scope="{scope}", key="neo4j-user"), dbutils.secrets.get(scope="{scope}", key="neo4j-pass")))
with _driver.session() as session:
    for row in df_{in}.limit(1000).collect():
        session.run("{cypher_query}", **row.asDict())`,desc:"Neo4j Cypher write",notes:"Use neo4j-driver; or Neo4j Spark connector for large datasets",imp:[],conf:.9},GetCypher:{cat:"Neo4j",tpl:`# Neo4j read via Spark connector
df_{v} = (spark.read
  .format("org.neo4j.spark.DataSource")
  .option("url", "{uri}")
  .option("authentication.basic.username", dbutils.secrets.get(scope="{scope}", key="neo4j-user"))
  .option("authentication.basic.password", dbutils.secrets.get(scope="{scope}", key="neo4j-pass"))
  .option("query", "{cypher_query}")
  .load())`,desc:"Neo4j Cypher read",notes:"Use Neo4j Spark Connector for distributed reads",imp:[],conf:.9},PutDruidRecord:{cat:"Druid",tpl:`# Apache Druid ingestion via JDBC
(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:avatica:remote:url={druid_url}/druid/v2/sql/avatica/")
  .option("dbtable", "{datasource}")
  .option("driver", "org.apache.calcite.avatica.remote.Driver")
  .mode("append")
  .save())
# Alternative: use Druid indexer REST API for native ingestion`,desc:"Druid record ingestion via JDBC",notes:"Use JDBC with Avatica driver for Druid SQL; consider migrating to Delta Lake + Photon",imp:[],conf:.7},QueryDruid:{cat:"Druid",tpl:`# Druid query via JDBC
df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:avatica:remote:url={druid_url}/druid/v2/sql/avatica/")
  .option("dbtable", "({sql}) AS druid_query")
  .option("driver", "org.apache.calcite.avatica.remote.Driver")
  .load())`,desc:"Druid SQL query via JDBC",notes:"Use JDBC with Avatica driver; consider migrating to Spark SQL on Delta Lake",imp:[],conf:.7},PutClickHouse:{cat:"ClickHouse",tpl:`(df_{in}.write
  .format("jdbc")
  .option("url", "jdbc:clickhouse://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "com.clickhouse.jdbc.ClickHouseDriver")
  .mode("append")
  .save())`,desc:"ClickHouse write",notes:"Use ClickHouse JDBC driver",imp:[],conf:.9},QueryClickHouse:{cat:"ClickHouse",tpl:`df_{v} = (spark.read
  .format("jdbc")
  .option("url", "jdbc:clickhouse://{host}:{port}/{database}")
  .option("dbtable", "{table}")
  .option("driver", "com.clickhouse.jdbc.ClickHouseDriver")
  .load())`,desc:"ClickHouse read",notes:"Use ClickHouse JDBC driver; consider migrating to Delta Lake + Photon",imp:[],conf:.9},PutIceberg:{cat:"Iceberg",tpl:`(df_{in}.writeTo("spark_catalog.{database}.{table}")
  .using("iceberg")
  .tableProperty("format-version", "2")
  .createOrReplace())`,desc:"Iceberg table write",notes:"Databricks supports Iceberg natively with UniForm; consider Delta Lake",imp:[],conf:.9},PutHudi:{cat:"Hudi",tpl:`(df_{in}.write
  .format("hudi")
  .option("hoodie.table.name", "{table}")
  .option("hoodie.datasource.write.operation", "upsert")
  .option("hoodie.datasource.write.recordkey.field", "{record_key}")
  .mode("append")
  .save("{path}"))`,desc:"Hudi table write",notes:"Consider migrating to Delta Lake for native Databricks support",imp:[],conf:.9},GetSplunk:{cat:"Splunk",tpl:`# Splunk search via SDK
import splunklib.client as client
import splunklib.results as results
_svc = client.connect(host="{host}", port={port}, username=dbutils.secrets.get(scope="{scope}", key="splunk-user"), password=dbutils.secrets.get(scope="{scope}", key="splunk-pass"))
_job = _svc.jobs.create("{search_query}", **{"earliest_time":"-1h"})
while not _job.is_done(): __import__("time").sleep(1)
_reader = results.JSONResultsReader(_job.results(output_mode="json"))
df_{v} = spark.createDataFrame([dict(r) for r in _reader if isinstance(r, dict)])`,desc:"Splunk search read",notes:"Use splunklib SDK; or Splunk Spark connector for large datasets",imp:[],conf:.9},QuerySplunkIndexingStatus:{cat:"Splunk",tpl:`# Splunk indexing status query
import splunklib.client as client
_svc = client.connect(host="{host}", port={port})
print(f"[SPLUNK] Indexing status: {_svc.indexes.list()}")`,desc:"Splunk indexing status",notes:"Use splunklib SDK for status monitoring",imp:[],conf:.9},QueryInfluxDB:{cat:"InfluxDB",tpl:`# InfluxDB query via client
from influxdb_client import InfluxDBClient
_client = InfluxDBClient(url="{url}", token=dbutils.secrets.get(scope="{scope}", key="influx-token"), org="{org}")
_query_api = _client.query_api()
_tables = _query_api.query("{flux_query}")
_records = []
for table in _tables:
    for record in table.records:
        _records.append(record.values)
df_{v} = spark.createDataFrame(_records)`,desc:"InfluxDB query",notes:"Use influxdb-client SDK; consider migrating time-series to Delta Lake",imp:[],conf:.9},ConvertAvroToParquet:{cat:"DataFrame API",tpl:`df_{v} = spark.read.format("avro").load("{input_path}")
df_{v}.write.format("parquet").save("{output_path}")`,desc:"Avro to Parquet conversion",notes:"Spark handles format conversion natively",imp:[],conf:.9},ConvertParquetToAvro:{cat:"DataFrame API",tpl:`df_{v} = spark.read.format("parquet").load("{input_path}")
df_{v}.write.format("avro").save("{output_path}")`,desc:"Parquet to Avro conversion",notes:"Spark handles format conversion natively",imp:[],conf:.9},SplitAvro:{cat:"DataFrame API",tpl:`# Avro split — Spark reads Avro files as DataFrames natively
df_{v} = spark.read.format("avro").load("{input_path}")
# Process each record individually if needed
for row in df_{v}.collect():
    pass  # Process row`,desc:"Avro split",notes:"Not needed in Spark — read entire Avro dataset as DataFrame",imp:[],conf:.9},ConvertJSONToAvro:{cat:"DataFrame API",tpl:`from pyspark.sql.avro.functions import to_avro
from pyspark.sql.functions import struct
df_{v} = df_{in}.select(to_avro(struct("*")).alias("value"))`,desc:"JSON to Avro conversion",notes:"Use Spark built-in avro functions",imp:[],conf:.9},FlattenJson:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import col, explode_outer
# Flatten nested JSON structure
df_{v} = df_{in}
for field in [f for f in df_{in}.schema.fields if str(f.dataType).startswith("Struct")]:
    for nested in field.dataType.fields:
        df_{v} = df_{v}.withColumn(f"{field.name}_{nested.name}", col(f"{field.name}.{nested.name}"))
    df_{v} = df_{v}.drop(field.name)`,desc:"JSON flattening",notes:"Use PySpark struct navigation; or explode for arrays",imp:[],conf:.9},Base64EncodeContent:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import base64, unbase64
df_{v} = df_{in}.withColumn("{column}", base64(col("{column}")))`,desc:"Base64 encode/decode",notes:"Use PySpark base64/unbase64 functions",imp:[],conf:.9},ConvertCharacterSet:{cat:"DataFrame API",tpl:`# Character set conversion — Spark handles encoding via options
df_{v} = spark.read.option("encoding", "{target_encoding}").format("{format}").load("{path}")`,desc:"Character set conversion",notes:"Use Spark read options for encoding; or Python encode/decode",imp:[],conf:.9},ExtractEmailHeaders:{cat:"Email",tpl:`# Extract email headers
import email
from pyspark.sql.functions import udf
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def extract_headers(raw):
    msg = email.message_from_string(raw)
    return dict(msg.items())
df_{v} = df_{in}.withColumn("headers", extract_headers(col("{content_column}")))`,desc:"Email header extraction",notes:"Use Python email module as UDF",imp:[],conf:.9},ExtractEmailAttachments:{cat:"Email",tpl:`# Extract email attachments
import email, base64
def extract_attachments(raw):
    msg = email.message_from_string(raw)
    attachments = []
    for part in msg.walk():
        if part.get_content_disposition() == "attachment":
            attachments.append({"filename": part.get_filename(), "size": len(part.get_payload())})
    return attachments
# Apply as UDF on email content column`,desc:"Email attachment extraction",notes:"Use Python email module; store attachments in Volumes",imp:[],conf:.9},ConsumeIMAP:{cat:"Email",tpl:`# IMAP email consumption
import imaplib, email
_mail = imaplib.IMAP4_SSL("{host}")
_mail.login(dbutils.secrets.get(scope="{scope}", key="email-user"), dbutils.secrets.get(scope="{scope}", key="email-pass"))
_mail.select("INBOX")
_, _nums = _mail.search(None, "UNSEEN")
_emails = []
for num in _nums[0].split():
    _, data = _mail.fetch(num, "(RFC822)")
    _emails.append({"raw": data[0][1].decode("utf-8", errors="replace")})
df_{v} = spark.createDataFrame(_emails)`,desc:"IMAP email consumer",notes:"Use imaplib; schedule as periodic job",imp:[],conf:.9},ConsumePOP3:{cat:"Email",tpl:`# POP3 email consumption
import poplib, email
_pop = poplib.POP3_SSL("{host}")
_pop.user(dbutils.secrets.get(scope="{scope}", key="email-user"))
_pop.pass_(dbutils.secrets.get(scope="{scope}", key="email-pass"))
_count = len(_pop.list()[1])
_emails = []
for i in range(1, min(_count+1, 100)):
    _, lines, _ = _pop.retr(i)
    _emails.append({"raw": b"\\n".join(lines).decode("utf-8", errors="replace")})
df_{v} = spark.createDataFrame(_emails)
_pop.quit()`,desc:"POP3 email consumer",notes:"Use poplib; schedule as periodic job",imp:[],conf:.9},SetSNMP:{cat:"SNMP",tpl:`# SNMP set operation
from pysnmp.hlapi import setCmd, SnmpEngine, CommunityData, UdpTransportTarget, ContextData, ObjectType, ObjectIdentity
_errorIndication, _, _, _ = next(setCmd(
    SnmpEngine(), CommunityData("{community}"),
    UdpTransportTarget(("{host}", {port})), ContextData(),
    ObjectType(ObjectIdentity("{oid}"), "{value}")
))
if _errorIndication: print(f"[SNMP ERROR] {_errorIndication}")`,desc:"SNMP set operation",notes:"Use pysnmp library; install via pip",imp:[],conf:.9},ListenSNMP:{cat:"SNMP",tpl:`# SNMP trap listener — use scheduled polling instead
from pysnmp.hlapi import getCmd, SnmpEngine, CommunityData, UdpTransportTarget, ContextData, ObjectType, ObjectIdentity
print("[MIGRATION] SNMP trap listener → scheduled SNMP polling job")`,desc:"SNMP trap listener",notes:"Replace with scheduled SNMP polling job",imp:[],conf:.9},PutSyslog:{cat:"Syslog",tpl:`# Syslog send
import socket
_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
_sock.sendto("{message}".encode(), ("{host}", {port}))
_sock.close()`,desc:"Syslog sender",notes:"Use socket for UDP syslog; or configure log forwarding",imp:[],conf:.9},PutUDP:{cat:"Network",tpl:`# UDP send
import socket
_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
for row in df_{in}.limit(1000).collect():
    _sock.sendto(str(row.asDict()).encode(), ("{host}", {port}))
_sock.close()`,desc:"UDP sender",notes:"Use Python socket for UDP operations",imp:[],conf:.9},GetTCP:{cat:"Network",tpl:`# TCP read — use structured streaming or scheduled batch instead
print("[MIGRATION] TCP listener → Databricks Structured Streaming or scheduled batch job")
# For TCP sources, stage data to cloud storage and use Auto Loader`,desc:"TCP reader",notes:"Replace with Auto Loader on staged data",imp:[],conf:.9},PutRELP:{cat:"Network",tpl:`# RELP output — use standard syslog or HTTP endpoint
import requests
for row in df_{in}.limit(1000).collect():
    requests.post("{endpoint}", json=row.asDict())`,desc:"RELP output",notes:"Replace with HTTP endpoint or syslog",imp:[],conf:.9},ListenRELP:{cat:"Network",tpl:`# RELP listener → use HTTP endpoint or cloud-based log collection
print("[MIGRATION] RELP listener → HTTP endpoint or cloud logging service")`,desc:"RELP listener",notes:"Replace with cloud-native log collection",imp:[],conf:.9},ExecuteFlumeSink:{cat:"Spark Streaming",tpl:`# Flume sink → Spark Structured Streaming
# Apache Flume is deprecated — migrate to Spark Streaming
df_{v} = (spark.readStream
  .format("{format}")
  .load("{path}"))
print("[MIGRATION] Flume sink replaced by Spark Structured Streaming")`,desc:"Flume sink → Structured Streaming",notes:"Flume is deprecated; migrate to Structured Streaming",imp:[],conf:.9},ExecuteFlumeSource:{cat:"Spark Streaming",tpl:`# Flume source → Spark Structured Streaming
# Apache Flume is deprecated — migrate to Spark Streaming
df_{v} = (spark.readStream
  .format("{format}")
  .load("{path}"))
print("[MIGRATION] Flume source replaced by Spark Structured Streaming")`,desc:"Flume source → Structured Streaming",notes:"Flume is deprecated; migrate to Structured Streaming",imp:[],conf:.9},ConsumeWindowsEventLog:{cat:"Windows",tpl:`# Windows Event Log → schedule a collector script
# In Databricks, collect Windows events via:
# 1. Forward events to a log aggregator (Splunk, ELK)
# 2. Write to cloud storage
# 3. Read with Auto Loader
print("[MIGRATION] Windows Event Log → forward to cloud storage + Auto Loader")`,desc:"Windows Event Log consumer",notes:"Forward events to cloud storage; use Auto Loader",imp:[],conf:.9},ConsumeEWS:{cat:"Email/Exchange",tpl:`# Exchange Web Services consumer
# Use Microsoft Graph API instead of EWS
import requests
_token = dbutils.secrets.get(scope="{scope}", key="graph-token")
_r = requests.get("https://graph.microsoft.com/v1.0/me/messages", headers={"Authorization":f"Bearer {_token}"})
df_{v} = spark.createDataFrame(_r.json().get("value", []))`,desc:"Exchange Web Services consumer",notes:"Migrate to Microsoft Graph API",imp:[],conf:.9},RetryFlowFile:{cat:"Utility",tpl:`# Retry logic — use try/except with backoff
import time
for _attempt in range(3):
    try:
        # <retry logic here>
        break
    except Exception as e:
        if _attempt < 2: time.sleep(2 ** _attempt)
        else: raise`,desc:"Retry logic",notes:"Use Python try/except with exponential backoff",imp:[],conf:.9},ReplaceTextWithMapping:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import regexp_replace, col
df_{v} = df_{in}
# Apply text replacements
_mappings = {"{pattern}": "{replacement}"}
for pat, rep in _mappings.items():
    df_{v} = df_{v}.withColumn("{column}", regexp_replace(col("{column}"), pat, rep))`,desc:"Text replacement with mapping",notes:"Use PySpark regexp_replace for pattern-based replacements",imp:[],conf:.9},MonitorActivity:{cat:"Utility",tpl:`# Monitor activity — track flow metrics
from datetime import datetime
_now = datetime.now()
print(f"[MONITOR] Flow activity check at {_now}")
# In Databricks, use Workflows monitoring and Spark UI`,desc:"Activity monitor",notes:"Use Databricks Workflows monitoring and alerting",imp:[],conf:.9},ScanAttribute:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import col
# Scan/filter based on attribute patterns
df_{v} = df_{in}.filter(col("{attribute}").rlike("{pattern}"))`,desc:"Attribute scanning",notes:"Use PySpark rlike for regex-based attribute scanning",imp:[],conf:.9},ScanContent:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import col
# Scan content for pattern matches
df_{v} = df_{in}.filter(col("{content_column}").rlike("{pattern}"))`,desc:"Content scanning",notes:"Use PySpark rlike for content pattern matching",imp:[],conf:.9},QueryWhois:{cat:"Network",tpl:`# WHOIS query
import subprocess
_result = subprocess.run(["whois", "{domain}"], capture_output=True, text=True, timeout=30)
print(_result.stdout[:500])`,desc:"WHOIS lookup",notes:"Use whois command or python-whois library",imp:[],conf:.9},GeoEnrichIPRecord:{cat:"DataFrame API",tpl:`# IP geolocation enrichment
# Install: pip install geoip2
import geoip2.database
_reader = geoip2.database.Reader("{geoip_db_path}")
def enrich_ip(ip):
    try:
        r = _reader.city(ip)
        return {"country": r.country.name, "city": r.city.name, "lat": r.location.latitude, "lon": r.location.longitude}
    except: return None
# Register as UDF and apply to IP column`,desc:"IP geolocation enrichment",notes:"Use geoip2 library with MaxMind database",imp:[],conf:.9},PublishKafka_1_0:{cat:"Kafka",tpl:`(df_{in}.selectExpr("CAST(key AS STRING)", "CAST(value AS STRING)")
  .write
  .format("kafka")
  .option("kafka.bootstrap.servers", "{bootstrap_servers}")
  .option("topic", "{topic}")
  .save())`,desc:"Kafka 1.0 producer",notes:"Use Spark Kafka connector (version-agnostic)",imp:[],conf:.9},ConsumeKafka_1_0:{cat:"Kafka",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{bootstrap_servers}")
  .option("subscribe", "{topic}")
  .option("startingOffsets", "earliest")
  .load())`,desc:"Kafka 1.0 consumer",notes:"Use Spark Kafka connector (version-agnostic)",imp:[],conf:.9},ConsumeKafkaRecord:{cat:"Kafka",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{bootstrap_servers}")
  .option("subscribe", "{topic}")
  .option("startingOffsets", "earliest")
  .load()
  .selectExpr("CAST(key AS STRING)", "CAST(value AS STRING)"))`,desc:"Kafka record consumer",notes:"Use Spark Kafka connector with schema-aware deserialization",imp:[],conf:.9},ListDatabaseTables:{cat:"JDBC",tpl:`# List database tables
df_{v} = spark.sql("SHOW TABLES IN {database}")
df_{v}.show()`,desc:"List database tables",notes:"Use Spark SQL SHOW TABLES; or JDBC metadata query",imp:[],conf:.9},PutSQL:{cat:"JDBC",tpl:`# Execute SQL statement
(df_{in}.write
  .format("jdbc")
  .option("url", "{jdbc_url}")
  .option("dbtable", "{table}")
  .option("driver", "{driver}")
  .mode("append")
  .save())`,desc:"SQL write via JDBC",notes:"Use Spark JDBC writer",imp:[],conf:.9},AvroSchemaRegistry:{cat:"Schema Registry",tpl:`# Avro Schema Registry integration
from confluent_kafka.schema_registry import SchemaRegistryClient
_sr = SchemaRegistryClient({"url": "{schema_registry_url}"})
_schema = _sr.get_latest_version("{subject}").schema
print(f"[SCHEMA] Latest schema version retrieved")`,desc:"Avro Schema Registry",notes:"Use Confluent Schema Registry client",imp:[],conf:.9},RemoteProcessGroup:{cat:"Deprecated",tpl:`# NiFi Remote Process Group — NOT needed in Databricks
# Cross-workspace data sharing handled by Unity Catalog
print("[MIGRATION] NiFi Remote Process Group → Unity Catalog cross-workspace sharing")`,desc:"NiFi RPG",notes:"Not needed — use Unity Catalog for data sharing",imp:[],conf:.9},InputPort:{cat:"Deprecated",tpl:`# NiFi Input Port — NOT needed in Databricks
# Data ingress handled by Auto Loader or readStream
print("[MIGRATION] NiFi Input Port → Auto Loader / readStream")`,desc:"NiFi Input Port",notes:"Not needed — use Auto Loader for ingestion",imp:[],conf:.9},OutputPort:{cat:"Deprecated",tpl:`# NiFi Output Port — NOT needed in Databricks
# Data egress handled by writeStream or Delta sharing
print("[MIGRATION] NiFi Output Port → writeStream / Delta Sharing")`,desc:"NiFi Output Port",notes:"Not needed — use writeStream or Delta Sharing",imp:[],conf:.9},Funnel:{cat:"Deprecated",tpl:`# NiFi Funnel — NOT needed in Databricks
# DataFrame operations naturally merge data flows via union()
print("[MIGRATION] NiFi Funnel → DataFrame union()")`,desc:"NiFi Funnel",notes:"Not needed — use DataFrame union()",imp:[],conf:.9},PutSlackMessage:{cat:"Slack",tpl:`# Slack message via webhook
import requests
requests.post("{webhook_url}", json={"text": "{message}"})`,desc:"Slack message",notes:"Use Slack webhook URL; store in secrets",imp:[],conf:.9},SendTelegram:{cat:"Notification",tpl:`# Telegram notification
import requests
requests.post(f"https://api.telegram.org/bot{dbutils.secrets.get(scope=\\"{scope}\\", key=\\"telegram-token\\")}/sendMessage", json={"chat_id":"{chat_id}","text":"{message}"})`,desc:"Telegram notification",notes:"Use Telegram Bot API",imp:[],conf:.9},PutPagerDuty:{cat:"Notification",tpl:`# PagerDuty alert
import requests
requests.post("https://events.pagerduty.com/v2/enqueue", json={"routing_key":dbutils.secrets.get(scope="{scope}",key="pd-key"),"event_action":"trigger","payload":{"summary":"{summary}","severity":"{severity}","source":"{source}"}})`,desc:"PagerDuty alert",notes:"Use PagerDuty Events API v2",imp:[],conf:.9},PutOpsGenie:{cat:"Notification",tpl:`# OpsGenie alert
import requests
requests.post("https://api.opsgenie.com/v2/alerts", headers={"Authorization":"GenieKey "+dbutils.secrets.get(scope="{scope}",key="opsgenie-key")}, json={"message":"{message}","priority":"{priority}"})`,desc:"OpsGenie alert",notes:"Use OpsGenie REST API",imp:[],conf:.9},PostHTTP:{cat:"HTTP",tpl:`# HTTP POST — streaming-safe with foreachBatch
import requests

def _post_batch_{v}(batch_df, batch_id):
    _records = batch_df.toPandas().to_dict(orient="records")
    _response = requests.post("{url}", json=_records, headers={"{header_key}":"{header_value}"}, timeout=30)
    print(f"[HTTP] Batch {batch_id}: {len(_records)} records -> {_response.status_code}")

# For streaming: df_{in}.writeStream.foreachBatch(_post_batch_{v}).start()
# For batch:
_post_batch_{v}(df_{in}, 0)`,desc:"HTTP POST with foreachBatch",notes:"Streaming-safe",imp:["requests"],conf:.92},GetHTTP:{cat:"HTTP",tpl:`# DEPRECATED NiFi processor — use InvokeHTTP instead
import requests
_response = requests.get("{url}", headers={"{header_key}":"{header_value}"}, timeout=30)
df_{v} = spark.createDataFrame([_response.json()] if isinstance(_response.json(), dict) else _response.json())`,desc:"HTTP GET (deprecated NiFi processor)",notes:"GetHTTP is deprecated in NiFi; use InvokeHTTP. Mapping uses requests library.",imp:[],conf:.5},CryptographicHashContent:{cat:"DataFrame API",tpl:`from pyspark.sql.functions import sha2, col
df_{v} = df_{in}.withColumn("{hash_column}", sha2(col("{content_column}"), 256))`,desc:"Cryptographic hash",notes:"Use PySpark sha2, md5, or sha1 functions",imp:[],conf:.9},SignContent:{cat:"Security",tpl:`# Digital signature — use Python cryptography library
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import padding
print("[CRYPTO] Use cryptography library for digital signatures")`,desc:"Digital signature",notes:"Use Python cryptography library",imp:[],conf:.9},VerifyContentMAC:{cat:"Security",tpl:`# MAC verification — use Python hmac module
import hmac, hashlib
_mac = hmac.new(key=b"{key}", msg=b"{message}", digestmod=hashlib.sha256)
print(f"[CRYPTO] MAC: {_mac.hexdigest()}")`,desc:"MAC verification",notes:"Use Python hmac module",imp:[],conf:.9},ValidateJSON:{cat:"DLT Expectations",tpl:`from pyspark.sql.functions import col, from_json, schema_of_json
# Validate JSON structure
_sample = df_{in}.select("{json_column}").first()[0]
_schema = schema_of_json(_sample)
df_{v} = df_{in}.withColumn("_parsed", from_json(col("{json_column}"), _schema)).filter(col("_parsed").isNotNull())`,desc:"JSON validation",notes:"Use DLT expectations for production data quality",imp:[],conf:.9},SchemaValidation:{cat:"DLT Expectations",tpl:`# Schema validation via DLT expectations
# @dlt.expect_all_or_drop({{"valid_schema": "col1 IS NOT NULL AND col2 IS NOT NULL"}})
df_{v} = df_{in}.filter(col("{required_col}").isNotNull())`,desc:"Schema validation",notes:"Use DLT expectations for declarative data quality",imp:[],conf:.9},ConsumeKafka_2_0:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .option("startingOffsets", "earliest")
  .load()
  .selectExpr("CAST(key AS STRING)", "CAST(value AS STRING)", "topic", "partition", "offset", "timestamp"))`,desc:"Kafka 2.0 consumer via Structured Streaming",notes:"Update broker config",imp:["pyspark.sql.functions"],conf:.95},ConsumeKafkaRecord_1_0:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .load()
  .selectExpr("CAST(value AS STRING) as json_str"))`,desc:"Kafka Record 1.0 consumer",notes:"Schema handled by Spark",imp:["pyspark.sql.functions"],conf:.95},ConsumeKafkaRecord_2_0:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{topic}")
  .load()
  .selectExpr("CAST(value AS STRING) as json_str"))`,desc:"Kafka Record 2.0 consumer",notes:"Schema handled by Spark",imp:["pyspark.sql.functions"],conf:.95},PublishKafka_2_0:{cat:"Structured Streaming",tpl:`(df_{v}
  .selectExpr("CAST(key AS STRING)", "CAST(value AS STRING)")
  .write.format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Kafka 2.0 producer",notes:"Update broker config",imp:[],conf:.95},PublishKafkaRecord_1_0:{cat:"Structured Streaming",tpl:`(df_{v}
  .selectExpr("CAST(key AS STRING)", "to_json(struct(*)) AS value")
  .write.format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Kafka Record 1.0 producer",notes:"Update broker config",imp:["pyspark.sql.functions"],conf:.95},PublishKafkaRecord_2_0:{cat:"Structured Streaming",tpl:`(df_{v}
  .selectExpr("CAST(key AS STRING)", "to_json(struct(*)) AS value")
  .write.format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("topic", "{topic}")
  .save())`,desc:"Kafka Record 2.0 producer",notes:"Update broker config",imp:["pyspark.sql.functions"],conf:.95},ConsumeKinesisStream:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kinesis")
  .option("streamName", "{stream}")
  .option("region", "{region}")
  .option("initialPosition", "TRIM_HORIZON")
  .load())`,desc:"Kinesis consumer via Structured Streaming",notes:"Use Databricks Kinesis connector",imp:[],conf:.92},ConvertAvroToORC:{cat:"Spark DataFrame",tpl:`df_{v} = spark.read.format("avro").load("{path}")
df_{v}.write.format("orc").save("{output_path}")`,desc:"Avro to ORC via Spark",notes:"Format-agnostic DataFrames",imp:[],conf:.95},FetchParquet:{cat:"Spark DataFrame",tpl:'df_{v} = spark.read.format("parquet").load("{path}")',desc:"Read Parquet natively",notes:"Parquet is Spark native",imp:[],conf:.95},JoltTransformRecord:{cat:"Spark DataFrame",tpl:`df_{v} = df_{input}
for src, dst in _jolt_mappings.items():
    df_{v} = df_{v}.withColumnRenamed(src, dst)`,desc:"Jolt record transform via DataFrame ops",notes:"Translate Jolt spec to PySpark",imp:["pyspark.sql.functions"],conf:.9},EvaluateXPath:{cat:"Spark XML",tpl:`from pyspark.sql.functions import xpath, col
# xpath() returns array; take first element
df_{v} = df_{input}.withColumn("_xpath_result", xpath(col("xml_content"), lit("{xpath_expr}"))[0])`,desc:"XPath evaluation via PySpark xpath()",notes:"xpath() returns ArrayType; use [0] to get first result. Install spark-xml for complex XML.",imp:["pyspark.sql.functions"],conf:.85},EvaluateXQuery:{cat:"Spark XML",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import lxml.etree as ET
@udf(StringType())
def eval_xquery(xml_str):
    doc = ET.fromstring(xml_str.encode())
    return str(doc.xpath("{xquery_expr}"))
df_{v} = df_{input}.withColumn("_xq", eval_xquery(col("value")))`,desc:"XQuery via lxml UDF",notes:"Install lxml on cluster",imp:["lxml"],conf:.9},SplitXml:{cat:"Spark XML",tpl:'df_{v} = spark.read.format("xml").option("rowTag", "{tag}").load("{path}")',desc:"Split XML via spark-xml rowTag",notes:"Install spark-xml",imp:[],conf:.92},ExtractGrok:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import regexp_extract, col
df_{v} = df_{input}.withColumn("_extracted", regexp_extract(col("value"), r"{regex_pattern}", 1))`,desc:"Grok extraction via regexp_extract",notes:"Translate Grok to regex",imp:["pyspark.sql.functions"],conf:.9},ExtractAvroMetadata:{cat:"Spark DataFrame",tpl:`df_{v} = spark.read.format("avro").load("{path}")
print(f"Schema: {df_{v}.schema.simpleString()}")`,desc:"Extract Avro schema metadata",notes:"Schema auto-detected by Spark",imp:[],conf:.93},ExtractHL7Attributes:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def parse_hl7(msg):
    segs = msg.split("\\r")
    return {s.split("|")[0]: "|".join(s.split("|")[1:4]) for s in segs if "|" in s}
df_{v} = df_{input}.withColumn("hl7_attrs", parse_hl7(col("value")))`,desc:"HL7 message parsing via UDF",notes:"Use hl7apy for production",imp:["pyspark.sql.functions"],conf:.9},ExtractCCDAAttributes:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def parse_ccda(xml):
    import lxml.etree as ET
    doc = ET.fromstring(xml.encode())
    return {"patient": doc.findtext(".//{urn:hl7-org:v3}patient/{urn:hl7-org:v3}name", default="")}
df_{v} = df_{input}.withColumn("ccda_attrs", parse_ccda(col("value")))`,desc:"CCDA clinical document parsing",notes:"Install lxml",imp:["lxml"],conf:.9},RouteHL7:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import col
df_{v}_adt = df_{input}.filter(col("value").contains("ADT"))
df_{v}_orm = df_{input}.filter(col("value").contains("ORM"))
df_{v} = df_{input}`,desc:"HL7 message routing by type",notes:"Filter by MSH segment",imp:["pyspark.sql.functions"],conf:.9},ExtractTNEFAttachments:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import ArrayType, StringType
@udf(ArrayType(StringType()))
def extract_tnef(data):
    return ["attachment_extracted"]
df_{v} = df_{input}.withColumn("tnef_attachments", extract_tnef(col("content")))`,desc:"TNEF attachment extraction",notes:"Install tnefparse",imp:["tnefparse"],conf:.9},ParseCEF:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import regexp_extract, col
df_{v} = df_{input}.withColumn("cef_vendor", regexp_extract(col("value"), r"CEF:\\d+\\|([^|]+)", 1)).withColumn("cef_severity", regexp_extract(col("value"), r"CEF:\\d+(?:\\|[^|]*){6}\\|([^|]+)", 1))`,desc:"CEF security log parsing",notes:"Regex-based",imp:["pyspark.sql.functions"],conf:.9},ParseEvtx:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import MapType, StringType
@udf(MapType(StringType(), StringType()))
def parse_evtx(xml):
    import lxml.etree as ET
    doc = ET.fromstring(xml.encode())
    return {"EventID": doc.findtext(".//{*}EventID", default="")}
df_{v} = df_{input}.withColumn("event_data", parse_evtx(col("value")))`,desc:"Windows Event Log XML parsing",notes:"Parse EVTX XML",imp:["lxml"],conf:.9},ParseNetflowv5:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import col
df_{v} = df_{input}.selectExpr("*", "substring(value,1,4) as src_ip", "substring(value,5,4) as dst_ip")`,desc:"NetFlow v5 packet parsing",notes:"Binary format needs UDF",imp:["pyspark.sql.functions"],conf:.9},ParseSyslog5424:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import regexp_extract, col
df_{v} = df_{input}.withColumn("priority", regexp_extract(col("value"), r"<(\\d+)>", 1)).withColumn("hostname", regexp_extract(col("value"), r"<\\d+>\\d+ [\\S]+ ([\\S]+)", 1))`,desc:"RFC 5424 Syslog parsing",notes:"Regex extraction",imp:["pyspark.sql.functions"],conf:.92},ListenGRPC:{cat:"Databricks Serving",tpl:`import grpc
from concurrent import futures
print(f"[gRPC] Server endpoint configured")`,desc:"gRPC listener via Databricks Serving",notes:"Deploy as Databricks App",imp:["grpcio"],conf:.9},InvokeGRPC:{cat:"PySpark UDF",tpl:`import grpc
_channel = grpc.insecure_channel("{host}:{port}")
df_{v} = df_{input}`,desc:"gRPC client invocation",notes:"Generate stubs from .proto",imp:["grpcio"],conf:.9},ConnectWebSocket:{cat:"Structured Streaming",tpl:`import websocket, json
_ws = websocket.create_connection("{ws_url}")
_msgs = [{"data": _ws.recv()} for _ in range(100)]
_ws.close()
df_{v} = spark.createDataFrame(_msgs)`,desc:"WebSocket client",notes:"Use websocket-client",imp:["websocket-client"],conf:.9},ListenWebSocket:{cat:"Structured Streaming",tpl:`import asyncio, websockets
print("[WS] WebSocket listener configured")`,desc:"WebSocket server via Databricks App",notes:"Deploy as Databricks App",imp:["websockets"],conf:.9},PutWebSocket:{cat:"PySpark UDF",tpl:`import websocket, json
_ws = websocket.create_connection("{ws_url}")
for row in df_{input}.limit(1000).collect():
    _ws.send(json.dumps(row.asDict()))
_ws.close()`,desc:"WebSocket message sender",notes:"Use websocket-client",imp:["websocket-client"],conf:.9},ListenSMTP:{cat:"Databricks App",tpl:`from aiosmtpd.controller import Controller
print("[SMTP] Email receiver configured")`,desc:"SMTP receiver via Databricks App",notes:"Deploy as Databricks App",imp:["aiosmtpd"],conf:.9},ForkRecord:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import explode, col
df_{v} = df_{input}.select(explode(col("{array_field}")).alias("record"), "*")`,desc:"Fork/explode nested records",notes:"Use explode",imp:["pyspark.sql.functions"],conf:.93},SampleRecord:{cat:"Spark DataFrame",tpl:"df_{v} = df_{input}.sample(fraction={sample_rate}, seed=42)",desc:"Sample records",notes:"Adjust fraction",imp:[],conf:.95},ScriptedTransformRecord:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col, struct
from pyspark.sql.types import StringType
import json
@udf(StringType())
def transform_record(row_json):
    data = json.loads(row_json)
    data["_processed"] = True
    return json.dumps(data)
df_{v} = df_{input}.withColumn("_transformed", transform_record(col("value")))`,desc:"Scripted record transform via UDF",notes:"Migrate NiFi script",imp:["pyspark.sql.functions"],conf:.9},PutRecord:{cat:"Delta Lake",tpl:'df_{input}.write.format("delta").mode("append").saveAsTable("{table_name}")',desc:"Generic record writer via Delta",notes:"Use Delta for persistence",imp:[],conf:.93},InvokeScriptedProcessor:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
@udf(StringType())
def scripted_logic(value):
    return value
df_{v} = df_{input}.withColumn("_result", scripted_logic(col("value")))`,desc:"Scripted processor via UDF",notes:"Translate NiFi script to Python",imp:["pyspark.sql.functions"],conf:.9},CryptographicHashAttribute:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import sha2, col
df_{v} = df_{input}.withColumn("_hash", sha2(col("{attr_name}"), 256))`,desc:"Hash attribute with SHA-256",notes:"Built-in sha2",imp:["pyspark.sql.functions"],conf:.95},HashAttribute:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import sha2, col
df_{v} = df_{input}.withColumn("_hash", sha2(col("{attr_name}"), 256))`,desc:"Hash attribute value",notes:"Built-in sha2/md5",imp:["pyspark.sql.functions"],conf:.95},EncryptContentPGP:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import BinaryType
import gnupg
_gpg = gnupg.GPG()
@udf(BinaryType())
def pgp_encrypt(data):
    return bytes(str(_gpg.encrypt(data, "{recipient_key}")), "utf-8")
df_{v} = df_{input}.withColumn("_encrypted", pgp_encrypt(col("value")))`,desc:"PGP encryption",notes:"Install python-gnupg",imp:["gnupg"],conf:.9},DecryptContentPGP:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import gnupg
_gpg = gnupg.GPG()
@udf(StringType())
def pgp_decrypt(data):
    return str(_gpg.decrypt(data, passphrase=dbutils.secrets.get(scope="pgp", key="passphrase")))
df_{v} = df_{input}.withColumn("_decrypted", pgp_decrypt(col("value")))`,desc:"PGP decryption",notes:"Install python-gnupg",imp:["gnupg"],conf:.9},AttributeRollingWindow:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import col, avg, window
df_{v} = df_{input}.groupBy(window("timestamp", "{window_duration}")).agg(avg("{metric_col}").alias("rolling_avg"))`,desc:"Rolling window aggregation",notes:"Use Spark window functions",imp:["pyspark.sql.functions"],conf:.92},AttributesToCSV:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import concat_ws, col
df_{v} = df_{input}.withColumn("_csv", concat_ws(",", *[col(c) for c in df_{input}.columns]))`,desc:"Attributes to CSV string",notes:"Use concat_ws",imp:["pyspark.sql.functions"],conf:.93},LookupAttribute:{cat:"Spark DataFrame",tpl:`_lookup_df = spark.table("{lookup_table}")
df_{v} = df_{input}.join(_lookup_df, df_{input}["{key_col}"] == _lookup_df["{lookup_key}"], "left")`,desc:"Attribute lookup via join",notes:"Broadcast join for small lookups",imp:["pyspark.sql.functions"],conf:.92},CaptureChangeMySQL:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("delta")
  .option("readChangeFeed", "true")
  .table("{source_table}"))`,desc:"MySQL CDC via DLT Change Data Feed",notes:"Or use Debezium + Kafka",imp:[],conf:.92},CompareFuzzyHash:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import FloatType
@udf(FloatType())
def fuzzy_sim(a, b):
    if not a or not b: return 0.0
    sa, sb = set(a), set(b)
    return float(len(sa & sb)) / float(len(sa | sb))
df_{v} = df_{input}.withColumn("_similarity", fuzzy_sim(col("hash1"), col("hash2")))`,desc:"Fuzzy hash comparison",notes:"Use ssdeep for production",imp:[],conf:.9},FuzzyHashContent:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import hashlib
@udf(StringType())
def fuzzy_hash(content):
    return hashlib.sha256(content.encode()).hexdigest()[:16]
df_{v} = df_{input}.withColumn("_fuzzy_hash", fuzzy_hash(col("value")))`,desc:"Fuzzy hash generation",notes:"Use ssdeep for true fuzzy hashing",imp:[],conf:.9},GeoEnrichIP:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StructType, StructField, StringType, FloatType
import geoip2.database
_reader = geoip2.database.Reader("/Volumes/<catalog>/<schema>/geo/GeoLite2-City.mmdb")
@udf(StructType([StructField("city",StringType()),StructField("country",StringType())]))
def geo_lookup(ip):
    try:
        r = _reader.city(ip)
        return (r.city.name, r.country.name)
    except: return (None, None)
df_{v} = df_{input}.withColumn("_geo", geo_lookup(col("ip_address")))`,desc:"IP geolocation enrichment",notes:"Download GeoLite2 DB",imp:["geoip2"],conf:.9},ISPEnrichIP:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import geoip2.database
_reader = geoip2.database.Reader("/Volumes/<catalog>/<schema>/geo/GeoLite2-ASN.mmdb")
@udf(StringType())
def isp_lookup(ip):
    try: return _reader.asn(ip).autonomous_system_organization
    except: return None
df_{v} = df_{input}.withColumn("_isp", isp_lookup(col("ip_address")))`,desc:"ISP/ASN enrichment",notes:"Download GeoLite2-ASN DB",imp:["geoip2"],conf:.9},IdentifyMimeType:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import mimetypes
@udf(StringType())
def detect_mime(fname):
    mime, _ = mimetypes.guess_type(fname or "")
    return mime or "application/octet-stream"
df_{v} = df_{input}.withColumn("mime_type", detect_mime(col("filename")))`,desc:"MIME type detection",notes:"Use python-magic for binary",imp:["mimetypes"],conf:.93},ModifyBytes:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import substring, col
df_{v} = df_{input}.withColumn("_modified", substring(col("content"), 1, 100))`,desc:"Byte-level content modification",notes:"Use substring",imp:["pyspark.sql.functions"],conf:.9},SegmentContent:{cat:"Spark DataFrame",tpl:`from pyspark.sql.functions import explode, split, col
df_{v} = df_{input}.withColumn("_segment", explode(split(col("value"), "{delimiter}")))`,desc:"Segment content by delimiter",notes:"Use split + explode",imp:["pyspark.sql.functions"],conf:.92},DuplicateFlowFile:{cat:"Spark DataFrame",tpl:`from functools import reduce
from pyspark.sql import DataFrame
df_{v} = reduce(DataFrame.union, [df_{input}] * {num_copies})`,desc:"Duplicate records N times",notes:"Use union",imp:[],conf:.93},GetHTMLElement:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
from bs4 import BeautifulSoup
@udf(StringType())
def extract_html(html):
    soup = BeautifulSoup(html, "html.parser")
    el = soup.select_one("{css_selector}")
    return el.get_text() if el else None
df_{v} = df_{input}.withColumn("_extracted", extract_html(col("html")))`,desc:"HTML element extraction",notes:"Install beautifulsoup4",imp:["beautifulsoup4"],conf:.9},ModifyHTMLElement:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
from bs4 import BeautifulSoup
@udf(StringType())
def modify_html(html):
    soup = BeautifulSoup(html, "html.parser")
    el = soup.select_one("{css_selector}")
    if el: el.string = "{new_value}"
    return str(soup)
df_{v} = df_{input}.withColumn("_modified_html", modify_html(col("html")))`,desc:"HTML element modification",notes:"Install beautifulsoup4",imp:["beautifulsoup4"],conf:.9},PutHTMLElement:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
from bs4 import BeautifulSoup
@udf(StringType())
def insert_html(html):
    soup = BeautifulSoup(html, "html.parser")
    tag = soup.new_tag("{tag_name}")
    tag.string = "{content}"
    soup.body.append(tag)
    return str(soup)
df_{v} = df_{input}.withColumn("_html", insert_html(col("html")))`,desc:"HTML element insertion",notes:"Install beautifulsoup4",imp:["beautifulsoup4"],conf:.9},GetSmbFile:{cat:"PySpark UDF",tpl:`import smbclient
smbclient.register_session("{server}", username=dbutils.secrets.get(scope="smb", key="user"), password=dbutils.secrets.get(scope="smb", key="pass"))
_data = smbclient.open_file(r"\\\\{server}\\{share}\\{path}", mode="rb").read()
df_{v} = spark.createDataFrame([{"content": _data.decode("utf-8", errors="replace")}])`,desc:"Read from SMB/Windows share",notes:"Install smbprotocol",imp:["smbprotocol"],conf:.9},PutSmbFile:{cat:"PySpark UDF",tpl:`import smbclient
smbclient.register_session("{server}", username=dbutils.secrets.get(scope="smb", key="user"), password=dbutils.secrets.get(scope="smb", key="pass"))
df_{input}.toPandas().to_csv(r"\\\\{server}\\{share}\\output.csv", index=False)`,desc:"Write to SMB/Windows share",notes:"Install smbprotocol",imp:["smbprotocol"],conf:.9},GetTwitter:{cat:"PySpark UDF",tpl:`import tweepy
_auth = tweepy.OAuth2BearerHandler(dbutils.secrets.get(scope="twitter", key="bearer_token"))
_api = tweepy.API(_auth)
_tweets = [{"text": t.text, "created_at": str(t.created_at)} for t in _api.search_tweets(q="{query}", count=100)]
df_{v} = spark.createDataFrame(_tweets)`,desc:"Twitter/X data ingestion",notes:"Use tweepy",imp:["tweepy"],conf:.9},PostSlack:{cat:"PySpark UDF",tpl:`import requests
requests.post("{webhook_url}", json={"text": "Pipeline notification"})
df_{v} = df_{input}`,desc:"Slack via webhook",notes:"Use Slack webhook URL",imp:["requests"],conf:.92},GetRethinkDB:{cat:"PySpark UDF",tpl:`from rethinkdb import r
_conn = r.connect(host="{host}", port=28015, db="{database}")
_docs = list(r.table("{table}").limit(50000).run(_conn))
df_{v} = spark.createDataFrame(_docs) if _docs else spark.createDataFrame([], "id STRING")
_conn.close()`,desc:"RethinkDB reader",notes:"Install rethinkdb",imp:["rethinkdb"],conf:.9},PutRethinkDB:{cat:"PySpark UDF",tpl:`from rethinkdb import r
_conn = r.connect(host="{host}", port=28015, db="{database}")
r.table("{table}").insert(df_{input}.limit(10000).toPandas().to_dict(orient="records")).run(_conn)
_conn.close()`,desc:"RethinkDB writer",notes:"Install rethinkdb",imp:["rethinkdb"],conf:.9},DeleteRethinkDB:{cat:"PySpark UDF",tpl:`from rethinkdb import r
_conn = r.connect(host="{host}", port=28015, db="{database}")
r.table("{table}").delete().run(_conn)
_conn.close()`,desc:"RethinkDB delete",notes:"Install rethinkdb",imp:["rethinkdb"],conf:.9},FetchGridFS:{cat:"PySpark UDF",tpl:`from pymongo import MongoClient
import gridfs
_client = MongoClient("{mongo_uri}")
_fs = gridfs.GridFS(_client["{database}"])
_files = [{"filename": f.filename, "length": f.length} for f in _fs.find().limit(1000)]
df_{v} = spark.createDataFrame(_files) if _files else spark.createDataFrame([], "filename STRING, length LONG")
_client.close()`,desc:"GridFS file listing",notes:"Use pymongo gridfs",imp:["pymongo"],conf:.9},PutGridFS:{cat:"PySpark UDF",tpl:`from pymongo import MongoClient
import gridfs
_client = MongoClient("{mongo_uri}")
_fs = gridfs.GridFS(_client["{database}"])
for row in df_{input}.limit(1000).collect():
    _fs.put(str(row.asDict()).encode(), filename=f"record")
_client.close()`,desc:"GridFS file upload",notes:"Use pymongo gridfs",imp:["pymongo"],conf:.9},DeleteGridFS:{cat:"PySpark UDF",tpl:`from pymongo import MongoClient
import gridfs
_client = MongoClient("{mongo_uri}")
_fs = gridfs.GridFS(_client["{database}"])
for f in _fs.find({"filename": "{pattern}"}):
    _fs.delete(f._id)
_client.close()`,desc:"GridFS file deletion",notes:"Use pymongo gridfs",imp:["pymongo"],conf:.9},FetchElasticsearch:{cat:"PySpark UDF",tpl:`from elasticsearch import Elasticsearch
_es = Elasticsearch("{es_url}", basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")))
_doc = _es.get(index="{index}", id="{doc_id}")
df_{v} = spark.createDataFrame([_doc["_source"]])`,desc:"Fetch single ES document",notes:"Use elasticsearch-py",imp:["elasticsearch"],conf:.9},DeleteByQueryElasticsearch:{cat:"PySpark UDF",tpl:`from elasticsearch import Elasticsearch
_es = Elasticsearch("{es_url}", basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")))
_es.delete_by_query(index="{index}", body={"query": {"match_all": {}}})
df_{v} = df_{input}`,desc:"ES delete by query",notes:"Use elasticsearch-py",imp:["elasticsearch"],conf:.9},QueryElasticsearchHttp:{cat:"PySpark UDF",tpl:`from elasticsearch import Elasticsearch
_es = Elasticsearch("{es_url}", basic_auth=(dbutils.secrets.get(scope="es", key="user"), dbutils.secrets.get(scope="es", key="pass")))
_result = _es.search(index="{index}", size=10000)
_hits = [h["_source"] for h in _result["hits"]["hits"]]
df_{v} = spark.createDataFrame(_hits) if _hits else spark.createDataFrame([], "id STRING")`,desc:"ES HTTP query",notes:"Use elasticsearch-py",imp:["elasticsearch"],conf:.9},DeleteHBaseCells:{cat:"PySpark UDF",tpl:`import happybase
_conn = happybase.Connection("{hbase_host}")
_table = _conn.table("{table}")
for row in df_{input}.limit(1000).collect():
    _table.delete(row["row_key"].encode())
_conn.close()`,desc:"HBase cell deletion",notes:"Use happybase",imp:["happybase"],conf:.9},DeleteHBaseRow:{cat:"PySpark UDF",tpl:`import happybase
_conn = happybase.Connection("{hbase_host}")
_table = _conn.table("{table}")
for row in df_{input}.limit(1000).collect():
    _table.delete(row["row_key"].encode())
_conn.close()`,desc:"HBase row deletion",notes:"Use happybase",imp:["happybase"],conf:.9},GetHDFSEvents:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "json")
  .option("cloudFiles.schemaLocation", "/Volumes/{catalog}/{schema}/checkpoints/hdfs_events")
  .load("{hdfs_path}"))`,desc:"HDFS events via Auto Loader",notes:"Use cloudFiles",imp:[],conf:.92},GetHDFSFileInfo:{cat:"Spark DataFrame",tpl:`_files = dbutils.fs.ls("{hdfs_path}")
df_{v} = spark.createDataFrame([{"path": f.path, "name": f.name, "size": f.size} for f in _files])`,desc:"HDFS file info listing",notes:"Use dbutils.fs.ls",imp:[],conf:.93},GetHDFSSequenceFile:{cat:"Spark DataFrame",tpl:'df_{v} = spark.sparkContext.sequenceFile("{hdfs_path}", "org.apache.hadoop.io.Text", "org.apache.hadoop.io.Text").toDF(["key", "value"])',desc:"Hadoop SequenceFile reader",notes:"Use sparkContext.sequenceFile",imp:[],conf:.9},DeleteDynamoDB:{cat:"PySpark UDF",tpl:`import boto3
_dynamodb = boto3.resource("dynamodb", region_name="{region}")
_table = _dynamodb.Table("{table}")
with _table.batch_writer() as _batch:
    for row in df_{input}.limit(10000).collect():
        _batch.delete_item(Key={"id": row["id"]})`,desc:"DynamoDB batch delete",notes:"Configure AWS creds",imp:["boto3"],conf:.9},DeleteSQS:{cat:"PySpark UDF",tpl:`import boto3
_sqs = boto3.client("sqs", region_name="{region}")
_msgs = _sqs.receive_message(QueueUrl="{queue_url}", MaxNumberOfMessages=10)
for msg in _msgs.get("Messages", []):
    _sqs.delete_message(QueueUrl="{queue_url}", ReceiptHandle=msg["ReceiptHandle"])`,desc:"SQS message deletion",notes:"Configure AWS creds",imp:["boto3"],conf:.9},InvokeAWSGatewayApi:{cat:"PySpark UDF",tpl:`import requests
_response = requests.post("{api_gateway_url}", json=df_{input}.limit(100).toPandas().to_dict(orient="records"))
df_{v} = spark.createDataFrame([_response.json()] if isinstance(_response.json(), dict) else _response.json())`,desc:"AWS API Gateway invocation",notes:"Configure AWS creds",imp:["boto3","requests"],conf:.9},PutSplunkHTTP:{cat:"PySpark UDF",tpl:`import requests
_token = dbutils.secrets.get(scope="splunk", key="hec_token")
for row in df_{input}.limit(10000).collect():
    requests.post("{splunk_hec_url}", json={"event": row.asDict()}, headers={"Authorization": f"Splunk {_token}"}, verify=False)`,desc:"Splunk HEC sender",notes:"Configure HEC token",imp:["requests"],conf:.9},PutRiemann:{cat:"PySpark UDF",tpl:`import socket
_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
_sock.connect(("{riemann_host}", 5555))
print("[RIEMANN] Sent monitoring events")
df_{v} = df_{input}`,desc:"Riemann monitoring events",notes:"Use riemann-client",imp:[],conf:.9},ListenTCPRecord:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("socket")
  .option("host", "{host}")
  .option("port", "{port}")
  .load())`,desc:"TCP record stream listener",notes:"Use socket source",imp:[],conf:.9},ListenUDPRecord:{cat:"Structured Streaming",tpl:`df_{v} = (spark.readStream
  .format("kafka")
  .option("kafka.bootstrap.servers", "{brokers}")
  .option("subscribe", "{udp_topic}")
  .load())`,desc:"UDP record stream via Kafka",notes:"Pipe UDP through Kafka",imp:[],conf:.9},UpdateCounter:{cat:"Spark DataFrame",tpl:`_counter = spark.sparkContext.accumulator(0)
def _count(row): _counter.add(1)
df_{input}.foreach(_count)
print(f"[COUNTER] Count: {_counter.value}")
df_{v} = df_{input}`,desc:"Counter via accumulator",notes:"Use accumulators or Delta",imp:[],conf:.92},UpdateHiveTable:{cat:"Delta Lake",tpl:`spark.sql("ALTER TABLE {table_name} SET TBLPROPERTIES ('updated'='true')")
df_{v} = df_{input}`,desc:"Hive table DDL update",notes:"Use Unity Catalog",imp:[],conf:.92},ValidateCsv:{cat:"Spark DataFrame",tpl:`df_{v} = spark.read.option("header", "true").option("mode", "PERMISSIVE").csv("{path}")
_corrupt = df_{v}.filter(col("_corrupt_record").isNotNull())`,desc:"CSV validation",notes:"Use permissive mode",imp:["pyspark.sql.functions"],conf:.93},GetMongoRecord:{cat:"PySpark UDF",tpl:`from pymongo import MongoClient
_client = MongoClient("{mongo_uri}")
_docs = list(_client["{database}"]["{collection}"].find({}, {"_id": 0}).limit(50000))
df_{v} = spark.createDataFrame(_docs) if _docs else spark.createDataFrame([], "id STRING")
_client.close()`,desc:"MongoDB record reader",notes:"Use pymongo",imp:["pymongo"],conf:.9},RunMongoAggregation:{cat:"PySpark UDF",tpl:`from pymongo import MongoClient
_client = MongoClient("{mongo_uri}")
_results = list(_client["{database}"]["{collection}"].aggregate([{pipeline}]))
df_{v} = spark.createDataFrame(_results) if _results else spark.createDataFrame([], "id STRING")
_client.close()`,desc:"MongoDB aggregation pipeline",notes:"Translate to PySpark",imp:["pymongo"],conf:.9},ExecuteInfluxDBQuery:{cat:"PySpark UDF",tpl:`from influxdb_client import InfluxDBClient
_client = InfluxDBClient(url="{influx_url}", token=dbutils.secrets.get(scope="influx", key="token"), org="{org}")
_tables = _client.query_api().query("{flux_query}")
_records = [r.values for table in _tables for r in table.records]
df_{v} = spark.createDataFrame(_records) if _records else spark.createDataFrame([], "time STRING, value DOUBLE")`,desc:"InfluxDB Flux query",notes:"Use influxdb-client",imp:["influxdb-client"],conf:.9},QueryDNS:{cat:"PySpark UDF",tpl:`from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
import socket
@udf(StringType())
def dns_lookup(hostname):
    try: return socket.gethostbyname(hostname)
    except: return None
df_{v} = df_{input}.withColumn("_ip", dns_lookup(col("hostname")))`,desc:"DNS lookup via UDF",notes:"Use socket.gethostbyname",imp:[],conf:.93},GetJMSQueue:{cat:"PySpark UDF",tpl:`import stomp
_msgs = []
class _L(stomp.ConnectionListener):
    def on_message(self, frame): _msgs.append({"body": frame.body})
_conn = stomp.Connection([("{jms_host}", {jms_port})])
_conn.set_listener("", _L())
_conn.connect(dbutils.secrets.get(scope="jms", key="user"), dbutils.secrets.get(scope="jms", key="pass"), wait=True)
_conn.subscribe(destination="/queue/{queue}", id=1, ack="auto")
import time; time.sleep(5)
_conn.disconnect()
df_{v} = spark.createDataFrame(_msgs) if _msgs else spark.createDataFrame([], "body STRING")`,desc:"JMS Queue consumer",notes:"Use stomp.py",imp:["stomp.py"],conf:.9},SpringContextProcessor:{cat:"PySpark UDF",tpl:`# Spring Context Processor — migrate Spring bean logic to Python
df_{v} = df_{input}`,desc:"Spring context migration",notes:"Manual migration required — no automated translation",imp:[],conf:.2},YandexTranslate:{cat:"PySpark UDF",tpl:`import requests
from pyspark.sql.functions import udf, col
from pyspark.sql.types import StringType
@udf(StringType())
def translate(text):
    r = requests.post("https://translate.api.cloud.yandex.net/translate/v2/translate", json={"texts": [text], "targetLanguageCode": "{lang}"})
    return r.json()["translations"][0]["text"]
df_{v} = df_{input}.withColumn("_translated", translate(col("value")))`,desc:"Yandex translation",notes:"Configure API key",imp:["requests"],conf:.9}},$i={source:{tpl:`# Source processor: {type}
# Auto Loader ingestion from landing zone
df_{v} = (spark.readStream
  .format("cloudFiles")
  .option("cloudFiles.format", "json")
  .option("cloudFiles.schemaLocation", "/Volumes/{catalog}/{schema}/_schema/{v}")
  .option("cloudFiles.inferColumnTypes", "true")
  .load("/Volumes/{catalog}/{schema}/landing/{v}"))
print(f"[SOURCE] {v}: streaming from landing zone")`,desc:"Source - Auto Loader ingestion",conf:.7},sink:{tpl:`# Sink processor: {type}
# Delta Lake write with merge semantics
(df_{in}.write
  .format("delta")
  .mode("append")
  .option("mergeSchema", "true")
  .saveAsTable("{catalog}.{schema}.{v}"))
print(f"[SINK] {v}: written to Delta table")`,desc:"Sink - Delta Lake write",conf:.7},transform:{tpl:`# Transform processor: {type}
# DataFrame transformation pipeline
from pyspark.sql.functions import col, lit, current_timestamp
df_{v} = (df_{in}
  .withColumn("_processed_at", current_timestamp())
  .withColumn("_source_processor", lit("{type}")))
print(f"[TRANSFORM] {v}: applied transformation")`,desc:"Transform - DataFrame transformation",conf:.7},route:{tpl:`# Route processor: {type}
# Conditional DataFrame routing via filter
from pyspark.sql.functions import col
_condition = "1=1"  # TODO: translate NiFi routing rules
df_{v}_matched = df_{in}.filter(_condition)
df_{v}_unmatched = df_{in}.filter(f"NOT ({_condition})")
df_{v} = df_{v}_matched
print(f"[ROUTE] {v}: matched={{df_{v}_matched.count()}}, unmatched={{df_{v}_unmatched.count()}}")`,desc:"Route - DataFrame filter routing",conf:.7},process:{tpl:`# Process processor: {type}
# Custom processing step
from pyspark.sql.functions import col, expr, current_timestamp
df_{in}.createOrReplaceTempView("tmp_{v}")
df_{v} = spark.sql("SELECT *, current_timestamp() AS _processed_at FROM tmp_{v}")
print(f"[PROCESS] {v}: processed {{df_{v}.count()}} rows")`,desc:"Process - Custom processing via Spark SQL",conf:.7},utility:{tpl:`# Utility processor: {type}
# Logging and inspection
print(f"[UTILITY] {v}: {{df_{in}.count()}} rows")
df_{in}.printSchema()
display(df_{in}.limit(5))
df_{v} = df_{in}`,desc:"Utility - logging and inspection",conf:.8}};function Ai(e,n,t,s,a,o){const i=o||3;if(!/^(InvokeHTTP|PutElasticsearch|PutMongo|PutS3|PutDynamoDB|ExecuteSQL|PutSQL|PutDatabaseRecord|ConsumeKafka|PublishKafka|Fetch|Get(HTTP|SQS|DynamoDB))/.test(n))return t;const c=n.toLowerCase().replace(/[^a-z0-9]/g,"_"),l=e.replace(/[^a-zA-Z0-9]/g,"_"),d=t.split(`
`).map(u=>"    "+u).join(`
`);return`# ${e} — with retry logic
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type
import logging
_logger = logging.getLogger("nifi_migration")

@retry(
    stop=stop_after_attempt(${i}),
    wait=wait_exponential(multiplier=1, min=2, max=30),
    retry=retry_if_exception_type((ConnectionError, TimeoutError, IOError)),
    before_sleep=lambda rs: _logger.warning(f"Retry {rs.attempt_number}/${i} for ${e}")
)
def _exec_${c}():
${d}
    return df_${l}

try:
    _exec_${c}()
except Exception as e:
    _logger.error(f"[FAILED] ${e}: {e}")
    raise`}function Ii(e,n,t,s,a){if(!e.includes("subprocess.run")&&!e.includes("_sp.run"))return e;const o=(a||{})["Input Source"]||"";if(o.toLowerCase().includes("flowfile")||o.toLowerCase().includes("content")){const i=e.match(/(?:subprocess\.run|_sp\.run)\(\s*(?:"([^"]+)"|'([^']+)'|\[([^\]]+)\])/),r=i?i[1]||i[2]||i[3]:"echo";return`# ${n} — distributed via Pandas UDF (per-row execution)
from pyspark.sql.functions import pandas_udf, col
import pandas as pd
import subprocess

@pandas_udf("string")
def _exec_cmd_${t}(rows: pd.Series) -> pd.Series:
    """Execute command per row — runs on workers, not driver"""
    results = []
    for row_val in rows:
        try:
            _r = subprocess.run(${JSON.stringify(r)}.split(), input=str(row_val), capture_output=True, text=True, timeout=30)
            results.append(_r.stdout.strip() if _r.returncode == 0 else f"ERROR: {_r.stderr[:100]}")
        except Exception as e:
            results.append(f"ERROR: {str(e)[:100]}")
    return pd.Series(results)

df_${t} = df_${s}.withColumn("_cmd_result", _exec_cmd_${t}(col("value")))
print(f"[CMD] Distributed execution via Pandas UDF")`}return e}const Fi=[{pattern:/\b(ssn|social.?security|ss_num)\b/i,field:"SSN"},{pattern:/\b(mrn|medical.?record|patient.?id|patient_number)\b/i,field:"MRN"},{pattern:/\b(dob|date.?of.?birth|birth.?date|birthdate)\b/i,field:"DOB"},{pattern:/\b(patient|patient.?name|first.?name|last.?name|full.?name)\b/i,field:"Patient Name"},{pattern:/\b(diagnosis|icd.?\d{1,2}|cpt.?code|procedure.?code|drg)\b/i,field:"Diagnosis/Code"},{pattern:/\b(phone|fax|email|address|zip.?code|street)\b/i,field:"Contact Info"},{pattern:/\b(insurance|policy.?number|member.?id|subscriber)\b/i,field:"Insurance"},{pattern:/\b(prescription|medication|rx_|drug.?name|ndc)\b/i,field:"Medication"},{pattern:/\b(lab.?result|test.?result|vital|blood.?pressure|heart.?rate)\b/i,field:"Clinical Data"},{pattern:/\b(account.?number|billing|charge|payment)\b/i,field:"Financial/Billing"}];function Ys(e){const n=[],t=JSON.stringify(e||{}).toLowerCase();Fi.forEach(a=>{a.pattern.test(t)&&(Object.keys(e||{}).forEach(o=>{a.pattern.test(o)&&n.push({key:o,category:a.field})}),Object.values(e||{}).forEach(o=>{typeof o=="string"&&a.pattern.test(o)&&n.push({key:o.substring(0,50),category:a.field})}))});const s=new Set;return n.filter(a=>s.has(a.key)?!1:(s.add(a.key),!0))}function Li(e,n){const{NIFI_DATABRICKS_MAP:t,ROLE_FALLBACK_TEMPLATES:s,parseVariableRegistry:a,resolveVariables:o,translateNELtoPySpark:i,generateRetryWrapper:r,wrapSubprocessAsPandasUDF:c,detectPHIFields:l}=n,d=e.controllerServices||[],u=a(e),f=Object.keys(u).length>0,p=e.processors||[],h=e.connections||[],m={};h.forEach(w=>{m[w.destinationName]||(m[w.destinationName]={inputs:[],outputs:[]}),m[w.destinationName].inputs.push(w.sourceName),m[w.sourceName]||(m[w.sourceName]={inputs:[],outputs:[]}),m[w.sourceName].outputs.push(w.destinationName)});const g=mi(p,h),_={};function E(w){if(_[w])return _[w];const x=hi(w,d);return x&&(_[w]=x),x}return p.map(w=>{const x=Ce(w.type),b=t[w.type],S=ye(w.name),y=m[w.name]&&m[w.name].inputs||[],C=y.length?ye(y[0]):"input";if(b){const A=w.properties||{};if(f)for(const[O,L]of Object.entries(A))typeof L=="string"&&(A[O]=o(L,u));let{code:T,conf:I}=li(b,S,C,y,A,i,(O,L)=>gi(O,L,i),w.name);T=T.replace(/\{(\w+)\}/g,"<$1>");const v=[w,A,S,C,T,I],M=_i(...v)||vi(...v)||bi(w,A,S,C,T,I,i)||yi(w,A,S,C,T,I,i)||ki(...v)||Si(...v)||wi(...v)||Ei(...v)||Ci(...v)||xi(...v)||Pi(...v)||Ti(...v)||Di(...v)||Ri(...v);if(M&&(T=M.code,I=M.conf),/^(ExecuteSQL|QueryDatabase|GenerateTableFetch|PutDatabaseRecord|PutSQL|SelectHiveQL)/.test(w.type)){const O=A["Database Connection Pooling Service"]||A["JDBC Connection Pool"]||"",L=E(O);if(L&&L.jdbcUrl){const F=L.jdbcUrl,G=L.driver||"",z=L.user||"",ne=A["SQL select query"]||A["SQL Statement"]||"",de=A["Table Name"]||"";if(/ExecuteSQL|QueryDatabase|GenerateTableFetch|SelectHiveQL/.test(w.type)){const re=ne?`"(${ne.replace(/"/g,'\\"').substring(0,300)}) AS subq"`:`"${de}"`;T=`# SQL: ${w.name} [CS: ${L.name}]
# JDBC: ${F}
# Driver: ${G}
df_${S} = (spark.read
  .format("jdbc")
  .option("url", "${F}")
  .option("dbtable", ${re})
  .option("driver", "${G}")
  .option("user", dbutils.secrets.get(scope="db", key="${z||"user"}"))
  .option("password", dbutils.secrets.get(scope="db", key="pass"))
  .load()
)
print(f"[SQL] Read from ${de||"query"} via ${L.name}")`,I=.95}else{const re=A["Schema Name"]?`${A["Schema Name"]}.${de}`:de;T=`# DB Write: ${w.name} [CS: ${L.name}]
# JDBC: ${F}
(df_${C}.write
  .format("jdbc")
  .option("url", "${F}")
  .option("dbtable", "${re}")
  .option("driver", "${G}")
  .option("user", dbutils.secrets.get(scope="db", key="${z||"user"}"))
  .option("password", dbutils.secrets.get(scope="db", key="pass"))
  .option("batchsize", 1000)
  .mode("append")
  .save()
)
print(f"[DB] Wrote to ${re} via ${L.name}")`,I=.95}}}if(/Kafka/.test(w.type)){const O=A["Kafka Client Service"]||"",L=E(O);if(L&&L.props){const F=L.props["bootstrap.servers"]||L.props["Kafka Brokers"]||"";F&&!T.includes(F)&&(T=T.replace(/kafka[_.]?[a-z]*:9092/gi,F))}}if(/ConvertRecord|ValidateRecord|LookupRecord|PutRecord|QueryRecord|PartitionRecord|SplitRecord|ForkRecord|SampleRecord|UpdateRecord/.test(w.type)){const O=A["Record Reader"]||"",L=A["Record Writer"]||"",F=E(O),G=E(L),z=F?F.format||"json":/CSV/i.test(O)?"csv":/Avro/i.test(O)?"avro":"json",ne=G?G.format||"json":/CSV/i.test(L)?"csv":/Avro/i.test(L)?"avro":"json";(!T||T.includes("{"))&&(T=`# ${w.type}: ${w.name}
# Reader: ${O} (${z}) | Writer: ${L} (${ne})
df_${S} = df_${C}
# Input format: ${z}, Output format: ${ne}
# Write: df_${S}.write.format("${ne}").save("/path/output")
print(f"[RECORD] ${w.type} — ${z} -> ${ne}")`,I=.93)}const K=g.has(w.name);T=fi(T,w.name,S,C,K),K&&!T.includes("readStream")&&!T.includes("writeStream")&&!T.includes("foreachBatch")&&(T=`# ⚠ STREAMING CONTEXT: upstream is a streaming source
# Ensure all operations are streaming-compatible
`+T);const U=A["Penalty Duration"]||"30 sec",Y=A["Yield Duration"]||"1 sec",j=A["Max Retries"]||A["Retry Count"]||"3";T=r(w.name,w.type,T,U,Y,parseInt(j)||3),T=c(T,w.name,S,C,A);const X=l(A);return X.length>0&&(T=`# ⚠ PHI/HIPAA WARNING: Protected health information detected
# Fields: `+X.map(O=>O.key+" ("+O.category+")").join(", ")+`
# All PHI fields are hashed (SHA-256) in DLQ writes
`+T),{name:w.name,type:w.type,group:w.group,role:x,mapped:!0,confidence:I,category:b.cat,code:T,desc:b.desc,notes:b.notes,imports:b.imp||[],state:w.state}}const P=s[x]||s.process,R=`${P.tpl}
# Original: ${w.name} (${w.type}) in ${w.group||"root"}`;return{name:w.name,type:w.type,group:w.group,role:x,mapped:!1,confidence:P.conf,category:"Manual Migration",code:R,desc:P.desc,notes:"Role-based template. Manual implementation required.",imports:[],state:w.state,gapReason:`No direct mapping - ${x}-based template provided`,fallbackUsed:!0}})}const Ni={NIFI_DATABRICKS_MAP:Ot,ROLE_FALLBACK_TEMPLATES:$i,parseVariableRegistry:ri,resolveVariables:si,translateNELtoPySpark:oi,generateRetryWrapper:Ai,wrapSubprocessAsPandasUDF:Ii,detectPHIFields:Ys};function br(e){return Li(e,Ni)}function Oi(e,n){const t=n.connections||[],s={},a={};(n.processors||[]).forEach(r=>{a[r.id]=r});const o={},i={};return t.forEach(r=>{o[r.sourceName]||(o[r.sourceName]=[]),o[r.sourceName].push({dest:r.destinationName,rel:r.relationship||"success"}),i[r.destinationName]||(i[r.destinationName]=[]),i[r.destinationName].push({src:r.sourceName,rel:r.relationship||"success"})}),e.forEach(r=>{const c=ye(r.name),l=(i[r.name]||[]).map(u=>({varName:"df_"+ye(u.src),procName:u.src,relationship:u.rel})),d=(o[r.name]||[]).map(u=>({varName:"df_"+ye(u.dest),procName:u.dest,relationship:u.rel}));s[r.name]={outputVar:"df_"+c,inputVars:l,outputTargets:d,role:r.role,type:r.type}}),s}const Mi=new Set(["pyspark.sql.functions","pyspark.sql.types","pyspark.sql.streaming","pyspark.sql.window","pyspark.sql","pyspark","datetime","json","logging","os","re","hashlib","base64","subprocess","mimetypes","socket","smtplib","email","functools","xml.etree","csv","io","collections","math","sys","time","typing","uuid","pathlib","struct","itertools"]);function Bi(e,n){const t={pyspark:new Set(["from pyspark.sql.functions import *","from pyspark.sql.types import *"]),python:new Set(["from datetime import datetime, timedelta","import json","import logging"]),databricks:new Set,thirdParty:new Set},s=new Set;e.forEach(l=>{(l.imports||[]).forEach(d=>{d.includes("pyspark")?t.pyspark.add(d):d.includes("dbutils")||d.includes("databricks")?t.databricks.add(d):t.python.add(d);const u=d.replace(/^(?:from|import)\s+/,"").split(/[\s.]/)[0];u&&!Mi.has(u)&&!u.startsWith("pyspark")&&!u.startsWith("dbutils")&&!u.startsWith("databricks")&&s.add(u)}),l.code&&(l.code.includes("requests.")&&(t.thirdParty.add("import requests"),s.add("requests")),l.code.includes("subprocess")&&t.python.add("import subprocess"),l.code.includes("re.")&&t.python.add("import re"),l.code.includes("os.")&&t.python.add("import os"),l.code.includes("hashlib")&&t.python.add("import hashlib"),l.code.includes("base64")&&t.python.add("import base64"),l.code.includes("xml.etree")&&t.python.add("import xml.etree.ElementTree as ET"),(l.code.includes("readStream")||l.code.includes("writeStream"))&&t.pyspark.add("from pyspark.sql.streaming import StreamingQuery"),l.code.includes("Window")&&t.pyspark.add("from pyspark.sql.window import Window"),l.code.includes("paramiko")&&s.add("paramiko"),l.code.includes("geoip2")&&s.add("geoip2"),l.code.includes("lxml")&&s.add("lxml"),l.code.includes("gnupg")&&s.add("python-gnupg"),l.code.includes("tenacity")&&s.add("tenacity"),l.code.includes("tweepy")&&s.add("tweepy"),(l.code.includes("BeautifulSoup")||l.code.includes("bs4"))&&s.add("beautifulsoup4"),l.code.includes("cryptography")&&s.add("cryptography"))});let a=`# ═══════════════════════════════════════════
# IMPORTS — Auto-collected from all processors
# ═══════════════════════════════════════════

`;a+=`# PySpark
`+[...t.pyspark].filter(l=>!l.startsWith("#")).sort().join(`
`);const o=[...t.python].filter(l=>!l.startsWith("#")).sort();o.length&&(a+=`

# Python Standard Library
`+o.join(`
`));const i=[...t.databricks].filter(l=>!l.startsWith("#")).sort();i.length&&(a+=`

# Databricks
`+i.join(`
`));const r=[...t.thirdParty].filter(l=>!l.startsWith("#")).sort();r.length&&(a+=`

# Third-party
`+r.join(`
`));let c=null;return s.size>0&&(c={type:"code",role:"setup",label:"Install Dependencies",source:`# Install required packages
`+[...s].sort().map(d=>`%pip install ${d}`).join(`
`)+`
dbutils.library.restartPython()`}),{code:a,all:t,pipCell:c}}function ji(e,n){const t=n.connections||[],s={};e.forEach((d,u)=>{s[d.name]=u});const a={},o={};e.forEach(d=>{a[d.name]=[],o[d.name]=0}),t.forEach(d=>{s[d.sourceName]!==void 0&&s[d.destinationName]!==void 0&&(a[d.sourceName].push(d.destinationName),o[d.destinationName]=(o[d.destinationName]||0)+1)});const i=[];e.forEach(d=>{(o[d.name]||0)===0&&i.push(d.name)});const r=[],c=new Set,l={source:0,route:1,transform:2,process:3,sink:4,utility:5};for(;i.length;){i.sort((u,f)=>{const p=e[s[u]],h=e[s[f]];return(l[p.role]||3)-(l[h.role]||3)});const d=i.shift();c.has(d)||(c.add(d),r.push(e[s[d]]),(a[d]||[]).forEach(u=>{o[u]--,o[u]<=0&&!c.has(u)&&i.push(u)}))}return e.forEach(d=>{c.has(d.name)||r.push(d)}),r}function qi(e,n){const t=(n.processors||[]).find(r=>r.name===e.name);if(!t)return{used:{},unused:{},all:{}};const s=t.properties||{},a=new Set,o=["Input Directory","File Filter","Output Directory","Directory","Database Connection Pooling Service","SQL select query","Table Name","Record Reader","Record Writer","Kafka Brokers","Topic Name","Group ID","Routing Strategy","JDBC Connection URL","Conflict Resolution Strategy","Log Level","Log Message","Command","Command Arguments"];Object.entries(s).forEach(([r])=>{o.some(c=>r.includes(c))&&a.add(r)});const i={};return Object.entries(s).forEach(([r,c])=>{a.has(r)||(i[r]=c)}),{used:Object.fromEntries([...a].map(r=>[r,s[r]])),unused:i,all:s}}function Ui({flowName:e,totalProcessors:n,mappedCount:t,coveragePct:s,qualifiedSchema:a}){return{type:"md",label:"Header",source:`# NiFi Migration: ${e}
Generated by SEG Demo | ${new Date().toISOString().split("T")[0]}

**Processors:** ${n} | **Mapped:** ${t} | **Coverage:** ${s}%

**Target:** ${a}

**Enhancements:** DataFrame Lineage | Smart Imports | Topo-Sort | Adaptive Code | Error Framework | Auto Recovery | Full Properties | Relationship Routing | Exec Report | E2E Validation`,role:"config"}}function zi({smartImportsCode:e,catalogName:n,schemaName:t,secretScope:s}){let a=e+`

# Databricks notebook configuration
spark.conf.set("spark.sql.adaptive.enabled", "true")`;n&&(a+=`
spark.sql("USE CATALOG \`${n}\`")`),a+=`
spark.sql("USE SCHEMA \`${t}\`")`,s&&(a+=`

SECRET_SCOPE = "${s}"`);const o=n?`/Volumes/${n}/${t}/checkpoints`:Te.workspacePath+"/checkpoints";return a+=`

# Config-driven paths (no hardcoded /tmp/ or /mnt/)`,a+=`
CHECKPOINT_BASE = "${o}"`,a+=`
VOLUMES_BASE = "${n?`/Volumes/${n}/${t}`:"/Volumes/main/default"}"`,a+=`
print(f"Notebook initialized — Spark version: {spark.version}")`,{type:"code",label:"Imports & Config",source:a,role:"config"}}function Gi({catalogName:e,schemaName:n,qualifiedSchema:t,tables:s}){if(!s||s.length===0)return null;let a="";return e&&(a+=`CREATE CATALOG IF NOT EXISTS ${e};
USE CATALOG ${e};
`),a+=`CREATE SCHEMA IF NOT EXISTS ${n};
USE SCHEMA ${n};
`,s.forEach(o=>{a+=`
CREATE TABLE IF NOT EXISTS ${t}.${o.name} (
`,a+=o.columns.map(i=>`  ${i.name} ${(i.data_type||i.type||"STRING").toUpperCase()}`).join(`,
`),a+=`
) USING DELTA;`}),{type:"sql",label:"Unity Catalog Setup",source:a,role:"config"}}function Hi(e,n,t){const s=ye(e.name);return e.role==="source"&&e.mapped&&e.code?"# Adaptive format detection for "+e.name+`
def _detect_format_`+s+`(path):
    import os
    ext = os.path.splitext(path)[1].lower() if path else ""
    fmt_map = {".csv":"csv",".tsv":"csv",".json":"json",".jsonl":"json",
               ".parquet":"parquet",".avro":"avro",".orc":"orc",".xml":"xml"}
    if ext in fmt_map: return fmt_map[ext]
    try:
        head = dbutils.fs.head(path, 4)
        if head.startswith("PAR1"): return "parquet"
        if head.startswith("{"): return "json"
    except: pass
    return "csv"

`+e.code:e.code}function Wi(e,n,t,s){if(!e.mapped||!e.code||e.code.startsWith("# TODO"))return e.code;const a=ye(e.name),o=s[e.name]||{},i=o.outputVar||"df_"+a,r=e.code.split(`
`).map(h=>"        "+h).join(`
`),c=e.name.replace(/"/g,'\\"').replace(/'/g,"''"),l=e.type.replace(/'/g,"''"),d=e.role.replace(/'/g,"''"),u=(e.desc||"").replace(/'/g,"''"),f=(e.notes||"").replace(/'/g,"''"),p=(o.inputVars||[]).map(h=>h.procName.replace(/'/g,"''")).join(",");return"# ["+d.toUpperCase()+"] "+e.name+`
# `+u+(f?"  |  "+f:"")+`
_cell_start_`+a+` = datetime.now()
_cell_status_`+a+` = "SUCCESS"
_cell_error_`+a+` = ""
_cell_rows_`+a+` = 0
try:
`+r+`
        try: _cell_rows_`+a+" = "+i+`.count()
        except: pass
        print(f"[OK] `+c+" ({_cell_rows_"+a+`} rows)")
        spark.sql(f"""INSERT INTO `+n+`.__execution_log VALUES (
            '`+c+"', '"+l+"', '"+d+`',
            current_timestamp(), '{_cell_status_`+a+`}',
            '{_cell_error_`+a+"}', {_cell_rows_"+a+`},
            '{str(datetime.now() - _cell_start_`+a+`)}',
            `+Math.round(e.confidence*100)+`,
            '`+p+`'
        )""")
except Exception as _e:
        _cell_status_`+a+` = "FAILED"
        _cell_error_`+a+` = str(_e).replace("'", "''")
        print(f"[ERROR] `+c+`: {_e}")
        spark.sql(f"""INSERT INTO `+n+`.__execution_log VALUES (
            '`+c+"', '"+l+"', '"+d+`',
            current_timestamp(), '{_cell_status_`+a+`}',
            '{_cell_error_`+a+"}', {_cell_rows_"+a+`},
            '{str(datetime.now() - _cell_start_`+a+`)}',
            `+Math.round(e.confidence*100)+`,
            '`+p+`'
        )""")`}function Qi(e,n,t){if(!e.mapped||!e.code||e.code.startsWith("# TODO"))return"";const s=ye(e.name),a=t[e.name]||{},o=a.inputVars&&a.inputVars.length?a.inputVars[0].varName:"df_input",i=a.outputVar||"df_"+s,r=e.name.replace(/"/g,'\\"');return e.role==="source"?`
        # RECOVERY: Try relaxed schema
        try:
            `+i+` = spark.read.option("mode","PERMISSIVE").option("inferSchema","true").option("header","true").csv("/Volumes/fallback")
            _cell_status_`+s+` = "RECOVERED"
            print(f"[RECOVERED] `+r+`")
        except Exception as _e2:
            `+i+` = spark.createDataFrame([], "col1 STRING")
            print(f"[FALLBACK] `+r+' — empty df: {_e2}")':e.role==="transform"||e.role==="process"?`
        # RECOVERY: Pass through input
        try:
            `+i+" = "+o+`
            _cell_status_`+s+` = "PASSTHROUGH"
            print(f"[PASSTHROUGH] `+r+`")
        except: print(f"[SKIP] `+r+'")':e.role==="sink"?`
        # RECOVERY: Write to DLQ
        try:
            `+o+'.limit(1000).write.mode("append").saveAsTable("'+n+`.__dead_letter_queue")
            _cell_status_`+s+` = "DLQ"
            print(f"[DLQ] `+r+`")
        except: print(f"[LOST] `+r+'")':""}function Ki(e,n,t){const a=(n.connections||[]).filter(c=>c.sourceName===e.name);if(a.length<=1)return"";const o=ye(e.name),i={};if(a.forEach(c=>{const l=c.relationship||"success";i[l]||(i[l]=[]),i[l].push(c.destinationName)}),Object.keys(i).length<=1)return"";let r=`
# ── Relationship Routing for `+e.name+` ──
`;return Object.entries(i).forEach(([c,l])=>{const d=l.map(u=>"df_"+ye(u));c==="success"||c==="matched"||c==="valid"?(r+='# Route "'+c+'" -> '+l.join(", ")+`
`,d.forEach(u=>{r+=u+" = df_"+o+`  # success path
`})):c==="failure"||c==="unmatched"||c==="invalid"?r+='# Route "'+c+'" -> '+l.join(", ")+` (error path)
`:(r+='# Route "'+c+'" -> '+l.join(", ")+`
`,d.forEach(u=>{r+=u+" = df_"+o+"_"+ye(c)+`  # conditional
`}))}),r}function Ji(e,{lineage:n,qualifiedSchema:t,nifi:s,fullProps:a,cellIndex:o}){const i=`[${e.role.toUpperCase()}] ${e.name} → ${e.category}`,r=n[e.name]||{},c=(r.inputVars||[]).map(h=>`${h.varName} (${h.relationship})`).join(", ")||"none";let l=Hi(e);const d=a||{unused:{}},u=Object.keys(d.unused).length>0?`
# Unused NiFi properties:
`+Object.entries(d.unused).slice(0,8).map(([h,m])=>"#   "+h+": "+String(m).substring(0,80)).join(`
`):"",f=Ki(e,s);let p;return e.mapped&&e.code&&!e.code.startsWith("# TODO")?(p=Wi(e,t,o,n),p+=Qi(e,t,n)):p=`# ${i}
# ${e.desc}${e.notes?"  |  "+e.notes:""}
# Input: ${c}
${l}`,p=`# Input lineage: ${c}
# Output: ${r.outputVar||"df_"+ye(e.name)}${u}
${p}${f}`,{type:"code",label:i,source:p,role:e.role,processor:e.name,procType:e.type,confidence:e.confidence,mapped:e.mapped}}function Zi(e,n){return`# ═══════════════════════════════════════════════════════════
# EXECUTION REPORT GENERATOR
# ═══════════════════════════════════════════════════════════
import json
from datetime import datetime

_exec_report = {
    "pipeline_name": "`+n+`",
    "generated_at": datetime.now().isoformat(),
    "total_processors": `+e.length+`,
    "mapped_processors": `+e.filter(t=>t.mapped).length+`,
    "coverage_pct": `+Math.round(e.filter(t=>t.mapped).length/Math.max(e.length,1)*100)+`,
    "processors": []
}

try:
    _exec_rows = spark.sql("""
        SELECT processor_name, processor_type, role, status, error_message,
               rows_processed, duration, confidence, upstream_procs
        FROM `+n+`.__execution_log ORDER BY timestamp
    """).collect()
    for _r in _exec_rows:
        _exec_report["processors"].append({
            "name": _r.processor_name, "type": _r.processor_type,
            "role": _r.role, "status": _r.status,
            "error": _r.error_message or "", "rows": _r.rows_processed or 0,
            "duration": _r.duration or "", "confidence": _r.confidence or 0
        })
except Exception as _e:
    print(f"[WARN] Could not read execution log: {_e}")

_successes = len([p for p in _exec_report["processors"] if p.get("status") == "SUCCESS"])
_failures = len([p for p in _exec_report["processors"] if p.get("status") == "FAILED"])
_recovered = len([p for p in _exec_report["processors"] if p.get("status") in ("RECOVERED","PASSTHROUGH","DLQ")])
_exec_report["summary"] = {"successes":_successes,"failures":_failures,"recovered":_recovered,
    "success_rate":round(_successes/max(len(_exec_report["processors"]),1)*100,1)}

try:
    _report_df = spark.createDataFrame([{"report_json":json.dumps(_exec_report),
        "generated_at":datetime.now().isoformat(),
        "success_rate":_exec_report["summary"]["success_rate"],
        "total_procs":_successes+_failures+_recovered}])
    _report_df.write.mode("append").saveAsTable("`+n+`.__execution_reports")
except: pass

print("=" * 60)
print("EXECUTION REPORT")
print("=" * 60)
print(f"Successes: {_successes} | Failures: {_failures} | Recovered: {_recovered}")
print(f"Success Rate: {_exec_report['summary']['success_rate']}%")
print("=" * 60)`}function Vi(e,n,t){const s=e.filter(r=>r.role==="source"),a=e.filter(r=>r.role==="sink");let o=s.slice(0,20).map(r=>{const c="df_"+ye(r.name);return'try: _source_vars["'+r.name+'"] = '+c+`.count()
except: _source_vars["`+r.name+'"] = -1'}).join(`
`),i=a.slice(0,20).map(r=>{const c="df_"+ye(r.name);return'try: _sink_vars["'+r.name+'"] = '+c+`.count()
except: _sink_vars["`+r.name+'"] = -1'}).join(`
`);return`# ═══════════════════════════════════════════════════════════
# END-TO-END VALIDATION
# ═══════════════════════════════════════════════════════════
import json
_source_vars = {}
_sink_vars = {}
`+o+`
`+i+`

_validation_report = {
    "pipeline": "`+n+`",
    "timestamp": datetime.now().isoformat(),
    "source_row_counts": _source_vars,
    "sink_row_counts": _sink_vars,
    "total_source_rows": sum(v for v in _source_vars.values() if v > 0),
    "total_sink_rows": sum(v for v in _sink_vars.values() if v > 0)
}
_src_total = _validation_report["total_source_rows"]
_snk_total = _validation_report["total_sink_rows"]
if _src_total > 0 and _snk_total > 0:
    _retention = round(_snk_total / _src_total * 100, 1)
    _validation_report["data_retention_pct"] = _retention
    print(f"Data retention: {_retention}%")

try:
    _val_df = spark.createDataFrame([{"report_json":json.dumps(_validation_report),
        "validated_at":datetime.now().isoformat(),
        "source_rows":_src_total,"sink_rows":_snk_total}])
    _val_df.write.mode("append").saveAsTable("`+n+`.__validation_reports")
except: pass

print("=" * 60)
print("END-TO-END VALIDATION COMPLETE")
print("=" * 60)
print(json.dumps(_validation_report, indent=2))`}function Xi(e,n,t){if(!e||e.length<2)return null;const s=e.map(c=>n.find(l=>l.name===c)).filter(Boolean);if(s.length===0)return null;const a=s.some(c=>/InvokeHTTP|PostHTTP|GetHTTP/i.test(c.type)),o=ye(e[0]),i=Yi(s,t);if(a){const c=i||"    result = df  # passthrough (no mapped code)";return`# Cycle detected: ${e.join(" → ")} → (loop back)
# Pattern: API retry loop — converted to tenacity retry
from tenacity import retry, stop_after_attempt, wait_exponential, RetryError

@retry(stop=stop_after_attempt(5), wait=wait_exponential(multiplier=1, min=2, max=60))
def _retry_loop_${o}(df):
    """Retry loop for: ${e.join(" → ")}"""
    result = df
${c}
    return result

try:
    df_${o} = _retry_loop_${o}(df_${o})
except RetryError:
    print(f"[LOOP] Retry cycle exhausted for ${e[0]}")`}const r=i||"    _loop_result = _loop_df_"+o+"  # passthrough (no mapped code)";return`# Cycle detected: ${e.join(" → ")} → (loop back)
# Pattern: Conditional loop — converted to while iteration
_max_iterations = 100
_iteration = 0
_loop_df_${o} = df_${o}
while _iteration < _max_iterations:
    _iteration += 1
${r}
    if _loop_result.count() == 0:
        break  # No more records to process
    _loop_df_${o} = _loop_result
df_${o} = _loop_df_${o}
print(f"[LOOP] Completed {_iteration} iterations for ${e[0]}")`}function Yi(e,n){const t=[];for(const s of e){if(!s.mapped||!s.code||s.code.startsWith("# TODO"))continue;const o=(n[s.name]||{}).outputVar||"df_"+ye(s.name);t.push(`    # --- ${s.name} (${s.type}) ---`);const i=s.code.split(`
`).map(r=>"    "+r).join(`
`);t.push(i),t.push(`    result = ${o}`)}return t.length>0?t.join(`
`):null}function ec(e){const n=[];return e&&e.forEach((t,s)=>{const a=typeof t=="string"?t:t.code||t.textContent||"",o=[],i=a.match(/\{[a-z_]+\}/g)||[];i.length>3&&o.push(`${i.length} unresolved placeholders: ${i.slice(0,3).join(", ")}...`);const r=(a.match(/\(/g)||[]).length,c=(a.match(/\)/g)||[]).length;Math.abs(r-c)>2&&o.push(`Unbalanced parentheses: ${r} open, ${c} close`);const l=a.match(/\$\{[^}]+\}/g)||[];l.length>0&&o.push(`${l.length} unresolved NiFi EL expressions: ${l.slice(0,2).join(", ")}...`);const d=new Set;a.includes("requests.")&&d.add("requests"),a.includes("boto3.")&&d.add("boto3"),a.includes("paramiko.")&&d.add("paramiko"),a.includes("pika.")&&d.add("pika"),a.includes("stomp.")&&d.add("stomp"),a.includes("pymongo")&&d.add("pymongo"),a.includes("elasticsearch")&&d.add("elasticsearch");const u=new Set;(a.match(/^import\s+(\w+)/gm)||[]).forEach(p=>u.add(p.replace("import ",""))),(a.match(/^from\s+(\w+)/gm)||[]).forEach(p=>u.add(p.replace("from ","")));const f=[...d].filter(p=>!u.has(p));f.length>0&&o.push(`Missing imports: ${f.join(", ")}`),n.push({cellIndex:s,valid:o.length===0,issues:o})}),n}function eo(e,n,t,s){s=s||{};const a=s.catalog||"",o=s.schema||"nifi_migration",i=a?`${a}.${o}`:o,r=[],c=Oi(e,n),l=Bi(e),d=ji(e,n),u={};d.forEach(S=>{u[S.name]=qi(S,n)});const f=n.processGroups&&n.processGroups[0]?n.processGroups[0].name:"NiFi Flow",p=d.filter(S=>S.mapped).length,h=Math.round(p/d.length*100);r.push(Ui({flowName:f,totalProcessors:d.length,mappedCount:p,coveragePct:h,qualifiedSchema:i})),l.pipCell&&r.push(l.pipCell),r.push(zi({smartImportsCode:l.code,catalogName:a,schemaName:o,secretScope:s.secretScope})),r.push({type:"code",label:"Execution Framework Setup",source:`# Execution Tracking Framework
from datetime import datetime

spark.sql(f"""
CREATE TABLE IF NOT EXISTS ${i}.__execution_log (
  processor_name STRING, processor_type STRING, role STRING,
  timestamp TIMESTAMP DEFAULT current_timestamp(), status STRING,
  error_message STRING, rows_processed LONG, duration STRING,
  confidence INT, upstream_procs STRING
) USING DELTA TBLPROPERTIES ('delta.autoOptimize.optimizeWrite' = 'true')
""")

spark.sql(f"""
CREATE TABLE IF NOT EXISTS ${i}.__dead_letter_queue (
  source_processor STRING, error STRING, record_data STRING,
  timestamp STRING, _ingested_at TIMESTAMP DEFAULT current_timestamp()
) USING DELTA TBLPROPERTIES ('delta.autoOptimize.optimizeWrite' = 'true')
""")

spark.sql(f"""
CREATE TABLE IF NOT EXISTS ${i}.__execution_reports (
  report_json STRING, generated_at STRING, success_rate DOUBLE, total_procs INT
) USING DELTA
""")

spark.sql(f"""
CREATE TABLE IF NOT EXISTS ${i}.__validation_reports (
  report_json STRING, validated_at STRING, source_rows LONG, sink_rows LONG
) USING DELTA
""")

print(f"[FRAMEWORK] Execution tracking ready: ${i}")`,role:"utility",processor:"Framework Setup",procType:"Internal",confidence:1,mapped:!0});const m=t&&t.tables||[],g=Gi({catalogName:a,schemaName:o,qualifiedSchema:i,tables:m});g&&r.push(g);const _=Object.entries(c).slice(0,30).map(([S,y])=>{const C=(y.inputVars||[]).map(P=>P.procName).join(", ")||"(source)";return`# ${y.outputVar} <- ${C}`}).join(`
`);r.push({type:"code",label:"DataFrame Lineage Map",source:`# DataFrame Lineage Map
${_}
${Object.keys(c).length>30?"# ... and "+(Object.keys(c).length-30)+" more":""}
print("[LINEAGE] DataFrame lineage map loaded — ${Object.keys(c).length} variables tracked")`,role:"config"});const E={};d.forEach(S=>{E[S.group]||(E[S.group]=[]),E[S.group].push(S)});let w=r.length;Object.entries(E).forEach(([S,y])=>{const C=y.filter(P=>P.mapped).length;r.push({type:"md",label:S,source:`## Process Group: ${S}
**${y.length} processors** | ${C} mapped | ${y.length-C} manual

*Cells ordered by connection topology*`,role:"config"}),y.forEach(P=>{w++,r.push(Ji(P,{lineage:c,qualifiedSchema:i,nifi:n,fullProps:u[P.name],cellIndex:w}))})}),r.push({type:"code",label:"Execution Report",source:Zi(d,i),role:"utility",processor:"ExecutionReport",procType:"Internal",confidence:1,mapped:!0}),r.push({type:"code",label:"End-to-End Validation",source:Vi(d,i),role:"utility",processor:"E2EValidation",procType:"Internal",confidence:1,mapped:!0}),r.push({type:"sql",label:"Migration Error Table",source:`CREATE TABLE IF NOT EXISTS ${i}.__migration_errors (
  processor_name STRING, processor_type STRING,
  error_time TIMESTAMP, error_message STRING
) USING DELTA;`,role:"config"}),r.push({type:"code",label:"Pipeline Complete",source:`# Final status
import json
try:
    _exec_log = spark.sql("SELECT status, count(*) as cnt FROM ${i}.__execution_log GROUP BY status").collect()
    _counts = {r.status: r.cnt for r in _exec_log}
    _ok = _counts.get("SUCCESS", 0)
    _fail = _counts.get("FAILED", 0)
    _recov = sum(v for k,v in _counts.items() if k in ("RECOVERED","PASSTHROUGH","DLQ"))
    print("=" * 60)
    print(f"PIPELINE COMPLETE: {_ok} success, {_fail} failed, {_recov} recovered")
    print(f"Success rate: {round(_ok/max(_ok+_fail+_recov,1)*100,1)}%")
    print("=" * 60)
    if _fail > 0:
        display(spark.sql("SELECT * FROM ${i}.__execution_log WHERE status='FAILED'"))
    dbutils.notebook.exit(json.dumps({"status":"COMPLETE","success":_ok,"failed":_fail,"recovered":_recov}))
except Exception as _e:
    print(f"[WARN] Status check failed: {_e}")
    dbutils.notebook.exit("COMPLETE")`,role:"utility"});try{let S;try{S=window.analyzeFlowGraph||null}catch{S=null}if(S){const y=S(n.processors||[],n.connections||[]);y.circularRefs&&y.circularRefs.length>0&&y.circularRefs.forEach(C=>{const P=Xi(C.cycle,d,c);P&&r.push({type:"code",label:"Loop: "+C.cycle[0],source:P,role:"transform",processor:C.cycle[0],procType:"CycleLoop",confidence:.75,mapped:!0})})}}catch(S){console.warn("Cycle-to-loop generation:",S)}s.catalog&&r.forEach(S=>{S.source=_a(S.source,s)});const b=ec(r.map(S=>S.source||"")).filter(S=>!S.valid);return b.length>0&&r.push({type:"code",label:"Code Validation Report",source:`# Code Validation Report
# `+b.length+` cells with potential issues:
`+b.map(S=>"# Cell "+S.cellIndex+": "+S.issues.join("; ")).join(`
`),role:"utility",processor:"CodeValidator",procType:"Internal",confidence:1,mapped:!0}),typeof window<"u"&&(window._lastNotebookCells=r,window._lastLineage=c),{cells:r,flowName:f,lineage:c,metadata:{processorCount:d.length,mappedCount:p,generatedAt:new Date().toISOString(),config:{catalog:a,schema:o},improvements:["lineage","smartImports","topoSort","adaptiveCode","errorFramework","autoRecovery","fullProperties","relationshipRouting","executionReport","e2eValidation","nelParser","phiDetection","sharedClusters","cycleDetection","streamingGuard"]}}}function to(e,n,t){t=t||{};const s=t.workspacePath||"/Workspace/Migrations/NiFi",a=t.sparkVersion||"14.3.x-scala2.12",o=t.nodeType||"Standard_DS3_v2",i=t.numWorkers||2,r=n.connections||[],c={};(n.processors||[]).forEach(h=>{c[h.name]=h.group||"(root)"});const l=[...new Set(Object.values(c))],d={};l.forEach(h=>{d[h]=new Set}),r.forEach(h=>{const m=c[h.sourceName],g=c[h.destinationName];m&&g&&m!==g&&d[g].add(m)});const u="nifi_migration_cluster",f=[{job_cluster_key:u,new_cluster:{spark_version:a,node_type_id:o,num_workers:i,spark_conf:{"spark.databricks.delta.optimizeWrite.enabled":"true","spark.databricks.delta.autoCompact.enabled":"true","spark.sql.adaptive.enabled":"true","spark.sql.shuffle.partitions":"auto"},custom_tags:{source:"nifi_migration"}}}],p=l.map(h=>({task_key:ye(h),description:`Process group: ${h}`,notebook_task:{notebook_path:`${s}/${ye(h)}_notebook`,source:"WORKSPACE"},depends_on:[...d[h]].map(m=>({task_key:ye(m)})),job_cluster_key:u}));return{name:`NiFi_Migration_${ye(l[0]||"flow")}`,job_clusters:f,tasks:p,format:"MULTI_TASK",tags:{source:"nifi_migration",generated_by:"seg_demo"}}}const tc=["source","route","transform","process","sink","utility"],Vt={source:"#3B82F6",route:"#EAB308",transform:"#A855F7",process:"#6366F1",sink:"#21C354",utility:"#808495"};function no(e,n){const t=e.length,s=e.filter(h=>h.mapped).length,a={};tc.forEach(h=>{a[h]={total:0,mapped:0,unmapped:0,procs:[]}}),e.forEach(h=>{const m=a[h.role]||a.process;m.total++,h.mapped?m.mapped++:m.unmapped++,m.procs.push(h)});const o={};e.forEach(h=>{o[h.group]||(o[h.group]={total:0,mapped:0,unmapped:0,procs:[]}),o[h.group].total++,h.mapped?o[h.group].mapped++:o[h.group].unmapped++,o[h.group].procs.push(h)});const i=e.filter(h=>!h.mapped||h.confidence<.3).map(h=>({name:h.name,type:h.type,group:h.group,role:h.role,reason:h.gapReason||`Low confidence mapping (${Math.round(h.confidence*100)}%)`,recommendation:h.type.match(/^(Listen|Handle)/)?"Consider Databricks Model Serving or external API gateway":h.type.match(/^Execute(Script|Stream)/)?"Manual translation required — review original script logic":h.type.match(/^(Put|Send)(Email|TCP|Syslog)/)?"Use webhook notification service or Databricks workflow alerts":"Review processor documentation and implement custom PySpark logic"})),r=[];i.length>t*.2&&r.push("High gap rate — consider custom UDFs for unsupported processor types"),e.some(h=>h.type.match(/Listen|Handle/))&&r.push("HTTP endpoints detected — evaluate Databricks Model Serving for REST API replacement"),e.some(h=>h.type.match(/Consume.*Kafka|Subscribe/))&&r.push("Streaming sources present — use Structured Streaming with Auto Loader trigger intervals"),(n.controllerServices||[]).length&&r.push(`${n.controllerServices.length} controller service(s) detected — map credentials to Databricks secret scopes`),s>t*.8&&r.push("High coverage — prioritize testing the mapped processors before addressing gaps"),r.push("Run the generated notebook in a Databricks workspace to validate each cell");const c=t?Math.round(s/t*100):0,l={source:2,sink:2,transform:1,route:1.5,process:3,script:4,custom:5},d=e.reduce((h,m)=>h+(l[m.role]||2),0),u=e.filter(h=>h.mapped).reduce((h,m)=>h+(l[m.role]||2),0),f=d>0?Math.round(u/d*100):0,p=f>=85?"Low":f>=60?"Medium":"High";return{summary:{totalProcessors:t,mappedProcessors:s,unmappedProcessors:t-s,coveragePercent:c,totalProcessGroups:Object.keys(o).length,totalConnections:(n.connections||[]).length,controllerServices:(n.controllerServices||[]).length},byRole:a,byGroup:o,gaps:i,recommendations:r,effort:p}}function Ne(e,n){const t=document.getElementById(e);t&&(t.innerHTML=`<div class="alert alert-error">${V(n)}</div>`)}function vt(e){return'<div class="metrics">'+e.map(n=>{const t=Array.isArray(n)?n[0]:n.label,s=Array.isArray(n)?n[1]:n.value,a=Array.isArray(n)?n[2]:n.delta,o=Array.isArray(n)?"":n.color||"";return`<div class="metric"><div class="label">${t}</div><div class="value"${o?' style="color:'+o+'"':""}>${s}</div>${a?`<div class="delta">${a}</div>`:""}</div>`}).join("")+"</div>"}function Mt(e,n){return`<div class="table-scroll"><table><thead><tr>${e.map(t=>`<th>${t}</th>`).join("")}</tr></thead><tbody>${n.map(t=>`<tr>${t.map(s=>`<td>${s??""}</td>`).join("")}</tr>`).join("")}</tbody></table></div>`}function rr(e,n,t=!1){return`<div class="expander ${t?"open":""}"><div class="expander-header" data-expander-toggle><span>${e}</span><span class="expander-arrow">▶</span></div><div class="expander-body">${n}</div></div>`}typeof document<"u"&&document.addEventListener("click",e=>{const n=e.target.closest("[data-expander-toggle]");n&&n.parentElement.classList.toggle("open")});async function on(){const e=Os(),n=Bs(),t=document.getElementById("pasteInput"),s=e||(t?t.value:"");if(!s.trim()&&!n){Ne("parseResults","Please upload or paste a NiFi flow file (XML, JSON, SQL, or archive).");return}const a=Xe(),o=document.getElementById("parseBtn");o&&(o.disabled=!0),fe("load","processing");const i=document.getElementById("parseProgress");i&&(i.style.display="flex");const r=document.getElementById("parsePBar"),c=document.getElementById("parsePPct"),l=document.getElementById("parsePStatus"),d=(b,S)=>{r&&(r.style.width=b+"%"),c&&(c.textContent=b+"%"),l&&(l.textContent=S)};d(10,"Cleaning & parsing input..."),await new Promise(b=>setTimeout(b,20));let u;const f=Ms();try{u=await st(s,f||"NiFi Flow",{bytes:n})}catch(b){Ye(a),Ae(new Ee("Parse failed: "+b.message,{code:"PARSE_FAILED",phase:"parse",severity:"high",cause:b})),Ne("parseResults","Failed to parse: "+b.message),o&&(o.disabled=!1),fe("load","ready"),i&&(i.style.display="none");return}if(d(20,"Validating flow..."),await new Promise(b=>setTimeout(b,20)),!u||!u._nifi||u._nifi.processors.length===0){Ne("parseResults","No processors found. Supported formats: NiFi XML/JSON, SQL scripts, .gz/.zip/.nar/.jar archives, .docx/.xlsx documents."),o&&(o.disabled=!1),fe("load","ready"),i&&(i.style.display="none");return}if(d(50,"Processing flow..."),u._deferredProcessorWork)try{const b=u._deferredProcessorWork,S=50;for(let y=0;y<b.processors.length;y+=S){b.batchFn(b.processors.slice(y,y+S));const C=50+Math.round(y/b.processors.length*30);d(C,"Analyzing processor "+(y+1)+"/"+b.processors.length+"..."),await new Promise(P=>setTimeout(P,0))}b.finalize()}catch(b){Ae(new Ee("Deferred processor work failed",{code:"DEFERRED_WORK_FAILED",phase:"parse",cause:b}))}d(85,"Building resource manifest..."),await new Promise(b=>setTimeout(b,20)),Je({parsed:u,manifest:Xs(u._nifi)}),d(95,"Rendering results...");const p=u._nifi,h=Ce;let m='<div class="alert alert-success" style="margin-top:16px">Successfully parsed NiFi flow: <strong>'+V(u.source_name)+"</strong></div>";m+=vt([{label:"Processors",value:p.processors.length},{label:"Connections",value:p.connections.length},{label:"Process Groups",value:p.processGroups.length},{label:"Controller Services",value:p.controllerServices.length},{label:"External Systems",value:p.clouderaTools.length}]);const g={};p.processors.forEach(b=>{g[b.type]=(g[b.type]||0)+1});const _=Object.entries(g).sort((b,S)=>S[1]-b[1]).map(([b,S])=>{const y=h(b),C=Vt[y]||"#808495";return['<span style="color:'+C+';font-weight:600">'+V(b)+"</span>",S,'<span class="badge" style="background:'+C+"22;color:"+C+'">'+y+"</span>"]});m+=rr("Processor Types ("+Object.keys(g).length+" unique)",Mt(["Type","Count","Role"],_)),u.parse_warnings.length&&(m+=u.parse_warnings.map(b=>'<div class="alert alert-warn" style="margin:4px 0;font-size:0.85rem">'+V(b)+"</div>").join(""));const E=document.getElementById("parseResults");E&&(E.innerHTML=m),d(100,"Done!"),o&&(o.disabled=!1),fe("load","done"),ct("analyze");const w=document.getElementById("analyzeNotReady"),x=document.getElementById("analyzeReady");w&&w.classList.add("hidden"),x&&x.classList.remove("hidden"),setTimeout(()=>{i&&(i.style.display="none")},500);try{await new Promise(b=>setTimeout(b,50)),rt("analyze"),await ro(),await new Promise(b=>setTimeout(b,50)),rt("assess"),await so(),await new Promise(b=>setTimeout(b,50)),rt("convert"),await oo(),await new Promise(b=>setTimeout(b,50)),rt("report"),await ao(),await new Promise(b=>setTimeout(b,50)),typeof window.generateFinalReport=="function"&&(rt("reportFinal"),await window.generateFinalReport()),await new Promise(b=>setTimeout(b,50)),typeof window.runValidation=="function"&&(rt("validate"),await window.runValidation()),await new Promise(b=>setTimeout(b,50)),typeof window.runValueAnalysis=="function"&&(rt("value"),await window.runValueAnalysis())}catch(b){Ae(new Ee("Auto-run pipeline failed",{code:"PIPELINE_AUTO_RUN_FAILED",phase:"pipeline",cause:b}))}}async function ro(){const e=Cn("analyze");if(!e.ok){Ne("analyzeResults","Prerequisites not met: "+e.missing.join(", ")+". Please complete earlier steps first.");return}const n=le(),t=Xe();fe("analyze","processing");try{const s=n.parsed._nifi,a=n.manifest,o=_r(s),i=Pn(s);let r="";const c=Object.keys(s.deepPropertyInventory?.nifiEL||{}).length,l=s.sqlTables?s.sqlTables.length:0,d=Object.keys(s.deepPropertyInventory?.credentialRefs||{}).length,u=Object.keys(i).length;r+=vt([{label:"Processors",value:s.processors.length},{label:"Connections",value:s.connections.length},{label:"Process Groups",value:s.processGroups.length},{label:"Controller Services",value:s.controllerServices.length},{label:"External Systems",value:u},{label:"EL Expressions",value:c},{label:"SQL Tables",value:l},{label:"Credentials",value:d}]);const f=gr(n.parsed),p=Ra(f,n.parsed);r+='<hr class="divider"><h3>Flow Visualization</h3>',r+='<div id="analysisTierContainer" style="position:relative"></div><div id="analysisTierDetail"></div><div id="analysisTierLegend"></div>';const h=Object.keys(i);if(h.length&&(r+='<hr class="divider"><h3>External Systems &amp; Dependencies ('+h.length+")</h3>",r+='<p style="color:var(--text2);font-size:0.82rem;margin-bottom:8px">Detected from processor types, JDBC URLs, and properties.</p>',h.forEach(x=>{const b=i[x];let y='<div class="sys-detail-row"><span class="sys-label">Processors:</span><span class="sys-value">'+b.processors.map(C=>{const P=Ot[C.type]?Ot[C.type].conf:0;return'<span class="conf-dot '+(P>=.7?"high":P>=.3?"med":"low")+'"></span>'+V(C.name)+' <span style="color:var(--text2)">('+C.direction+")</span>"}).join("<br>")+"</span></div>";y+='<div class="sys-detail-row"><span class="sys-label">Databricks:</span><span class="sys-value">'+V(b.dbxApproach)+"</span></div>",b.jdbcUrls.length&&(y+='<div class="sys-detail-row"><span class="sys-label">JDBC:</span><span class="sys-value"><code style="font-size:0.75rem">'+b.jdbcUrls.map(C=>V(C)).join("<br>")+"</code></span></div>"),b.credentials.length&&(y+='<div class="sys-detail-row"><span class="sys-label">Credentials:</span><span class="sys-value" style="color:var(--amber)">'+b.credentials.map(C=>V(C)).join(", ")+"</span></div>"),b.packages.length&&(y+='<div class="sys-detail-row"><span class="sys-label">Packages:</span><span class="sys-value"><code>'+b.packages.join(", ")+"</code></span></div>"),r+=rr(V(b.name)+' <span style="color:var(--text2);font-size:0.8rem">('+b.processors.length+" processor"+(b.processors.length!==1?"s":"")+")</span>",y,!1)})),r+='<hr class="divider"><h3>Processor Inventory ('+s.processors.length+")</h3>",r+='<p style="color:var(--text2);font-size:0.82rem;margin-bottom:8px">Click to expand for properties, scheduling, and dependencies.</p>',s.processors.forEach(x=>{const b=Ce(x.type),S=Vt[b]||"#808495",y=Ot[x.type],C=y?y.conf:0,P=C>=.7?"high":C>=.3?"med":"low",R=o.upstream[x.name]||[],A=o.downstream[x.name]||[],T=o.fullUpstream[x.name]||[],I=o.fullDownstream[x.name]||[];let v='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">';v+='<div><strong style="font-size:0.78rem;color:var(--text2)">Type:</strong> '+V(x.type)+"</div>",v+='<div><strong style="font-size:0.78rem;color:var(--text2)">Role:</strong> <span style="color:'+S+'">'+b+"</span></div>",v+='<div><strong style="font-size:0.78rem;color:var(--text2)">Group:</strong> '+V(x.group||"(root)")+"</div>",v+='<div><strong style="font-size:0.78rem;color:var(--text2)">State:</strong> '+(x.state||"UNKNOWN")+"</div>",v+='<div><strong style="font-size:0.78rem;color:var(--text2)">Scheduling:</strong> '+(x.schedulingStrategy||"-")+" / "+(x.schedulingPeriod||"-")+"</div>",v+='<div><strong style="font-size:0.78rem;color:var(--text2)">Confidence:</strong> <span class="conf-dot '+P+'"></span>'+Math.round(C*100)+"%</div></div>",(R.length||A.length)&&(v+='<div style="display:flex;gap:16px;margin-bottom:8px;font-size:0.8rem">',R.length&&(v+='<div><strong style="color:#3B82F6">Upstream ('+T.length+"):</strong> "+R.map(U=>V(U)).join(", ")+"</div>"),A.length&&(v+='<div><strong style="color:#21C354">Downstream ('+I.length+"):</strong> "+A.map(U=>V(U)).join(", ")+"</div>"),v+="</div>");const M=Object.entries(x.properties||{});M.length&&(v+='<table style="width:100%;font-size:0.78rem;border-collapse:collapse">',M.forEach(([U,Y])=>{const j=Us(U)?"********":Y,O=Y&&Y.includes("${")?String(j).replace(/\$\{([^}]+)\}/g,'<span class="el-highlight">${$1}</span>'):V(String(j||""));v+='<tr><td style="color:var(--text2);padding:2px 6px;border-bottom:1px solid var(--border);white-space:nowrap">'+V(U)+'</td><td style="padding:2px 6px;border-bottom:1px solid var(--border);word-break:break-all">'+O+"</td></tr>"}),v+="</table>"),y&&(v+='<div style="margin-top:8px;padding:8px;background:var(--bg);border-radius:4px;font-size:0.75rem"><strong style="color:var(--green)">Databricks: </strong>'+V(y.desc)+'<br><span style="color:var(--text2)">'+V(y.notes)+"</span></div>");const K='<span class="conf-dot '+P+'"></span><span style="color:'+S+'">['+b.toUpperCase()+"]</span> "+V(x.name)+' <span style="color:var(--text2);font-size:0.8rem">'+V(x.type)+"</span>";r+=rr(K,v,!1)}),r+='<hr class="divider"><h3>Connection Map ('+s.connections.length+")</h3>",s.connections.length){const x=s.connections.map(b=>[V(b.sourceName||b.sourceId),V(b.destinationName||b.destinationId),(b.relationships||[]).map(S=>'<span class="badge" style="background:var(--surface2);font-size:0.7rem">'+V(S)+"</span>").join(" "),b.backPressure?V(b.backPressure):"-"]);r+=Mt(["Source","Destination","Relationships","Back Pressure"],x)}s.controllerServices.length&&(r+='<hr class="divider"><h3>Controller Services ('+s.controllerServices.length+")</h3>",r+=Mt(["Name","Type","State","Properties"],s.controllerServices.map(x=>[V(x.name),V(x.type),x.state||"-",Object.keys(x.properties||{}).length+" props"])));const m=Object.entries(s.deepPropertyInventory.nifiEL||{});m.length&&(r+='<hr class="divider"><h3>NiFi Expression Language ('+m.length+")</h3>",r+=Mt(["Expression","Used By"],m.slice(0,50).map(([x,b])=>['<code class="el-highlight">'+V(x.substring(0,80))+"</code>",(Array.isArray(b)?b:[b]).map(S=>V(String(S))).join(", ")])),m.length>50&&(r+='<p style="color:var(--text2);font-size:0.82rem">... and '+(m.length-50)+" more</p>"));const g={TIMER_DRIVEN:0,CRON_DRIVEN:0,EVENT_DRIVEN:0,OTHER:0};s.processors.forEach(x=>{const b=(x.schedulingStrategy||"").toUpperCase();b in g?g[b]++:g.OTHER++}),r+='<hr class="divider"><h3>Scheduling Summary</h3>',r+=vt([{label:"Timer Driven",value:g.TIMER_DRIVEN},{label:"Cron Driven",value:g.CRON_DRIVEN},{label:"Event Driven",value:g.EVENT_DRIVEN}]);const _=document.getElementById("analyzeResults");_&&(_.innerHTML=r),Je({analysis:{blueprint:f,tierData:p,depGraph:o,systems:i}}),setTimeout(()=>{try{Ga(p,"analysisTierContainer","analysisTierDetail","analysisTierLegend")}catch(x){console.error("[analyze] Tier diagram render error:",x)}},50),fe("analyze","done"),ct("assess");const E=document.getElementById("assessNotReady"),w=document.getElementById("assessReady");E&&E.classList.add("hidden"),w&&w.classList.remove("hidden")}catch(s){Ye(t),Ae(new Ee("Analysis failed: "+s.message,{code:"ANALYZE_FAILED",phase:"analyze",cause:s})),Ne("analyzeResults","Analysis failed: "+s.message),fe("analyze","ready")}}async function so(){const e=Cn("assess");if(!e.ok){Ne("assessResults","Prerequisites not met: "+e.missing.join(", ")+". Please complete earlier steps first.");return}const n=le(),t=Xe();fe("assess","processing");try{const s=n.parsed._nifi,a=br(s),o=_r(s),i=Pn(s),r=a.length,c=a.filter(K=>K.mapped&&K.confidence>=.7),l=a.filter(K=>K.mapped&&K.confidence>0&&K.confidence<.7),d=a.filter(K=>!K.mapped||K.confidence===0),u=a.filter(K=>K.mapped),f=r?c.length/r:0,p=u.length?u.reduce((K,U)=>K+U.confidence,0)/u.length:0,h=r?u.length/r:0,m=Object.keys(i).length,g=Math.max(0,1-m/20),_=Math.round(f*50+p*20+h*20+g*10),E=c.length*.5+l.length*2+d.length*5,w=Math.ceil(E/5),x=_>=75?"green":_>=40?"amber":"red",b=_>=75?"&#x1F7E2;":_>=40?"&#x1F7E1;":"&#x1F534;",S=_>=75?"HIGH READINESS":_>=40?"MODERATE READINESS":"LOW READINESS";let y='<hr class="divider">';y+='<div class="score-big" style="color:var(--'+x+')">'+b+" "+S+" &mdash; "+_+"%</div>",y+=vt([{label:"Auto-Convert",value:c.length,color:"var(--green)"},{label:"Manual",value:l.length,color:"var(--amber)"},{label:"Unsupported",value:d.length,color:"var(--red)"},{label:"Effort Est.",value:E.toFixed(0)+" days (~"+w+" wks)"}]),y+=vt([{label:"Auto-Convert % (50w)",value:Math.round(f*100)+"%"},{label:"Avg Confidence (20w)",value:Math.round(p*100)+"%"},{label:"Coverage (20w)",value:Math.round(h*100)+"%"},{label:"Simplicity (10w)",value:Math.round(g*100)+"%"}]);const C=r?c.length/r*100:0,P=r?l.length/r*100:0,R=r?d.length/r*100:0;y+='<div class="effort-bar">',C>0&&(y+='<div class="effort-seg" style="width:'+C+'%;background:var(--green)">'+c.length+" auto</div>"),P>0&&(y+='<div class="effort-seg" style="width:'+P+'%;background:var(--amber)">'+l.length+" manual</div>"),R>0&&(y+='<div class="effort-seg" style="width:'+R+'%;background:var(--red)">'+d.length+" unsupported</div>"),y+="</div>",y+='<hr class="divider"><h3>Per-Processor Confidence</h3>';const A=a.map(K=>{const U=K.confidence>=.7?"high":K.confidence>=.3?"med":"low",Y=o.fullUpstream[K.name]||[],j=o.fullDownstream[K.name]||[];return[V(K.name),'<span style="color:'+(Vt[K.role]||"#808495")+'">'+K.role+"</span>",V(K.group),'<span class="conf-dot '+U+'"></span>'+Math.round(K.confidence*100)+"%",K.mapped?V((K.desc||"").substring(0,50)):'<em style="color:var(--red)">'+(K.gapReason||"Unmapped").substring(0,50)+"</em>",K.confidence>=.7?"0.5d":K.confidence>=.3?"2d":"5d",Y.length+" up / "+j.length+" down"]});y+=Mt(["Processor","Role","Group","Confidence","Approach","Effort","Deps"],A);const T=new Set;a.forEach(K=>{yr(K.type).forEach(U=>U.pip.forEach(Y=>T.add(Y)))}),T.size&&(y+='<hr class="divider"><h3>Required Packages</h3>',y+=`<pre style="background:var(--bg);padding:12px;border-radius:6px;font-size:0.8rem"># requirements.txt
`,[...T].sort().forEach(K=>{y+=K+`
`}),y+="</pre>");const I=document.getElementById("assessResults");I&&(I.innerHTML=y),Je({assessment:{mappings:a,readinessScore:_,autoCount:c.length,manualCount:l.length,unsupportedCount:d.length,effortDays:E,systems:i,depGraph:o}}),fe("assess","done"),ct("convert");const v=document.getElementById("convertNotReady"),M=document.getElementById("convertReady");v&&v.classList.add("hidden"),M&&M.classList.remove("hidden")}catch(s){Ye(t),Ae(new Ee("Assessment failed: "+s.message,{code:"ASSESS_FAILED",phase:"assess",cause:s})),Ne("assessResults","Assessment failed: "+s.message),fe("assess","ready")}}async function oo(){const e=Cn("convert");if(!e.ok){Ne("notebookResults","Prerequisites not met: "+e.missing.join(", ")+". Please complete earlier steps first.");return}const n=le(),t=Xe();fe("convert","processing");try{const s=n.parsed._nifi,a=Ls(),o=n.assessment?.mappings||br(s),r=eo(o,s,n.analysis?n.analysis.blueprint:gr(n.parsed),a).cells,c=new Set;o.forEach(m=>{yr(m.type).forEach(g=>g.pip.forEach(_=>c.add(_)))}),c.size&&r.unshift({type:"code",role:"config",label:"Package Requirements",source:`# Install required packages
`+[...c].sort().map(m=>"# MAGIC %pip install "+m).join(`
`)+`
dbutils.library.restartPython()`});const l=to(o,s,a);Je({notebook:{mappings:o,cells:r,workflow:l,config:a}});let d='<hr class="divider">';d+="<h3>Processor Mapping</h3>";const u=o.map(m=>[V(m.name),`<span style="color:${Vt[m.role]||"#808495"}">${V(m.role)}</span>`,V(m.group||"—"),m.mapped?V(m.desc):'<em style="color:var(--text2)">No equivalent</em>',m.mapped?`<span class="conf-badge ${m.confidence>=.8?"conf-high":m.confidence>=.5?"conf-med":"conf-low"}">${Math.round(m.confidence*100)}%</span>`:'<span class="conf-badge conf-none">—</span>']);d+=`<div class="table-scroll"><table class="mapping-table"><thead><tr><th>NiFi Processor</th><th>Role</th><th>Group</th><th>Databricks Equivalent</th><th>Confidence</th></tr></thead><tbody>${u.map(m=>`<tr>${m.map(g=>`<td>${g}</td>`).join("")}</tr>`).join("")}</tbody></table></div>`,d+='<hr class="divider"><h3>Generated Notebook</h3>',d+='<div class="notebook-preview">',r.forEach((m,g)=>{const _=m.label||(m.type==="md"?"markdown":"code"),E=m.role?"lb-"+m.role:"lb-config",w=m.type==="md"?' <span style="opacity:0.5">[md]</span>':m.type==="sql"?' <span style="opacity:0.5">[sql]</span>':"",x=m.source.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");d+=`<div class="notebook-cell"><div class="cell-label ${E}">[${g+1}] ${_}${w}</div><pre>${x}</pre></div>`}),d+="</div>",d+='<hr class="divider"><div style="display:flex;gap:8px;flex-wrap:wrap">',d+='<button class="btn" id="dlNotebookBtnInline">Download .py Notebook</button>',d+='<button class="btn" id="dlWorkflowBtnInline">Download Workflow JSON</button>',d+="</div>";const f=document.getElementById("notebookResults");if(f){f.innerHTML=d;const m=document.getElementById("dlNotebookBtnInline");m&&m.addEventListener("click",()=>{typeof window.downloadNotebook=="function"&&window.downloadNotebook()});const g=document.getElementById("dlWorkflowBtnInline");g&&g.addEventListener("click",()=>{typeof window.downloadWorkflow=="function"&&window.downloadWorkflow()})}fe("convert","done");const p=document.getElementById("reportNotReady"),h=document.getElementById("reportReady");p&&p.classList.add("hidden"),h&&h.classList.remove("hidden"),ct("report")}catch(s){Ye(t),Ae(new Ee("Notebook generation failed: "+s.message,{code:"GENERATE_FAILED",phase:"convert",cause:s})),Ne("notebookResults","Notebook generation failed: "+s.message),fe("convert","ready")}}async function ao(){const e=Cn("report");if(!e.ok){Ne("reportResults","Prerequisites not met: "+e.missing.join(", ")+". Please complete earlier steps first.");return}const n=le(),t=Xe();fe("report","processing");try{const s=n.parsed._nifi,a=no(n.notebook.mappings,s);Je({migrationReport:a});const o=a.summary;let i='<hr class="divider">';const r=o.coveragePercent,c=r>=85?"green":r>=60?"amber":"red",l=r>=85?"HIGH COVERAGE":r>=60?"PARTIAL COVERAGE":"LOW COVERAGE";i+=`<div class="score-big">${l} — ${r}%</div>`,i+=vt([["Total Processors",o.totalProcessors],["Mapped",o.mappedProcessors],["Unmapped",o.unmappedProcessors],["Process Groups",o.totalProcessGroups],["Connections",o.totalConnections],["Effort",`<span class="badge badge-${a.effort==="Low"?"green":a.effort==="Medium"?"amber":"red"}">${a.effort}</span>`]]),i+='<hr class="divider"><h3>Coverage by Role</h3>',["source","route","transform","process","sink","utility"].forEach(h=>{const m=a.byRole[h];if(!m)return;const g=m.total?Math.round(m.mapped/m.total*100):0,_=g>=85?"green":g>=60?"amber":"red",E=Vt[h]||"#808495";i+='<div style="margin:8px 0">',i+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">',i+=`<span style="font-weight:600;color:${E};text-transform:uppercase;font-size:0.85rem">${h}</span>`,i+=`<span style="font-size:0.85rem;color:var(--text2)">${m.mapped}/${m.total} (${g}%)</span>`,i+="</div>",i+=`<div class="progress-bar"><div class="progress-fill ${_}" style="width:${g}%"></div></div>`,i+="</div>"}),a.gaps&&a.gaps.length&&(i+='<hr class="divider"><h3>Gap Analysis — Unmapped Processors</h3>',a.gaps.forEach(h=>{i+='<div class="gap-card">',i+=`<div class="gap-title">${V(h.name)} <span class="gap-meta">${V(h.type)} &middot; ${V(h.group||"ungrouped")}</span></div>`,i+=`<div class="gap-rec">${V(h.recommendation||"Manual implementation required")}</div>`,i+="</div>"})),a.recommendations&&a.recommendations.length&&(i+='<hr class="divider"><h3>Recommendations</h3>',i+='<ul style="margin:0;padding-left:20px">',a.recommendations.forEach(h=>{i+=`<li style="margin:4px 0">${V(h)}</li>`}),i+="</ul>"),i+='<hr class="divider"><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">',i+='<button class="btn" id="dlReportBtnInline">Download Report (Markdown)</button>',i+="</div>";const u=document.getElementById("reportResults");if(u){u.innerHTML=i;const h=document.getElementById("dlReportBtnInline");h&&h.addEventListener("click",()=>{typeof window.downloadReport=="function"&&window.downloadReport()})}fe("report","done");const f=document.getElementById("reportFinalNotReady"),p=document.getElementById("reportFinalReady");f&&f.classList.add("hidden"),p&&p.classList.remove("hidden"),ct("reportFinal")}catch(s){Ye(t),Ae(new Ee("Report generation failed: "+s.message,{code:"REPORT_FAILED",phase:"report",cause:s})),Ne("reportResults","Report generation failed: "+s.message),fe("report","ready")}}function io(e,n){const t={deadEnds:[],orphans:[],circularRefs:[],disconnected:[],backpressure:[]};if(!e||!n)return t;const s={},a={};e.forEach(f=>{s[f.id]=f,a[f.name]=f});const o={},i={};e.forEach(f=>{o[f.id]=[],i[f.id]=[]}),n.forEach(f=>{const p=f.sourceId||f.source&&f.source.id,h=f.destId||f.destination&&f.destination.id;p&&h&&o[p]&&i[h]&&(o[p].push(h),i[h].push(p))});const r=/^(Put|Log|Publish|Send|Notify|PutEmail|PutSlack)/;e.forEach(f=>{o[f.id]&&o[f.id].length===0&&!r.test(f.type)&&t.deadEnds.push({name:f.name,type:f.type,id:f.id})});const c=/^(Get|List|Listen|Consume|Generate|TailFile|HandleHttp)/;e.forEach(f=>{i[f.id]&&i[f.id].length===0&&!c.test(f.type)&&t.orphans.push({name:f.name,type:f.type,id:f.id})});const l=new Set,d=new Set;function u(f,p){if(d.has(f))return t.circularRefs.push({cycle:p.concat(f).map(h=>s[h]?s[h].name:h)}),!0;if(l.has(f))return!1;l.add(f),d.add(f);for(const h of o[f]||[])u(h,p.concat(f));return d.delete(f),!1}return e.forEach(f=>{l.has(f.id)||u(f.id,[])}),e.forEach(f=>{o[f.id]&&o[f.id].length===0&&i[f.id]&&i[f.id].length===0&&t.disconnected.push({name:f.name,type:f.type,id:f.id})}),t}const nc=[{name:"SQL Injection",regex:/(\bDROP\s+TABLE\b|\bUNION\s+SELECT\b|\bxp_cmdshell\b|\bEXEC\s+sp_|\bDELETE\s+FROM\b.*;\s*--|;\s*DROP\b|'\s*OR\s+'[^']*'\s*=\s*')/i,severity:"CRITICAL"},{name:"Command Injection",regex:/(rm\s+-rf\s+\/|curl\s+evil|wget\s+.*\|\s*bash|\/bin\/sh\s+-[ic]|exec\s*\(|system\s*\(|subprocess)/i,severity:"CRITICAL"},{name:"SSRF",regex:/(169\.254\.169\.254|metadata\.google\.internal|localhost:\d{4}\/admin)/i,severity:"HIGH"},{name:"Hardcoded Secret",regex:/(password\s*=\s*['"][^'"]{3,}|secret\s*=\s*['"][^'"]{3,}|api_key\s*=\s*['"][^'"]{3,})/i,severity:"HIGH"},{name:"Reverse Shell",regex:/(\/dev\/tcp\/|nc\s+-[el]|ncat\s|socket\.SOCK_STREAM.*connect|bash\s+-i\s*>&)/i,severity:"CRITICAL"},{name:"Path Traversal",regex:/(\.\.\/\.\.\/|\/etc\/passwd|\/etc\/shadow|\/root\/)/i,severity:"MEDIUM"},{name:"Dangerous File Access",regex:/(\.pem|\.key|\.crt|credentials\.json|\.env\b)/i,severity:"MEDIUM"},{name:"Perl Injection",regex:/(use\s+IO::Socket|eval\s*\(|open\s*\(\s*F\s*,\s*'\|)/i,severity:"CRITICAL"},{name:"Java Exploitation",regex:/(Runtime\.getRuntime\(\)|ProcessBuilder|jndi:ldap|Class\.forName)/i,severity:"CRITICAL"},{name:"Data Exfiltration",regex:/(LOAD_FILE|INTO\s+OUTFILE|COPY\s+.*\s+TO\s+'\/|UTL_HTTP\.REQUEST)/i,severity:"HIGH"}];function rc(e){const n=[];return e.forEach(t=>{const s=Object.values(t.properties||{}).join(" ");nc.forEach(a=>{const o=a.regex.exec(s);o&&n.push({processor:t.name,type:t.type,finding:a.name,severity:a.severity,snippet:o[0].substring(0,100)})})}),n}const sc=["minute","hour","day-of-month","month","day-of-week"],oc=["second","minute","hour","day-of-month","month","day-of-week"],an=[null,"January","February","March","April","May","June","July","August","September","October","November","December"],cn=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function ac(e,n){if(e==="*")return`every ${n}`;if(e==="?")return`any ${n}`;if(e.includes("/")){const[t,s]=e.split("/");return t==="*"?`every ${s} ${n}s`:`every ${s} ${n}s starting at ${t}`}if(e.includes("-")&&!e.includes(",")){const[t,s]=e.split("-");return n==="day-of-week"?`${cn[t]||t} through ${cn[s]||s}`:n==="month"?`${an[t]||t} through ${an[s]||s}`:`${n}s ${t} through ${s}`}if(e.includes(",")){const t=e.split(",");return n==="day-of-week"?t.map(s=>cn[s]||s).join(", "):n==="month"?t.map(s=>an[s]||s).join(", "):`${n}s ${t.join(", ")}`}return n==="day-of-week"?cn[e]||`day ${e}`:n==="month"?an[e]||`month ${e}`:`at ${n} ${e}`}function ic(e){if(typeof e!="string")return{valid:!1,description:"Invalid CRON expression",fields:{}};const n=e.trim().split(/\s+/);if(n.length<5||n.length>7)return{valid:!1,description:`Invalid CRON expression (${n.length} fields, expected 5-6)`,fields:{}};const s=n.length>=6?oc:sc,a={},o=[];for(let r=0;r<s.length&&r<n.length;r++)a[s[r]]=n[r],n[r]!=="*"&&n[r]!=="?"&&o.push(ac(n[r],s[r]));return{valid:!0,description:o.length>0?o.join(", "):"every minute (all wildcards)",fields:a}}function cc(e){const n=[],t=[],s=[];return(e||[]).forEach(a=>{const o=a.schedulingStrategy||"TIMER_DRIVEN",i=a.schedulingPeriod||"0 sec";if(o==="CRON_DRIVEN"){const r=ic(i);t.push({processor:a.name,type:a.type,group:a.group||"(root)",expression:i,...r})}else o==="EVENT_DRIVEN"?s.push({processor:a.name,type:a.type,group:a.group||"(root)"}):n.push({processor:a.name,type:a.type,group:a.group||"(root)",period:i,isZero:i==="0 sec"||i==="0 ms"||i==="0"})}),{timers:n,cronSchedules:t,eventDriven:s,summary:{totalProcessors:(e||[]).length,timerDriven:n.length,cronDriven:t.length,eventDrivenCount:s.length,zeroPeriodCount:n.filter(a=>a.isZero).length}}}function lc(e){const n={filePaths:{},urls:{},jdbcUrls:{},nifiEL:{},cronExprs:{},credentialRefs:{},hostPorts:{},dataFormats:new Set,encodings:new Set};return(e||[]).forEach(t=>{const s=t.properties||{},a=Object.values(s),o=Object.keys(s);for(let i=0;i<a.length;i++){const r=a[i];if(!r||typeof r!="string")continue;const c=r.length;if(c>3&&r.includes("/")){const l=r.match(Me.filePath);l&&l.forEach(d=>{d.length>3&&!/^\/\//.test(d)&&(n.filePaths[d]||(n.filePaths[d]=[]),n.filePaths[d].push({processor:t.name,group:t.group,property:o[i]}))})}if(c>8&&/https?:/.test(r)){const l=r.match(Me.urlPattern);l&&l.forEach(d=>{n.urls[d]||(n.urls[d]=[]),n.urls[d].push({processor:t.name,group:t.group,property:o[i]})})}if(c>10&&r.startsWith("jdbc:")){const l=r.match(Me.jdbcUrl);l&&l.forEach(d=>{n.jdbcUrls[d]||(n.jdbcUrls[d]=[]),n.jdbcUrls[d].push({processor:t.name,group:t.group,property:o[i]})})}if(c>3&&r.includes("${")){const l=r.match(Me.nifiEL);l&&l.forEach(d=>{const u=d.slice(2,-1);n.nifiEL[u]||(n.nifiEL[u]=[]),n.nifiEL[u].push({processor:t.name,group:t.group,property:o[i]})})}if(c>8&&Me.cronExpr.test(r)&&(n.cronExprs[r.trim()]||(n.cronExprs[r.trim()]=[]),n.cronExprs[r.trim()].push({processor:t.name,group:t.group,property:o[i]})),Me.credentialKey.test(o[i])){const l=r.length>3?r.substring(0,2)+"***"+r.substring(r.length-1):"***";n.credentialRefs[o[i]]||(n.credentialRefs[o[i]]=[]),n.credentialRefs[o[i]].push({processor:t.name,group:t.group,value:l})}if(c>5){Me.hostPort.lastIndex=0;let l;for(;(l=Me.hostPort.exec(r))!==null;){const d=l[2]?l[1]+":"+l[2]:l[1];!/\.(css|js|html|png|jpg|gif|svg|ico|woff|ttf|eot)$/i.test(d)&&!/^(www\.|http|example\.com|localhost)/i.test(l[1])&&(n.hostPorts[d]||(n.hostPorts[d]=[]),n.hostPorts[d].push({processor:t.name,group:t.group,property:o[i]}))}}if(Me.dataFormat.test(r)){const l=r.match(Me.dataFormat);l&&l.forEach(d=>n.dataFormats.add(d.toLowerCase()))}}t.schedulingStrategy==="CRON_DRIVEN"&&t.schedulingPeriod&&(n.cronExprs[t.schedulingPeriod]||(n.cronExprs[t.schedulingPeriod]=[]),n.cronExprs[t.schedulingPeriod].push({processor:t.name,group:t.group,property:"schedulingPeriod"}))}),n}function dc(e){e.deepPropertyInventory||(e.deepPropertyInventory=lc(e.processors));const n=_r(e),t=Pn(e),s=zs(n.downstream),a=Xs(e),o=io(e.processors,e.connections),i=rc(e.processors||[]),r=[];(e.processors||[]).forEach(d=>{const u=Ys(d.properties);u.length>0&&r.push({processor:d.name,type:d.type,group:d.group,fields:u})});const c=cc(e.processors);let l=null;return e.tables&&e.tables.length>0&&(l=gr(e)),{dependencyGraph:n,externalSystems:t,cycles:s,manifest:a,flowGraph:o,securityFindings:i,phiResults:r,scheduling:c,blueprint:l,deepPropertyInventory:e.deepPropertyInventory}}function pc(e){const{mappings:n,nifi:t,blueprint:s,config:a}=e,o=eo(n,t,s,a),i=to(n,t,a);return{notebook:o,workflow:i}}async function uc({processors:e,mappings:n,mappingByName:t,allCellTextLower:s,batchSize:a=100,onProgress:o}){const i=[];e.forEach(f=>{const p=Ce(f.type);let h="";const m=f.properties||{};if(p==="source"){const _=Object.values(m).filter(E=>E&&typeof E=="string").join(" ").match(/\b(s3|hdfs|kafka|jdbc|file|ftp|sftp|http)/i);h="INGEST data"+(_?" from "+_[0].toUpperCase():"")}else if(p==="sink")h="WRITE/OUTPUT data"+(m.Directory?" to "+m.Directory:"")+(m["Topic Name"]?" to Kafka:"+m["Topic Name"]:"");else if(p==="transform")h="TRANSFORM data"+(f.type.includes("JSON")?" (JSON)":f.type.includes("SQL")?" (SQL)":f.type.includes("Attribute")?" (attributes)":"");else if(p==="route"){const g=Object.keys(m).filter(_=>_!=="Routing Strategy").length;h="ROUTE/BRANCH"+(g>0?" ("+g+" conditions)":"")}else p==="process"?h="PROCESS data ("+f.type.replace(/^org\.apache\.nifi\.processors?\.\w+\./,"")+")":h="UTILITY ("+f.type.replace(/^org\.apache\.nifi\.processors?\.\w+\./,"")+")";i.push({name:f.name,type:f.type,role:p,intent:h,props:m})});let r=0,c=0,l=0;const d=[];for(let f=0;f<i.length;f+=a)i.slice(f,f+a).forEach(h=>{const m=t[h.name];if(!m){l++,d.push({proc:h.name,type:h.type,intent:h.intent,issue:"No mapping found — processor entirely missing from notebook"});return}if(!m.mapped){l++,d.push({proc:h.name,type:h.type,intent:h.intent,issue:"Unmapped — no Databricks equivalent generated"});return}const g=m.name.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();if(!(s.includes(g)||s.includes(h.name.toLowerCase()))){c++,d.push({proc:h.name,type:h.type,intent:h.intent,issue:"Mapped but no dedicated notebook cell references this processor"});return}m.confidence>=.7?r++:(c++,d.push({proc:h.name,type:h.type,intent:h.intent,issue:"Low confidence ("+Math.round(m.confidence*100)+"%) — intent may not be fully preserved"}))}),o&&o(8+Math.round(f/i.length*20),"Intent analysis: "+Math.min(f+a,i.length)+"/"+i.length+" processors..."),await new Promise(h=>setTimeout(h,0));const u=i.length?Math.round(r/i.length*100):0;return{nifiIntents:i,intentMatched:r,intentPartial:c,intentMissing:l,intentGaps:d,intentScore:u}}async function fc({mappings:e,procByName:n,cellTextsLower:t,findCellsWithVar:s,batchSize:a=100,onProgress:o}){const i=[];let r=0,c=0;for(let d=0;d<e.length;d+=a)e.slice(d,d+a).forEach(f=>{const p=f.name.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase(),h=s(p);if(h.length===0){const S=f.name.toLowerCase(),y=s(S);y.length>0&&h.push(...y)}const m=n[f.name],g=m?m.properties||{}:{},_=Object.entries(g).filter(([S,y])=>y&&!/password|secret|token/i.test(S));let E=0,w=[];if(h.length>0){const S=h.map(y=>t[y]).join(`
`);_.forEach(([y,C])=>{const P=y.toLowerCase().replace(/[\s-]/g,""),R=String(C).toLowerCase().substring(0,50);S.includes(P)||S.includes(R)||S.includes(y.toLowerCase())?E++:w.push(y)})}const x=_.length>0?Math.round(E/_.length*100):100,b=f.mapped?h.length===0?"no-cell":x>=70?"good":x>=30?"partial":"weak":"missing";b==="good"?r++:c++,i.push({name:f.name,type:f.type,role:f.role,mapped:f.mapped,cellCount:h.length,cellIndices:h,propTotal:_.length,propsInCode:E,propCoverage:x,propsMissing:w,status:b,confidence:f.confidence,desc:f.desc})}),o&&o(30+Math.round(d/e.length*25),"Line validation: "+Math.min(d+a,e.length)+"/"+e.length+" mappings..."),await new Promise(f=>setTimeout(f,0));const l=e.length?Math.round(r/e.length*100):0;return{lineResults:i,lineMatched:r,lineGaps:c,lineScore:l}}async function mc({nifi:e,systems:n,allCellTextLower:t,onProgress:s}){let a=0;const o=[],i=e.connections.length,r=e.processors.length;let c=0;e.connections.forEach(y=>{const C=(y.sourceName||"").replace(/[^a-zA-Z0-9]/g,"_").toLowerCase(),P=(y.destinationName||"").replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();C&&P&&t.includes(C)&&t.includes(P)&&c++});const l=i?Math.round(c/i*100):100;o.push({label:"Flow Topology Preserved",score:l,detail:c+"/"+i+" connections reflected in variable chaining"}),s&&s(65,"Checking processor type identifiability..."),await new Promise(y=>setTimeout(y,0));let d=0;e.processors.forEach(y=>{const C=y.type.split(".").pop().toLowerCase();(t.includes(C)||t.includes("nifi: "+C)||t.includes(y.type.toLowerCase()))&&d++});const u=r?Math.round(d/r*100):100;o.push({label:"Processor Types Identifiable",score:u,detail:d+"/"+r+" NiFi types referenced in notebook comments/code"});let f=0;e.processors.forEach(y=>{y.schedulingPeriod&&y.schedulingPeriod!=="0 sec"?(t.includes(y.schedulingPeriod.toLowerCase())||t.includes("schedule")||t.includes("trigger"))&&f++:f++});const p=r?Math.round(f/r*100):100;o.push({label:"Scheduling Parameters Preserved",score:p,detail:f+"/"+r+" scheduling configs captured"}),s&&s(72,"Checking controller services and external systems..."),await new Promise(y=>setTimeout(y,0));const h=e.controllerServices.length;let m=0;e.controllerServices.forEach(y=>{const C=y.name.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();(t.includes(C)||t.includes(y.name.toLowerCase()))&&m++});const g=h?Math.round(m/h*100):100;o.push({label:"Controller Services Referenced",score:g,detail:m+"/"+h+" controller services found in notebook"});const _=Object.keys(n);let E=0;_.forEach(y=>{t.includes(y.toLowerCase())&&E++});const w=_.length?Math.round(E/_.length*100):100;o.push({label:"External Systems Connected",score:w,detail:E+"/"+_.length+" external systems referenced in code"});const x=[];e.processors.forEach(y=>{y.autoTerminatedRelationships&&y.autoTerminatedRelationships.length>0&&x.push({name:y.name,rels:y.autoTerminatedRelationships})});const b=t.includes("try:")||t.includes("except")||t.includes('.option("failonerror"'),S=b?70:x.length>0?30:50;return o.push({label:"Error Handling Coverage",score:S,detail:b?"Try/except or error options found in notebook":"No explicit error handling — "+x.length+" processors have auto-terminated failure relationships"}),a=Math.round(o.reduce((y,C)=>y+C.score,0)/o.length),{reScore:a,reChecks:o}}async function hc({mappings:e,procByName:n,batchSize:t=100,onProgress:s}){const a=[];let o=0,i=0,r=0;for(let l=0;l<e.length;l+=t)e.slice(l,l+t).forEach(u=>{const f=n[u.name];if(!f)return;const p=Ce(u.type),h=f.properties||{},m=[];p==="source"&&m.push("Data ingestion"),p==="sink"&&m.push("Data output/write"),p==="transform"&&m.push("Data transformation"),p==="route"&&m.push("Conditional routing"),p==="process"&&m.push("Data processing"),p==="utility"&&m.push("Utility"),(u.type.includes("SQL")||u.type.includes("Sql"))&&m.push("SQL execution"),(u.type.includes("JSON")||u.type.includes("Json"))&&m.push("JSON processing"),u.type.includes("Avro")&&m.push("Avro serialization"),(u.type.includes("CSV")||u.type.includes("Csv"))&&m.push("CSV processing"),u.type.includes("Kafka")&&m.push("Kafka messaging"),(u.type.includes("HDFS")||u.type.includes("Hdfs"))&&m.push("HDFS file operations"),(u.type.includes("S3")||u.type.includes("AWS"))&&m.push("S3/AWS operations"),(u.type.includes("Encrypt")||u.type.includes("Hash"))&&m.push("Encryption/hashing"),(u.type.includes("HTTP")||u.type.includes("Http"))&&m.push("HTTP communication"),(u.type.includes("Merge")||u.type.includes("Split"))&&m.push("Data merge/split"),u.type.includes("Attribute")&&m.push("Attribute manipulation"),(u.type.includes("Wait")||u.type.includes("Notify"))&&m.push("Flow coordination"),u.type.includes("Kudu")&&m.push("Kudu table operations");const g=Object.entries(h).filter(([x,b])=>b&&String(b).includes("${"));g.length&&m.push("NiFi Expression Language ("+g.length+" expressions)");let _=[],E="missing";u.mapped&&u.confidence>=.7?(E="mapped",o++,u.desc&&_.push(u.desc)):u.mapped?(E="partial",i++,u.desc&&_.push(u.desc+" (low confidence)")):r++;const w=yr(u.type);a.push({name:u.name,type:u.type,role:p,nifiFunctions:m,dbxFunctions:_,status:E,confidence:u.confidence,packages:w,elCount:g.length})}),s&&s(78+Math.round(l/e.length*15),"Function mapping: "+Math.min(l+t,e.length)+"/"+e.length+"..."),await new Promise(u=>setTimeout(u,0));const c=e.length?Math.round((o+i*.5)/e.length*100):0;return{funcResults:a,funcMapped:o,funcPartial:i,funcMissing:r,funcScore:c}}function gc({intentGaps:e,lineGapItems:n,nifiDatabricksMap:t}){const s=[...e];n.forEach(i=>{s.some(r=>r.proc===i.name)||s.push({proc:i.name,type:i.type,intent:"",issue:i.status==="missing"?"No mapping":i.status==="no-cell"?"No cell":"Low prop coverage"})});const a={};s.forEach(i=>{const r=i.type.split(".").pop();a[r]||(a[r]=[]),a[r].push(i)});const o={};return Object.entries(a).sort((i,r)=>r[1].length-i[1].length).forEach(([i,r])=>{const c=r.some(d=>d.issue.includes("Missing")||d.issue.includes("Unmapped")||d.issue.includes("No mapping"))?"HIGH":"MEDIUM",l=t?t[i]:null;o[i]={gaps:r,severity:c,mapEntry:l}}),{allGaps:s,gapsByType:o}}async function Ur({nifi:e,mappings:n,cells:t,systems:s,nifiDatabricksMap:a,onProgress:o}){const i=o||(()=>{});i(2,"Building lookup indexes..."),await new Promise(b=>setTimeout(b,0));const r={};e.processors.forEach(b=>{r[b.name]=b});const c={};n.forEach(b=>{c[b.name]=b});const l=t.map(b=>(b.source||"").toLowerCase()),d=l.join(`
`);function u(b){const S=[];for(let y=0;y<l.length;y++)l[y].includes(b)&&S.push(y);return S}i(5,"Building connection graph..."),await new Promise(b=>setTimeout(b,0));const f={};e.connections.forEach(b=>{f[b.sourceName]||(f[b.sourceName]=[]),f[b.sourceName].push(b)}),i(8,"Running intent analysis ("+e.processors.length+" processors)...");const p=await uc({processors:e.processors,mappings:n,mappingByName:c,allCellTextLower:d,onProgress:i});i(30,"Running line validation ("+n.length+" mappings)...");const h=await fc({mappings:n,procByName:r,cellTextsLower:l,findCellsWithVar:u,onProgress:i});i(58,"Running reverse engineering readiness checks...");const m=await mc({nifi:e,systems:s,allCellTextLower:d,onProgress:i});i(78,"Running function mapping analysis...");const g=await hc({mappings:n,procByName:r,onProgress:i});i(95,"Computing overall score..."),await new Promise(b=>setTimeout(b,0));const _=Math.round((p.intentScore+h.lineScore+m.reScore+g.funcScore)/4),E=h.lineResults.filter(b=>b.status!=="good"),w=gc({intentGaps:p.intentGaps,lineGapItems:E,nifiDatabricksMap:a});i(95,"Checking notebook imports...");const x=_c(t);return i(100,"Validation complete!"),{overallScore:_,intentScore:p.intentScore,lineScore:h.lineScore,reScore:m.reScore,funcScore:g.funcScore,intentGaps:p.intentGaps,nifiIntents:p.nifiIntents,intentMatched:p.intentMatched,intentPartial:p.intentPartial,intentMissing:p.intentMissing,lineResults:h.lineResults,lineMatched:h.lineMatched,lineGaps:h.lineGaps,reChecks:m.reChecks,funcResults:g.funcResults,funcMapped:g.funcMapped,funcPartial:g.funcPartial,funcMissing:g.funcMissing,allGaps:w.allGaps,gapsByType:w.gapsByType,connMap:f,missingImports:x,timestamp:new Date().toISOString()}}function _c(e){const n=[{pattern:/\bspark\.read/i,symbol:"SparkSession",suggestion:"from pyspark.sql import SparkSession"},{pattern:/\bcol\s*\(/i,symbol:"col",suggestion:"from pyspark.sql.functions import col"},{pattern:/\blit\s*\(/i,symbol:"lit",suggestion:"from pyspark.sql.functions import lit"},{pattern:/\bwhen\s*\(/i,symbol:"when",suggestion:"from pyspark.sql.functions import when"},{pattern:/\bexpr\s*\(/i,symbol:"expr",suggestion:"from pyspark.sql.functions import expr"},{pattern:/\bstruct\s*\(/i,symbol:"struct",suggestion:"from pyspark.sql.functions import struct"},{pattern:/\barray\s*\(/i,symbol:"array",suggestion:"from pyspark.sql.functions import array"},{pattern:/\bfrom_json\s*\(/i,symbol:"from_json",suggestion:"from pyspark.sql.functions import from_json"},{pattern:/\bto_json\s*\(/i,symbol:"to_json",suggestion:"from pyspark.sql.functions import to_json"},{pattern:/\bStructType\s*\(/i,symbol:"StructType",suggestion:"from pyspark.sql.types import StructType"},{pattern:/\bStructField\s*\(/i,symbol:"StructField",suggestion:"from pyspark.sql.types import StructField"},{pattern:/\bStringType\s*\(/i,symbol:"StringType",suggestion:"from pyspark.sql.types import StringType"},{pattern:/\bIntegerType\s*\(/i,symbol:"IntegerType",suggestion:"from pyspark.sql.types import IntegerType"},{pattern:/\bpandas_udf/i,symbol:"pandas_udf",suggestion:"from pyspark.sql.functions import pandas_udf"},{pattern:/\bWindow\./i,symbol:"Window",suggestion:"from pyspark.sql.window import Window"},{pattern:/\bjson\.loads/i,symbol:"json",suggestion:"import json"},{pattern:/\bre\./i,symbol:"re",suggestion:"import re"},{pattern:/\bdatetime\./i,symbol:"datetime",suggestion:"from datetime import datetime"},{pattern:/\bbase64\./i,symbol:"base64",suggestion:"import base64"},{pattern:/\bhashlib\./i,symbol:"hashlib",suggestion:"import hashlib"}],t=e.map(o=>o.source||"").join(`
`),s=t.split(`
`).filter(o=>/^\s*(import |from .+ import )/.test(o)).join(`
`),a=[];for(const{pattern:o,symbol:i,suggestion:r}of n)if(o.test(t)&&!s.includes(i)){const c=e.findIndex(l=>o.test(l.source||""));a.push({symbol:i,usedIn:c,suggestion:r})}return a}function yc(e,n){const t=e.length,s=e.filter(d=>d.mapped&&d.confidence>=.8).length,a=e.filter(d=>d.mapped).length,o=n.connections||[],i=new Set(e.filter(d=>d.mapped).map(d=>d.name)),r=o.length,c=o.filter(d=>i.has(d.sourceName)&&i.has(d.destinationName)).length,l=e.map((d,u)=>{let f;return d.mapped?d.confidence>=.8?f="exact":f="functional":f="gap",{idx:u+1,name:d.name,type:d.type,group:d.group||"—",role:d.role,equiv:d.mapped?d.desc:"—",category:d.mapped?d.category:"—",matchType:f,confidence:d.confidence,code:d.code}});return{exact:{count:s,total:t,pct:t?Math.round(s/t*100):0},functional:{count:a,total:t,pct:t?Math.round(a/t*100):0},actions:{count:c,total:r,pct:r?Math.round(c/r*100):0},rows:l}}function zr(e,n){return/password|secret|token|key|credential/i.test(e)?"***":typeof n=="string"?n.replace(/(jdbc:\w+:\/\/)([^:]+):([^@]+)@/g,"$1$2:***@"):n}function co(e){const n=e.parsed?e.parsed._nifi:null;return{meta:{generated:new Date().toISOString(),tool:"NiFi Flow Analyzer",version:"2.0.1",flow_name:e.parsed?e.parsed.source_name:"unknown"},flow_summary:{source_name:e.parsed?e.parsed.source_name:"Unknown",processor_count:n?n.processors.length:0,connection_count:n?n.connections.length:0,process_group_count:n?n.processGroups.length:0,controller_service_count:n?n.controllerServices.length:0,external_system_count:n?n.clouderaTools.length:0},processors:n?n.processors.map(s=>({name:s.name,type:s.type,group:s.group,state:s.state,role:Ce(s.type),scheduling:{strategy:s.schedulingStrategy,period:s.schedulingPeriod},properties:Object.fromEntries(Object.entries(s.properties).map(([a,o])=>[a,zr(a,o)]))})):[],connections:n?n.connections.map(s=>({source:s.sourceName,destination:s.destinationName,relationships:s.relationships,backPressure:s.backPressure})):[],controller_services:n?n.controllerServices.map(s=>({name:s.name,type:s.type,properties:Object.fromEntries(Object.entries(s.properties).map(([a,o])=>[a,zr(a,o)]))})):[],assessment:e.assessment?{readiness_score:e.assessment.readinessScore,auto_convertible:e.assessment.autoCount,manual_conversion:e.assessment.manualCount,unsupported:e.assessment.unsupportedCount,mappings:e.assessment.mappings?e.assessment.mappings.map(s=>({name:s.name,nifi_type:s.nifiType||s.type,role:s.role,mapped:s.mapped,databricks:s.desc,confidence:s.confidence})):[]}:null,notebook:e.notebook?{cell_count:e.notebook.cells.length,config:e.notebook.config}:null,migration_report:e.migrationReport||null,manifest:e.manifest?{directories:Object.keys(e.manifest.directories).length,sql_tables:Object.keys(e.manifest.sqlTables).length,http_endpoints:e.manifest.httpEndpoints.length,kafka_topics:e.manifest.kafkaTopics.length,scripts:e.manifest.scripts.length,db_connections:e.manifest.dbConnections.length,external_systems:(e.manifest.clouderaTools||[]).length}:null,deep_property_inventory:n?{file_paths:Object.keys(n.deepPropertyInventory.filePaths||{}).length,urls:Object.keys(n.deepPropertyInventory.urls||{}).length,jdbc_urls:Object.keys(n.deepPropertyInventory.jdbcUrls||{}).length,nifi_el_expressions:Object.keys(n.deepPropertyInventory.nifiEL||{}).length,cron_expressions:Object.keys(n.deepPropertyInventory.cronExprs||{}).length,credential_references:Object.keys(n.deepPropertyInventory.credentialRefs||{}).length}:null}}function bc(e,n,t){const s=co(e),a=s;let o='<hr class="divider">';o+="<h3>Report Summary</h3>",o+=n([{label:"Processors",value:a.flow_summary.processor_count},{label:"Connections",value:a.flow_summary.connection_count},{label:"External Systems",value:a.flow_summary.external_system_count},{label:"Readiness",value:a.assessment?a.assessment.readiness_score+"%":"N/A"}]),a.assessment&&(o+="<h3>Assessment Overview</h3>",o+=n([{label:"Auto-Convert",value:a.assessment.auto_convertible,color:"var(--green)"},{label:"Manual",value:a.assessment.manual_conversion,color:"var(--amber)"},{label:"Unsupported",value:a.assessment.unsupported,color:"var(--red)"}]));const i=JSON.stringify(a,null,2).substring(0,5e3);return o+='<hr class="divider"><h3>Report Preview</h3>',o+='<pre style="max-height:400px;overflow:auto;font-size:0.75rem">'+t(i)+(JSON.stringify(a).length>5e3?`
... (truncated)`:"")+"</pre>",o+='<hr class="divider"><div style="display:flex;gap:8px">',o+='<button class="btn btn-primary" id="finalReportDownloadBtn">Download Full Report (JSON)</button>',o+="</div>",{html:o,report:s}}function kn(e){if(typeof e=="string")return e.replace(/[\x00-\x1f]/g,"");if(Array.isArray(e))return e.map(kn);if(e&&typeof e=="object"){const n={};for(const[t,s]of Object.entries(e))n[t]=kn(s);return n}return e}const vc={MergeContent:{reason:"Spark handles partitioned reads natively — no need to merge small files manually",savings:"medium",risk:"low"},MergeRecord:{reason:"Spark handles partitioned reads natively — no need to merge records manually",savings:"medium",risk:"low"},CompressContent:{reason:"Delta Lake handles compression (zstd/snappy) automatically",savings:"low",risk:"none"},UnpackContent:{reason:"Delta Lake handles decompression automatically on read",savings:"low",risk:"none"},SplitText:{reason:"Spark reads entire datasets at once — no need to split text into individual records",savings:"medium",risk:"low"},SplitJson:{reason:"Spark reads JSON files as DataFrames natively — no splitting needed",savings:"medium",risk:"low"},SplitXml:{reason:"spark-xml reads entire XML documents — no splitting needed",savings:"medium",risk:"low"},SplitContent:{reason:"Spark operates on entire partitions — no content splitting needed",savings:"medium",risk:"low"},SplitAvro:{reason:"Spark reads Avro files as DataFrames natively",savings:"medium",risk:"low"},SplitRecord:{reason:"Spark operates on entire DataFrames — individual record splitting unnecessary",savings:"medium",risk:"low"},UpdateAttribute:{reason:"Use .withColumn() to add/modify columns — no separate attribute update step",savings:"low",risk:"none"},RouteOnAttribute:{reason:"Use .filter() or .when() for simple attribute-based routing",savings:"low",risk:"low"},LogAttribute:{reason:"Use Spark logging or display() — no dedicated log processor needed",savings:"low",risk:"none"},LogMessage:{reason:"Use print() or logging module — no dedicated log processor needed",savings:"low",risk:"none"},Wait:{reason:"Use Databricks Workflows task dependencies instead of in-flow waits",savings:"medium",risk:"low"},Notify:{reason:"Use Databricks Workflows task dependencies instead of notifications",savings:"medium",risk:"low"},DetectDuplicate:{reason:"Use dropDuplicates() — built into Spark DataFrame API",savings:"medium",risk:"low"},ControlRate:{reason:"Spark handles backpressure natively via Structured Streaming",savings:"low",risk:"none"},DistributeLoad:{reason:"Spark handles data distribution across executors automatically",savings:"medium",risk:"none"},ValidateRecord:{reason:"Use DLT expectations for declarative data quality rules",savings:"low",risk:"low"},RetryFlowFile:{reason:"Use Spark retry mechanisms or Workflows retry policies",savings:"low",risk:"low"},MonitorActivity:{reason:"Use Databricks Workflows monitoring and Spark UI",savings:"low",risk:"none"},DebugFlow:{reason:"Use Spark UI, display(), or notebook debugging — no dedicated debug processor",savings:"low",risk:"none"},CountText:{reason:"Use df.count() — built into Spark DataFrame API",savings:"low",risk:"none"},AttributesToJSON:{reason:"Use to_json() — built into PySpark",savings:"low",risk:"none"},GenerateFlowFile:{reason:"Use spark.range() or createDataFrame() for test data generation",savings:"low",risk:"none"},EnforceOrder:{reason:"Use orderBy() — built into Spark DataFrame API",savings:"low",risk:"none"},Funnel:{reason:"Use DataFrame union() — NiFi funnels have no Databricks equivalent needed",savings:"low",risk:"none"},InputPort:{reason:"NiFi ports not needed — data flows handled by notebooks/jobs",savings:"low",risk:"none"},OutputPort:{reason:"NiFi ports not needed — data flows handled by notebooks/jobs",savings:"low",risk:"none"}},Be={file_polling:{nifi:"GetFile/ListFile polling with scheduling",dbx:"Auto Loader (cloudFiles) with file notification mode",benefit:"10-100x faster file discovery, exactly-once guarantees, schema evolution"},batch_loop:{nifi:"Repeated batch processing via CRON-scheduled processors",dbx:"Structured Streaming with trigger(availableNow=True)",benefit:"Incremental processing, checkpoint-based exactly-once, auto-scaling"},schema_mgmt:{nifi:"Schema Registry + Avro/JSON schema enforcement per processor",dbx:"Unity Catalog schema governance with automatic schema evolution",benefit:"Centralized governance, lineage tracking, access controls"},data_quality:{nifi:"ValidateRecord + RouteOnAttribute for quality checks",dbx:"DLT Expectations (expect, expect_or_drop, expect_or_fail)",benefit:"Declarative quality rules, automatic quarantine, quality dashboards"},dedup:{nifi:"DetectDuplicate processor with distributed cache",dbx:"dropDuplicates() or MERGE INTO with Delta Lake",benefit:"No external cache needed, ACID guarantees, time travel"},merge_small:{nifi:"MergeContent to combine small files",dbx:"Delta Lake Auto Optimize + Auto Compaction",benefit:"Automatic small file compaction, no manual merge logic"},scheduling:{nifi:"CRON-driven processor scheduling with backpressure",dbx:"Databricks Workflows with task dependencies and triggers",benefit:"DAG-based orchestration, conditional logic, cost-optimized clusters"},caching:{nifi:"DistributedMapCache for lookup enrichment",dbx:"Broadcast variables or Delta Lake lookups",benefit:"No external cache infrastructure, automatic distribution"},security:{nifi:"Per-processor credentials and NiFi Registry policies",dbx:"Unity Catalog + Secret Scopes + identity federation",benefit:"Centralized IAM, fine-grained ACLs, audit logging"},monitoring:{nifi:"NiFi bulletins, provenance, and flow status",dbx:"Spark UI, Ganglia, custom Databricks dashboards",benefit:"Deep execution insights, cost tracking, ML-integrated monitoring"}};function lo({nifi:e,notebook:n,escapeHTML:t}){const s=e.processors||[],a=e.connections||[];let o="";o+='<h3 style="margin:0 0 12px;color:var(--primary)">1. What This Workflow Does</h3>';const i=s.filter(F=>Ce(F.type)==="source"),r=s.filter(F=>Ce(F.type)==="sink"),c=s.filter(F=>Ce(F.type)==="transform"),l=s.filter(F=>Ce(F.type)==="route"),d=s.filter(F=>Ce(F.type)==="process"),u=[...new Set(i.map(F=>F.type))],f=[...new Set(r.map(F=>F.type))],p=Pn(e),h=Object.values(p).map(F=>F.name);let m='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">';m+='<p style="font-size:0.95rem;line-height:1.6;margin:0">',m+=`This NiFi flow consists of <strong>${s.length} processors</strong> organized into <strong>${e.processGroups.length} process group(s)</strong>. `,m+=`It ingests data from <strong>${i.length} source(s)</strong> (${u.join(", ")||"none identified"}), `,m+=`applies <strong>${c.length} transformation(s)</strong> and <strong>${l.length} routing decision(s)</strong>, `,m+=`then delivers to <strong>${r.length} destination(s)</strong> (${f.join(", ")||"none identified"}).`,h.length&&(m+=` External systems involved: <strong>${h.join(", ")}</strong>.`),m+="</p></div>",m+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">',[{role:"Sources",count:i.length,color:"#3B82F6",icon:"&#9654;"},{role:"Transforms",count:c.length,color:"#A855F7",icon:"&#9881;"},{role:"Routing",count:l.length,color:"#EAB308",icon:"&#8644;"},{role:"Processing",count:d.length,color:"#6366F1",icon:"&#9881;"},{role:"Sinks",count:r.length,color:"#21C354",icon:"&#9632;"}].forEach(F=>{m+=`<div style="background:${F.color}11;border:1px solid ${F.color}44;border-radius:8px;padding:12px;text-align:center">`,m+=`<div style="font-size:1.5rem">${F.icon}</div>`,m+=`<div style="font-size:1.8rem;font-weight:700;color:${F.color}">${F.count}</div>`,m+=`<div style="font-size:0.8rem;color:var(--text2)">${F.role}</div></div>`}),m+="</div>",Object.keys(p).length&&(m+='<h4 style="margin:12px 0 6px">Integration Points</h4>',m+='<div style="display:flex;gap:8px;flex-wrap:wrap">',Object.values(p).forEach(F=>{const G=F.processors.map(z=>z.direction).includes("WRITE")&&F.processors.map(z=>z.direction).includes("READ")?"&#8644;":F.processors.map(z=>z.direction).includes("WRITE")?"&#8594;":"&#8592;";m+=`<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:0.82rem">${G} <strong>${t(F.name)}</strong> <span style="color:var(--text2)">(${F.processors.length})</span></span>`}),m+="</div>");const _=new Set;s.forEach(F=>{/JSON/i.test(F.type)&&_.add("JSON"),/XML/i.test(F.type)&&_.add("XML"),/Avro/i.test(F.type)&&_.add("Avro"),/CSV|Delimited/i.test(F.type)&&_.add("CSV"),/Parquet/i.test(F.type)&&_.add("Parquet"),/ORC/i.test(F.type)&&_.add("ORC");const G=Object.values(F.properties||{}).join(" ");/json/i.test(G)&&_.add("JSON"),/xml/i.test(G)&&_.add("XML"),/csv|delimited/i.test(G)&&_.add("CSV"),/avro/i.test(G)&&_.add("Avro"),/parquet/i.test(G)&&_.add("Parquet")}),_.size&&(m+=`<p style="margin:12px 0 0;font-size:0.85rem;color:var(--text2)">Data formats detected: <strong>${[..._].join(", ")}</strong></p>`),o+=m,o+='<h3 style="margin:24px 0 12px;color:var(--primary)">2. How to Build It Better in Databricks</h3>';const E=[];s.some(F=>/^(GetFile|ListFile|TailFile|FetchFile)$/i.test(F.type))&&E.push({...Be.file_polling,category:"Ingestion",priority:1}),s.some(F=>F.schedulingStrategy==="CRON_DRIVEN"||/TIMER_DRIVEN/i.test(F.schedulingStrategy))&&E.push({...Be.batch_loop,category:"Processing",priority:2}),s.some(F=>/Schema|Avro|Record/i.test(F.type))&&E.push({...Be.schema_mgmt,category:"Governance",priority:2}),s.some(F=>/Validate|RouteOn/i.test(F.type))&&E.push({...Be.data_quality,category:"Quality",priority:1}),s.some(F=>/DetectDuplicate/i.test(F.type))&&E.push({...Be.dedup,category:"Deduplication",priority:2}),s.some(F=>/MergeContent|MergeRecord/i.test(F.type))&&E.push({...Be.merge_small,category:"Optimization",priority:2}),s.length>5&&E.push({...Be.scheduling,category:"Orchestration",priority:3}),s.some(F=>/Cache|Lookup/i.test(F.type))&&E.push({...Be.caching,category:"Enrichment",priority:3}),e.controllerServices.some(F=>/SSL|Kerberos|LDAP|Credential/i.test(F.type))&&E.push({...Be.security,category:"Security",priority:1}),E.push({...Be.monitoring,category:"Monitoring",priority:3}),E.sort((F,G)=>F.priority-G.priority),o+='<div style="display:grid;gap:12px">',E.forEach(F=>{const G=F.priority===1?"var(--green)":F.priority===2?"var(--primary)":"var(--text2)",z=F.priority===1?"HIGH":F.priority===2?"MEDIUM":"LOW";o+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px">',o+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">',o+=`<strong style="font-size:0.95rem">${t(F.category)}</strong>`,o+=`<span style="font-size:0.72rem;padding:2px 8px;border-radius:4px;background:${G}22;color:${G};font-weight:700">${z} PRIORITY</span>`,o+="</div>",o+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.85rem">',o+=`<div><div style="color:var(--text2);font-size:0.75rem;margin-bottom:4px">CURRENT (NiFi)</div>${t(F.nifi)}</div>`,o+=`<div><div style="color:var(--green);font-size:0.75rem;margin-bottom:4px">RECOMMENDED (Databricks)</div><strong>${t(F.dbx)}</strong></div>`,o+="</div>",o+=`<div style="margin-top:8px;font-size:0.82rem;color:var(--text2)">&#9889; ${t(F.benefit)}</div>`,o+="</div>"}),o+="</div>",o+=`<h3 style="margin:24px 0 12px;color:var(--primary)">3. Steps That Aren't Needed in Databricks</h3>`;const w=[];if(s.forEach(F=>{const G=vc[F.type];G&&w.push({name:F.name,type:F.type,group:F.group,...G})}),w.length===0)o+='<div class="val-ok">All processors in this flow serve essential functions in the Databricks migration.</div>';else{const F={high:3,medium:2,low:1},G=w.sort((z,ne)=>(F[ne.savings]||0)-(F[z.savings]||0));o+=`<div class="alert alert-success" style="margin-bottom:12px"><strong>${w.length}</strong> of ${s.length} processors (${Math.round(w.length/s.length*100)}%) can be eliminated in Databricks</div>`,o+='<div class="table-scroll"><table style="font-size:0.82rem"><thead><tr><th>Processor</th><th>Type</th><th>Reason to Drop</th><th>Savings</th><th>Risk</th></tr></thead><tbody>',G.forEach(z=>{const ne=z.savings==="high"?"var(--green)":z.savings==="medium"?"var(--primary)":"var(--text2)",de=z.risk==="high"?"var(--red)":z.risk==="medium"?"var(--amber)":z.risk==="low"?"var(--text2)":"var(--green)";o+=`<tr><td><strong>${t(z.name)}</strong></td>`,o+=`<td><code style="font-size:0.75rem">${t(z.type)}</code></td>`,o+=`<td style="font-size:0.8rem">${t(z.reason)}</td>`,o+=`<td><span style="color:${ne};font-weight:600">${z.savings.toUpperCase()}</span></td>`,o+=`<td><span style="color:${de};font-weight:600">${(z.risk||"none").toUpperCase()}</span></td></tr>`}),o+="</tbody></table></div>"}o+='<h3 style="margin:24px 0 12px;color:var(--primary)">4. Quantified Complexity Reduction</h3>';const x=s.length,b=w.length,S=x-b,y=x>0?Math.round(b/x*100):0,C=n?(n.cells||[]).length:S,P=Math.max(3,C-b);if(o+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px">',[{label:"NiFi Processors",value:x,color:"var(--text2)",sub:"current flow"},{label:"Can Be Dropped",value:b,color:"var(--amber)",sub:`${y}% reduction`},{label:"Essential Steps",value:S,color:"var(--green)",sub:"remain in Databricks"},{label:"Notebook Cells",value:P,color:"var(--primary)",sub:"projected output"}].forEach(F=>{o+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center">',o+=`<div style="font-size:2rem;font-weight:800;color:${F.color}">${F.value}</div>`,o+=`<div style="font-size:0.85rem;font-weight:600">${F.label}</div>`,o+=`<div style="font-size:0.75rem;color:var(--text2)">${F.sub}</div></div>`}),o+="</div>",w.length){const F={};w.forEach(G=>{const z=G.type.match(/Merge|Split/)?"Merge/Split":G.type.match(/Log|Debug|Count|Monitor/)?"Logging/Monitoring":G.type.match(/Route|Distribute|Control|Detect/)?"Routing/Control":G.type.match(/Update|Attribute|Enforce/)?"Attribute Management":G.type.match(/Wait|Notify|Retry/)?"Flow Control":G.type.match(/Validate/)?"Validation":G.type.match(/Compress|Unpack/)?"Compression":G.type.match(/Generate|Funnel|Port/)?"NiFi Internal":"Other";F[z]||(F[z]=[]),F[z].push(G)}),o+='<h4 style="margin:12px 0 6px">Dropped Processors by Category</h4>',o+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px">',Object.entries(F).sort((G,z)=>z[1].length-G[1].length).forEach(([G,z])=>{o+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px">',o+=`<strong style="font-size:0.85rem">${t(G)}</strong> <span style="color:var(--text2);font-size:0.8rem">(${z.length})</span>`,o+=`<div style="font-size:0.78rem;color:var(--text2);margin-top:4px">${z.map(ne=>t(ne.type)).join(", ")}</div></div>`}),o+="</div>"}o+='<h3 style="margin:24px 0 12px;color:var(--primary)">5. Migration ROI Summary</h3>';const A=e.processGroups.reduce((F,G)=>{const z=(G.path||G.name||"").split("/").length;return Math.max(F,z)},1),T=l.length>0?1+l.length*.15:1,I=(e.controllerServices||[]).length*4,v=Math.round((s.length*2+a.length+I+Object.keys(p).length*5+A*3)*T),M=S*2+Object.keys(p).length*3,K=v>0?Math.round((1-M/v)*100):0,Y=[{name:"ACID Transactions",desc:"Delta Lake provides full ACID guarantees on all data operations",icon:"&#128274;",when:()=>!0},{name:"Time Travel",desc:"Query and restore previous versions of data with VERSION AS OF",icon:"&#9200;",when:()=>!0},{name:"Unity Catalog Governance",desc:"Centralized access control, lineage, and audit logging",icon:"&#128737;",when:()=>(e.controllerServices||[]).length>0||Object.keys(p).length>0},{name:"ML Integration",desc:"Seamless integration with MLflow, Feature Store, and model serving",icon:"&#129302;",when:()=>s.some(F=>/Execute(Script|Stream)|Predict|ML|Model/i.test(F.type))},{name:"Auto Scaling",desc:"Automatic cluster scaling based on workload demand",icon:"&#128200;",when:()=>s.length>10},{name:"Photon Engine",desc:"Vectorized query engine for 2-8x performance improvement",icon:"&#9889;",when:()=>c.length>3||s.some(F=>/SQL|Query|Convert/i.test(F.type))},{name:"Delta Live Tables",desc:"Declarative data pipelines with built-in quality management",icon:"&#128736;",when:()=>!0},{name:"Liquid Clustering",desc:"Automatic data layout optimization replacing manual Z-ordering",icon:"&#128204;",when:()=>s.some(F=>/Merge|Partition|Sort/i.test(F.type))},{name:"Structured Streaming",desc:"Unified batch and streaming with exactly-once processing",icon:"&#127919;",when:()=>s.some(F=>/Consume|Subscribe|Listen|Kafka|JMS/i.test(F.type))},{name:"Secret Scopes",desc:"Secure credential management replacing NiFi controller services",icon:"&#128272;",when:()=>(e.controllerServices||[]).some(F=>/SSL|Password|Credential|DBCP/i.test(F.type))}].filter(F=>F.when());o+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">',o+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px">',o+='<h4 style="margin:0 0 12px;font-size:0.95rem">Complexity Comparison</h4>';const j=100,X=v>0?Math.round(M/v*100):50;o+=`<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:4px"><span>NiFi (current)</span><strong>${v} pts</strong></div>`,o+=`<div style="height:20px;background:var(--red)33;border-radius:4px;overflow:hidden"><div style="height:100%;width:${j}%;background:var(--red);border-radius:4px"></div></div></div>`,o+=`<div><div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:4px"><span>Databricks (projected)</span><strong>${M} pts</strong></div>`,o+=`<div style="height:20px;background:var(--green)33;border-radius:4px;overflow:hidden"><div style="height:100%;width:${X}%;background:var(--green);border-radius:4px"></div></div></div>`,o+=`<div style="text-align:center;margin-top:12px;font-size:1.1rem;font-weight:700;color:var(--green)">${K}% complexity reduction</div>`,o+="</div>",o+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px">',o+='<h4 style="margin:0 0 12px;font-size:0.95rem">Migration Summary</h4>',[{label:"Processors eliminated",value:`${b} of ${x} (${y}%)`},{label:"External systems",value:`${Object.keys(p).length} integration(s)`},{label:"Controller services",value:`${(e.controllerServices||[]).length} to migrate`},{label:"Process groups",value:`${e.processGroups.length} → Databricks jobs`},{label:"Notebook cells",value:`${P} (vs ${x} NiFi processors)`},{label:"New capabilities",value:`${Y.length} Databricks features gained`}].forEach(F=>{o+=`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:0.85rem"><span style="color:var(--text2)">${F.label}</span><strong>${F.value}</strong></div>`}),o+="</div></div>",o+='<h4 style="margin:16px 0 8px">New Capabilities Gained with Databricks</h4>',o+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px">',Y.forEach(F=>{o+='<div style="background:var(--green)08;border:1px solid var(--green)33;border-radius:8px;padding:10px">',o+=`<div style="font-size:1.1rem;margin-bottom:4px">${F.icon}</div>`,o+=`<div style="font-weight:600;font-size:0.88rem">${t(F.name)}</div>`,o+=`<div style="font-size:0.78rem;color:var(--text2);margin-top:2px">${t(F.desc)}</div></div>`}),o+="</div>",o+='<div style="margin-top:24px;text-align:center">',o+='<button class="btn btn-primary" id="valueAnalysisDownloadBtn">Download Value Analysis (JSON)</button>',o+="</div>";const L={summary:{totalProcessors:x,droppable:b,essential:S,reductionPct:y,nifiComplexity:v,dbxComplexity:M,complexityReduction:K},droppableProcessors:w,recommendations:E.map(F=>({category:F.category,nifi:F.nifi,dbx:F.dbx,benefit:F.benefit,priority:F.priority})),externalSystems:Object.keys(p),newCapabilities:Y.map(F=>F.name),timestamp:new Date().toISOString()};return{html:o,valueAnalysis:L}}function wt(e){const n=new Date().toISOString().replace(/[:.]/g,"-").substring(0,16);return`${e?.parsed?.source_name?e.parsed.source_name.replace(/\.[^.]+$/,"").replace(/[^a-zA-Z0-9_-]/g,"_").substring(0,40):"nifi_migration"}_${n}`}function Et(e,n){if(!e||e.size===0)return console.error("[download] Empty blob, skipping download for:",n),!1;const t=document.createElement("a");return t.href=URL.createObjectURL(e),t.download=n,t.click(),URL.revokeObjectURL(t.href),!0}function Ln(e){if(!e.notebook)return console.warn("[download] No notebook in state — complete Convert step first."),!1;const n=e.notebook.cells;if(!n||n.length===0)return console.warn("[download] Notebook has no cells — cannot download empty notebook."),!1;const t=n.filter(o=>!o.source||o.source.trim().length===0);t.length>0&&console.warn(`[download] ${t.length} empty cells detected in notebook.`);const s=n.map(o=>o.type==="md"||o.type==="markdown"||o.role==="markdown"?`# MAGIC %md
`+o.source.split(`
`).map(i=>"# MAGIC "+i).join(`
`):o.type==="sql"?`# MAGIC %sql
`+o.source.split(`
`).map(i=>"# MAGIC "+i).join(`
`):o.source),a=`# Databricks notebook source
# Generated: `+new Date().toISOString()+`
# Cells: `+n.length+`

`+s.join(`

# COMMAND ----------

`);return Et(new Blob([a],{type:"text/plain"}),wt(e)+"_notebook.py")}function Nn(e){if(!e.notebook?.workflow)return console.warn("[download] No workflow in state — complete Convert step first."),!1;const n={...e.notebook.workflow,_meta:{generated:new Date().toISOString(),tool:"NiFi Flow Analyzer v2.0.1",source:e.parsed?.source_name||"unknown"}};return Et(new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),wt(e)+"_workflow.json")}function On(e){if(!e.migrationReport)return console.warn("[download] No migration report in state — complete Report step first."),!1;const n=e.migrationReport,t=n.summary;let s=`# NiFi → Databricks Migration Report

`;return s+=`> Generated: ${new Date().toISOString()} | Tool: NiFi Flow Analyzer v2.0.1

`,s+=`## Summary
| Metric | Value |
|--------|-------|
`,s+=`| Total Processors | ${t.totalProcessors} |
| Mapped | ${t.mappedProcessors} |
| Unmapped | ${t.unmappedProcessors} |
`,s+=`| Coverage | ${t.coveragePercent}% |
| Process Groups | ${t.totalProcessGroups} |
| Effort | ${n.effort} |

`,s+=`## By Role
| Role | Mapped | Total | % |
|------|--------|-------|---|
`,Object.entries(n.byRole).forEach(([a,o])=>{s+=`| ${a} | ${o.mapped} | ${o.total} | ${o.total?Math.round(o.mapped/o.total*100):0}% |
`}),s+=`
## By Group
| Group | Mapped | Total | % |
|-------|--------|-------|---|
`,Object.entries(n.byGroup).forEach(([a,o])=>{s+=`| ${a} | ${o.mapped} | ${o.total} | ${o.total?Math.round(o.mapped/o.total*100):0}% |
`}),n.gaps&&n.gaps.length&&(s+=`
## Gaps (${n.gaps.length})
| Processor | Type | Group | Recommendation |
|-----------|------|-------|----------------|
`,n.gaps.forEach(a=>{s+=`| ${a.processor||a.name} | ${a.type} | ${a.group||"—"} | ${a.recommendation||"Manual"} |
`})),n.recommendations&&n.recommendations.length&&(s+=`
## Recommendations
`,n.recommendations.forEach(a=>{s+=`- ${a}
`})),Et(new Blob([s],{type:"text/markdown"}),wt(e)+"_migration_report.md")}function Mn(e){if(!e.finalReport)return console.warn("[download] No final report in state — complete Final Report step first."),!1;const n={...kn(e.finalReport),_meta:{generated:new Date().toISOString(),tool:"NiFi Flow Analyzer v2.0.1",source:e.parsed?.source_name||"unknown"}},t=JSON.stringify(n,null,2);return Et(new Blob([t],{type:"application/json"}),wt(e)+"_analysis_report.json")}function Bn(e){if(!e.validation)return console.warn("[download] No validation in state — complete Validate step first."),!1;const n={...kn(e.validation),_meta:{generated:new Date().toISOString(),tool:"NiFi Flow Analyzer v2.0.1"}},t=JSON.stringify(n,null,2);return Et(new Blob([t],{type:"application/json"}),wt(e)+"_validation_report.json")}function jn(e){if(!e.valueAnalysis)return console.warn("[download] No value analysis in state — complete Value Analysis step first."),!1;const t={...typeof e.valueAnalysis=="string"?{html:e.valueAnalysis}:e.valueAnalysis,_meta:{generated:new Date().toISOString(),tool:"NiFi Flow Analyzer v2.0.1"}},s=JSON.stringify(t,null,2);return Et(new Blob([s],{type:"application/json"}),wt(e)+"_value_analysis.json")}function Gr(e){if(!e||e.length===0){alert("No notebook cells generated yet. Run the conversion pipeline first.");return}let n=`# Databricks notebook source
`;n+=`# Generated by NiFi Flow Analyzer — Automated Migration
`,n+="# Date: "+new Date().toISOString().split("T")[0]+`

`,e.forEach((o,i)=>{i>0&&(n+=`
# COMMAND ----------

`);const r=o.source||o.code||"";o.type==="markdown"||o.type==="md"||o.role==="markdown"?(n+=`# MAGIC %md
`,r.split(`
`).forEach(c=>{n+="# MAGIC "+c+`
`})):o.type==="sql"?(n+=`# MAGIC %sql
`,r.split(`
`).forEach(c=>{n+="# MAGIC "+c+`
`})):n+=r+`
`});const t=new Blob([n],{type:"text/plain"}),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download="nifi_migration_notebook.py",a.click(),URL.revokeObjectURL(s)}function Hr(e){if(!e||e.length===0){alert("No notebook cells generated yet. Run the conversion pipeline first.");return}const n={nbformat:4,nbformat_minor:5,metadata:{kernelspec:{display_name:"Python 3",language:"python",name:"python3"},language_info:{name:"python",version:"3.10.0"}},cells:e.map(o=>{const i=o.type==="markdown"||o.type==="md"||o.role==="markdown",r={cell_type:i?"markdown":"code",metadata:{},source:(o.source||o.code||"").split(`
`).map((c,l,d)=>l<d.length-1?c+`
`:c)};return i||(r.outputs=[],r.execution_count=null),r})},t=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download="nifi_migration_notebook.ipynb",a.click(),URL.revokeObjectURL(s)}function kc(e,n){if(!e){alert("No NiFi flow loaded yet.");return}const t=e.processGroups||[],s=e.connections||[],a=n(t,s);let o=`# Databricks Workflow — Generated from NiFi Flow
`;o+="# Date: "+new Date().toISOString().split("T")[0]+`

`,o+=`name: nifi_migration_workflow
`,o+=`tasks:
`,a.tasks.forEach(l=>{o+="  - task_key: "+l.task_key+`
`,o+=`    notebook_task:
`,o+="      notebook_path: "+l.notebook_task.notebook_path+`
`,o+=`      source: WORKSPACE
`,l.depends_on&&l.depends_on.length>0&&(o+=`    depends_on:
`,l.depends_on.forEach(d=>{o+="      - task_key: "+d.task_key+`
`})),o+=`
`});const i=new Blob([o],{type:"text/yaml"}),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download="nifi_migration_workflow.yml",c.click(),URL.revokeObjectURL(r)}function Sc(e,{escapeHTML:n,metricsHTML:t}={}){const s={};return e.notebook&&e.parsed&&e.parsed._nifi&&(s.migrationReport=no(e.notebook.mappings||e.assessment?.mappings||[],e.parsed._nifi)),e.assessment&&e.parsed&&e.parsed._nifi&&(s.comparison=yc(e.assessment.mappings,e.parsed._nifi)),e.parsed&&(s.finalReport=co(e)),e.parsed&&e.parsed._nifi&&e.notebook&&n&&(s.valueAnalysis=lo({nifi:e.parsed._nifi,notebook:e.notebook,escapeHTML:n})),s}document.addEventListener("DOMContentLoaded",()=>{la();const e=ha();window.addEventListener("unhandledrejection",b=>{Ae(new Ee(b.reason?.message||"Unhandled promise rejection",{code:"UNHANDLED_REJECTION",severity:"high",cause:b.reason}))}),window.addEventListener("error",b=>{Ae(new Ee(b.message||"Uncaught error",{code:"UNCAUGHT_ERROR",severity:"high",context:{filename:b.filename,lineno:b.lineno}}))}),ya(),js();const n=document.getElementById("fileInput");n&&n.addEventListener("change",async()=>{It();const{handleFile:b}=await ut(async()=>{const{handleFile:S}=await Promise.resolve().then(()=>ka);return{handleFile:S}},void 0,import.meta.url);await b(),on()});const t=document.getElementById("parseBtn");t&&t.addEventListener("click",()=>{It(),on()}),document.querySelectorAll("[data-sample-flow]").forEach(b=>{b.addEventListener("click",()=>{const S=b.dataset.sampleFlow;It(),wa(S,on)})}),document.querySelectorAll("[data-sample-file]").forEach(b=>{b.addEventListener("click",()=>{const S=b.dataset.sampleFile,y=b.dataset.sampleName||S.split("/").pop();It(),Ea(S,y,on)})});const o=document.getElementById("analyzeBtn");o&&o.addEventListener("click",()=>{ro()});const i=document.getElementById("assessBtn");i&&i.addEventListener("click",()=>{so()});const r=document.getElementById("convertBtn");r&&r.addEventListener("click",()=>{oo()});const c=document.getElementById("reportBtn");c&&c.addEventListener("click",()=>{ao()});const l=document.getElementById("downloadNotebookBtn");l&&l.addEventListener("click",()=>{Ln(le())});const d=document.getElementById("downloadWorkflowBtn");d&&d.addEventListener("click",()=>{Nn(le())});const u=document.getElementById("downloadReportBtn");u&&u.addEventListener("click",()=>{On(le())});const f=document.getElementById("downloadFinalReportBtn");f&&f.addEventListener("click",()=>{Mn(le())});const p=document.getElementById("downloadValidationBtn");p&&p.addEventListener("click",()=>{Bn(le())});const h=document.getElementById("downloadValueBtn");h&&h.addEventListener("click",()=>{jn(le())});const m=document.getElementById("exportDatabricksBtn");m&&m.addEventListener("click",()=>{const S=le().notebook?.cells||[];Gr(S)});const g=document.getElementById("exportJupyterBtn");g&&g.addEventListener("click",()=>{const S=le().notebook?.cells||[];Hr(S)});const _=document.getElementById("exportWorkflowYamlBtn");_&&_.addEventListener("click",()=>{const b=le();b.parsed?._nifi&&kc(b.parsed._nifi,(S,y)=>({tasks:(S||[]).map((C,P)=>({task_key:C.name?.replace(/\s+/g,"_").toLowerCase()||`task_${P}`,notebook_task:{notebook_path:`/Workspace/Migrations/NiFi/${C.name||"task_"+P}`},depends_on:P>0?[{task_key:(S[P-1].name||`task_${P-1}`).replace(/\s+/g,"_").toLowerCase()}]:[]}))}))});const E=document.getElementById("cfgSaveBtn");E&&E.addEventListener("click",()=>{const b=Ls();ga(b),An.emit("config:saved",b);const S=E.textContent;E.textContent="Saved!",E.disabled=!0,setTimeout(()=>{E.textContent=S,E.disabled=!1},1500)});const w=document.getElementById("cfgResetBtn");w&&w.addEventListener("click",()=>{const b={...Te},S={cfgCatalog:b.catalog,cfgSchema:b.schema,cfgScope:b.secretScope,cfgCloud:b.cloudProvider,cfgSparkVersion:b.sparkVersion,cfgNodeType:b.nodeType,cfgWorkers:b.numWorkers,cfgWorkspacePath:b.workspacePath};Object.entries(S).forEach(([y,C])=>{const P=document.getElementById(y);P&&(P.value=C??"")}),An.emit("config:reset",b)}),document.body.addEventListener("click",b=>{const S=b.target.closest("button");if(!S)return;const y=S.textContent.trim().toLowerCase();y.includes("download")&&y.includes("notebook")?(b.preventDefault(),Ln(le())):y.includes("download")&&y.includes("workflow")?(b.preventDefault(),Nn(le())):y.includes("download")&&y.includes("report")&&y.includes("markdown")&&(b.preventDefault(),On(le()))}),window.downloadNotebook=()=>Ln(le()),window.downloadWorkflow=()=>Nn(le()),window.downloadReport=()=>On(le()),window.downloadFinalReport=()=>Mn(le()),window.downloadValidationReport=()=>Bn(le()),window.downloadValueAnalysis=()=>jn(le()),window.exportAsDatabricksNotebook=()=>{const b=le();Gr(b.notebook?.cells||[])},window.exportAsJupyterNotebook=()=>{const b=le();Hr(b.notebook?.cells||[])},window.parseFlow=st,window.runAnalysisEngine=dc,window.mapNiFiToDatabricks=br,window.generateNotebookAndWorkflow=pc,window.runValidationEngine=Ur,window.generateReportSuite=Sc,window.analyzeFlowGraph=io;const x=b=>'<div class="metrics">'+b.map(S=>{const y=Array.isArray(S)?S[0]:S.label,C=Array.isArray(S)?S[1]:S.value,P=Array.isArray(S)?S[2]:S.delta,R=Array.isArray(S)?"":S.color||"";return`<div class="metric"><div class="label">${y}</div><div class="value"${R?' style="color:'+R+'"':""}>${C}</div>${P?`<div class="delta">${P}</div>`:""}</div>`}).join("")+"</div>";window.generateFinalReport=async()=>{const b=le();if(!b.parsed)return;const S=Xe();fe("reportFinal","processing");try{const{html:y,report:C}=bc(b,x,V);Je({finalReport:C});const P=document.getElementById("reportFinalResults");P&&(P.innerHTML=y);const R=P&&P.querySelector(".btn-primary, .btn");R&&R.textContent.includes("Download Full Report")&&(R.removeAttribute("onclick"),R.addEventListener("click",()=>Mn(le()))),fe("reportFinal","done"),ct("validate");const A=document.getElementById("validateNotReady"),T=document.getElementById("validateReady");A&&A.classList.add("hidden"),T&&T.classList.remove("hidden")}catch(y){Ye(S),Ae(new Ee("Final report failed: "+y.message,{code:"FINAL_REPORT_FAILED",phase:"reportFinal",cause:y}));const C=document.getElementById("reportFinalResults");C&&(C.innerHTML=`<div class="alert alert-error">${V("Final report failed: "+y.message)}</div>`),fe("reportFinal","ready")}},window.runValidation=async()=>{const b=le();if(!b.parsed||!b.parsed._nifi||!b.notebook)return;const S=Xe();fe("validate","processing");const y=document.getElementById("validateResults");try{const C=await Ur({nifi:b.parsed._nifi,mappings:b.notebook.mappings||b.assessment?.mappings||[],cells:b.notebook.cells||[],systems:b.assessment?.systems||{},nifiDatabricksMap:Ot,onProgress:(A,T)=>{y&&(y.innerHTML=`<div style="color:var(--text2);padding:16px">${T} (${A}%)</div>`)}});if(Je({validation:C}),y){const A=C.overallScore||0;let I=`<hr class="divider"><div class="score-big" style="color:var(--${A>=90?"green":A>=70?"amber":"red"})">Validation Score: ${Math.round(A)}%</div>`;if(I+=x([{label:"Intent Match",value:Math.round(C.intentScore||0)+"%"},{label:"Line Coverage",value:Math.round(C.lineScore||0)+"%"},{label:"Reverse Eng.",value:Math.round(C.reScore||0)+"%"},{label:"Function Map",value:Math.round(C.funcScore||0)+"%"}]),C.allGaps&&C.allGaps.length){I+='<hr class="divider"><h3>Gaps ('+C.allGaps.length+")</h3>";const M=50,K=Math.ceil(C.allGaps.length/M);for(let U=0;U<K;U++){const Y=U*M,j=Math.min(Y+M,C.allGaps.length),X=K>1?`Gaps ${Y+1}-${j}`:"All Gaps";I+=`<div class="expander ${U===0?"open":""}"><div class="expander-header" data-expander-toggle><span>${X}</span><span class="expander-arrow">▶</span></div><div class="expander-body">`,I+='<ul style="margin:0;padding-left:20px;font-size:0.85rem">',C.allGaps.slice(Y,j).forEach(O=>{I+='<li style="margin:4px 0"><strong>'+V(O.processor||O.name||"")+"</strong>: "+V(O.gap||O.reason||O.message||"")+"</li>"}),I+="</ul></div></div>"}}C.missingImports&&C.missingImports.length&&(I+='<hr class="divider"><h3>Missing Imports ('+C.missingImports.length+")</h3>",I+='<ul style="margin:0;padding-left:20px;font-size:0.85rem">',C.missingImports.forEach(M=>{I+='<li style="margin:4px 0"><code>'+V(M.module||"")+"</code> needed by "+V(M.cell||"")+"</li>"}),I+="</ul>"),I+='<hr class="divider"><button class="btn" id="validationDownloadBtn">Download Validation Report</button>',y.innerHTML=I;const v=document.getElementById("validationDownloadBtn");v&&v.addEventListener("click",()=>Bn(le()))}fe("validate","done"),ct("value");const P=document.getElementById("valueNotReady"),R=document.getElementById("valueReady");P&&P.classList.add("hidden"),R&&R.classList.remove("hidden")}catch(C){Ye(S),Ae(new Ee("Validation failed: "+C.message,{code:"VALIDATE_FAILED",phase:"validate",cause:C})),y&&(y.innerHTML=`<div class="alert alert-error">${V("Validation failed: "+C.message)}</div>`),fe("validate","ready")}},window.runValueAnalysis=async()=>{const b=le();if(!b.parsed||!b.parsed._nifi||!b.notebook)return;const S=Xe();fe("value","processing");try{const y=lo({nifi:b.parsed._nifi,notebook:b.notebook,escapeHTML:V});Je({valueAnalysis:typeof y=="object"?y:{html:y}});const C=document.getElementById("valueResults");if(C){C.innerHTML=typeof y=="string"?y:y?.html||"";const P=C.querySelector(".btn-primary, .btn");P&&P.textContent.includes("Download Value Analysis")&&(P.removeAttribute("onclick"),P.addEventListener("click",()=>jn(le())))}fe("value","done")}catch(y){Ye(S),Ae(new Ee("Value analysis failed: "+y.message,{code:"VALUE_ANALYSIS_FAILED",phase:"value",cause:y}));const C=document.getElementById("valueResults");C&&(C.innerHTML=`<div class="alert alert-error">${V("Value analysis failed: "+y.message)}</div>`),fe("value","ready")}},console.info("[main] NiFi Flow Analyzer initialized"),An.emit("app:ready",{config:e})});/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const wc=4,Wr=0,Qr=1,Ec=2;function Ct(e){let n=e.length;for(;--n>=0;)e[n]=0}const Cc=0,po=1,xc=2,Pc=3,Tc=258,vr=29,Xt=256,Ut=Xt+1+vr,_t=30,kr=19,uo=2*Ut+1,ot=15,qn=16,Dc=7,Sr=256,fo=16,mo=17,ho=18,sr=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),yn=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Rc=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),go=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$c=512,Qe=new Array((Ut+2)*2);Ct(Qe);const Bt=new Array(_t*2);Ct(Bt);const zt=new Array($c);Ct(zt);const Gt=new Array(Tc-Pc+1);Ct(Gt);const wr=new Array(vr);Ct(wr);const Sn=new Array(_t);Ct(Sn);function Un(e,n,t,s,a){this.static_tree=e,this.extra_bits=n,this.extra_base=t,this.elems=s,this.max_length=a,this.has_stree=e&&e.length}let _o,yo,bo;function zn(e,n){this.dyn_tree=e,this.max_code=0,this.stat_desc=n}const vo=e=>e<256?zt[e]:zt[256+(e>>>7)],Ht=(e,n)=>{e.pending_buf[e.pending++]=n&255,e.pending_buf[e.pending++]=n>>>8&255},xe=(e,n,t)=>{e.bi_valid>qn-t?(e.bi_buf|=n<<e.bi_valid&65535,Ht(e,e.bi_buf),e.bi_buf=n>>qn-e.bi_valid,e.bi_valid+=t-qn):(e.bi_buf|=n<<e.bi_valid&65535,e.bi_valid+=t)},qe=(e,n,t)=>{xe(e,t[n*2],t[n*2+1])},ko=(e,n)=>{let t=0;do t|=e&1,e>>>=1,t<<=1;while(--n>0);return t>>>1},Ac=e=>{e.bi_valid===16?(Ht(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},Ic=(e,n)=>{const t=n.dyn_tree,s=n.max_code,a=n.stat_desc.static_tree,o=n.stat_desc.has_stree,i=n.stat_desc.extra_bits,r=n.stat_desc.extra_base,c=n.stat_desc.max_length;let l,d,u,f,p,h,m=0;for(f=0;f<=ot;f++)e.bl_count[f]=0;for(t[e.heap[e.heap_max]*2+1]=0,l=e.heap_max+1;l<uo;l++)d=e.heap[l],f=t[t[d*2+1]*2+1]+1,f>c&&(f=c,m++),t[d*2+1]=f,!(d>s)&&(e.bl_count[f]++,p=0,d>=r&&(p=i[d-r]),h=t[d*2],e.opt_len+=h*(f+p),o&&(e.static_len+=h*(a[d*2+1]+p)));if(m!==0){do{for(f=c-1;e.bl_count[f]===0;)f--;e.bl_count[f]--,e.bl_count[f+1]+=2,e.bl_count[c]--,m-=2}while(m>0);for(f=c;f!==0;f--)for(d=e.bl_count[f];d!==0;)u=e.heap[--l],!(u>s)&&(t[u*2+1]!==f&&(e.opt_len+=(f-t[u*2+1])*t[u*2],t[u*2+1]=f),d--)}},So=(e,n,t)=>{const s=new Array(ot+1);let a=0,o,i;for(o=1;o<=ot;o++)a=a+t[o-1]<<1,s[o]=a;for(i=0;i<=n;i++){let r=e[i*2+1];r!==0&&(e[i*2]=ko(s[r]++,r))}},Fc=()=>{let e,n,t,s,a;const o=new Array(ot+1);for(t=0,s=0;s<vr-1;s++)for(wr[s]=t,e=0;e<1<<sr[s];e++)Gt[t++]=s;for(Gt[t-1]=s,a=0,s=0;s<16;s++)for(Sn[s]=a,e=0;e<1<<yn[s];e++)zt[a++]=s;for(a>>=7;s<_t;s++)for(Sn[s]=a<<7,e=0;e<1<<yn[s]-7;e++)zt[256+a++]=s;for(n=0;n<=ot;n++)o[n]=0;for(e=0;e<=143;)Qe[e*2+1]=8,e++,o[8]++;for(;e<=255;)Qe[e*2+1]=9,e++,o[9]++;for(;e<=279;)Qe[e*2+1]=7,e++,o[7]++;for(;e<=287;)Qe[e*2+1]=8,e++,o[8]++;for(So(Qe,Ut+1,o),e=0;e<_t;e++)Bt[e*2+1]=5,Bt[e*2]=ko(e,5);_o=new Un(Qe,sr,Xt+1,Ut,ot),yo=new Un(Bt,yn,0,_t,ot),bo=new Un(new Array(0),Rc,0,kr,Dc)},wo=e=>{let n;for(n=0;n<Ut;n++)e.dyn_ltree[n*2]=0;for(n=0;n<_t;n++)e.dyn_dtree[n*2]=0;for(n=0;n<kr;n++)e.bl_tree[n*2]=0;e.dyn_ltree[Sr*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Eo=e=>{e.bi_valid>8?Ht(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},Kr=(e,n,t,s)=>{const a=n*2,o=t*2;return e[a]<e[o]||e[a]===e[o]&&s[n]<=s[t]},Gn=(e,n,t)=>{const s=e.heap[t];let a=t<<1;for(;a<=e.heap_len&&(a<e.heap_len&&Kr(n,e.heap[a+1],e.heap[a],e.depth)&&a++,!Kr(n,s,e.heap[a],e.depth));)e.heap[t]=e.heap[a],t=a,a<<=1;e.heap[t]=s},Jr=(e,n,t)=>{let s,a,o=0,i,r;if(e.sym_next!==0)do s=e.pending_buf[e.sym_buf+o++]&255,s+=(e.pending_buf[e.sym_buf+o++]&255)<<8,a=e.pending_buf[e.sym_buf+o++],s===0?qe(e,a,n):(i=Gt[a],qe(e,i+Xt+1,n),r=sr[i],r!==0&&(a-=wr[i],xe(e,a,r)),s--,i=vo(s),qe(e,i,t),r=yn[i],r!==0&&(s-=Sn[i],xe(e,s,r)));while(o<e.sym_next);qe(e,Sr,n)},or=(e,n)=>{const t=n.dyn_tree,s=n.stat_desc.static_tree,a=n.stat_desc.has_stree,o=n.stat_desc.elems;let i,r,c=-1,l;for(e.heap_len=0,e.heap_max=uo,i=0;i<o;i++)t[i*2]!==0?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):t[i*2+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=c<2?++c:0,t[l*2]=1,e.depth[l]=0,e.opt_len--,a&&(e.static_len-=s[l*2+1]);for(n.max_code=c,i=e.heap_len>>1;i>=1;i--)Gn(e,t,i);l=o;do i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Gn(e,t,1),r=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=r,t[l*2]=t[i*2]+t[r*2],e.depth[l]=(e.depth[i]>=e.depth[r]?e.depth[i]:e.depth[r])+1,t[i*2+1]=t[r*2+1]=l,e.heap[1]=l++,Gn(e,t,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],Ic(e,n),So(t,c,e.bl_count)},Zr=(e,n,t)=>{let s,a=-1,o,i=n[1],r=0,c=7,l=4;for(i===0&&(c=138,l=3),n[(t+1)*2+1]=65535,s=0;s<=t;s++)o=i,i=n[(s+1)*2+1],!(++r<c&&o===i)&&(r<l?e.bl_tree[o*2]+=r:o!==0?(o!==a&&e.bl_tree[o*2]++,e.bl_tree[fo*2]++):r<=10?e.bl_tree[mo*2]++:e.bl_tree[ho*2]++,r=0,a=o,i===0?(c=138,l=3):o===i?(c=6,l=3):(c=7,l=4))},Vr=(e,n,t)=>{let s,a=-1,o,i=n[1],r=0,c=7,l=4;for(i===0&&(c=138,l=3),s=0;s<=t;s++)if(o=i,i=n[(s+1)*2+1],!(++r<c&&o===i)){if(r<l)do qe(e,o,e.bl_tree);while(--r!==0);else o!==0?(o!==a&&(qe(e,o,e.bl_tree),r--),qe(e,fo,e.bl_tree),xe(e,r-3,2)):r<=10?(qe(e,mo,e.bl_tree),xe(e,r-3,3)):(qe(e,ho,e.bl_tree),xe(e,r-11,7));r=0,a=o,i===0?(c=138,l=3):o===i?(c=6,l=3):(c=7,l=4)}},Lc=e=>{let n;for(Zr(e,e.dyn_ltree,e.l_desc.max_code),Zr(e,e.dyn_dtree,e.d_desc.max_code),or(e,e.bl_desc),n=kr-1;n>=3&&e.bl_tree[go[n]*2+1]===0;n--);return e.opt_len+=3*(n+1)+5+5+4,n},Nc=(e,n,t,s)=>{let a;for(xe(e,n-257,5),xe(e,t-1,5),xe(e,s-4,4),a=0;a<s;a++)xe(e,e.bl_tree[go[a]*2+1],3);Vr(e,e.dyn_ltree,n-1),Vr(e,e.dyn_dtree,t-1)},Oc=e=>{let n=4093624447,t;for(t=0;t<=31;t++,n>>>=1)if(n&1&&e.dyn_ltree[t*2]!==0)return Wr;if(e.dyn_ltree[18]!==0||e.dyn_ltree[20]!==0||e.dyn_ltree[26]!==0)return Qr;for(t=32;t<Xt;t++)if(e.dyn_ltree[t*2]!==0)return Qr;return Wr};let Xr=!1;const Mc=e=>{Xr||(Fc(),Xr=!0),e.l_desc=new zn(e.dyn_ltree,_o),e.d_desc=new zn(e.dyn_dtree,yo),e.bl_desc=new zn(e.bl_tree,bo),e.bi_buf=0,e.bi_valid=0,wo(e)},Co=(e,n,t,s)=>{xe(e,(Cc<<1)+(s?1:0),3),Eo(e),Ht(e,t),Ht(e,~t),t&&e.pending_buf.set(e.window.subarray(n,n+t),e.pending),e.pending+=t},Bc=e=>{xe(e,po<<1,3),qe(e,Sr,Qe),Ac(e)},jc=(e,n,t,s)=>{let a,o,i=0;e.level>0?(e.strm.data_type===Ec&&(e.strm.data_type=Oc(e)),or(e,e.l_desc),or(e,e.d_desc),i=Lc(e),a=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=a&&(a=o)):a=o=t+5,t+4<=a&&n!==-1?Co(e,n,t,s):e.strategy===wc||o===a?(xe(e,(po<<1)+(s?1:0),3),Jr(e,Qe,Bt)):(xe(e,(xc<<1)+(s?1:0),3),Nc(e,e.l_desc.max_code+1,e.d_desc.max_code+1,i+1),Jr(e,e.dyn_ltree,e.dyn_dtree)),wo(e),s&&Eo(e)},qc=(e,n,t)=>(e.pending_buf[e.sym_buf+e.sym_next++]=n,e.pending_buf[e.sym_buf+e.sym_next++]=n>>8,e.pending_buf[e.sym_buf+e.sym_next++]=t,n===0?e.dyn_ltree[t*2]++:(e.matches++,n--,e.dyn_ltree[(Gt[t]+Xt+1)*2]++,e.dyn_dtree[vo(n)*2]++),e.sym_next===e.sym_end);var Uc=Mc,zc=Co,Gc=jc,Hc=qc,Wc=Bc,Qc={_tr_init:Uc,_tr_stored_block:zc,_tr_flush_block:Gc,_tr_tally:Hc,_tr_align:Wc};const Kc=(e,n,t,s)=>{let a=e&65535|0,o=e>>>16&65535|0,i=0;for(;t!==0;){i=t>2e3?2e3:t,t-=i;do a=a+n[s++]|0,o=o+a|0;while(--i);a%=65521,o%=65521}return a|o<<16|0};var Wt=Kc;const Jc=()=>{let e,n=[];for(var t=0;t<256;t++){e=t;for(var s=0;s<8;s++)e=e&1?3988292384^e>>>1:e>>>1;n[t]=e}return n},Zc=new Uint32Array(Jc()),Vc=(e,n,t,s)=>{const a=Zc,o=s+t;e^=-1;for(let i=s;i<o;i++)e=e>>>8^a[(e^n[i])&255];return e^-1};var be=Vc,lt={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Yt={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Xc,_tr_stored_block:ar,_tr_flush_block:Yc,_tr_tally:et,_tr_align:el}=Qc,{Z_NO_FLUSH:tt,Z_PARTIAL_FLUSH:tl,Z_FULL_FLUSH:nl,Z_FINISH:Ie,Z_BLOCK:Yr,Z_OK:ve,Z_STREAM_END:es,Z_STREAM_ERROR:Ue,Z_DATA_ERROR:rl,Z_BUF_ERROR:Hn,Z_DEFAULT_COMPRESSION:sl,Z_FILTERED:ol,Z_HUFFMAN_ONLY:ln,Z_RLE:al,Z_FIXED:il,Z_DEFAULT_STRATEGY:cl,Z_UNKNOWN:ll,Z_DEFLATED:Tn}=Yt,dl=9,pl=15,ul=8,fl=29,ml=256,ir=ml+1+fl,hl=30,gl=19,_l=2*ir+1,yl=15,se=3,Ve=258,ze=Ve+se+1,bl=32,kt=42,Er=57,cr=69,lr=73,dr=91,pr=103,at=113,Ft=666,ke=1,xt=2,dt=3,Pt=4,vl=3,it=(e,n)=>(e.msg=lt[n],n),ts=e=>e*2-(e>4?9:0),Ze=e=>{let n=e.length;for(;--n>=0;)e[n]=0},kl=e=>{let n,t,s,a=e.w_size;n=e.hash_size,s=n;do t=e.head[--s],e.head[s]=t>=a?t-a:0;while(--n);n=a,s=n;do t=e.prev[--s],e.prev[s]=t>=a?t-a:0;while(--n)};let Sl=(e,n,t)=>(n<<e.hash_shift^t)&e.hash_mask,nt=Sl;const Pe=e=>{const n=e.state;let t=n.pending;t>e.avail_out&&(t=e.avail_out),t!==0&&(e.output.set(n.pending_buf.subarray(n.pending_out,n.pending_out+t),e.next_out),e.next_out+=t,n.pending_out+=t,e.total_out+=t,e.avail_out-=t,n.pending-=t,n.pending===0&&(n.pending_out=0))},De=(e,n)=>{Yc(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,n),e.block_start=e.strstart,Pe(e.strm)},ce=(e,n)=>{e.pending_buf[e.pending++]=n},At=(e,n)=>{e.pending_buf[e.pending++]=n>>>8&255,e.pending_buf[e.pending++]=n&255},ur=(e,n,t,s)=>{let a=e.avail_in;return a>s&&(a=s),a===0?0:(e.avail_in-=a,n.set(e.input.subarray(e.next_in,e.next_in+a),t),e.state.wrap===1?e.adler=Wt(e.adler,n,a,t):e.state.wrap===2&&(e.adler=be(e.adler,n,a,t)),e.next_in+=a,e.total_in+=a,a)},xo=(e,n)=>{let t=e.max_chain_length,s=e.strstart,a,o,i=e.prev_length,r=e.nice_match;const c=e.strstart>e.w_size-ze?e.strstart-(e.w_size-ze):0,l=e.window,d=e.w_mask,u=e.prev,f=e.strstart+Ve;let p=l[s+i-1],h=l[s+i];e.prev_length>=e.good_match&&(t>>=2),r>e.lookahead&&(r=e.lookahead);do if(a=n,!(l[a+i]!==h||l[a+i-1]!==p||l[a]!==l[s]||l[++a]!==l[s+1])){s+=2,a++;do;while(l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&l[++s]===l[++a]&&s<f);if(o=Ve-(f-s),s=f-Ve,o>i){if(e.match_start=n,i=o,o>=r)break;p=l[s+i-1],h=l[s+i]}}while((n=u[n&d])>c&&--t!==0);return i<=e.lookahead?i:e.lookahead},St=e=>{const n=e.w_size;let t,s,a;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=n+(n-ze)&&(e.window.set(e.window.subarray(n,n+n-s),0),e.match_start-=n,e.strstart-=n,e.block_start-=n,e.insert>e.strstart&&(e.insert=e.strstart),kl(e),s+=n),e.strm.avail_in===0)break;if(t=ur(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=t,e.lookahead+e.insert>=se)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=nt(e,e.ins_h,e.window[a+1]);e.insert&&(e.ins_h=nt(e,e.ins_h,e.window[a+se-1]),e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<se)););}while(e.lookahead<ze&&e.strm.avail_in!==0)},Po=(e,n)=>{let t=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s,a,o,i=0,r=e.strm.avail_in;do{if(s=65535,o=e.bi_valid+42>>3,e.strm.avail_out<o||(o=e.strm.avail_out-o,a=e.strstart-e.block_start,s>a+e.strm.avail_in&&(s=a+e.strm.avail_in),s>o&&(s=o),s<t&&(s===0&&n!==Ie||n===tt||s!==a+e.strm.avail_in)))break;i=n===Ie&&s===a+e.strm.avail_in?1:0,ar(e,0,0,i),e.pending_buf[e.pending-4]=s,e.pending_buf[e.pending-3]=s>>8,e.pending_buf[e.pending-2]=~s,e.pending_buf[e.pending-1]=~s>>8,Pe(e.strm),a&&(a>s&&(a=s),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+a),e.strm.next_out),e.strm.next_out+=a,e.strm.avail_out-=a,e.strm.total_out+=a,e.block_start+=a,s-=a),s&&(ur(e.strm,e.strm.output,e.strm.next_out,s),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s)}while(i===0);return r-=e.strm.avail_in,r&&(r>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=r&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-r,e.strm.next_in),e.strstart),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),i?Pt:n!==tt&&n!==Ie&&e.strm.avail_in===0&&e.strstart===e.block_start?xt:(o=e.window_size-e.strstart,e.strm.avail_in>o&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,o+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),o>e.strm.avail_in&&(o=e.strm.avail_in),o&&(ur(e.strm,e.window,e.strstart,o),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.high_water<e.strstart&&(e.high_water=e.strstart),o=e.bi_valid+42>>3,o=e.pending_buf_size-o>65535?65535:e.pending_buf_size-o,t=o>e.w_size?e.w_size:o,a=e.strstart-e.block_start,(a>=t||(a||n===Ie)&&n!==tt&&e.strm.avail_in===0&&a<=o)&&(s=a>o?o:a,i=n===Ie&&e.strm.avail_in===0&&s===a?1:0,ar(e,e.block_start,s,i),e.block_start+=s,Pe(e.strm)),i?dt:ke)},Wn=(e,n)=>{let t,s;for(;;){if(e.lookahead<ze){if(St(e),e.lookahead<ze&&n===tt)return ke;if(e.lookahead===0)break}if(t=0,e.lookahead>=se&&(e.ins_h=nt(e,e.ins_h,e.window[e.strstart+se-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),t!==0&&e.strstart-t<=e.w_size-ze&&(e.match_length=xo(e,t)),e.match_length>=se)if(s=et(e,e.strstart-e.match_start,e.match_length-se),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=se){e.match_length--;do e.strstart++,e.ins_h=nt(e,e.ins_h,e.window[e.strstart+se-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=nt(e,e.ins_h,e.window[e.strstart+1]);else s=et(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(De(e,!1),e.strm.avail_out===0))return ke}return e.insert=e.strstart<se-1?e.strstart:se-1,n===Ie?(De(e,!0),e.strm.avail_out===0?dt:Pt):e.sym_next&&(De(e,!1),e.strm.avail_out===0)?ke:xt},ht=(e,n)=>{let t,s,a;for(;;){if(e.lookahead<ze){if(St(e),e.lookahead<ze&&n===tt)return ke;if(e.lookahead===0)break}if(t=0,e.lookahead>=se&&(e.ins_h=nt(e,e.ins_h,e.window[e.strstart+se-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=se-1,t!==0&&e.prev_length<e.max_lazy_match&&e.strstart-t<=e.w_size-ze&&(e.match_length=xo(e,t),e.match_length<=5&&(e.strategy===ol||e.match_length===se&&e.strstart-e.match_start>4096)&&(e.match_length=se-1)),e.prev_length>=se&&e.match_length<=e.prev_length){a=e.strstart+e.lookahead-se,s=et(e,e.strstart-1-e.prev_match,e.prev_length-se),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=a&&(e.ins_h=nt(e,e.ins_h,e.window[e.strstart+se-1]),t=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=se-1,e.strstart++,s&&(De(e,!1),e.strm.avail_out===0))return ke}else if(e.match_available){if(s=et(e,0,e.window[e.strstart-1]),s&&De(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return ke}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=et(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<se-1?e.strstart:se-1,n===Ie?(De(e,!0),e.strm.avail_out===0?dt:Pt):e.sym_next&&(De(e,!1),e.strm.avail_out===0)?ke:xt},wl=(e,n)=>{let t,s,a,o;const i=e.window;for(;;){if(e.lookahead<=Ve){if(St(e),e.lookahead<=Ve&&n===tt)return ke;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=se&&e.strstart>0&&(a=e.strstart-1,s=i[a],s===i[++a]&&s===i[++a]&&s===i[++a])){o=e.strstart+Ve;do;while(s===i[++a]&&s===i[++a]&&s===i[++a]&&s===i[++a]&&s===i[++a]&&s===i[++a]&&s===i[++a]&&s===i[++a]&&a<o);e.match_length=Ve-(o-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=se?(t=et(e,1,e.match_length-se),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(t=et(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),t&&(De(e,!1),e.strm.avail_out===0))return ke}return e.insert=0,n===Ie?(De(e,!0),e.strm.avail_out===0?dt:Pt):e.sym_next&&(De(e,!1),e.strm.avail_out===0)?ke:xt},El=(e,n)=>{let t;for(;;){if(e.lookahead===0&&(St(e),e.lookahead===0)){if(n===tt)return ke;break}if(e.match_length=0,t=et(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,t&&(De(e,!1),e.strm.avail_out===0))return ke}return e.insert=0,n===Ie?(De(e,!0),e.strm.avail_out===0?dt:Pt):e.sym_next&&(De(e,!1),e.strm.avail_out===0)?ke:xt};function je(e,n,t,s,a){this.good_length=e,this.max_lazy=n,this.nice_length=t,this.max_chain=s,this.func=a}const Lt=[new je(0,0,0,0,Po),new je(4,4,8,4,Wn),new je(4,5,16,8,Wn),new je(4,6,32,32,Wn),new je(4,4,16,16,ht),new je(8,16,32,32,ht),new je(8,16,128,128,ht),new je(8,32,128,256,ht),new je(32,128,258,1024,ht),new je(32,258,258,4096,ht)],Cl=e=>{e.window_size=2*e.w_size,Ze(e.head),e.max_lazy_match=Lt[e.level].max_lazy,e.good_match=Lt[e.level].good_length,e.nice_match=Lt[e.level].nice_length,e.max_chain_length=Lt[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=se-1,e.match_available=0,e.ins_h=0};function xl(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Tn,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(_l*2),this.dyn_dtree=new Uint16Array((2*hl+1)*2),this.bl_tree=new Uint16Array((2*gl+1)*2),Ze(this.dyn_ltree),Ze(this.dyn_dtree),Ze(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(yl+1),this.heap=new Uint16Array(2*ir+1),Ze(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*ir+1),Ze(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const en=e=>{if(!e)return 1;const n=e.state;return!n||n.strm!==e||n.status!==kt&&n.status!==Er&&n.status!==cr&&n.status!==lr&&n.status!==dr&&n.status!==pr&&n.status!==at&&n.status!==Ft?1:0},To=e=>{if(en(e))return it(e,Ue);e.total_in=e.total_out=0,e.data_type=ll;const n=e.state;return n.pending=0,n.pending_out=0,n.wrap<0&&(n.wrap=-n.wrap),n.status=n.wrap===2?Er:n.wrap?kt:at,e.adler=n.wrap===2?0:1,n.last_flush=-2,Xc(n),ve},Do=e=>{const n=To(e);return n===ve&&Cl(e.state),n},Pl=(e,n)=>en(e)||e.state.wrap!==2?Ue:(e.state.gzhead=n,ve),Ro=(e,n,t,s,a,o)=>{if(!e)return Ue;let i=1;if(n===sl&&(n=6),s<0?(i=0,s=-s):s>15&&(i=2,s-=16),a<1||a>dl||t!==Tn||s<8||s>15||n<0||n>9||o<0||o>il||s===8&&i!==1)return it(e,Ue);s===8&&(s=9);const r=new xl;return e.state=r,r.strm=e,r.status=kt,r.wrap=i,r.gzhead=null,r.w_bits=s,r.w_size=1<<r.w_bits,r.w_mask=r.w_size-1,r.hash_bits=a+7,r.hash_size=1<<r.hash_bits,r.hash_mask=r.hash_size-1,r.hash_shift=~~((r.hash_bits+se-1)/se),r.window=new Uint8Array(r.w_size*2),r.head=new Uint16Array(r.hash_size),r.prev=new Uint16Array(r.w_size),r.lit_bufsize=1<<a+6,r.pending_buf_size=r.lit_bufsize*4,r.pending_buf=new Uint8Array(r.pending_buf_size),r.sym_buf=r.lit_bufsize,r.sym_end=(r.lit_bufsize-1)*3,r.level=n,r.strategy=o,r.method=t,Do(e)},Tl=(e,n)=>Ro(e,n,Tn,pl,ul,cl),Dl=(e,n)=>{if(en(e)||n>Yr||n<0)return e?it(e,Ue):Ue;const t=e.state;if(!e.output||e.avail_in!==0&&!e.input||t.status===Ft&&n!==Ie)return it(e,e.avail_out===0?Hn:Ue);const s=t.last_flush;if(t.last_flush=n,t.pending!==0){if(Pe(e),e.avail_out===0)return t.last_flush=-1,ve}else if(e.avail_in===0&&ts(n)<=ts(s)&&n!==Ie)return it(e,Hn);if(t.status===Ft&&e.avail_in!==0)return it(e,Hn);if(t.status===kt&&t.wrap===0&&(t.status=at),t.status===kt){let a=Tn+(t.w_bits-8<<4)<<8,o=-1;if(t.strategy>=ln||t.level<2?o=0:t.level<6?o=1:t.level===6?o=2:o=3,a|=o<<6,t.strstart!==0&&(a|=bl),a+=31-a%31,At(t,a),t.strstart!==0&&(At(t,e.adler>>>16),At(t,e.adler&65535)),e.adler=1,t.status=at,Pe(e),t.pending!==0)return t.last_flush=-1,ve}if(t.status===Er){if(e.adler=0,ce(t,31),ce(t,139),ce(t,8),t.gzhead)ce(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),ce(t,t.gzhead.time&255),ce(t,t.gzhead.time>>8&255),ce(t,t.gzhead.time>>16&255),ce(t,t.gzhead.time>>24&255),ce(t,t.level===9?2:t.strategy>=ln||t.level<2?4:0),ce(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(ce(t,t.gzhead.extra.length&255),ce(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(e.adler=be(e.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=cr;else if(ce(t,0),ce(t,0),ce(t,0),ce(t,0),ce(t,0),ce(t,t.level===9?2:t.strategy>=ln||t.level<2?4:0),ce(t,vl),t.status=at,Pe(e),t.pending!==0)return t.last_flush=-1,ve}if(t.status===cr){if(t.gzhead.extra){let a=t.pending,o=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+o>t.pending_buf_size;){let r=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+r),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex+=r,Pe(e),t.pending!==0)return t.last_flush=-1,ve;a=0,o-=r}let i=new Uint8Array(t.gzhead.extra);t.pending_buf.set(i.subarray(t.gzindex,t.gzindex+o),t.pending),t.pending+=o,t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex=0}t.status=lr}if(t.status===lr){if(t.gzhead.name){let a=t.pending,o;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a)),Pe(e),t.pending!==0)return t.last_flush=-1,ve;a=0}t.gzindex<t.gzhead.name.length?o=t.gzhead.name.charCodeAt(t.gzindex++)&255:o=0,ce(t,o)}while(o!==0);t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a)),t.gzindex=0}t.status=dr}if(t.status===dr){if(t.gzhead.comment){let a=t.pending,o;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a)),Pe(e),t.pending!==0)return t.last_flush=-1,ve;a=0}t.gzindex<t.gzhead.comment.length?o=t.gzhead.comment.charCodeAt(t.gzindex++)&255:o=0,ce(t,o)}while(o!==0);t.gzhead.hcrc&&t.pending>a&&(e.adler=be(e.adler,t.pending_buf,t.pending-a,a))}t.status=pr}if(t.status===pr){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(Pe(e),t.pending!==0))return t.last_flush=-1,ve;ce(t,e.adler&255),ce(t,e.adler>>8&255),e.adler=0}if(t.status=at,Pe(e),t.pending!==0)return t.last_flush=-1,ve}if(e.avail_in!==0||t.lookahead!==0||n!==tt&&t.status!==Ft){let a=t.level===0?Po(t,n):t.strategy===ln?El(t,n):t.strategy===al?wl(t,n):Lt[t.level].func(t,n);if((a===dt||a===Pt)&&(t.status=Ft),a===ke||a===dt)return e.avail_out===0&&(t.last_flush=-1),ve;if(a===xt&&(n===tl?el(t):n!==Yr&&(ar(t,0,0,!1),n===nl&&(Ze(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),Pe(e),e.avail_out===0))return t.last_flush=-1,ve}return n!==Ie?ve:t.wrap<=0?es:(t.wrap===2?(ce(t,e.adler&255),ce(t,e.adler>>8&255),ce(t,e.adler>>16&255),ce(t,e.adler>>24&255),ce(t,e.total_in&255),ce(t,e.total_in>>8&255),ce(t,e.total_in>>16&255),ce(t,e.total_in>>24&255)):(At(t,e.adler>>>16),At(t,e.adler&65535)),Pe(e),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?ve:es)},Rl=e=>{if(en(e))return Ue;const n=e.state.status;return e.state=null,n===at?it(e,rl):ve},$l=(e,n)=>{let t=n.length;if(en(e))return Ue;const s=e.state,a=s.wrap;if(a===2||a===1&&s.status!==kt||s.lookahead)return Ue;if(a===1&&(e.adler=Wt(e.adler,n,t,0)),s.wrap=0,t>=s.w_size){a===0&&(Ze(s.head),s.strstart=0,s.block_start=0,s.insert=0);let c=new Uint8Array(s.w_size);c.set(n.subarray(t-s.w_size,t),0),n=c,t=s.w_size}const o=e.avail_in,i=e.next_in,r=e.input;for(e.avail_in=t,e.next_in=0,e.input=n,St(s);s.lookahead>=se;){let c=s.strstart,l=s.lookahead-(se-1);do s.ins_h=nt(s,s.ins_h,s.window[c+se-1]),s.prev[c&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=c,c++;while(--l);s.strstart=c,s.lookahead=se-1,St(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=se-1,s.match_available=0,e.next_in=i,e.input=r,e.avail_in=o,s.wrap=a,ve};var Al=Tl,Il=Ro,Fl=Do,Ll=To,Nl=Pl,Ol=Dl,Ml=Rl,Bl=$l,jl="pako deflate (from Nodeca project)",jt={deflateInit:Al,deflateInit2:Il,deflateReset:Fl,deflateResetKeep:Ll,deflateSetHeader:Nl,deflate:Ol,deflateEnd:Ml,deflateSetDictionary:Bl,deflateInfo:jl};const ql=(e,n)=>Object.prototype.hasOwnProperty.call(e,n);var Ul=function(e){const n=Array.prototype.slice.call(arguments,1);for(;n.length;){const t=n.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const s in t)ql(t,s)&&(e[s]=t[s])}}return e},zl=e=>{let n=0;for(let s=0,a=e.length;s<a;s++)n+=e[s].length;const t=new Uint8Array(n);for(let s=0,a=0,o=e.length;s<o;s++){let i=e[s];t.set(i,a),a+=i.length}return t},Dn={assign:Ul,flattenChunks:zl};let $o=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{$o=!1}const Qt=new Uint8Array(256);for(let e=0;e<256;e++)Qt[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Qt[254]=Qt[254]=1;var Gl=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let n,t,s,a,o,i=e.length,r=0;for(a=0;a<i;a++)t=e.charCodeAt(a),(t&64512)===55296&&a+1<i&&(s=e.charCodeAt(a+1),(s&64512)===56320&&(t=65536+(t-55296<<10)+(s-56320),a++)),r+=t<128?1:t<2048?2:t<65536?3:4;for(n=new Uint8Array(r),o=0,a=0;o<r;a++)t=e.charCodeAt(a),(t&64512)===55296&&a+1<i&&(s=e.charCodeAt(a+1),(s&64512)===56320&&(t=65536+(t-55296<<10)+(s-56320),a++)),t<128?n[o++]=t:t<2048?(n[o++]=192|t>>>6,n[o++]=128|t&63):t<65536?(n[o++]=224|t>>>12,n[o++]=128|t>>>6&63,n[o++]=128|t&63):(n[o++]=240|t>>>18,n[o++]=128|t>>>12&63,n[o++]=128|t>>>6&63,n[o++]=128|t&63);return n};const Hl=(e,n)=>{if(n<65534&&e.subarray&&$o)return String.fromCharCode.apply(null,e.length===n?e:e.subarray(0,n));let t="";for(let s=0;s<n;s++)t+=String.fromCharCode(e[s]);return t};var Wl=(e,n)=>{const t=n||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,n));let s,a;const o=new Array(t*2);for(a=0,s=0;s<t;){let i=e[s++];if(i<128){o[a++]=i;continue}let r=Qt[i];if(r>4){o[a++]=65533,s+=r-1;continue}for(i&=r===2?31:r===3?15:7;r>1&&s<t;)i=i<<6|e[s++]&63,r--;if(r>1){o[a++]=65533;continue}i<65536?o[a++]=i:(i-=65536,o[a++]=55296|i>>10&1023,o[a++]=56320|i&1023)}return Hl(o,a)},Ql=(e,n)=>{n=n||e.length,n>e.length&&(n=e.length);let t=n-1;for(;t>=0&&(e[t]&192)===128;)t--;return t<0||t===0?n:t+Qt[e[t]]>n?t:n},Kt={string2buf:Gl,buf2string:Wl,utf8border:Ql};function Kl(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var Ao=Kl;const Io=Object.prototype.toString,{Z_NO_FLUSH:Jl,Z_SYNC_FLUSH:Zl,Z_FULL_FLUSH:Vl,Z_FINISH:Xl,Z_OK:wn,Z_STREAM_END:Yl,Z_DEFAULT_COMPRESSION:ed,Z_DEFAULT_STRATEGY:td,Z_DEFLATED:nd}=Yt;function tn(e){this.options=Dn.assign({level:ed,method:nd,chunkSize:16384,windowBits:15,memLevel:8,strategy:td},e||{});let n=this.options;n.raw&&n.windowBits>0?n.windowBits=-n.windowBits:n.gzip&&n.windowBits>0&&n.windowBits<16&&(n.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ao,this.strm.avail_out=0;let t=jt.deflateInit2(this.strm,n.level,n.method,n.windowBits,n.memLevel,n.strategy);if(t!==wn)throw new Error(lt[t]);if(n.header&&jt.deflateSetHeader(this.strm,n.header),n.dictionary){let s;if(typeof n.dictionary=="string"?s=Kt.string2buf(n.dictionary):Io.call(n.dictionary)==="[object ArrayBuffer]"?s=new Uint8Array(n.dictionary):s=n.dictionary,t=jt.deflateSetDictionary(this.strm,s),t!==wn)throw new Error(lt[t]);this._dict_set=!0}}tn.prototype.push=function(e,n){const t=this.strm,s=this.options.chunkSize;let a,o;if(this.ended)return!1;for(n===~~n?o=n:o=n===!0?Xl:Jl,typeof e=="string"?t.input=Kt.string2buf(e):Io.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(s),t.next_out=0,t.avail_out=s),(o===Zl||o===Vl)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(a=jt.deflate(t,o),a===Yl)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),a=jt.deflateEnd(this.strm),this.onEnd(a),this.ended=!0,a===wn;if(t.avail_out===0){this.onData(t.output);continue}if(o>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};tn.prototype.onData=function(e){this.chunks.push(e)};tn.prototype.onEnd=function(e){e===wn&&(this.result=Dn.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function Cr(e,n){const t=new tn(n);if(t.push(e,!0),t.err)throw t.msg||lt[t.err];return t.result}function rd(e,n){return n=n||{},n.raw=!0,Cr(e,n)}function sd(e,n){return n=n||{},n.gzip=!0,Cr(e,n)}var od=tn,ad=Cr,id=rd,cd=sd,ld={Deflate:od,deflate:ad,deflateRaw:id,gzip:cd};const dn=16209,dd=16191;var pd=function(n,t){let s,a,o,i,r,c,l,d,u,f,p,h,m,g,_,E,w,x,b,S,y,C,P,R;const A=n.state;s=n.next_in,P=n.input,a=s+(n.avail_in-5),o=n.next_out,R=n.output,i=o-(t-n.avail_out),r=o+(n.avail_out-257),c=A.dmax,l=A.wsize,d=A.whave,u=A.wnext,f=A.window,p=A.hold,h=A.bits,m=A.lencode,g=A.distcode,_=(1<<A.lenbits)-1,E=(1<<A.distbits)-1;e:do{h<15&&(p+=P[s++]<<h,h+=8,p+=P[s++]<<h,h+=8),w=m[p&_];t:for(;;){if(x=w>>>24,p>>>=x,h-=x,x=w>>>16&255,x===0)R[o++]=w&65535;else if(x&16){b=w&65535,x&=15,x&&(h<x&&(p+=P[s++]<<h,h+=8),b+=p&(1<<x)-1,p>>>=x,h-=x),h<15&&(p+=P[s++]<<h,h+=8,p+=P[s++]<<h,h+=8),w=g[p&E];n:for(;;){if(x=w>>>24,p>>>=x,h-=x,x=w>>>16&255,x&16){if(S=w&65535,x&=15,h<x&&(p+=P[s++]<<h,h+=8,h<x&&(p+=P[s++]<<h,h+=8)),S+=p&(1<<x)-1,S>c){n.msg="invalid distance too far back",A.mode=dn;break e}if(p>>>=x,h-=x,x=o-i,S>x){if(x=S-x,x>d&&A.sane){n.msg="invalid distance too far back",A.mode=dn;break e}if(y=0,C=f,u===0){if(y+=l-x,x<b){b-=x;do R[o++]=f[y++];while(--x);y=o-S,C=R}}else if(u<x){if(y+=l+u-x,x-=u,x<b){b-=x;do R[o++]=f[y++];while(--x);if(y=0,u<b){x=u,b-=x;do R[o++]=f[y++];while(--x);y=o-S,C=R}}}else if(y+=u-x,x<b){b-=x;do R[o++]=f[y++];while(--x);y=o-S,C=R}for(;b>2;)R[o++]=C[y++],R[o++]=C[y++],R[o++]=C[y++],b-=3;b&&(R[o++]=C[y++],b>1&&(R[o++]=C[y++]))}else{y=o-S;do R[o++]=R[y++],R[o++]=R[y++],R[o++]=R[y++],b-=3;while(b>2);b&&(R[o++]=R[y++],b>1&&(R[o++]=R[y++]))}}else if((x&64)===0){w=g[(w&65535)+(p&(1<<x)-1)];continue n}else{n.msg="invalid distance code",A.mode=dn;break e}break}}else if((x&64)===0){w=m[(w&65535)+(p&(1<<x)-1)];continue t}else if(x&32){A.mode=dd;break e}else{n.msg="invalid literal/length code",A.mode=dn;break e}break}}while(s<a&&o<r);b=h>>3,s-=b,h-=b<<3,p&=(1<<h)-1,n.next_in=s,n.next_out=o,n.avail_in=s<a?5+(a-s):5-(s-a),n.avail_out=o<r?257+(r-o):257-(o-r),A.hold=p,A.bits=h};const gt=15,ns=852,rs=592,ss=0,Qn=1,os=2,ud=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),fd=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),md=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),hd=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),gd=(e,n,t,s,a,o,i,r)=>{const c=r.bits;let l=0,d=0,u=0,f=0,p=0,h=0,m=0,g=0,_=0,E=0,w,x,b,S,y,C=null,P;const R=new Uint16Array(gt+1),A=new Uint16Array(gt+1);let T=null,I,v,M;for(l=0;l<=gt;l++)R[l]=0;for(d=0;d<s;d++)R[n[t+d]]++;for(p=c,f=gt;f>=1&&R[f]===0;f--);if(p>f&&(p=f),f===0)return a[o++]=1<<24|64<<16|0,a[o++]=1<<24|64<<16|0,r.bits=1,0;for(u=1;u<f&&R[u]===0;u++);for(p<u&&(p=u),g=1,l=1;l<=gt;l++)if(g<<=1,g-=R[l],g<0)return-1;if(g>0&&(e===ss||f!==1))return-1;for(A[1]=0,l=1;l<gt;l++)A[l+1]=A[l]+R[l];for(d=0;d<s;d++)n[t+d]!==0&&(i[A[n[t+d]]++]=d);if(e===ss?(C=T=i,P=20):e===Qn?(C=ud,T=fd,P=257):(C=md,T=hd,P=0),E=0,d=0,l=u,y=o,h=p,m=0,b=-1,_=1<<p,S=_-1,e===Qn&&_>ns||e===os&&_>rs)return 1;for(;;){I=l-m,i[d]+1<P?(v=0,M=i[d]):i[d]>=P?(v=T[i[d]-P],M=C[i[d]-P]):(v=96,M=0),w=1<<l-m,x=1<<h,u=x;do x-=w,a[y+(E>>m)+x]=I<<24|v<<16|M|0;while(x!==0);for(w=1<<l-1;E&w;)w>>=1;if(w!==0?(E&=w-1,E+=w):E=0,d++,--R[l]===0){if(l===f)break;l=n[t+i[d]]}if(l>p&&(E&S)!==b){for(m===0&&(m=p),y+=u,h=l-m,g=1<<h;h+m<f&&(g-=R[h+m],!(g<=0));)h++,g<<=1;if(_+=1<<h,e===Qn&&_>ns||e===os&&_>rs)return 1;b=E&S,a[b]=p<<24|h<<16|y-o|0}}return E!==0&&(a[y+E]=l-m<<24|64<<16|0),r.bits=p,0};var qt=gd;const _d=0,Fo=1,Lo=2,{Z_FINISH:as,Z_BLOCK:yd,Z_TREES:pn,Z_OK:pt,Z_STREAM_END:bd,Z_NEED_DICT:vd,Z_STREAM_ERROR:Le,Z_DATA_ERROR:No,Z_MEM_ERROR:Oo,Z_BUF_ERROR:kd,Z_DEFLATED:is}=Yt,Rn=16180,cs=16181,ls=16182,ds=16183,ps=16184,us=16185,fs=16186,ms=16187,hs=16188,gs=16189,En=16190,We=16191,Kn=16192,_s=16193,Jn=16194,ys=16195,bs=16196,vs=16197,ks=16198,un=16199,fn=16200,Ss=16201,ws=16202,Es=16203,Cs=16204,xs=16205,Zn=16206,Ps=16207,Ts=16208,he=16209,Mo=16210,Bo=16211,Sd=852,wd=592,Ed=15,Cd=Ed,Ds=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function xd(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const ft=e=>{if(!e)return 1;const n=e.state;return!n||n.strm!==e||n.mode<Rn||n.mode>Bo?1:0},jo=e=>{if(ft(e))return Le;const n=e.state;return e.total_in=e.total_out=n.total=0,e.msg="",n.wrap&&(e.adler=n.wrap&1),n.mode=Rn,n.last=0,n.havedict=0,n.flags=-1,n.dmax=32768,n.head=null,n.hold=0,n.bits=0,n.lencode=n.lendyn=new Int32Array(Sd),n.distcode=n.distdyn=new Int32Array(wd),n.sane=1,n.back=-1,pt},qo=e=>{if(ft(e))return Le;const n=e.state;return n.wsize=0,n.whave=0,n.wnext=0,jo(e)},Uo=(e,n)=>{let t;if(ft(e))return Le;const s=e.state;return n<0?(t=0,n=-n):(t=(n>>4)+5,n<48&&(n&=15)),n&&(n<8||n>15)?Le:(s.window!==null&&s.wbits!==n&&(s.window=null),s.wrap=t,s.wbits=n,qo(e))},zo=(e,n)=>{if(!e)return Le;const t=new xd;e.state=t,t.strm=e,t.window=null,t.mode=Rn;const s=Uo(e,n);return s!==pt&&(e.state=null),s},Pd=e=>zo(e,Cd);let Rs=!0,Vn,Xn;const Td=e=>{if(Rs){Vn=new Int32Array(512),Xn=new Int32Array(32);let n=0;for(;n<144;)e.lens[n++]=8;for(;n<256;)e.lens[n++]=9;for(;n<280;)e.lens[n++]=7;for(;n<288;)e.lens[n++]=8;for(qt(Fo,e.lens,0,288,Vn,0,e.work,{bits:9}),n=0;n<32;)e.lens[n++]=5;qt(Lo,e.lens,0,32,Xn,0,e.work,{bits:5}),Rs=!1}e.lencode=Vn,e.lenbits=9,e.distcode=Xn,e.distbits=5},Go=(e,n,t,s)=>{let a;const o=e.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),s>=o.wsize?(o.window.set(n.subarray(t-o.wsize,t),0),o.wnext=0,o.whave=o.wsize):(a=o.wsize-o.wnext,a>s&&(a=s),o.window.set(n.subarray(t-s,t-s+a),o.wnext),s-=a,s?(o.window.set(n.subarray(t-s,t),0),o.wnext=s,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0},Dd=(e,n)=>{let t,s,a,o,i,r,c,l,d,u,f,p,h,m,g=0,_,E,w,x,b,S,y,C;const P=new Uint8Array(4);let R,A;const T=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ft(e)||!e.output||!e.input&&e.avail_in!==0)return Le;t=e.state,t.mode===We&&(t.mode=Kn),i=e.next_out,a=e.output,c=e.avail_out,o=e.next_in,s=e.input,r=e.avail_in,l=t.hold,d=t.bits,u=r,f=c,C=pt;e:for(;;)switch(t.mode){case Rn:if(t.wrap===0){t.mode=Kn;break}for(;d<16;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(t.wrap&2&&l===35615){t.wbits===0&&(t.wbits=15),t.check=0,P[0]=l&255,P[1]=l>>>8&255,t.check=be(t.check,P,2,0),l=0,d=0,t.mode=cs;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((l&255)<<8)+(l>>8))%31){e.msg="incorrect header check",t.mode=he;break}if((l&15)!==is){e.msg="unknown compression method",t.mode=he;break}if(l>>>=4,d-=4,y=(l&15)+8,t.wbits===0&&(t.wbits=y),y>15||y>t.wbits){e.msg="invalid window size",t.mode=he;break}t.dmax=1<<t.wbits,t.flags=0,e.adler=t.check=1,t.mode=l&512?gs:We,l=0,d=0;break;case cs:for(;d<16;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(t.flags=l,(t.flags&255)!==is){e.msg="unknown compression method",t.mode=he;break}if(t.flags&57344){e.msg="unknown header flags set",t.mode=he;break}t.head&&(t.head.text=l>>8&1),t.flags&512&&t.wrap&4&&(P[0]=l&255,P[1]=l>>>8&255,t.check=be(t.check,P,2,0)),l=0,d=0,t.mode=ls;case ls:for(;d<32;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.head&&(t.head.time=l),t.flags&512&&t.wrap&4&&(P[0]=l&255,P[1]=l>>>8&255,P[2]=l>>>16&255,P[3]=l>>>24&255,t.check=be(t.check,P,4,0)),l=0,d=0,t.mode=ds;case ds:for(;d<16;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.head&&(t.head.xflags=l&255,t.head.os=l>>8),t.flags&512&&t.wrap&4&&(P[0]=l&255,P[1]=l>>>8&255,t.check=be(t.check,P,2,0)),l=0,d=0,t.mode=ps;case ps:if(t.flags&1024){for(;d<16;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.length=l,t.head&&(t.head.extra_len=l),t.flags&512&&t.wrap&4&&(P[0]=l&255,P[1]=l>>>8&255,t.check=be(t.check,P,2,0)),l=0,d=0}else t.head&&(t.head.extra=null);t.mode=us;case us:if(t.flags&1024&&(p=t.length,p>r&&(p=r),p&&(t.head&&(y=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(s.subarray(o,o+p),y)),t.flags&512&&t.wrap&4&&(t.check=be(t.check,s,p,o)),r-=p,o+=p,t.length-=p),t.length))break e;t.length=0,t.mode=fs;case fs:if(t.flags&2048){if(r===0)break e;p=0;do y=s[o+p++],t.head&&y&&t.length<65536&&(t.head.name+=String.fromCharCode(y));while(y&&p<r);if(t.flags&512&&t.wrap&4&&(t.check=be(t.check,s,p,o)),r-=p,o+=p,y)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=ms;case ms:if(t.flags&4096){if(r===0)break e;p=0;do y=s[o+p++],t.head&&y&&t.length<65536&&(t.head.comment+=String.fromCharCode(y));while(y&&p<r);if(t.flags&512&&t.wrap&4&&(t.check=be(t.check,s,p,o)),r-=p,o+=p,y)break e}else t.head&&(t.head.comment=null);t.mode=hs;case hs:if(t.flags&512){for(;d<16;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(t.wrap&4&&l!==(t.check&65535)){e.msg="header crc mismatch",t.mode=he;break}l=0,d=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=We;break;case gs:for(;d<32;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}e.adler=t.check=Ds(l),l=0,d=0,t.mode=En;case En:if(t.havedict===0)return e.next_out=i,e.avail_out=c,e.next_in=o,e.avail_in=r,t.hold=l,t.bits=d,vd;e.adler=t.check=1,t.mode=We;case We:if(n===yd||n===pn)break e;case Kn:if(t.last){l>>>=d&7,d-=d&7,t.mode=Zn;break}for(;d<3;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}switch(t.last=l&1,l>>>=1,d-=1,l&3){case 0:t.mode=_s;break;case 1:if(Td(t),t.mode=un,n===pn){l>>>=2,d-=2;break e}break;case 2:t.mode=bs;break;case 3:e.msg="invalid block type",t.mode=he}l>>>=2,d-=2;break;case _s:for(l>>>=d&7,d-=d&7;d<32;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if((l&65535)!==(l>>>16^65535)){e.msg="invalid stored block lengths",t.mode=he;break}if(t.length=l&65535,l=0,d=0,t.mode=Jn,n===pn)break e;case Jn:t.mode=ys;case ys:if(p=t.length,p){if(p>r&&(p=r),p>c&&(p=c),p===0)break e;a.set(s.subarray(o,o+p),i),r-=p,o+=p,c-=p,i+=p,t.length-=p;break}t.mode=We;break;case bs:for(;d<14;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(t.nlen=(l&31)+257,l>>>=5,d-=5,t.ndist=(l&31)+1,l>>>=5,d-=5,t.ncode=(l&15)+4,l>>>=4,d-=4,t.nlen>286||t.ndist>30){e.msg="too many length or distance symbols",t.mode=he;break}t.have=0,t.mode=vs;case vs:for(;t.have<t.ncode;){for(;d<3;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.lens[T[t.have++]]=l&7,l>>>=3,d-=3}for(;t.have<19;)t.lens[T[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,R={bits:t.lenbits},C=qt(_d,t.lens,0,19,t.lencode,0,t.work,R),t.lenbits=R.bits,C){e.msg="invalid code lengths set",t.mode=he;break}t.have=0,t.mode=ks;case ks:for(;t.have<t.nlen+t.ndist;){for(;g=t.lencode[l&(1<<t.lenbits)-1],_=g>>>24,E=g>>>16&255,w=g&65535,!(_<=d);){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(w<16)l>>>=_,d-=_,t.lens[t.have++]=w;else{if(w===16){for(A=_+2;d<A;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(l>>>=_,d-=_,t.have===0){e.msg="invalid bit length repeat",t.mode=he;break}y=t.lens[t.have-1],p=3+(l&3),l>>>=2,d-=2}else if(w===17){for(A=_+3;d<A;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}l>>>=_,d-=_,y=0,p=3+(l&7),l>>>=3,d-=3}else{for(A=_+7;d<A;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}l>>>=_,d-=_,y=0,p=11+(l&127),l>>>=7,d-=7}if(t.have+p>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=he;break}for(;p--;)t.lens[t.have++]=y}}if(t.mode===he)break;if(t.lens[256]===0){e.msg="invalid code -- missing end-of-block",t.mode=he;break}if(t.lenbits=9,R={bits:t.lenbits},C=qt(Fo,t.lens,0,t.nlen,t.lencode,0,t.work,R),t.lenbits=R.bits,C){e.msg="invalid literal/lengths set",t.mode=he;break}if(t.distbits=6,t.distcode=t.distdyn,R={bits:t.distbits},C=qt(Lo,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,R),t.distbits=R.bits,C){e.msg="invalid distances set",t.mode=he;break}if(t.mode=un,n===pn)break e;case un:t.mode=fn;case fn:if(r>=6&&c>=258){e.next_out=i,e.avail_out=c,e.next_in=o,e.avail_in=r,t.hold=l,t.bits=d,pd(e,f),i=e.next_out,a=e.output,c=e.avail_out,o=e.next_in,s=e.input,r=e.avail_in,l=t.hold,d=t.bits,t.mode===We&&(t.back=-1);break}for(t.back=0;g=t.lencode[l&(1<<t.lenbits)-1],_=g>>>24,E=g>>>16&255,w=g&65535,!(_<=d);){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(E&&(E&240)===0){for(x=_,b=E,S=w;g=t.lencode[S+((l&(1<<x+b)-1)>>x)],_=g>>>24,E=g>>>16&255,w=g&65535,!(x+_<=d);){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}l>>>=x,d-=x,t.back+=x}if(l>>>=_,d-=_,t.back+=_,t.length=w,E===0){t.mode=xs;break}if(E&32){t.back=-1,t.mode=We;break}if(E&64){e.msg="invalid literal/length code",t.mode=he;break}t.extra=E&15,t.mode=Ss;case Ss:if(t.extra){for(A=t.extra;d<A;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.length+=l&(1<<t.extra)-1,l>>>=t.extra,d-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=ws;case ws:for(;g=t.distcode[l&(1<<t.distbits)-1],_=g>>>24,E=g>>>16&255,w=g&65535,!(_<=d);){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if((E&240)===0){for(x=_,b=E,S=w;g=t.distcode[S+((l&(1<<x+b)-1)>>x)],_=g>>>24,E=g>>>16&255,w=g&65535,!(x+_<=d);){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}l>>>=x,d-=x,t.back+=x}if(l>>>=_,d-=_,t.back+=_,E&64){e.msg="invalid distance code",t.mode=he;break}t.offset=w,t.extra=E&15,t.mode=Es;case Es:if(t.extra){for(A=t.extra;d<A;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}t.offset+=l&(1<<t.extra)-1,l>>>=t.extra,d-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=he;break}t.mode=Cs;case Cs:if(c===0)break e;if(p=f-c,t.offset>p){if(p=t.offset-p,p>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=he;break}p>t.wnext?(p-=t.wnext,h=t.wsize-p):h=t.wnext-p,p>t.length&&(p=t.length),m=t.window}else m=a,h=i-t.offset,p=t.length;p>c&&(p=c),c-=p,t.length-=p;do a[i++]=m[h++];while(--p);t.length===0&&(t.mode=fn);break;case xs:if(c===0)break e;a[i++]=t.length,c--,t.mode=fn;break;case Zn:if(t.wrap){for(;d<32;){if(r===0)break e;r--,l|=s[o++]<<d,d+=8}if(f-=c,e.total_out+=f,t.total+=f,t.wrap&4&&f&&(e.adler=t.check=t.flags?be(t.check,a,f,i-f):Wt(t.check,a,f,i-f)),f=c,t.wrap&4&&(t.flags?l:Ds(l))!==t.check){e.msg="incorrect data check",t.mode=he;break}l=0,d=0}t.mode=Ps;case Ps:if(t.wrap&&t.flags){for(;d<32;){if(r===0)break e;r--,l+=s[o++]<<d,d+=8}if(t.wrap&4&&l!==(t.total&4294967295)){e.msg="incorrect length check",t.mode=he;break}l=0,d=0}t.mode=Ts;case Ts:C=bd;break e;case he:C=No;break e;case Mo:return Oo;case Bo:default:return Le}return e.next_out=i,e.avail_out=c,e.next_in=o,e.avail_in=r,t.hold=l,t.bits=d,(t.wsize||f!==e.avail_out&&t.mode<he&&(t.mode<Zn||n!==as))&&Go(e,e.output,e.next_out,f-e.avail_out),u-=e.avail_in,f-=e.avail_out,e.total_in+=u,e.total_out+=f,t.total+=f,t.wrap&4&&f&&(e.adler=t.check=t.flags?be(t.check,a,f,e.next_out-f):Wt(t.check,a,f,e.next_out-f)),e.data_type=t.bits+(t.last?64:0)+(t.mode===We?128:0)+(t.mode===un||t.mode===Jn?256:0),(u===0&&f===0||n===as)&&C===pt&&(C=kd),C},Rd=e=>{if(ft(e))return Le;let n=e.state;return n.window&&(n.window=null),e.state=null,pt},$d=(e,n)=>{if(ft(e))return Le;const t=e.state;return(t.wrap&2)===0?Le:(t.head=n,n.done=!1,pt)},Ad=(e,n)=>{const t=n.length;let s,a,o;return ft(e)||(s=e.state,s.wrap!==0&&s.mode!==En)?Le:s.mode===En&&(a=1,a=Wt(a,n,t,0),a!==s.check)?No:(o=Go(e,n,t,t),o?(s.mode=Mo,Oo):(s.havedict=1,pt))};var Id=qo,Fd=Uo,Ld=jo,Nd=Pd,Od=zo,Md=Dd,Bd=Rd,jd=$d,qd=Ad,Ud="pako inflate (from Nodeca project)",Ke={inflateReset:Id,inflateReset2:Fd,inflateResetKeep:Ld,inflateInit:Nd,inflateInit2:Od,inflate:Md,inflateEnd:Bd,inflateGetHeader:jd,inflateSetDictionary:qd,inflateInfo:Ud};function zd(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Gd=zd;const Ho=Object.prototype.toString,{Z_NO_FLUSH:Hd,Z_FINISH:Wd,Z_OK:Jt,Z_STREAM_END:Yn,Z_NEED_DICT:er,Z_STREAM_ERROR:Qd,Z_DATA_ERROR:$s,Z_MEM_ERROR:Kd}=Yt;function nn(e){this.options=Dn.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const n=this.options;n.raw&&n.windowBits>=0&&n.windowBits<16&&(n.windowBits=-n.windowBits,n.windowBits===0&&(n.windowBits=-15)),n.windowBits>=0&&n.windowBits<16&&!(e&&e.windowBits)&&(n.windowBits+=32),n.windowBits>15&&n.windowBits<48&&(n.windowBits&15)===0&&(n.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ao,this.strm.avail_out=0;let t=Ke.inflateInit2(this.strm,n.windowBits);if(t!==Jt)throw new Error(lt[t]);if(this.header=new Gd,Ke.inflateGetHeader(this.strm,this.header),n.dictionary&&(typeof n.dictionary=="string"?n.dictionary=Kt.string2buf(n.dictionary):Ho.call(n.dictionary)==="[object ArrayBuffer]"&&(n.dictionary=new Uint8Array(n.dictionary)),n.raw&&(t=Ke.inflateSetDictionary(this.strm,n.dictionary),t!==Jt)))throw new Error(lt[t])}nn.prototype.push=function(e,n){const t=this.strm,s=this.options.chunkSize,a=this.options.dictionary;let o,i,r;if(this.ended)return!1;for(n===~~n?i=n:i=n===!0?Wd:Hd,Ho.call(e)==="[object ArrayBuffer]"?t.input=new Uint8Array(e):t.input=e,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(s),t.next_out=0,t.avail_out=s),o=Ke.inflate(t,i),o===er&&a&&(o=Ke.inflateSetDictionary(t,a),o===Jt?o=Ke.inflate(t,i):o===$s&&(o=er));t.avail_in>0&&o===Yn&&t.state.wrap>0&&e[t.next_in]!==0;)Ke.inflateReset(t),o=Ke.inflate(t,i);switch(o){case Qd:case $s:case er:case Kd:return this.onEnd(o),this.ended=!0,!1}if(r=t.avail_out,t.next_out&&(t.avail_out===0||o===Yn))if(this.options.to==="string"){let c=Kt.utf8border(t.output,t.next_out),l=t.next_out-c,d=Kt.buf2string(t.output,c);t.next_out=l,t.avail_out=s-l,l&&t.output.set(t.output.subarray(c,c+l),0),this.onData(d)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(o===Jt&&r===0)){if(o===Yn)return o=Ke.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};nn.prototype.onData=function(e){this.chunks.push(e)};nn.prototype.onEnd=function(e){e===Jt&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Dn.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function xr(e,n){const t=new nn(n);if(t.push(e),t.err)throw t.msg||lt[t.err];return t.result}function Jd(e,n){return n=n||{},n.raw=!0,xr(e,n)}var Zd=nn,Vd=xr,Xd=Jd,Yd=xr,ep={Inflate:Zd,inflate:Vd,inflateRaw:Xd,ungzip:Yd};const{Deflate:tp,deflate:np,deflateRaw:rp,gzip:sp}=ld,{Inflate:op,inflate:ap,inflateRaw:ip,ungzip:cp}=ep;var Wo=tp,Qo=np,Ko=rp,Jo=sp,Zo=op,Vo=ap,Xo=ip,Yo=cp,ea=Yt,lp={Deflate:Wo,deflate:Qo,deflateRaw:Ko,gzip:Jo,Inflate:Zo,inflate:Vo,inflateRaw:Xo,ungzip:Yo,constants:ea};const ta=Object.freeze(Object.defineProperty({__proto__:null,Deflate:Wo,Inflate:Zo,constants:ea,default:lp,deflate:Qo,deflateRaw:Ko,gzip:Jo,inflate:Vo,inflateRaw:Xo,ungzip:Yo},Symbol.toStringTag,{value:"Module"}));var mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function dp(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function hn(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var tr={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var As;function pp(){return As||(As=1,(function(e,n){(function(t){e.exports=t()})(function(){return(function t(s,a,o){function i(l,d){if(!a[l]){if(!s[l]){var u=typeof hn=="function"&&hn;if(!d&&u)return u(l,!0);if(r)return r(l,!0);var f=new Error("Cannot find module '"+l+"'");throw f.code="MODULE_NOT_FOUND",f}var p=a[l]={exports:{}};s[l][0].call(p.exports,function(h){var m=s[l][1][h];return i(m||h)},p,p.exports,t,s,a,o)}return a[l].exports}for(var r=typeof hn=="function"&&hn,c=0;c<o.length;c++)i(o[c]);return i})({1:[function(t,s,a){var o=t("./utils"),i=t("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(c){for(var l,d,u,f,p,h,m,g=[],_=0,E=c.length,w=E,x=o.getTypeOf(c)!=="string";_<c.length;)w=E-_,u=x?(l=c[_++],d=_<E?c[_++]:0,_<E?c[_++]:0):(l=c.charCodeAt(_++),d=_<E?c.charCodeAt(_++):0,_<E?c.charCodeAt(_++):0),f=l>>2,p=(3&l)<<4|d>>4,h=1<w?(15&d)<<2|u>>6:64,m=2<w?63&u:64,g.push(r.charAt(f)+r.charAt(p)+r.charAt(h)+r.charAt(m));return g.join("")},a.decode=function(c){var l,d,u,f,p,h,m=0,g=0,_="data:";if(c.substr(0,_.length)===_)throw new Error("Invalid base64 input, it looks like a data url.");var E,w=3*(c=c.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(c.charAt(c.length-1)===r.charAt(64)&&w--,c.charAt(c.length-2)===r.charAt(64)&&w--,w%1!=0)throw new Error("Invalid base64 input, bad content length.");for(E=i.uint8array?new Uint8Array(0|w):new Array(0|w);m<c.length;)l=r.indexOf(c.charAt(m++))<<2|(f=r.indexOf(c.charAt(m++)))>>4,d=(15&f)<<4|(p=r.indexOf(c.charAt(m++)))>>2,u=(3&p)<<6|(h=r.indexOf(c.charAt(m++))),E[g++]=l,p!==64&&(E[g++]=d),h!==64&&(E[g++]=u);return E}},{"./support":30,"./utils":32}],2:[function(t,s,a){var o=t("./external"),i=t("./stream/DataWorker"),r=t("./stream/Crc32Probe"),c=t("./stream/DataLengthProbe");function l(d,u,f,p,h){this.compressedSize=d,this.uncompressedSize=u,this.crc32=f,this.compression=p,this.compressedContent=h}l.prototype={getContentWorker:function(){var d=new i(o.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new c("data_length")),u=this;return d.on("end",function(){if(this.streamInfo.data_length!==u.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),d},getCompressedWorker:function(){return new i(o.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(d,u,f){return d.pipe(new r).pipe(new c("uncompressedSize")).pipe(u.compressWorker(f)).pipe(new c("compressedSize")).withStreamInfo("compression",u)},s.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,s,a){var o=t("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new o("STORE compression")},uncompressWorker:function(){return new o("STORE decompression")}},a.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,s,a){var o=t("./utils"),i=(function(){for(var r,c=[],l=0;l<256;l++){r=l;for(var d=0;d<8;d++)r=1&r?3988292384^r>>>1:r>>>1;c[l]=r}return c})();s.exports=function(r,c){return r!==void 0&&r.length?o.getTypeOf(r)!=="string"?(function(l,d,u,f){var p=i,h=f+u;l^=-1;for(var m=f;m<h;m++)l=l>>>8^p[255&(l^d[m])];return-1^l})(0|c,r,r.length,0):(function(l,d,u,f){var p=i,h=f+u;l^=-1;for(var m=f;m<h;m++)l=l>>>8^p[255&(l^d.charCodeAt(m))];return-1^l})(0|c,r,r.length,0):0}},{"./utils":32}],5:[function(t,s,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(t,s,a){var o=null;o=typeof Promise<"u"?Promise:t("lie"),s.exports={Promise:o}},{lie:37}],7:[function(t,s,a){var o=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=t("pako"),r=t("./utils"),c=t("./stream/GenericWorker"),l=o?"uint8array":"array";function d(u,f){c.call(this,"FlateWorker/"+u),this._pako=null,this._pakoAction=u,this._pakoOptions=f,this.meta={}}a.magic="\b\0",r.inherits(d,c),d.prototype.processChunk=function(u){this.meta=u.meta,this._pako===null&&this._createPako(),this._pako.push(r.transformTo(l,u.data),!1)},d.prototype.flush=function(){c.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},d.prototype.cleanUp=function(){c.prototype.cleanUp.call(this),this._pako=null},d.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var u=this;this._pako.onData=function(f){u.push({data:f,meta:u.meta})}},a.compressWorker=function(u){return new d("Deflate",u)},a.uncompressWorker=function(){return new d("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,s,a){function o(p,h){var m,g="";for(m=0;m<h;m++)g+=String.fromCharCode(255&p),p>>>=8;return g}function i(p,h,m,g,_,E){var w,x,b=p.file,S=p.compression,y=E!==l.utf8encode,C=r.transformTo("string",E(b.name)),P=r.transformTo("string",l.utf8encode(b.name)),R=b.comment,A=r.transformTo("string",E(R)),T=r.transformTo("string",l.utf8encode(R)),I=P.length!==b.name.length,v=T.length!==R.length,M="",K="",U="",Y=b.dir,j=b.date,X={crc32:0,compressedSize:0,uncompressedSize:0};h&&!m||(X.crc32=p.crc32,X.compressedSize=p.compressedSize,X.uncompressedSize=p.uncompressedSize);var O=0;h&&(O|=8),y||!I&&!v||(O|=2048);var L=0,F=0;Y&&(L|=16),_==="UNIX"?(F=798,L|=(function(z,ne){var de=z;return z||(de=ne?16893:33204),(65535&de)<<16})(b.unixPermissions,Y)):(F=20,L|=(function(z){return 63&(z||0)})(b.dosPermissions)),w=j.getUTCHours(),w<<=6,w|=j.getUTCMinutes(),w<<=5,w|=j.getUTCSeconds()/2,x=j.getUTCFullYear()-1980,x<<=4,x|=j.getUTCMonth()+1,x<<=5,x|=j.getUTCDate(),I&&(K=o(1,1)+o(d(C),4)+P,M+="up"+o(K.length,2)+K),v&&(U=o(1,1)+o(d(A),4)+T,M+="uc"+o(U.length,2)+U);var G="";return G+=`
\0`,G+=o(O,2),G+=S.magic,G+=o(w,2),G+=o(x,2),G+=o(X.crc32,4),G+=o(X.compressedSize,4),G+=o(X.uncompressedSize,4),G+=o(C.length,2),G+=o(M.length,2),{fileRecord:u.LOCAL_FILE_HEADER+G+C+M,dirRecord:u.CENTRAL_FILE_HEADER+o(F,2)+G+o(A.length,2)+"\0\0\0\0"+o(L,4)+o(g,4)+C+M+A}}var r=t("../utils"),c=t("../stream/GenericWorker"),l=t("../utf8"),d=t("../crc32"),u=t("../signature");function f(p,h,m,g){c.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=h,this.zipPlatform=m,this.encodeFileName=g,this.streamFiles=p,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(f,c),f.prototype.push=function(p){var h=p.meta.percent||0,m=this.entriesCount,g=this._sources.length;this.accumulate?this.contentBuffer.push(p):(this.bytesWritten+=p.data.length,c.prototype.push.call(this,{data:p.data,meta:{currentFile:this.currentFile,percent:m?(h+100*(m-g-1))/m:100}}))},f.prototype.openedSource=function(p){this.currentSourceOffset=this.bytesWritten,this.currentFile=p.file.name;var h=this.streamFiles&&!p.file.dir;if(h){var m=i(p,h,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(p){this.accumulate=!1;var h=this.streamFiles&&!p.file.dir,m=i(p,h,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),h)this.push({data:(function(g){return u.DATA_DESCRIPTOR+o(g.crc32,4)+o(g.compressedSize,4)+o(g.uncompressedSize,4)})(p),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var p=this.bytesWritten,h=0;h<this.dirRecords.length;h++)this.push({data:this.dirRecords[h],meta:{percent:100}});var m=this.bytesWritten-p,g=(function(_,E,w,x,b){var S=r.transformTo("string",b(x));return u.CENTRAL_DIRECTORY_END+"\0\0\0\0"+o(_,2)+o(_,2)+o(E,4)+o(w,4)+o(S.length,2)+S})(this.dirRecords.length,m,p,this.zipComment,this.encodeFileName);this.push({data:g,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(p){this._sources.push(p);var h=this;return p.on("data",function(m){h.processChunk(m)}),p.on("end",function(){h.closedSource(h.previous.streamInfo),h._sources.length?h.prepareNextSource():h.end()}),p.on("error",function(m){h.error(m)}),this},f.prototype.resume=function(){return!!c.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(p){var h=this._sources;if(!c.prototype.error.call(this,p))return!1;for(var m=0;m<h.length;m++)try{h[m].error(p)}catch{}return!0},f.prototype.lock=function(){c.prototype.lock.call(this);for(var p=this._sources,h=0;h<p.length;h++)p[h].lock()},s.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,s,a){var o=t("../compressions"),i=t("./ZipFileWorker");a.generateWorker=function(r,c,l){var d=new i(c.streamFiles,l,c.platform,c.encodeFileName),u=0;try{r.forEach(function(f,p){u++;var h=(function(E,w){var x=E||w,b=o[x];if(!b)throw new Error(x+" is not a valid compression method !");return b})(p.options.compression,c.compression),m=p.options.compressionOptions||c.compressionOptions||{},g=p.dir,_=p.date;p._compressWorker(h,m).withStreamInfo("file",{name:f,dir:g,date:_,comment:p.comment||"",unixPermissions:p.unixPermissions,dosPermissions:p.dosPermissions}).pipe(d)}),d.entriesCount=u}catch(f){d.error(f)}return d}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,s,a){function o(){if(!(this instanceof o))return new o;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new o;for(var r in this)typeof this[r]!="function"&&(i[r]=this[r]);return i}}(o.prototype=t("./object")).loadAsync=t("./load"),o.support=t("./support"),o.defaults=t("./defaults"),o.version="3.10.1",o.loadAsync=function(i,r){return new o().loadAsync(i,r)},o.external=t("./external"),s.exports=o},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,s,a){var o=t("./utils"),i=t("./external"),r=t("./utf8"),c=t("./zipEntries"),l=t("./stream/Crc32Probe"),d=t("./nodejsUtils");function u(f){return new i.Promise(function(p,h){var m=f.decompressed.getContentWorker().pipe(new l);m.on("error",function(g){h(g)}).on("end",function(){m.streamInfo.crc32!==f.decompressed.crc32?h(new Error("Corrupted zip : CRC32 mismatch")):p()}).resume()})}s.exports=function(f,p){var h=this;return p=o.extend(p||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),d.isNode&&d.isStream(f)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):o.prepareContent("the loaded zip file",f,!0,p.optimizedBinaryString,p.base64).then(function(m){var g=new c(p);return g.load(m),g}).then(function(m){var g=[i.Promise.resolve(m)],_=m.files;if(p.checkCRC32)for(var E=0;E<_.length;E++)g.push(u(_[E]));return i.Promise.all(g)}).then(function(m){for(var g=m.shift(),_=g.files,E=0;E<_.length;E++){var w=_[E],x=w.fileNameStr,b=o.resolve(w.fileNameStr);h.file(b,w.decompressed,{binary:!0,optimizedBinaryString:!0,date:w.date,dir:w.dir,comment:w.fileCommentStr.length?w.fileCommentStr:null,unixPermissions:w.unixPermissions,dosPermissions:w.dosPermissions,createFolders:p.createFolders}),w.dir||(h.file(b).unsafeOriginalName=x)}return g.zipComment.length&&(h.comment=g.zipComment),h})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,s,a){var o=t("../utils"),i=t("../stream/GenericWorker");function r(c,l){i.call(this,"Nodejs stream input adapter for "+c),this._upstreamEnded=!1,this._bindStream(l)}o.inherits(r,i),r.prototype._bindStream=function(c){var l=this;(this._stream=c).pause(),c.on("data",function(d){l.push({data:d,meta:{percent:0}})}).on("error",function(d){l.isPaused?this.generatedError=d:l.error(d)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},r.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},s.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,s,a){var o=t("readable-stream").Readable;function i(r,c,l){o.call(this,c),this._helper=r;var d=this;r.on("data",function(u,f){d.push(u)||d._helper.pause(),l&&l(f)}).on("error",function(u){d.emit("error",u)}).on("end",function(){d.push(null)})}t("../utils").inherits(i,o),i.prototype._read=function(){this._helper.resume()},s.exports=i},{"../utils":32,"readable-stream":16}],14:[function(t,s,a){s.exports={isNode:typeof Buffer<"u",newBufferFrom:function(o,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(o,i);if(typeof o=="number")throw new Error('The "data" argument must not be a number');return new Buffer(o,i)},allocBuffer:function(o){if(Buffer.alloc)return Buffer.alloc(o);var i=new Buffer(o);return i.fill(0),i},isBuffer:function(o){return Buffer.isBuffer(o)},isStream:function(o){return o&&typeof o.on=="function"&&typeof o.pause=="function"&&typeof o.resume=="function"}}},{}],15:[function(t,s,a){function o(b,S,y){var C,P=r.getTypeOf(S),R=r.extend(y||{},d);R.date=R.date||new Date,R.compression!==null&&(R.compression=R.compression.toUpperCase()),typeof R.unixPermissions=="string"&&(R.unixPermissions=parseInt(R.unixPermissions,8)),R.unixPermissions&&16384&R.unixPermissions&&(R.dir=!0),R.dosPermissions&&16&R.dosPermissions&&(R.dir=!0),R.dir&&(b=_(b)),R.createFolders&&(C=g(b))&&E.call(this,C,!0);var A=P==="string"&&R.binary===!1&&R.base64===!1;y&&y.binary!==void 0||(R.binary=!A),(S instanceof u&&S.uncompressedSize===0||R.dir||!S||S.length===0)&&(R.base64=!1,R.binary=!0,S="",R.compression="STORE",P="string");var T=null;T=S instanceof u||S instanceof c?S:h.isNode&&h.isStream(S)?new m(b,S):r.prepareContent(b,S,R.binary,R.optimizedBinaryString,R.base64);var I=new f(b,T,R);this.files[b]=I}var i=t("./utf8"),r=t("./utils"),c=t("./stream/GenericWorker"),l=t("./stream/StreamHelper"),d=t("./defaults"),u=t("./compressedObject"),f=t("./zipObject"),p=t("./generate"),h=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),g=function(b){b.slice(-1)==="/"&&(b=b.substring(0,b.length-1));var S=b.lastIndexOf("/");return 0<S?b.substring(0,S):""},_=function(b){return b.slice(-1)!=="/"&&(b+="/"),b},E=function(b,S){return S=S!==void 0?S:d.createFolders,b=_(b),this.files[b]||o.call(this,b,null,{dir:!0,createFolders:S}),this.files[b]};function w(b){return Object.prototype.toString.call(b)==="[object RegExp]"}var x={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(b){var S,y,C;for(S in this.files)C=this.files[S],(y=S.slice(this.root.length,S.length))&&S.slice(0,this.root.length)===this.root&&b(y,C)},filter:function(b){var S=[];return this.forEach(function(y,C){b(y,C)&&S.push(C)}),S},file:function(b,S,y){if(arguments.length!==1)return b=this.root+b,o.call(this,b,S,y),this;if(w(b)){var C=b;return this.filter(function(R,A){return!A.dir&&C.test(R)})}var P=this.files[this.root+b];return P&&!P.dir?P:null},folder:function(b){if(!b)return this;if(w(b))return this.filter(function(P,R){return R.dir&&b.test(P)});var S=this.root+b,y=E.call(this,S),C=this.clone();return C.root=y.name,C},remove:function(b){b=this.root+b;var S=this.files[b];if(S||(b.slice(-1)!=="/"&&(b+="/"),S=this.files[b]),S&&!S.dir)delete this.files[b];else for(var y=this.filter(function(P,R){return R.name.slice(0,b.length)===b}),C=0;C<y.length;C++)delete this.files[y[C].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(b){var S,y={};try{if((y=r.extend(b||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=y.type.toLowerCase(),y.compression=y.compression.toUpperCase(),y.type==="binarystring"&&(y.type="string"),!y.type)throw new Error("No output type specified.");r.checkSupport(y.type),y.platform!=="darwin"&&y.platform!=="freebsd"&&y.platform!=="linux"&&y.platform!=="sunos"||(y.platform="UNIX"),y.platform==="win32"&&(y.platform="DOS");var C=y.comment||this.comment||"";S=p.generateWorker(this,y,C)}catch(P){(S=new c("error")).error(P)}return new l(S,y.type||"string",y.mimeType)},generateAsync:function(b,S){return this.generateInternalStream(b).accumulate(S)},generateNodeStream:function(b,S){return(b=b||{}).type||(b.type="nodebuffer"),this.generateInternalStream(b).toNodejsStream(S)}};s.exports=x},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,s,a){s.exports=t("stream")},{stream:void 0}],17:[function(t,s,a){var o=t("./DataReader");function i(r){o.call(this,r);for(var c=0;c<this.data.length;c++)r[c]=255&r[c]}t("../utils").inherits(i,o),i.prototype.byteAt=function(r){return this.data[this.zero+r]},i.prototype.lastIndexOfSignature=function(r){for(var c=r.charCodeAt(0),l=r.charCodeAt(1),d=r.charCodeAt(2),u=r.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===c&&this.data[f+1]===l&&this.data[f+2]===d&&this.data[f+3]===u)return f-this.zero;return-1},i.prototype.readAndCheckSignature=function(r){var c=r.charCodeAt(0),l=r.charCodeAt(1),d=r.charCodeAt(2),u=r.charCodeAt(3),f=this.readData(4);return c===f[0]&&l===f[1]&&d===f[2]&&u===f[3]},i.prototype.readData=function(r){if(this.checkOffset(r),r===0)return[];var c=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,c},s.exports=i},{"../utils":32,"./DataReader":18}],18:[function(t,s,a){var o=t("../utils");function i(r){this.data=r,this.length=r.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(r){this.checkIndex(this.index+r)},checkIndex:function(r){if(this.length<this.zero+r||r<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+r+"). Corrupted zip ?")},setIndex:function(r){this.checkIndex(r),this.index=r},skip:function(r){this.setIndex(this.index+r)},byteAt:function(){},readInt:function(r){var c,l=0;for(this.checkOffset(r),c=this.index+r-1;c>=this.index;c--)l=(l<<8)+this.byteAt(c);return this.index+=r,l},readString:function(r){return o.transformTo("string",this.readData(r))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var r=this.readInt(4);return new Date(Date.UTC(1980+(r>>25&127),(r>>21&15)-1,r>>16&31,r>>11&31,r>>5&63,(31&r)<<1))}},s.exports=i},{"../utils":32}],19:[function(t,s,a){var o=t("./Uint8ArrayReader");function i(r){o.call(this,r)}t("../utils").inherits(i,o),i.prototype.readData=function(r){this.checkOffset(r);var c=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,c},s.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,s,a){var o=t("./DataReader");function i(r){o.call(this,r)}t("../utils").inherits(i,o),i.prototype.byteAt=function(r){return this.data.charCodeAt(this.zero+r)},i.prototype.lastIndexOfSignature=function(r){return this.data.lastIndexOf(r)-this.zero},i.prototype.readAndCheckSignature=function(r){return r===this.readData(4)},i.prototype.readData=function(r){this.checkOffset(r);var c=this.data.slice(this.zero+this.index,this.zero+this.index+r);return this.index+=r,c},s.exports=i},{"../utils":32,"./DataReader":18}],21:[function(t,s,a){var o=t("./ArrayReader");function i(r){o.call(this,r)}t("../utils").inherits(i,o),i.prototype.readData=function(r){if(this.checkOffset(r),r===0)return new Uint8Array(0);var c=this.data.subarray(this.zero+this.index,this.zero+this.index+r);return this.index+=r,c},s.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(t,s,a){var o=t("../utils"),i=t("../support"),r=t("./ArrayReader"),c=t("./StringReader"),l=t("./NodeBufferReader"),d=t("./Uint8ArrayReader");s.exports=function(u){var f=o.getTypeOf(u);return o.checkSupport(f),f!=="string"||i.uint8array?f==="nodebuffer"?new l(u):i.uint8array?new d(o.transformTo("uint8array",u)):new r(o.transformTo("array",u)):new c(u)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,s,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,s,a){var o=t("./GenericWorker"),i=t("../utils");function r(c){o.call(this,"ConvertWorker to "+c),this.destType=c}i.inherits(r,o),r.prototype.processChunk=function(c){this.push({data:i.transformTo(this.destType,c.data),meta:c.meta})},s.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(t,s,a){var o=t("./GenericWorker"),i=t("../crc32");function r(){o.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(r,o),r.prototype.processChunk=function(c){this.streamInfo.crc32=i(c.data,this.streamInfo.crc32||0),this.push(c)},s.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,s,a){var o=t("../utils"),i=t("./GenericWorker");function r(c){i.call(this,"DataLengthProbe for "+c),this.propName=c,this.withStreamInfo(c,0)}o.inherits(r,i),r.prototype.processChunk=function(c){if(c){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+c.data.length}i.prototype.processChunk.call(this,c)},s.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(t,s,a){var o=t("../utils"),i=t("./GenericWorker");function r(c){i.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,c.then(function(d){l.dataIsReady=!0,l.data=d,l.max=d&&d.length||0,l.type=o.getTypeOf(d),l.isPaused||l._tickAndRepeat()},function(d){l.error(d)})}o.inherits(r,i),r.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,o.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(o.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var c=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":c=this.data.substring(this.index,l);break;case"uint8array":c=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":c=this.data.slice(this.index,l)}return this.index=l,this.push({data:c,meta:{percent:this.max?this.index/this.max*100:0}})},s.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(t,s,a){function o(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}o.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,r){return this._listeners[i].push(r),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,r){if(this._listeners[i])for(var c=0;c<this._listeners[i].length;c++)this._listeners[i][c].call(this,r)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var r=this;return i.on("data",function(c){r.processChunk(c)}),i.on("end",function(){r.end()}),i.on("error",function(c){r.error(c)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,r){return this.extraStreamInfo[i]=r,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},s.exports=o},{}],29:[function(t,s,a){var o=t("../utils"),i=t("./ConvertWorker"),r=t("./GenericWorker"),c=t("../base64"),l=t("../support"),d=t("../external"),u=null;if(l.nodestream)try{u=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(h,m){return new d.Promise(function(g,_){var E=[],w=h._internalType,x=h._outputType,b=h._mimeType;h.on("data",function(S,y){E.push(S),m&&m(y)}).on("error",function(S){E=[],_(S)}).on("end",function(){try{var S=(function(y,C,P){switch(y){case"blob":return o.newBlob(o.transformTo("arraybuffer",C),P);case"base64":return c.encode(C);default:return o.transformTo(y,C)}})(x,(function(y,C){var P,R=0,A=null,T=0;for(P=0;P<C.length;P++)T+=C[P].length;switch(y){case"string":return C.join("");case"array":return Array.prototype.concat.apply([],C);case"uint8array":for(A=new Uint8Array(T),P=0;P<C.length;P++)A.set(C[P],R),R+=C[P].length;return A;case"nodebuffer":return Buffer.concat(C);default:throw new Error("concat : unsupported type '"+y+"'")}})(w,E),b);g(S)}catch(y){_(y)}E=[]}).resume()})}function p(h,m,g){var _=m;switch(m){case"blob":case"arraybuffer":_="uint8array";break;case"base64":_="string"}try{this._internalType=_,this._outputType=m,this._mimeType=g,o.checkSupport(_),this._worker=h.pipe(new i(_)),h.lock()}catch(E){this._worker=new r("error"),this._worker.error(E)}}p.prototype={accumulate:function(h){return f(this,h)},on:function(h,m){var g=this;return h==="data"?this._worker.on(h,function(_){m.call(g,_.data,_.meta)}):this._worker.on(h,function(){o.delay(m,arguments,g)}),this},resume:function(){return o.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(h){if(o.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:this._outputType!=="nodebuffer"},h)}},s.exports=p},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,s,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var o=new ArrayBuffer(0);try{a.blob=new Blob([o],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(o),a.blob=i.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!t("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(t,s,a){for(var o=t("./utils"),i=t("./support"),r=t("./nodejsUtils"),c=t("./stream/GenericWorker"),l=new Array(256),d=0;d<256;d++)l[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;l[254]=l[254]=1;function u(){c.call(this,"utf-8 decode"),this.leftOver=null}function f(){c.call(this,"utf-8 encode")}a.utf8encode=function(p){return i.nodebuffer?r.newBufferFrom(p,"utf-8"):(function(h){var m,g,_,E,w,x=h.length,b=0;for(E=0;E<x;E++)(64512&(g=h.charCodeAt(E)))==55296&&E+1<x&&(64512&(_=h.charCodeAt(E+1)))==56320&&(g=65536+(g-55296<<10)+(_-56320),E++),b+=g<128?1:g<2048?2:g<65536?3:4;for(m=i.uint8array?new Uint8Array(b):new Array(b),E=w=0;w<b;E++)(64512&(g=h.charCodeAt(E)))==55296&&E+1<x&&(64512&(_=h.charCodeAt(E+1)))==56320&&(g=65536+(g-55296<<10)+(_-56320),E++),g<128?m[w++]=g:(g<2048?m[w++]=192|g>>>6:(g<65536?m[w++]=224|g>>>12:(m[w++]=240|g>>>18,m[w++]=128|g>>>12&63),m[w++]=128|g>>>6&63),m[w++]=128|63&g);return m})(p)},a.utf8decode=function(p){return i.nodebuffer?o.transformTo("nodebuffer",p).toString("utf-8"):(function(h){var m,g,_,E,w=h.length,x=new Array(2*w);for(m=g=0;m<w;)if((_=h[m++])<128)x[g++]=_;else if(4<(E=l[_]))x[g++]=65533,m+=E-1;else{for(_&=E===2?31:E===3?15:7;1<E&&m<w;)_=_<<6|63&h[m++],E--;1<E?x[g++]=65533:_<65536?x[g++]=_:(_-=65536,x[g++]=55296|_>>10&1023,x[g++]=56320|1023&_)}return x.length!==g&&(x.subarray?x=x.subarray(0,g):x.length=g),o.applyFromCharCode(x)})(p=o.transformTo(i.uint8array?"uint8array":"array",p))},o.inherits(u,c),u.prototype.processChunk=function(p){var h=o.transformTo(i.uint8array?"uint8array":"array",p.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var m=h;(h=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),h.set(m,this.leftOver.length)}else h=this.leftOver.concat(h);this.leftOver=null}var g=(function(E,w){var x;for((w=w||E.length)>E.length&&(w=E.length),x=w-1;0<=x&&(192&E[x])==128;)x--;return x<0||x===0?w:x+l[E[x]]>w?x:w})(h),_=h;g!==h.length&&(i.uint8array?(_=h.subarray(0,g),this.leftOver=h.subarray(g,h.length)):(_=h.slice(0,g),this.leftOver=h.slice(g,h.length))),this.push({data:a.utf8decode(_),meta:p.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=u,o.inherits(f,c),f.prototype.processChunk=function(p){this.push({data:a.utf8encode(p.data),meta:p.meta})},a.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,s,a){var o=t("./support"),i=t("./base64"),r=t("./nodejsUtils"),c=t("./external");function l(m){return m}function d(m,g){for(var _=0;_<m.length;++_)g[_]=255&m.charCodeAt(_);return g}t("setimmediate"),a.newBlob=function(m,g){a.checkSupport("blob");try{return new Blob([m],{type:g})}catch{try{var _=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return _.append(m),_.getBlob(g)}catch{throw new Error("Bug : can't construct the Blob.")}}};var u={stringifyByChunk:function(m,g,_){var E=[],w=0,x=m.length;if(x<=_)return String.fromCharCode.apply(null,m);for(;w<x;)g==="array"||g==="nodebuffer"?E.push(String.fromCharCode.apply(null,m.slice(w,Math.min(w+_,x)))):E.push(String.fromCharCode.apply(null,m.subarray(w,Math.min(w+_,x)))),w+=_;return E.join("")},stringifyByChar:function(m){for(var g="",_=0;_<m.length;_++)g+=String.fromCharCode(m[_]);return g},applyCanBeUsed:{uint8array:(function(){try{return o.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return o.nodebuffer&&String.fromCharCode.apply(null,r.allocBuffer(1)).length===1}catch{return!1}})()}};function f(m){var g=65536,_=a.getTypeOf(m),E=!0;if(_==="uint8array"?E=u.applyCanBeUsed.uint8array:_==="nodebuffer"&&(E=u.applyCanBeUsed.nodebuffer),E)for(;1<g;)try{return u.stringifyByChunk(m,_,g)}catch{g=Math.floor(g/2)}return u.stringifyByChar(m)}function p(m,g){for(var _=0;_<m.length;_++)g[_]=m[_];return g}a.applyFromCharCode=f;var h={};h.string={string:l,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return h.string.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:function(m){return d(m,r.allocBuffer(m.length))}},h.array={string:f,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return r.newBufferFrom(m)}},h.arraybuffer={string:function(m){return f(new Uint8Array(m))},array:function(m){return p(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return r.newBufferFrom(new Uint8Array(m))}},h.uint8array={string:f,array:function(m){return p(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return r.newBufferFrom(m)}},h.nodebuffer={string:f,array:function(m){return p(m,new Array(m.length))},arraybuffer:function(m){return h.nodebuffer.uint8array(m).buffer},uint8array:function(m){return p(m,new Uint8Array(m.length))},nodebuffer:l},a.transformTo=function(m,g){if(g=g||"",!m)return g;a.checkSupport(m);var _=a.getTypeOf(g);return h[_][m](g)},a.resolve=function(m){for(var g=m.split("/"),_=[],E=0;E<g.length;E++){var w=g[E];w==="."||w===""&&E!==0&&E!==g.length-1||(w===".."?_.pop():_.push(w))}return _.join("/")},a.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":o.nodebuffer&&r.isBuffer(m)?"nodebuffer":o.uint8array&&m instanceof Uint8Array?"uint8array":o.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(m){if(!o[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(m){var g,_,E="";for(_=0;_<(m||"").length;_++)E+="\\x"+((g=m.charCodeAt(_))<16?"0":"")+g.toString(16).toUpperCase();return E},a.delay=function(m,g,_){setImmediate(function(){m.apply(_||null,g||[])})},a.inherits=function(m,g){function _(){}_.prototype=g.prototype,m.prototype=new _},a.extend=function(){var m,g,_={};for(m=0;m<arguments.length;m++)for(g in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],g)&&_[g]===void 0&&(_[g]=arguments[m][g]);return _},a.prepareContent=function(m,g,_,E,w){return c.Promise.resolve(g).then(function(x){return o.blob&&(x instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(x))!==-1)&&typeof FileReader<"u"?new c.Promise(function(b,S){var y=new FileReader;y.onload=function(C){b(C.target.result)},y.onerror=function(C){S(C.target.error)},y.readAsArrayBuffer(x)}):x}).then(function(x){var b=a.getTypeOf(x);return b?(b==="arraybuffer"?x=a.transformTo("uint8array",x):b==="string"&&(w?x=i.decode(x):_&&E!==!0&&(x=(function(S){return d(S,o.uint8array?new Uint8Array(S.length):new Array(S.length))})(x))),x):c.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,s,a){var o=t("./reader/readerFor"),i=t("./utils"),r=t("./signature"),c=t("./zipEntry"),l=t("./support");function d(u){this.files=[],this.loadOptions=u}d.prototype={checkSignature:function(u){if(!this.reader.readAndCheckSignature(u)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(f)+", expected "+i.pretty(u)+")")}},isSignature:function(u,f){var p=this.reader.index;this.reader.setIndex(u);var h=this.reader.readString(4)===f;return this.reader.setIndex(p),h},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var u=this.reader.readData(this.zipCommentLength),f=l.uint8array?"uint8array":"array",p=i.transformTo(f,u);this.zipComment=this.loadOptions.decodeFileName(p)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var u,f,p,h=this.zip64EndOfCentralSize-44;0<h;)u=this.reader.readInt(2),f=this.reader.readInt(4),p=this.reader.readData(f),this.zip64ExtensibleData[u]={id:u,length:f,value:p}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var u,f;for(u=0;u<this.files.length;u++)f=this.files[u],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var u;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(u=new c({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(u);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var u=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(u<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(u);var f=u;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(u=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(u),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var p=this.centralDirOffset+this.centralDirSize;this.zip64&&(p+=20,p+=12+this.zip64EndOfCentralSize);var h=f-p;if(0<h)this.isSignature(f,r.CENTRAL_FILE_HEADER)||(this.reader.zero=h);else if(h<0)throw new Error("Corrupted zip: missing "+Math.abs(h)+" bytes.")},prepareReader:function(u){this.reader=o(u)},load:function(u){this.prepareReader(u),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},s.exports=d},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,s,a){var o=t("./reader/readerFor"),i=t("./utils"),r=t("./compressedObject"),c=t("./crc32"),l=t("./utf8"),d=t("./compressions"),u=t("./support");function f(p,h){this.options=p,this.loadOptions=h}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(p){var h,m;if(p.skip(22),this.fileNameLength=p.readInt(2),m=p.readInt(2),this.fileName=p.readData(this.fileNameLength),p.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((h=(function(g){for(var _ in d)if(Object.prototype.hasOwnProperty.call(d,_)&&d[_].magic===g)return d[_];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,h,p.readData(this.compressedSize))},readCentralPart:function(p){this.versionMadeBy=p.readInt(2),p.skip(2),this.bitFlag=p.readInt(2),this.compressionMethod=p.readString(2),this.date=p.readDate(),this.crc32=p.readInt(4),this.compressedSize=p.readInt(4),this.uncompressedSize=p.readInt(4);var h=p.readInt(2);if(this.extraFieldsLength=p.readInt(2),this.fileCommentLength=p.readInt(2),this.diskNumberStart=p.readInt(2),this.internalFileAttributes=p.readInt(2),this.externalFileAttributes=p.readInt(4),this.localHeaderOffset=p.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");p.skip(h),this.readExtraFields(p),this.parseZIP64ExtraField(p),this.fileComment=p.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var p=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),p==0&&(this.dosPermissions=63&this.externalFileAttributes),p==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var p=o(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=p.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=p.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=p.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=p.readInt(4))}},readExtraFields:function(p){var h,m,g,_=p.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});p.index+4<_;)h=p.readInt(2),m=p.readInt(2),g=p.readData(m),this.extraFields[h]={id:h,length:m,value:g};p.setIndex(_)},handleUTF8:function(){var p=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var h=this.findExtraFieldUnicodePath();if(h!==null)this.fileNameStr=h;else{var m=i.transformTo(p,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var g=this.findExtraFieldUnicodeComment();if(g!==null)this.fileCommentStr=g;else{var _=i.transformTo(p,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(_)}}},findExtraFieldUnicodePath:function(){var p=this.extraFields[28789];if(p){var h=o(p.value);return h.readInt(1)!==1||c(this.fileName)!==h.readInt(4)?null:l.utf8decode(h.readData(p.length-5))}return null},findExtraFieldUnicodeComment:function(){var p=this.extraFields[25461];if(p){var h=o(p.value);return h.readInt(1)!==1||c(this.fileComment)!==h.readInt(4)?null:l.utf8decode(h.readData(p.length-5))}return null}},s.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,s,a){function o(h,m,g){this.name=h,this.dir=g.dir,this.date=g.date,this.comment=g.comment,this.unixPermissions=g.unixPermissions,this.dosPermissions=g.dosPermissions,this._data=m,this._dataBinary=g.binary,this.options={compression:g.compression,compressionOptions:g.compressionOptions}}var i=t("./stream/StreamHelper"),r=t("./stream/DataWorker"),c=t("./utf8"),l=t("./compressedObject"),d=t("./stream/GenericWorker");o.prototype={internalStream:function(h){var m=null,g="string";try{if(!h)throw new Error("No output type specified.");var _=(g=h.toLowerCase())==="string"||g==="text";g!=="binarystring"&&g!=="text"||(g="string"),m=this._decompressWorker();var E=!this._dataBinary;E&&!_&&(m=m.pipe(new c.Utf8EncodeWorker)),!E&&_&&(m=m.pipe(new c.Utf8DecodeWorker))}catch(w){(m=new d("error")).error(w)}return new i(m,g,"")},async:function(h,m){return this.internalStream(h).accumulate(m)},nodeStream:function(h,m){return this.internalStream(h||"nodebuffer").toNodejsStream(m)},_compressWorker:function(h,m){if(this._data instanceof l&&this._data.compression.magic===h.magic)return this._data.getCompressedWorker();var g=this._decompressWorker();return this._dataBinary||(g=g.pipe(new c.Utf8EncodeWorker)),l.createWorkerFrom(g,h,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof d?this._data:new r(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},p=0;p<u.length;p++)o.prototype[u[p]]=f;s.exports=o},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,s,a){(function(o){var i,r,c=o.MutationObserver||o.WebKitMutationObserver;if(c){var l=0,d=new c(h),u=o.document.createTextNode("");d.observe(u,{characterData:!0}),i=function(){u.data=l=++l%2}}else if(o.setImmediate||o.MessageChannel===void 0)i="document"in o&&"onreadystatechange"in o.document.createElement("script")?function(){var m=o.document.createElement("script");m.onreadystatechange=function(){h(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},o.document.documentElement.appendChild(m)}:function(){setTimeout(h,0)};else{var f=new o.MessageChannel;f.port1.onmessage=h,i=function(){f.port2.postMessage(0)}}var p=[];function h(){var m,g;r=!0;for(var _=p.length;_;){for(g=p,p=[],m=-1;++m<_;)g[m]();_=p.length}r=!1}s.exports=function(m){p.push(m)!==1||r||i()}}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,s,a){var o=t("immediate");function i(){}var r={},c=["REJECTED"],l=["FULFILLED"],d=["PENDING"];function u(_){if(typeof _!="function")throw new TypeError("resolver must be a function");this.state=d,this.queue=[],this.outcome=void 0,_!==i&&m(this,_)}function f(_,E,w){this.promise=_,typeof E=="function"&&(this.onFulfilled=E,this.callFulfilled=this.otherCallFulfilled),typeof w=="function"&&(this.onRejected=w,this.callRejected=this.otherCallRejected)}function p(_,E,w){o(function(){var x;try{x=E(w)}catch(b){return r.reject(_,b)}x===_?r.reject(_,new TypeError("Cannot resolve promise with itself")):r.resolve(_,x)})}function h(_){var E=_&&_.then;if(_&&(typeof _=="object"||typeof _=="function")&&typeof E=="function")return function(){E.apply(_,arguments)}}function m(_,E){var w=!1;function x(y){w||(w=!0,r.reject(_,y))}function b(y){w||(w=!0,r.resolve(_,y))}var S=g(function(){E(b,x)});S.status==="error"&&x(S.value)}function g(_,E){var w={};try{w.value=_(E),w.status="success"}catch(x){w.status="error",w.value=x}return w}(s.exports=u).prototype.finally=function(_){if(typeof _!="function")return this;var E=this.constructor;return this.then(function(w){return E.resolve(_()).then(function(){return w})},function(w){return E.resolve(_()).then(function(){throw w})})},u.prototype.catch=function(_){return this.then(null,_)},u.prototype.then=function(_,E){if(typeof _!="function"&&this.state===l||typeof E!="function"&&this.state===c)return this;var w=new this.constructor(i);return this.state!==d?p(w,this.state===l?_:E,this.outcome):this.queue.push(new f(w,_,E)),w},f.prototype.callFulfilled=function(_){r.resolve(this.promise,_)},f.prototype.otherCallFulfilled=function(_){p(this.promise,this.onFulfilled,_)},f.prototype.callRejected=function(_){r.reject(this.promise,_)},f.prototype.otherCallRejected=function(_){p(this.promise,this.onRejected,_)},r.resolve=function(_,E){var w=g(h,E);if(w.status==="error")return r.reject(_,w.value);var x=w.value;if(x)m(_,x);else{_.state=l,_.outcome=E;for(var b=-1,S=_.queue.length;++b<S;)_.queue[b].callFulfilled(E)}return _},r.reject=function(_,E){_.state=c,_.outcome=E;for(var w=-1,x=_.queue.length;++w<x;)_.queue[w].callRejected(E);return _},u.resolve=function(_){return _ instanceof this?_:r.resolve(new this(i),_)},u.reject=function(_){var E=new this(i);return r.reject(E,_)},u.all=function(_){var E=this;if(Object.prototype.toString.call(_)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=_.length,x=!1;if(!w)return this.resolve([]);for(var b=new Array(w),S=0,y=-1,C=new this(i);++y<w;)P(_[y],y);return C;function P(R,A){E.resolve(R).then(function(T){b[A]=T,++S!==w||x||(x=!0,r.resolve(C,b))},function(T){x||(x=!0,r.reject(C,T))})}},u.race=function(_){var E=this;if(Object.prototype.toString.call(_)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=_.length,x=!1;if(!w)return this.resolve([]);for(var b=-1,S=new this(i);++b<w;)y=_[b],E.resolve(y).then(function(C){x||(x=!0,r.resolve(S,C))},function(C){x||(x=!0,r.reject(S,C))});var y;return S}},{immediate:36}],38:[function(t,s,a){var o={};(0,t("./lib/utils/common").assign)(o,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),s.exports=o},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,s,a){var o=t("./zlib/deflate"),i=t("./utils/common"),r=t("./utils/strings"),c=t("./zlib/messages"),l=t("./zlib/zstream"),d=Object.prototype.toString,u=0,f=-1,p=0,h=8;function m(_){if(!(this instanceof m))return new m(_);this.options=i.assign({level:f,method:h,chunkSize:16384,windowBits:15,memLevel:8,strategy:p,to:""},_||{});var E=this.options;E.raw&&0<E.windowBits?E.windowBits=-E.windowBits:E.gzip&&0<E.windowBits&&E.windowBits<16&&(E.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var w=o.deflateInit2(this.strm,E.level,E.method,E.windowBits,E.memLevel,E.strategy);if(w!==u)throw new Error(c[w]);if(E.header&&o.deflateSetHeader(this.strm,E.header),E.dictionary){var x;if(x=typeof E.dictionary=="string"?r.string2buf(E.dictionary):d.call(E.dictionary)==="[object ArrayBuffer]"?new Uint8Array(E.dictionary):E.dictionary,(w=o.deflateSetDictionary(this.strm,x))!==u)throw new Error(c[w]);this._dict_set=!0}}function g(_,E){var w=new m(E);if(w.push(_,!0),w.err)throw w.msg||c[w.err];return w.result}m.prototype.push=function(_,E){var w,x,b=this.strm,S=this.options.chunkSize;if(this.ended)return!1;x=E===~~E?E:E===!0?4:0,typeof _=="string"?b.input=r.string2buf(_):d.call(_)==="[object ArrayBuffer]"?b.input=new Uint8Array(_):b.input=_,b.next_in=0,b.avail_in=b.input.length;do{if(b.avail_out===0&&(b.output=new i.Buf8(S),b.next_out=0,b.avail_out=S),(w=o.deflate(b,x))!==1&&w!==u)return this.onEnd(w),!(this.ended=!0);b.avail_out!==0&&(b.avail_in!==0||x!==4&&x!==2)||(this.options.to==="string"?this.onData(r.buf2binstring(i.shrinkBuf(b.output,b.next_out))):this.onData(i.shrinkBuf(b.output,b.next_out)))}while((0<b.avail_in||b.avail_out===0)&&w!==1);return x===4?(w=o.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===u):x!==2||(this.onEnd(u),!(b.avail_out=0))},m.prototype.onData=function(_){this.chunks.push(_)},m.prototype.onEnd=function(_){_===u&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=_,this.msg=this.strm.msg},a.Deflate=m,a.deflate=g,a.deflateRaw=function(_,E){return(E=E||{}).raw=!0,g(_,E)},a.gzip=function(_,E){return(E=E||{}).gzip=!0,g(_,E)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,s,a){var o=t("./zlib/inflate"),i=t("./utils/common"),r=t("./utils/strings"),c=t("./zlib/constants"),l=t("./zlib/messages"),d=t("./zlib/zstream"),u=t("./zlib/gzheader"),f=Object.prototype.toString;function p(m){if(!(this instanceof p))return new p(m);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},m||{});var g=this.options;g.raw&&0<=g.windowBits&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),!(0<=g.windowBits&&g.windowBits<16)||m&&m.windowBits||(g.windowBits+=32),15<g.windowBits&&g.windowBits<48&&(15&g.windowBits)==0&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var _=o.inflateInit2(this.strm,g.windowBits);if(_!==c.Z_OK)throw new Error(l[_]);this.header=new u,o.inflateGetHeader(this.strm,this.header)}function h(m,g){var _=new p(g);if(_.push(m,!0),_.err)throw _.msg||l[_.err];return _.result}p.prototype.push=function(m,g){var _,E,w,x,b,S,y=this.strm,C=this.options.chunkSize,P=this.options.dictionary,R=!1;if(this.ended)return!1;E=g===~~g?g:g===!0?c.Z_FINISH:c.Z_NO_FLUSH,typeof m=="string"?y.input=r.binstring2buf(m):f.call(m)==="[object ArrayBuffer]"?y.input=new Uint8Array(m):y.input=m,y.next_in=0,y.avail_in=y.input.length;do{if(y.avail_out===0&&(y.output=new i.Buf8(C),y.next_out=0,y.avail_out=C),(_=o.inflate(y,c.Z_NO_FLUSH))===c.Z_NEED_DICT&&P&&(S=typeof P=="string"?r.string2buf(P):f.call(P)==="[object ArrayBuffer]"?new Uint8Array(P):P,_=o.inflateSetDictionary(this.strm,S)),_===c.Z_BUF_ERROR&&R===!0&&(_=c.Z_OK,R=!1),_!==c.Z_STREAM_END&&_!==c.Z_OK)return this.onEnd(_),!(this.ended=!0);y.next_out&&(y.avail_out!==0&&_!==c.Z_STREAM_END&&(y.avail_in!==0||E!==c.Z_FINISH&&E!==c.Z_SYNC_FLUSH)||(this.options.to==="string"?(w=r.utf8border(y.output,y.next_out),x=y.next_out-w,b=r.buf2string(y.output,w),y.next_out=x,y.avail_out=C-x,x&&i.arraySet(y.output,y.output,w,x,0),this.onData(b)):this.onData(i.shrinkBuf(y.output,y.next_out)))),y.avail_in===0&&y.avail_out===0&&(R=!0)}while((0<y.avail_in||y.avail_out===0)&&_!==c.Z_STREAM_END);return _===c.Z_STREAM_END&&(E=c.Z_FINISH),E===c.Z_FINISH?(_=o.inflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===c.Z_OK):E!==c.Z_SYNC_FLUSH||(this.onEnd(c.Z_OK),!(y.avail_out=0))},p.prototype.onData=function(m){this.chunks.push(m)},p.prototype.onEnd=function(m){m===c.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},a.Inflate=p,a.inflate=h,a.inflateRaw=function(m,g){return(g=g||{}).raw=!0,h(m,g)},a.ungzip=h},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,s,a){var o=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(c){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var d=l.shift();if(d){if(typeof d!="object")throw new TypeError(d+"must be non-object");for(var u in d)d.hasOwnProperty(u)&&(c[u]=d[u])}}return c},a.shrinkBuf=function(c,l){return c.length===l?c:c.subarray?c.subarray(0,l):(c.length=l,c)};var i={arraySet:function(c,l,d,u,f){if(l.subarray&&c.subarray)c.set(l.subarray(d,d+u),f);else for(var p=0;p<u;p++)c[f+p]=l[d+p]},flattenChunks:function(c){var l,d,u,f,p,h;for(l=u=0,d=c.length;l<d;l++)u+=c[l].length;for(h=new Uint8Array(u),l=f=0,d=c.length;l<d;l++)p=c[l],h.set(p,f),f+=p.length;return h}},r={arraySet:function(c,l,d,u,f){for(var p=0;p<u;p++)c[f+p]=l[d+p]},flattenChunks:function(c){return[].concat.apply([],c)}};a.setTyped=function(c){c?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,i)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,r))},a.setTyped(o)},{}],42:[function(t,s,a){var o=t("./common"),i=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{r=!1}for(var c=new o.Buf8(256),l=0;l<256;l++)c[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function d(u,f){if(f<65537&&(u.subarray&&r||!u.subarray&&i))return String.fromCharCode.apply(null,o.shrinkBuf(u,f));for(var p="",h=0;h<f;h++)p+=String.fromCharCode(u[h]);return p}c[254]=c[254]=1,a.string2buf=function(u){var f,p,h,m,g,_=u.length,E=0;for(m=0;m<_;m++)(64512&(p=u.charCodeAt(m)))==55296&&m+1<_&&(64512&(h=u.charCodeAt(m+1)))==56320&&(p=65536+(p-55296<<10)+(h-56320),m++),E+=p<128?1:p<2048?2:p<65536?3:4;for(f=new o.Buf8(E),m=g=0;g<E;m++)(64512&(p=u.charCodeAt(m)))==55296&&m+1<_&&(64512&(h=u.charCodeAt(m+1)))==56320&&(p=65536+(p-55296<<10)+(h-56320),m++),p<128?f[g++]=p:(p<2048?f[g++]=192|p>>>6:(p<65536?f[g++]=224|p>>>12:(f[g++]=240|p>>>18,f[g++]=128|p>>>12&63),f[g++]=128|p>>>6&63),f[g++]=128|63&p);return f},a.buf2binstring=function(u){return d(u,u.length)},a.binstring2buf=function(u){for(var f=new o.Buf8(u.length),p=0,h=f.length;p<h;p++)f[p]=u.charCodeAt(p);return f},a.buf2string=function(u,f){var p,h,m,g,_=f||u.length,E=new Array(2*_);for(p=h=0;p<_;)if((m=u[p++])<128)E[h++]=m;else if(4<(g=c[m]))E[h++]=65533,p+=g-1;else{for(m&=g===2?31:g===3?15:7;1<g&&p<_;)m=m<<6|63&u[p++],g--;1<g?E[h++]=65533:m<65536?E[h++]=m:(m-=65536,E[h++]=55296|m>>10&1023,E[h++]=56320|1023&m)}return d(E,h)},a.utf8border=function(u,f){var p;for((f=f||u.length)>u.length&&(f=u.length),p=f-1;0<=p&&(192&u[p])==128;)p--;return p<0||p===0?f:p+c[u[p]]>f?p:f}},{"./common":41}],43:[function(t,s,a){s.exports=function(o,i,r,c){for(var l=65535&o|0,d=o>>>16&65535|0,u=0;r!==0;){for(r-=u=2e3<r?2e3:r;d=d+(l=l+i[c++]|0)|0,--u;);l%=65521,d%=65521}return l|d<<16|0}},{}],44:[function(t,s,a){s.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,s,a){var o=(function(){for(var i,r=[],c=0;c<256;c++){i=c;for(var l=0;l<8;l++)i=1&i?3988292384^i>>>1:i>>>1;r[c]=i}return r})();s.exports=function(i,r,c,l){var d=o,u=l+c;i^=-1;for(var f=l;f<u;f++)i=i>>>8^d[255&(i^r[f])];return-1^i}},{}],46:[function(t,s,a){var o,i=t("../utils/common"),r=t("./trees"),c=t("./adler32"),l=t("./crc32"),d=t("./messages"),u=0,f=4,p=0,h=-2,m=-1,g=4,_=2,E=8,w=9,x=286,b=30,S=19,y=2*x+1,C=15,P=3,R=258,A=R+P+1,T=42,I=113,v=1,M=2,K=3,U=4;function Y(k,H){return k.msg=d[H],H}function j(k){return(k<<1)-(4<k?9:0)}function X(k){for(var H=k.length;0<=--H;)k[H]=0}function O(k){var H=k.state,q=H.pending;q>k.avail_out&&(q=k.avail_out),q!==0&&(i.arraySet(k.output,H.pending_buf,H.pending_out,q,k.next_out),k.next_out+=q,H.pending_out+=q,k.total_out+=q,k.avail_out-=q,H.pending-=q,H.pending===0&&(H.pending_out=0))}function L(k,H){r._tr_flush_block(k,0<=k.block_start?k.block_start:-1,k.strstart-k.block_start,H),k.block_start=k.strstart,O(k.strm)}function F(k,H){k.pending_buf[k.pending++]=H}function G(k,H){k.pending_buf[k.pending++]=H>>>8&255,k.pending_buf[k.pending++]=255&H}function z(k,H){var q,$,D=k.max_chain_length,N=k.strstart,W=k.prev_length,Q=k.nice_match,B=k.strstart>k.w_size-A?k.strstart-(k.w_size-A):0,J=k.window,ee=k.w_mask,Z=k.prev,te=k.strstart+R,ue=J[N+W-1],oe=J[N+W];k.prev_length>=k.good_match&&(D>>=2),Q>k.lookahead&&(Q=k.lookahead);do if(J[(q=H)+W]===oe&&J[q+W-1]===ue&&J[q]===J[N]&&J[++q]===J[N+1]){N+=2,q++;do;while(J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&J[++N]===J[++q]&&N<te);if($=R-(te-N),N=te-R,W<$){if(k.match_start=H,Q<=(W=$))break;ue=J[N+W-1],oe=J[N+W]}}while((H=Z[H&ee])>B&&--D!=0);return W<=k.lookahead?W:k.lookahead}function ne(k){var H,q,$,D,N,W,Q,B,J,ee,Z=k.w_size;do{if(D=k.window_size-k.lookahead-k.strstart,k.strstart>=Z+(Z-A)){for(i.arraySet(k.window,k.window,Z,Z,0),k.match_start-=Z,k.strstart-=Z,k.block_start-=Z,H=q=k.hash_size;$=k.head[--H],k.head[H]=Z<=$?$-Z:0,--q;);for(H=q=Z;$=k.prev[--H],k.prev[H]=Z<=$?$-Z:0,--q;);D+=Z}if(k.strm.avail_in===0)break;if(W=k.strm,Q=k.window,B=k.strstart+k.lookahead,J=D,ee=void 0,ee=W.avail_in,J<ee&&(ee=J),q=ee===0?0:(W.avail_in-=ee,i.arraySet(Q,W.input,W.next_in,ee,B),W.state.wrap===1?W.adler=c(W.adler,Q,ee,B):W.state.wrap===2&&(W.adler=l(W.adler,Q,ee,B)),W.next_in+=ee,W.total_in+=ee,ee),k.lookahead+=q,k.lookahead+k.insert>=P)for(N=k.strstart-k.insert,k.ins_h=k.window[N],k.ins_h=(k.ins_h<<k.hash_shift^k.window[N+1])&k.hash_mask;k.insert&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[N+P-1])&k.hash_mask,k.prev[N&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=N,N++,k.insert--,!(k.lookahead+k.insert<P)););}while(k.lookahead<A&&k.strm.avail_in!==0)}function de(k,H){for(var q,$;;){if(k.lookahead<A){if(ne(k),k.lookahead<A&&H===u)return v;if(k.lookahead===0)break}if(q=0,k.lookahead>=P&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+P-1])&k.hash_mask,q=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),q!==0&&k.strstart-q<=k.w_size-A&&(k.match_length=z(k,q)),k.match_length>=P)if($=r._tr_tally(k,k.strstart-k.match_start,k.match_length-P),k.lookahead-=k.match_length,k.match_length<=k.max_lazy_match&&k.lookahead>=P){for(k.match_length--;k.strstart++,k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+P-1])&k.hash_mask,q=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart,--k.match_length!=0;);k.strstart++}else k.strstart+=k.match_length,k.match_length=0,k.ins_h=k.window[k.strstart],k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+1])&k.hash_mask;else $=r._tr_tally(k,0,k.window[k.strstart]),k.lookahead--,k.strstart++;if($&&(L(k,!1),k.strm.avail_out===0))return v}return k.insert=k.strstart<P-1?k.strstart:P-1,H===f?(L(k,!0),k.strm.avail_out===0?K:U):k.last_lit&&(L(k,!1),k.strm.avail_out===0)?v:M}function re(k,H){for(var q,$,D;;){if(k.lookahead<A){if(ne(k),k.lookahead<A&&H===u)return v;if(k.lookahead===0)break}if(q=0,k.lookahead>=P&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+P-1])&k.hash_mask,q=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),k.prev_length=k.match_length,k.prev_match=k.match_start,k.match_length=P-1,q!==0&&k.prev_length<k.max_lazy_match&&k.strstart-q<=k.w_size-A&&(k.match_length=z(k,q),k.match_length<=5&&(k.strategy===1||k.match_length===P&&4096<k.strstart-k.match_start)&&(k.match_length=P-1)),k.prev_length>=P&&k.match_length<=k.prev_length){for(D=k.strstart+k.lookahead-P,$=r._tr_tally(k,k.strstart-1-k.prev_match,k.prev_length-P),k.lookahead-=k.prev_length-1,k.prev_length-=2;++k.strstart<=D&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+P-1])&k.hash_mask,q=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),--k.prev_length!=0;);if(k.match_available=0,k.match_length=P-1,k.strstart++,$&&(L(k,!1),k.strm.avail_out===0))return v}else if(k.match_available){if(($=r._tr_tally(k,0,k.window[k.strstart-1]))&&L(k,!1),k.strstart++,k.lookahead--,k.strm.avail_out===0)return v}else k.match_available=1,k.strstart++,k.lookahead--}return k.match_available&&($=r._tr_tally(k,0,k.window[k.strstart-1]),k.match_available=0),k.insert=k.strstart<P-1?k.strstart:P-1,H===f?(L(k,!0),k.strm.avail_out===0?K:U):k.last_lit&&(L(k,!1),k.strm.avail_out===0)?v:M}function ae(k,H,q,$,D){this.good_length=k,this.max_lazy=H,this.nice_length=q,this.max_chain=$,this.func=D}function ge(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=E,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*y),this.dyn_dtree=new i.Buf16(2*(2*b+1)),this.bl_tree=new i.Buf16(2*(2*S+1)),X(this.dyn_ltree),X(this.dyn_dtree),X(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(C+1),this.heap=new i.Buf16(2*x+1),X(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*x+1),X(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function me(k){var H;return k&&k.state?(k.total_in=k.total_out=0,k.data_type=_,(H=k.state).pending=0,H.pending_out=0,H.wrap<0&&(H.wrap=-H.wrap),H.status=H.wrap?T:I,k.adler=H.wrap===2?0:1,H.last_flush=u,r._tr_init(H),p):Y(k,h)}function Re(k){var H=me(k);return H===p&&(function(q){q.window_size=2*q.w_size,X(q.head),q.max_lazy_match=o[q.level].max_lazy,q.good_match=o[q.level].good_length,q.nice_match=o[q.level].nice_length,q.max_chain_length=o[q.level].max_chain,q.strstart=0,q.block_start=0,q.lookahead=0,q.insert=0,q.match_length=q.prev_length=P-1,q.match_available=0,q.ins_h=0})(k.state),H}function Se(k,H,q,$,D,N){if(!k)return h;var W=1;if(H===m&&(H=6),$<0?(W=0,$=-$):15<$&&(W=2,$-=16),D<1||w<D||q!==E||$<8||15<$||H<0||9<H||N<0||g<N)return Y(k,h);$===8&&($=9);var Q=new ge;return(k.state=Q).strm=k,Q.wrap=W,Q.gzhead=null,Q.w_bits=$,Q.w_size=1<<Q.w_bits,Q.w_mask=Q.w_size-1,Q.hash_bits=D+7,Q.hash_size=1<<Q.hash_bits,Q.hash_mask=Q.hash_size-1,Q.hash_shift=~~((Q.hash_bits+P-1)/P),Q.window=new i.Buf8(2*Q.w_size),Q.head=new i.Buf16(Q.hash_size),Q.prev=new i.Buf16(Q.w_size),Q.lit_bufsize=1<<D+6,Q.pending_buf_size=4*Q.lit_bufsize,Q.pending_buf=new i.Buf8(Q.pending_buf_size),Q.d_buf=1*Q.lit_bufsize,Q.l_buf=3*Q.lit_bufsize,Q.level=H,Q.strategy=N,Q.method=q,Re(k)}o=[new ae(0,0,0,0,function(k,H){var q=65535;for(q>k.pending_buf_size-5&&(q=k.pending_buf_size-5);;){if(k.lookahead<=1){if(ne(k),k.lookahead===0&&H===u)return v;if(k.lookahead===0)break}k.strstart+=k.lookahead,k.lookahead=0;var $=k.block_start+q;if((k.strstart===0||k.strstart>=$)&&(k.lookahead=k.strstart-$,k.strstart=$,L(k,!1),k.strm.avail_out===0)||k.strstart-k.block_start>=k.w_size-A&&(L(k,!1),k.strm.avail_out===0))return v}return k.insert=0,H===f?(L(k,!0),k.strm.avail_out===0?K:U):(k.strstart>k.block_start&&(L(k,!1),k.strm.avail_out),v)}),new ae(4,4,8,4,de),new ae(4,5,16,8,de),new ae(4,6,32,32,de),new ae(4,4,16,16,re),new ae(8,16,32,32,re),new ae(8,16,128,128,re),new ae(8,32,128,256,re),new ae(32,128,258,1024,re),new ae(32,258,258,4096,re)],a.deflateInit=function(k,H){return Se(k,H,E,15,8,0)},a.deflateInit2=Se,a.deflateReset=Re,a.deflateResetKeep=me,a.deflateSetHeader=function(k,H){return k&&k.state?k.state.wrap!==2?h:(k.state.gzhead=H,p):h},a.deflate=function(k,H){var q,$,D,N;if(!k||!k.state||5<H||H<0)return k?Y(k,h):h;if($=k.state,!k.output||!k.input&&k.avail_in!==0||$.status===666&&H!==f)return Y(k,k.avail_out===0?-5:h);if($.strm=k,q=$.last_flush,$.last_flush=H,$.status===T)if($.wrap===2)k.adler=0,F($,31),F($,139),F($,8),$.gzhead?(F($,($.gzhead.text?1:0)+($.gzhead.hcrc?2:0)+($.gzhead.extra?4:0)+($.gzhead.name?8:0)+($.gzhead.comment?16:0)),F($,255&$.gzhead.time),F($,$.gzhead.time>>8&255),F($,$.gzhead.time>>16&255),F($,$.gzhead.time>>24&255),F($,$.level===9?2:2<=$.strategy||$.level<2?4:0),F($,255&$.gzhead.os),$.gzhead.extra&&$.gzhead.extra.length&&(F($,255&$.gzhead.extra.length),F($,$.gzhead.extra.length>>8&255)),$.gzhead.hcrc&&(k.adler=l(k.adler,$.pending_buf,$.pending,0)),$.gzindex=0,$.status=69):(F($,0),F($,0),F($,0),F($,0),F($,0),F($,$.level===9?2:2<=$.strategy||$.level<2?4:0),F($,3),$.status=I);else{var W=E+($.w_bits-8<<4)<<8;W|=(2<=$.strategy||$.level<2?0:$.level<6?1:$.level===6?2:3)<<6,$.strstart!==0&&(W|=32),W+=31-W%31,$.status=I,G($,W),$.strstart!==0&&(G($,k.adler>>>16),G($,65535&k.adler)),k.adler=1}if($.status===69)if($.gzhead.extra){for(D=$.pending;$.gzindex<(65535&$.gzhead.extra.length)&&($.pending!==$.pending_buf_size||($.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),O(k),D=$.pending,$.pending!==$.pending_buf_size));)F($,255&$.gzhead.extra[$.gzindex]),$.gzindex++;$.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),$.gzindex===$.gzhead.extra.length&&($.gzindex=0,$.status=73)}else $.status=73;if($.status===73)if($.gzhead.name){D=$.pending;do{if($.pending===$.pending_buf_size&&($.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),O(k),D=$.pending,$.pending===$.pending_buf_size)){N=1;break}N=$.gzindex<$.gzhead.name.length?255&$.gzhead.name.charCodeAt($.gzindex++):0,F($,N)}while(N!==0);$.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),N===0&&($.gzindex=0,$.status=91)}else $.status=91;if($.status===91)if($.gzhead.comment){D=$.pending;do{if($.pending===$.pending_buf_size&&($.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),O(k),D=$.pending,$.pending===$.pending_buf_size)){N=1;break}N=$.gzindex<$.gzhead.comment.length?255&$.gzhead.comment.charCodeAt($.gzindex++):0,F($,N)}while(N!==0);$.gzhead.hcrc&&$.pending>D&&(k.adler=l(k.adler,$.pending_buf,$.pending-D,D)),N===0&&($.status=103)}else $.status=103;if($.status===103&&($.gzhead.hcrc?($.pending+2>$.pending_buf_size&&O(k),$.pending+2<=$.pending_buf_size&&(F($,255&k.adler),F($,k.adler>>8&255),k.adler=0,$.status=I)):$.status=I),$.pending!==0){if(O(k),k.avail_out===0)return $.last_flush=-1,p}else if(k.avail_in===0&&j(H)<=j(q)&&H!==f)return Y(k,-5);if($.status===666&&k.avail_in!==0)return Y(k,-5);if(k.avail_in!==0||$.lookahead!==0||H!==u&&$.status!==666){var Q=$.strategy===2?(function(B,J){for(var ee;;){if(B.lookahead===0&&(ne(B),B.lookahead===0)){if(J===u)return v;break}if(B.match_length=0,ee=r._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++,ee&&(L(B,!1),B.strm.avail_out===0))return v}return B.insert=0,J===f?(L(B,!0),B.strm.avail_out===0?K:U):B.last_lit&&(L(B,!1),B.strm.avail_out===0)?v:M})($,H):$.strategy===3?(function(B,J){for(var ee,Z,te,ue,oe=B.window;;){if(B.lookahead<=R){if(ne(B),B.lookahead<=R&&J===u)return v;if(B.lookahead===0)break}if(B.match_length=0,B.lookahead>=P&&0<B.strstart&&(Z=oe[te=B.strstart-1])===oe[++te]&&Z===oe[++te]&&Z===oe[++te]){ue=B.strstart+R;do;while(Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&Z===oe[++te]&&te<ue);B.match_length=R-(ue-te),B.match_length>B.lookahead&&(B.match_length=B.lookahead)}if(B.match_length>=P?(ee=r._tr_tally(B,1,B.match_length-P),B.lookahead-=B.match_length,B.strstart+=B.match_length,B.match_length=0):(ee=r._tr_tally(B,0,B.window[B.strstart]),B.lookahead--,B.strstart++),ee&&(L(B,!1),B.strm.avail_out===0))return v}return B.insert=0,J===f?(L(B,!0),B.strm.avail_out===0?K:U):B.last_lit&&(L(B,!1),B.strm.avail_out===0)?v:M})($,H):o[$.level].func($,H);if(Q!==K&&Q!==U||($.status=666),Q===v||Q===K)return k.avail_out===0&&($.last_flush=-1),p;if(Q===M&&(H===1?r._tr_align($):H!==5&&(r._tr_stored_block($,0,0,!1),H===3&&(X($.head),$.lookahead===0&&($.strstart=0,$.block_start=0,$.insert=0))),O(k),k.avail_out===0))return $.last_flush=-1,p}return H!==f?p:$.wrap<=0?1:($.wrap===2?(F($,255&k.adler),F($,k.adler>>8&255),F($,k.adler>>16&255),F($,k.adler>>24&255),F($,255&k.total_in),F($,k.total_in>>8&255),F($,k.total_in>>16&255),F($,k.total_in>>24&255)):(G($,k.adler>>>16),G($,65535&k.adler)),O(k),0<$.wrap&&($.wrap=-$.wrap),$.pending!==0?p:1)},a.deflateEnd=function(k){var H;return k&&k.state?(H=k.state.status)!==T&&H!==69&&H!==73&&H!==91&&H!==103&&H!==I&&H!==666?Y(k,h):(k.state=null,H===I?Y(k,-3):p):h},a.deflateSetDictionary=function(k,H){var q,$,D,N,W,Q,B,J,ee=H.length;if(!k||!k.state||(N=(q=k.state).wrap)===2||N===1&&q.status!==T||q.lookahead)return h;for(N===1&&(k.adler=c(k.adler,H,ee,0)),q.wrap=0,ee>=q.w_size&&(N===0&&(X(q.head),q.strstart=0,q.block_start=0,q.insert=0),J=new i.Buf8(q.w_size),i.arraySet(J,H,ee-q.w_size,q.w_size,0),H=J,ee=q.w_size),W=k.avail_in,Q=k.next_in,B=k.input,k.avail_in=ee,k.next_in=0,k.input=H,ne(q);q.lookahead>=P;){for($=q.strstart,D=q.lookahead-(P-1);q.ins_h=(q.ins_h<<q.hash_shift^q.window[$+P-1])&q.hash_mask,q.prev[$&q.w_mask]=q.head[q.ins_h],q.head[q.ins_h]=$,$++,--D;);q.strstart=$,q.lookahead=P-1,ne(q)}return q.strstart+=q.lookahead,q.block_start=q.strstart,q.insert=q.lookahead,q.lookahead=0,q.match_length=q.prev_length=P-1,q.match_available=0,k.next_in=Q,k.input=B,k.avail_in=W,q.wrap=N,p},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,s,a){s.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,s,a){s.exports=function(o,i){var r,c,l,d,u,f,p,h,m,g,_,E,w,x,b,S,y,C,P,R,A,T,I,v,M;r=o.state,c=o.next_in,v=o.input,l=c+(o.avail_in-5),d=o.next_out,M=o.output,u=d-(i-o.avail_out),f=d+(o.avail_out-257),p=r.dmax,h=r.wsize,m=r.whave,g=r.wnext,_=r.window,E=r.hold,w=r.bits,x=r.lencode,b=r.distcode,S=(1<<r.lenbits)-1,y=(1<<r.distbits)-1;e:do{w<15&&(E+=v[c++]<<w,w+=8,E+=v[c++]<<w,w+=8),C=x[E&S];t:for(;;){if(E>>>=P=C>>>24,w-=P,(P=C>>>16&255)===0)M[d++]=65535&C;else{if(!(16&P)){if((64&P)==0){C=x[(65535&C)+(E&(1<<P)-1)];continue t}if(32&P){r.mode=12;break e}o.msg="invalid literal/length code",r.mode=30;break e}R=65535&C,(P&=15)&&(w<P&&(E+=v[c++]<<w,w+=8),R+=E&(1<<P)-1,E>>>=P,w-=P),w<15&&(E+=v[c++]<<w,w+=8,E+=v[c++]<<w,w+=8),C=b[E&y];n:for(;;){if(E>>>=P=C>>>24,w-=P,!(16&(P=C>>>16&255))){if((64&P)==0){C=b[(65535&C)+(E&(1<<P)-1)];continue n}o.msg="invalid distance code",r.mode=30;break e}if(A=65535&C,w<(P&=15)&&(E+=v[c++]<<w,(w+=8)<P&&(E+=v[c++]<<w,w+=8)),p<(A+=E&(1<<P)-1)){o.msg="invalid distance too far back",r.mode=30;break e}if(E>>>=P,w-=P,(P=d-u)<A){if(m<(P=A-P)&&r.sane){o.msg="invalid distance too far back",r.mode=30;break e}if(I=_,(T=0)===g){if(T+=h-P,P<R){for(R-=P;M[d++]=_[T++],--P;);T=d-A,I=M}}else if(g<P){if(T+=h+g-P,(P-=g)<R){for(R-=P;M[d++]=_[T++],--P;);if(T=0,g<R){for(R-=P=g;M[d++]=_[T++],--P;);T=d-A,I=M}}}else if(T+=g-P,P<R){for(R-=P;M[d++]=_[T++],--P;);T=d-A,I=M}for(;2<R;)M[d++]=I[T++],M[d++]=I[T++],M[d++]=I[T++],R-=3;R&&(M[d++]=I[T++],1<R&&(M[d++]=I[T++]))}else{for(T=d-A;M[d++]=M[T++],M[d++]=M[T++],M[d++]=M[T++],2<(R-=3););R&&(M[d++]=M[T++],1<R&&(M[d++]=M[T++]))}break}}break}}while(c<l&&d<f);c-=R=w>>3,E&=(1<<(w-=R<<3))-1,o.next_in=c,o.next_out=d,o.avail_in=c<l?l-c+5:5-(c-l),o.avail_out=d<f?f-d+257:257-(d-f),r.hold=E,r.bits=w}},{}],49:[function(t,s,a){var o=t("../utils/common"),i=t("./adler32"),r=t("./crc32"),c=t("./inffast"),l=t("./inftrees"),d=1,u=2,f=0,p=-2,h=1,m=852,g=592;function _(T){return(T>>>24&255)+(T>>>8&65280)+((65280&T)<<8)+((255&T)<<24)}function E(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new o.Buf16(320),this.work=new o.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function w(T){var I;return T&&T.state?(I=T.state,T.total_in=T.total_out=I.total=0,T.msg="",I.wrap&&(T.adler=1&I.wrap),I.mode=h,I.last=0,I.havedict=0,I.dmax=32768,I.head=null,I.hold=0,I.bits=0,I.lencode=I.lendyn=new o.Buf32(m),I.distcode=I.distdyn=new o.Buf32(g),I.sane=1,I.back=-1,f):p}function x(T){var I;return T&&T.state?((I=T.state).wsize=0,I.whave=0,I.wnext=0,w(T)):p}function b(T,I){var v,M;return T&&T.state?(M=T.state,I<0?(v=0,I=-I):(v=1+(I>>4),I<48&&(I&=15)),I&&(I<8||15<I)?p:(M.window!==null&&M.wbits!==I&&(M.window=null),M.wrap=v,M.wbits=I,x(T))):p}function S(T,I){var v,M;return T?(M=new E,(T.state=M).window=null,(v=b(T,I))!==f&&(T.state=null),v):p}var y,C,P=!0;function R(T){if(P){var I;for(y=new o.Buf32(512),C=new o.Buf32(32),I=0;I<144;)T.lens[I++]=8;for(;I<256;)T.lens[I++]=9;for(;I<280;)T.lens[I++]=7;for(;I<288;)T.lens[I++]=8;for(l(d,T.lens,0,288,y,0,T.work,{bits:9}),I=0;I<32;)T.lens[I++]=5;l(u,T.lens,0,32,C,0,T.work,{bits:5}),P=!1}T.lencode=y,T.lenbits=9,T.distcode=C,T.distbits=5}function A(T,I,v,M){var K,U=T.state;return U.window===null&&(U.wsize=1<<U.wbits,U.wnext=0,U.whave=0,U.window=new o.Buf8(U.wsize)),M>=U.wsize?(o.arraySet(U.window,I,v-U.wsize,U.wsize,0),U.wnext=0,U.whave=U.wsize):(M<(K=U.wsize-U.wnext)&&(K=M),o.arraySet(U.window,I,v-M,K,U.wnext),(M-=K)?(o.arraySet(U.window,I,v-M,M,0),U.wnext=M,U.whave=U.wsize):(U.wnext+=K,U.wnext===U.wsize&&(U.wnext=0),U.whave<U.wsize&&(U.whave+=K))),0}a.inflateReset=x,a.inflateReset2=b,a.inflateResetKeep=w,a.inflateInit=function(T){return S(T,15)},a.inflateInit2=S,a.inflate=function(T,I){var v,M,K,U,Y,j,X,O,L,F,G,z,ne,de,re,ae,ge,me,Re,Se,k,H,q,$,D=0,N=new o.Buf8(4),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!T||!T.state||!T.output||!T.input&&T.avail_in!==0)return p;(v=T.state).mode===12&&(v.mode=13),Y=T.next_out,K=T.output,X=T.avail_out,U=T.next_in,M=T.input,j=T.avail_in,O=v.hold,L=v.bits,F=j,G=X,H=f;e:for(;;)switch(v.mode){case h:if(v.wrap===0){v.mode=13;break}for(;L<16;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(2&v.wrap&&O===35615){N[v.check=0]=255&O,N[1]=O>>>8&255,v.check=r(v.check,N,2,0),L=O=0,v.mode=2;break}if(v.flags=0,v.head&&(v.head.done=!1),!(1&v.wrap)||(((255&O)<<8)+(O>>8))%31){T.msg="incorrect header check",v.mode=30;break}if((15&O)!=8){T.msg="unknown compression method",v.mode=30;break}if(L-=4,k=8+(15&(O>>>=4)),v.wbits===0)v.wbits=k;else if(k>v.wbits){T.msg="invalid window size",v.mode=30;break}v.dmax=1<<k,T.adler=v.check=1,v.mode=512&O?10:12,L=O=0;break;case 2:for(;L<16;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(v.flags=O,(255&v.flags)!=8){T.msg="unknown compression method",v.mode=30;break}if(57344&v.flags){T.msg="unknown header flags set",v.mode=30;break}v.head&&(v.head.text=O>>8&1),512&v.flags&&(N[0]=255&O,N[1]=O>>>8&255,v.check=r(v.check,N,2,0)),L=O=0,v.mode=3;case 3:for(;L<32;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.head&&(v.head.time=O),512&v.flags&&(N[0]=255&O,N[1]=O>>>8&255,N[2]=O>>>16&255,N[3]=O>>>24&255,v.check=r(v.check,N,4,0)),L=O=0,v.mode=4;case 4:for(;L<16;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.head&&(v.head.xflags=255&O,v.head.os=O>>8),512&v.flags&&(N[0]=255&O,N[1]=O>>>8&255,v.check=r(v.check,N,2,0)),L=O=0,v.mode=5;case 5:if(1024&v.flags){for(;L<16;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.length=O,v.head&&(v.head.extra_len=O),512&v.flags&&(N[0]=255&O,N[1]=O>>>8&255,v.check=r(v.check,N,2,0)),L=O=0}else v.head&&(v.head.extra=null);v.mode=6;case 6:if(1024&v.flags&&(j<(z=v.length)&&(z=j),z&&(v.head&&(k=v.head.extra_len-v.length,v.head.extra||(v.head.extra=new Array(v.head.extra_len)),o.arraySet(v.head.extra,M,U,z,k)),512&v.flags&&(v.check=r(v.check,M,z,U)),j-=z,U+=z,v.length-=z),v.length))break e;v.length=0,v.mode=7;case 7:if(2048&v.flags){if(j===0)break e;for(z=0;k=M[U+z++],v.head&&k&&v.length<65536&&(v.head.name+=String.fromCharCode(k)),k&&z<j;);if(512&v.flags&&(v.check=r(v.check,M,z,U)),j-=z,U+=z,k)break e}else v.head&&(v.head.name=null);v.length=0,v.mode=8;case 8:if(4096&v.flags){if(j===0)break e;for(z=0;k=M[U+z++],v.head&&k&&v.length<65536&&(v.head.comment+=String.fromCharCode(k)),k&&z<j;);if(512&v.flags&&(v.check=r(v.check,M,z,U)),j-=z,U+=z,k)break e}else v.head&&(v.head.comment=null);v.mode=9;case 9:if(512&v.flags){for(;L<16;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(O!==(65535&v.check)){T.msg="header crc mismatch",v.mode=30;break}L=O=0}v.head&&(v.head.hcrc=v.flags>>9&1,v.head.done=!0),T.adler=v.check=0,v.mode=12;break;case 10:for(;L<32;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}T.adler=v.check=_(O),L=O=0,v.mode=11;case 11:if(v.havedict===0)return T.next_out=Y,T.avail_out=X,T.next_in=U,T.avail_in=j,v.hold=O,v.bits=L,2;T.adler=v.check=1,v.mode=12;case 12:if(I===5||I===6)break e;case 13:if(v.last){O>>>=7&L,L-=7&L,v.mode=27;break}for(;L<3;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}switch(v.last=1&O,L-=1,3&(O>>>=1)){case 0:v.mode=14;break;case 1:if(R(v),v.mode=20,I!==6)break;O>>>=2,L-=2;break e;case 2:v.mode=17;break;case 3:T.msg="invalid block type",v.mode=30}O>>>=2,L-=2;break;case 14:for(O>>>=7&L,L-=7&L;L<32;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if((65535&O)!=(O>>>16^65535)){T.msg="invalid stored block lengths",v.mode=30;break}if(v.length=65535&O,L=O=0,v.mode=15,I===6)break e;case 15:v.mode=16;case 16:if(z=v.length){if(j<z&&(z=j),X<z&&(z=X),z===0)break e;o.arraySet(K,M,U,z,Y),j-=z,U+=z,X-=z,Y+=z,v.length-=z;break}v.mode=12;break;case 17:for(;L<14;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(v.nlen=257+(31&O),O>>>=5,L-=5,v.ndist=1+(31&O),O>>>=5,L-=5,v.ncode=4+(15&O),O>>>=4,L-=4,286<v.nlen||30<v.ndist){T.msg="too many length or distance symbols",v.mode=30;break}v.have=0,v.mode=18;case 18:for(;v.have<v.ncode;){for(;L<3;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.lens[W[v.have++]]=7&O,O>>>=3,L-=3}for(;v.have<19;)v.lens[W[v.have++]]=0;if(v.lencode=v.lendyn,v.lenbits=7,q={bits:v.lenbits},H=l(0,v.lens,0,19,v.lencode,0,v.work,q),v.lenbits=q.bits,H){T.msg="invalid code lengths set",v.mode=30;break}v.have=0,v.mode=19;case 19:for(;v.have<v.nlen+v.ndist;){for(;ae=(D=v.lencode[O&(1<<v.lenbits)-1])>>>16&255,ge=65535&D,!((re=D>>>24)<=L);){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(ge<16)O>>>=re,L-=re,v.lens[v.have++]=ge;else{if(ge===16){for($=re+2;L<$;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(O>>>=re,L-=re,v.have===0){T.msg="invalid bit length repeat",v.mode=30;break}k=v.lens[v.have-1],z=3+(3&O),O>>>=2,L-=2}else if(ge===17){for($=re+3;L<$;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}L-=re,k=0,z=3+(7&(O>>>=re)),O>>>=3,L-=3}else{for($=re+7;L<$;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}L-=re,k=0,z=11+(127&(O>>>=re)),O>>>=7,L-=7}if(v.have+z>v.nlen+v.ndist){T.msg="invalid bit length repeat",v.mode=30;break}for(;z--;)v.lens[v.have++]=k}}if(v.mode===30)break;if(v.lens[256]===0){T.msg="invalid code -- missing end-of-block",v.mode=30;break}if(v.lenbits=9,q={bits:v.lenbits},H=l(d,v.lens,0,v.nlen,v.lencode,0,v.work,q),v.lenbits=q.bits,H){T.msg="invalid literal/lengths set",v.mode=30;break}if(v.distbits=6,v.distcode=v.distdyn,q={bits:v.distbits},H=l(u,v.lens,v.nlen,v.ndist,v.distcode,0,v.work,q),v.distbits=q.bits,H){T.msg="invalid distances set",v.mode=30;break}if(v.mode=20,I===6)break e;case 20:v.mode=21;case 21:if(6<=j&&258<=X){T.next_out=Y,T.avail_out=X,T.next_in=U,T.avail_in=j,v.hold=O,v.bits=L,c(T,G),Y=T.next_out,K=T.output,X=T.avail_out,U=T.next_in,M=T.input,j=T.avail_in,O=v.hold,L=v.bits,v.mode===12&&(v.back=-1);break}for(v.back=0;ae=(D=v.lencode[O&(1<<v.lenbits)-1])>>>16&255,ge=65535&D,!((re=D>>>24)<=L);){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(ae&&(240&ae)==0){for(me=re,Re=ae,Se=ge;ae=(D=v.lencode[Se+((O&(1<<me+Re)-1)>>me)])>>>16&255,ge=65535&D,!(me+(re=D>>>24)<=L);){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}O>>>=me,L-=me,v.back+=me}if(O>>>=re,L-=re,v.back+=re,v.length=ge,ae===0){v.mode=26;break}if(32&ae){v.back=-1,v.mode=12;break}if(64&ae){T.msg="invalid literal/length code",v.mode=30;break}v.extra=15&ae,v.mode=22;case 22:if(v.extra){for($=v.extra;L<$;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.length+=O&(1<<v.extra)-1,O>>>=v.extra,L-=v.extra,v.back+=v.extra}v.was=v.length,v.mode=23;case 23:for(;ae=(D=v.distcode[O&(1<<v.distbits)-1])>>>16&255,ge=65535&D,!((re=D>>>24)<=L);){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if((240&ae)==0){for(me=re,Re=ae,Se=ge;ae=(D=v.distcode[Se+((O&(1<<me+Re)-1)>>me)])>>>16&255,ge=65535&D,!(me+(re=D>>>24)<=L);){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}O>>>=me,L-=me,v.back+=me}if(O>>>=re,L-=re,v.back+=re,64&ae){T.msg="invalid distance code",v.mode=30;break}v.offset=ge,v.extra=15&ae,v.mode=24;case 24:if(v.extra){for($=v.extra;L<$;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}v.offset+=O&(1<<v.extra)-1,O>>>=v.extra,L-=v.extra,v.back+=v.extra}if(v.offset>v.dmax){T.msg="invalid distance too far back",v.mode=30;break}v.mode=25;case 25:if(X===0)break e;if(z=G-X,v.offset>z){if((z=v.offset-z)>v.whave&&v.sane){T.msg="invalid distance too far back",v.mode=30;break}ne=z>v.wnext?(z-=v.wnext,v.wsize-z):v.wnext-z,z>v.length&&(z=v.length),de=v.window}else de=K,ne=Y-v.offset,z=v.length;for(X<z&&(z=X),X-=z,v.length-=z;K[Y++]=de[ne++],--z;);v.length===0&&(v.mode=21);break;case 26:if(X===0)break e;K[Y++]=v.length,X--,v.mode=21;break;case 27:if(v.wrap){for(;L<32;){if(j===0)break e;j--,O|=M[U++]<<L,L+=8}if(G-=X,T.total_out+=G,v.total+=G,G&&(T.adler=v.check=v.flags?r(v.check,K,G,Y-G):i(v.check,K,G,Y-G)),G=X,(v.flags?O:_(O))!==v.check){T.msg="incorrect data check",v.mode=30;break}L=O=0}v.mode=28;case 28:if(v.wrap&&v.flags){for(;L<32;){if(j===0)break e;j--,O+=M[U++]<<L,L+=8}if(O!==(4294967295&v.total)){T.msg="incorrect length check",v.mode=30;break}L=O=0}v.mode=29;case 29:H=1;break e;case 30:H=-3;break e;case 31:return-4;case 32:default:return p}return T.next_out=Y,T.avail_out=X,T.next_in=U,T.avail_in=j,v.hold=O,v.bits=L,(v.wsize||G!==T.avail_out&&v.mode<30&&(v.mode<27||I!==4))&&A(T,T.output,T.next_out,G-T.avail_out)?(v.mode=31,-4):(F-=T.avail_in,G-=T.avail_out,T.total_in+=F,T.total_out+=G,v.total+=G,v.wrap&&G&&(T.adler=v.check=v.flags?r(v.check,K,G,T.next_out-G):i(v.check,K,G,T.next_out-G)),T.data_type=v.bits+(v.last?64:0)+(v.mode===12?128:0)+(v.mode===20||v.mode===15?256:0),(F==0&&G===0||I===4)&&H===f&&(H=-5),H)},a.inflateEnd=function(T){if(!T||!T.state)return p;var I=T.state;return I.window&&(I.window=null),T.state=null,f},a.inflateGetHeader=function(T,I){var v;return T&&T.state?(2&(v=T.state).wrap)==0?p:((v.head=I).done=!1,f):p},a.inflateSetDictionary=function(T,I){var v,M=I.length;return T&&T.state?(v=T.state).wrap!==0&&v.mode!==11?p:v.mode===11&&i(1,I,M,0)!==v.check?-3:A(T,I,M,M)?(v.mode=31,-4):(v.havedict=1,f):p},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,s,a){var o=t("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];s.exports=function(d,u,f,p,h,m,g,_){var E,w,x,b,S,y,C,P,R,A=_.bits,T=0,I=0,v=0,M=0,K=0,U=0,Y=0,j=0,X=0,O=0,L=null,F=0,G=new o.Buf16(16),z=new o.Buf16(16),ne=null,de=0;for(T=0;T<=15;T++)G[T]=0;for(I=0;I<p;I++)G[u[f+I]]++;for(K=A,M=15;1<=M&&G[M]===0;M--);if(M<K&&(K=M),M===0)return h[m++]=20971520,h[m++]=20971520,_.bits=1,0;for(v=1;v<M&&G[v]===0;v++);for(K<v&&(K=v),T=j=1;T<=15;T++)if(j<<=1,(j-=G[T])<0)return-1;if(0<j&&(d===0||M!==1))return-1;for(z[1]=0,T=1;T<15;T++)z[T+1]=z[T]+G[T];for(I=0;I<p;I++)u[f+I]!==0&&(g[z[u[f+I]]++]=I);if(y=d===0?(L=ne=g,19):d===1?(L=i,F-=257,ne=r,de-=257,256):(L=c,ne=l,-1),T=v,S=m,Y=I=O=0,x=-1,b=(X=1<<(U=K))-1,d===1&&852<X||d===2&&592<X)return 1;for(;;){for(C=T-Y,R=g[I]<y?(P=0,g[I]):g[I]>y?(P=ne[de+g[I]],L[F+g[I]]):(P=96,0),E=1<<T-Y,v=w=1<<U;h[S+(O>>Y)+(w-=E)]=C<<24|P<<16|R|0,w!==0;);for(E=1<<T-1;O&E;)E>>=1;if(E!==0?(O&=E-1,O+=E):O=0,I++,--G[T]==0){if(T===M)break;T=u[f+g[I]]}if(K<T&&(O&b)!==x){for(Y===0&&(Y=K),S+=v,j=1<<(U=T-Y);U+Y<M&&!((j-=G[U+Y])<=0);)U++,j<<=1;if(X+=1<<U,d===1&&852<X||d===2&&592<X)return 1;h[x=O&b]=K<<24|U<<16|S-m|0}}return O!==0&&(h[S+O]=T-Y<<24|64<<16|0),_.bits=K,0}},{"../utils/common":41}],51:[function(t,s,a){s.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,s,a){var o=t("../utils/common"),i=0,r=1;function c(D){for(var N=D.length;0<=--N;)D[N]=0}var l=0,d=29,u=256,f=u+1+d,p=30,h=19,m=2*f+1,g=15,_=16,E=7,w=256,x=16,b=17,S=18,y=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],C=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],P=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],A=new Array(2*(f+2));c(A);var T=new Array(2*p);c(T);var I=new Array(512);c(I);var v=new Array(256);c(v);var M=new Array(d);c(M);var K,U,Y,j=new Array(p);function X(D,N,W,Q,B){this.static_tree=D,this.extra_bits=N,this.extra_base=W,this.elems=Q,this.max_length=B,this.has_stree=D&&D.length}function O(D,N){this.dyn_tree=D,this.max_code=0,this.stat_desc=N}function L(D){return D<256?I[D]:I[256+(D>>>7)]}function F(D,N){D.pending_buf[D.pending++]=255&N,D.pending_buf[D.pending++]=N>>>8&255}function G(D,N,W){D.bi_valid>_-W?(D.bi_buf|=N<<D.bi_valid&65535,F(D,D.bi_buf),D.bi_buf=N>>_-D.bi_valid,D.bi_valid+=W-_):(D.bi_buf|=N<<D.bi_valid&65535,D.bi_valid+=W)}function z(D,N,W){G(D,W[2*N],W[2*N+1])}function ne(D,N){for(var W=0;W|=1&D,D>>>=1,W<<=1,0<--N;);return W>>>1}function de(D,N,W){var Q,B,J=new Array(g+1),ee=0;for(Q=1;Q<=g;Q++)J[Q]=ee=ee+W[Q-1]<<1;for(B=0;B<=N;B++){var Z=D[2*B+1];Z!==0&&(D[2*B]=ne(J[Z]++,Z))}}function re(D){var N;for(N=0;N<f;N++)D.dyn_ltree[2*N]=0;for(N=0;N<p;N++)D.dyn_dtree[2*N]=0;for(N=0;N<h;N++)D.bl_tree[2*N]=0;D.dyn_ltree[2*w]=1,D.opt_len=D.static_len=0,D.last_lit=D.matches=0}function ae(D){8<D.bi_valid?F(D,D.bi_buf):0<D.bi_valid&&(D.pending_buf[D.pending++]=D.bi_buf),D.bi_buf=0,D.bi_valid=0}function ge(D,N,W,Q){var B=2*N,J=2*W;return D[B]<D[J]||D[B]===D[J]&&Q[N]<=Q[W]}function me(D,N,W){for(var Q=D.heap[W],B=W<<1;B<=D.heap_len&&(B<D.heap_len&&ge(N,D.heap[B+1],D.heap[B],D.depth)&&B++,!ge(N,Q,D.heap[B],D.depth));)D.heap[W]=D.heap[B],W=B,B<<=1;D.heap[W]=Q}function Re(D,N,W){var Q,B,J,ee,Z=0;if(D.last_lit!==0)for(;Q=D.pending_buf[D.d_buf+2*Z]<<8|D.pending_buf[D.d_buf+2*Z+1],B=D.pending_buf[D.l_buf+Z],Z++,Q===0?z(D,B,N):(z(D,(J=v[B])+u+1,N),(ee=y[J])!==0&&G(D,B-=M[J],ee),z(D,J=L(--Q),W),(ee=C[J])!==0&&G(D,Q-=j[J],ee)),Z<D.last_lit;);z(D,w,N)}function Se(D,N){var W,Q,B,J=N.dyn_tree,ee=N.stat_desc.static_tree,Z=N.stat_desc.has_stree,te=N.stat_desc.elems,ue=-1;for(D.heap_len=0,D.heap_max=m,W=0;W<te;W++)J[2*W]!==0?(D.heap[++D.heap_len]=ue=W,D.depth[W]=0):J[2*W+1]=0;for(;D.heap_len<2;)J[2*(B=D.heap[++D.heap_len]=ue<2?++ue:0)]=1,D.depth[B]=0,D.opt_len--,Z&&(D.static_len-=ee[2*B+1]);for(N.max_code=ue,W=D.heap_len>>1;1<=W;W--)me(D,J,W);for(B=te;W=D.heap[1],D.heap[1]=D.heap[D.heap_len--],me(D,J,1),Q=D.heap[1],D.heap[--D.heap_max]=W,D.heap[--D.heap_max]=Q,J[2*B]=J[2*W]+J[2*Q],D.depth[B]=(D.depth[W]>=D.depth[Q]?D.depth[W]:D.depth[Q])+1,J[2*W+1]=J[2*Q+1]=B,D.heap[1]=B++,me(D,J,1),2<=D.heap_len;);D.heap[--D.heap_max]=D.heap[1],(function(oe,$e){var Tt,Oe,Dt,_e,rn,$n,Ge=$e.dyn_tree,Tr=$e.max_code,ra=$e.stat_desc.static_tree,sa=$e.stat_desc.has_stree,oa=$e.stat_desc.extra_bits,Dr=$e.stat_desc.extra_base,Rt=$e.stat_desc.max_length,sn=0;for(_e=0;_e<=g;_e++)oe.bl_count[_e]=0;for(Ge[2*oe.heap[oe.heap_max]+1]=0,Tt=oe.heap_max+1;Tt<m;Tt++)Rt<(_e=Ge[2*Ge[2*(Oe=oe.heap[Tt])+1]+1]+1)&&(_e=Rt,sn++),Ge[2*Oe+1]=_e,Tr<Oe||(oe.bl_count[_e]++,rn=0,Dr<=Oe&&(rn=oa[Oe-Dr]),$n=Ge[2*Oe],oe.opt_len+=$n*(_e+rn),sa&&(oe.static_len+=$n*(ra[2*Oe+1]+rn)));if(sn!==0){do{for(_e=Rt-1;oe.bl_count[_e]===0;)_e--;oe.bl_count[_e]--,oe.bl_count[_e+1]+=2,oe.bl_count[Rt]--,sn-=2}while(0<sn);for(_e=Rt;_e!==0;_e--)for(Oe=oe.bl_count[_e];Oe!==0;)Tr<(Dt=oe.heap[--Tt])||(Ge[2*Dt+1]!==_e&&(oe.opt_len+=(_e-Ge[2*Dt+1])*Ge[2*Dt],Ge[2*Dt+1]=_e),Oe--)}})(D,N),de(J,ue,D.bl_count)}function k(D,N,W){var Q,B,J=-1,ee=N[1],Z=0,te=7,ue=4;for(ee===0&&(te=138,ue=3),N[2*(W+1)+1]=65535,Q=0;Q<=W;Q++)B=ee,ee=N[2*(Q+1)+1],++Z<te&&B===ee||(Z<ue?D.bl_tree[2*B]+=Z:B!==0?(B!==J&&D.bl_tree[2*B]++,D.bl_tree[2*x]++):Z<=10?D.bl_tree[2*b]++:D.bl_tree[2*S]++,J=B,ue=(Z=0)===ee?(te=138,3):B===ee?(te=6,3):(te=7,4))}function H(D,N,W){var Q,B,J=-1,ee=N[1],Z=0,te=7,ue=4;for(ee===0&&(te=138,ue=3),Q=0;Q<=W;Q++)if(B=ee,ee=N[2*(Q+1)+1],!(++Z<te&&B===ee)){if(Z<ue)for(;z(D,B,D.bl_tree),--Z!=0;);else B!==0?(B!==J&&(z(D,B,D.bl_tree),Z--),z(D,x,D.bl_tree),G(D,Z-3,2)):Z<=10?(z(D,b,D.bl_tree),G(D,Z-3,3)):(z(D,S,D.bl_tree),G(D,Z-11,7));J=B,ue=(Z=0)===ee?(te=138,3):B===ee?(te=6,3):(te=7,4)}}c(j);var q=!1;function $(D,N,W,Q){G(D,(l<<1)+(Q?1:0),3),(function(B,J,ee,Z){ae(B),F(B,ee),F(B,~ee),o.arraySet(B.pending_buf,B.window,J,ee,B.pending),B.pending+=ee})(D,N,W)}a._tr_init=function(D){q||((function(){var N,W,Q,B,J,ee=new Array(g+1);for(B=Q=0;B<d-1;B++)for(M[B]=Q,N=0;N<1<<y[B];N++)v[Q++]=B;for(v[Q-1]=B,B=J=0;B<16;B++)for(j[B]=J,N=0;N<1<<C[B];N++)I[J++]=B;for(J>>=7;B<p;B++)for(j[B]=J<<7,N=0;N<1<<C[B]-7;N++)I[256+J++]=B;for(W=0;W<=g;W++)ee[W]=0;for(N=0;N<=143;)A[2*N+1]=8,N++,ee[8]++;for(;N<=255;)A[2*N+1]=9,N++,ee[9]++;for(;N<=279;)A[2*N+1]=7,N++,ee[7]++;for(;N<=287;)A[2*N+1]=8,N++,ee[8]++;for(de(A,f+1,ee),N=0;N<p;N++)T[2*N+1]=5,T[2*N]=ne(N,5);K=new X(A,y,u+1,f,g),U=new X(T,C,0,p,g),Y=new X(new Array(0),P,0,h,E)})(),q=!0),D.l_desc=new O(D.dyn_ltree,K),D.d_desc=new O(D.dyn_dtree,U),D.bl_desc=new O(D.bl_tree,Y),D.bi_buf=0,D.bi_valid=0,re(D)},a._tr_stored_block=$,a._tr_flush_block=function(D,N,W,Q){var B,J,ee=0;0<D.level?(D.strm.data_type===2&&(D.strm.data_type=(function(Z){var te,ue=4093624447;for(te=0;te<=31;te++,ue>>>=1)if(1&ue&&Z.dyn_ltree[2*te]!==0)return i;if(Z.dyn_ltree[18]!==0||Z.dyn_ltree[20]!==0||Z.dyn_ltree[26]!==0)return r;for(te=32;te<u;te++)if(Z.dyn_ltree[2*te]!==0)return r;return i})(D)),Se(D,D.l_desc),Se(D,D.d_desc),ee=(function(Z){var te;for(k(Z,Z.dyn_ltree,Z.l_desc.max_code),k(Z,Z.dyn_dtree,Z.d_desc.max_code),Se(Z,Z.bl_desc),te=h-1;3<=te&&Z.bl_tree[2*R[te]+1]===0;te--);return Z.opt_len+=3*(te+1)+5+5+4,te})(D),B=D.opt_len+3+7>>>3,(J=D.static_len+3+7>>>3)<=B&&(B=J)):B=J=W+5,W+4<=B&&N!==-1?$(D,N,W,Q):D.strategy===4||J===B?(G(D,2+(Q?1:0),3),Re(D,A,T)):(G(D,4+(Q?1:0),3),(function(Z,te,ue,oe){var $e;for(G(Z,te-257,5),G(Z,ue-1,5),G(Z,oe-4,4),$e=0;$e<oe;$e++)G(Z,Z.bl_tree[2*R[$e]+1],3);H(Z,Z.dyn_ltree,te-1),H(Z,Z.dyn_dtree,ue-1)})(D,D.l_desc.max_code+1,D.d_desc.max_code+1,ee+1),Re(D,D.dyn_ltree,D.dyn_dtree)),re(D),Q&&ae(D)},a._tr_tally=function(D,N,W){return D.pending_buf[D.d_buf+2*D.last_lit]=N>>>8&255,D.pending_buf[D.d_buf+2*D.last_lit+1]=255&N,D.pending_buf[D.l_buf+D.last_lit]=255&W,D.last_lit++,N===0?D.dyn_ltree[2*W]++:(D.matches++,N--,D.dyn_ltree[2*(v[W]+u+1)]++,D.dyn_dtree[2*L(N)]++),D.last_lit===D.lit_bufsize-1},a._tr_align=function(D){G(D,2,3),z(D,w,A),(function(N){N.bi_valid===16?(F(N,N.bi_buf),N.bi_buf=0,N.bi_valid=0):8<=N.bi_valid&&(N.pending_buf[N.pending++]=255&N.bi_buf,N.bi_buf>>=8,N.bi_valid-=8)})(D)}},{"../utils/common":41}],53:[function(t,s,a){s.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,s,a){(function(o){(function(i,r){if(!i.setImmediate){var c,l,d,u,f=1,p={},h=!1,m=i.document,g=Object.getPrototypeOf&&Object.getPrototypeOf(i);g=g&&g.setTimeout?g:i,c={}.toString.call(i.process)==="[object process]"?function(x){process.nextTick(function(){E(x)})}:(function(){if(i.postMessage&&!i.importScripts){var x=!0,b=i.onmessage;return i.onmessage=function(){x=!1},i.postMessage("","*"),i.onmessage=b,x}})()?(u="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",w,!1):i.attachEvent("onmessage",w),function(x){i.postMessage(u+x,"*")}):i.MessageChannel?((d=new MessageChannel).port1.onmessage=function(x){E(x.data)},function(x){d.port2.postMessage(x)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(x){var b=m.createElement("script");b.onreadystatechange=function(){E(x),b.onreadystatechange=null,l.removeChild(b),b=null},l.appendChild(b)}):function(x){setTimeout(E,0,x)},g.setImmediate=function(x){typeof x!="function"&&(x=new Function(""+x));for(var b=new Array(arguments.length-1),S=0;S<b.length;S++)b[S]=arguments[S+1];var y={callback:x,args:b};return p[f]=y,c(f),f++},g.clearImmediate=_}function _(x){delete p[x]}function E(x){if(h)setTimeout(E,0,x);else{var b=p[x];if(b){h=!0;try{(function(S){var y=S.callback,C=S.args;switch(C.length){case 0:y();break;case 1:y(C[0]);break;case 2:y(C[0],C[1]);break;case 3:y(C[0],C[1],C[2]);break;default:y.apply(r,C)}})(b)}finally{_(x),h=!1}}}}function w(x){x.source===i&&typeof x.data=="string"&&x.data.indexOf(u)===0&&E(+x.data.slice(u.length))}})(typeof self>"u"?o===void 0?this:o:self)}).call(this,typeof mn<"u"?mn:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(tr)),tr.exports}var na=pp();const up=dp(na),Pr=aa({__proto__:null,default:up},[na]);</script>
  <style rel="stylesheet" crossorigin>:root{--bg: #0e1117;--surface: #1a1d27;--surface2: #262730;--border: #363842;--text: #fafafa;--text2: #808495;--primary: #ff4b4b;--primary-hover: #ff6b6b;--green: #21c354;--amber: #faca15;--red: #ff4b4b;--blue: #1d4ed8;--font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;--mono: "SF Mono", "Fira Code", monospace}*{box-sizing:border-box;margin:0;padding:0}body{background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.6}h1{font-size:2rem;margin-bottom:4px}h2{font-size:1.4rem;margin:24px 0 12px;border-bottom:1px solid var(--border);padding-bottom:8px}h3{font-size:1.1rem;margin:16px 0 8px}.caption{color:var(--text2);font-size:.9rem;margin-bottom:20px}code{background:var(--surface2);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:.85rem}pre{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;overflow-x:auto;font-family:var(--mono);font-size:.85rem;margin:12px 0}.hidden{display:none}.divider{border:none;border-top:1px solid var(--border);margin:24px 0}.container{max-width:1200px;margin:0 auto;padding:20px}.tabs{display:grid;grid-template-columns:repeat(6,1fr);gap:0;margin-bottom:24px}.tab{padding:10px 8px;cursor:pointer;color:var(--text2);border-bottom:2px solid var(--border);white-space:nowrap;font-size:.88rem;transition:all .2s;text-align:center}.tab:hover{color:var(--text)}.tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}.tab{position:relative}.tab .check{display:none;margin-left:6px;color:var(--green);font-size:.85rem}.tab.done .check{display:inline-block;animation:pop .4s ease}.tab.locked{opacity:.4;pointer-events:none}.tab .spinner-sm{display:none;width:12px;height:12px;border:2px solid var(--border);border-top:2px solid var(--primary);border-radius:50%;animation:spin .6s linear infinite;margin-left:6px;vertical-align:middle}.tab.processing .spinner-sm{display:inline-block}.panel{display:none}.panel.active{display:block}.row{display:flex;gap:20px;flex-wrap:wrap}.col{flex:1;min-width:280px}.col-3{flex:1;min-width:200px}@media(max-width:768px){.row{flex-direction:column}.col,.col-3{min-width:100%}}.btn{padding:10px 24px;border:none;border-radius:6px;cursor:pointer;font-size:.95rem;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-hover)}.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}.btn:disabled{opacity:.5;cursor:not-allowed}.alert{padding:12px 16px;border-radius:6px;margin:12px 0;font-size:.9rem}.alert-info{background:#1e3a5f;border:1px solid #2563eb;color:#93c5fd}.alert-success{background:#14532d;border:1px solid var(--green);color:#86efac}.alert-warn{background:#713f12;border:1px solid var(--amber);color:#fde68a}.alert-error{background:#450a0a;border:1px solid var(--red);color:#fca5a5}.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:.8rem;font-weight:600}.badge-green{background:#14532d;color:#86efac}.badge-amber{background:#713f12;color:#fde68a}.badge-red{background:#450a0a;color:#fca5a5}.conf-badge{padding:1px 6px;border-radius:3px;font-size:.65rem;font-weight:700}.conf-high{background:#21c35433;color:#86efac}.conf-med{background:#eab30833;color:#fde68a}.conf-low{background:#ef444433;color:#fca5a5}.conf-none{background:#80849526;color:#9ca3af}.conf-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}.conf-dot.high{background:var(--green)}.conf-dot.med{background:var(--amber)}.conf-dot.low{background:var(--red)}.conf-dot.none{background:var(--text2)}.progress-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:6px 0}.progress-fill{height:100%;border-radius:4px;transition:width .3s}.progress-fill.green{background:var(--green)}.progress-fill.amber{background:var(--amber)}.progress-fill.red{background:var(--red)}.file-upload{border:2px dashed var(--border);border-radius:8px;padding:40px 20px;text-align:center;cursor:pointer;transition:border-color .2s}.file-upload:hover{border-color:var(--primary)}.file-upload input{display:none}.sources-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin:16px 0}.source-badge{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;text-align:center;border-top:3px solid var(--border);transition:border-color .2s}.source-badge:hover{border-color:var(--primary)}.source-badge .src-name{font-weight:600;font-size:.85rem}.source-badge .src-type{color:var(--text2);font-size:.7rem;text-transform:uppercase;letter-spacing:.3px}.detected-source{display:inline-flex;align-items:center;gap:8px;padding:6px 14px;background:var(--surface);border:1px solid var(--green);border-radius:6px;margin:8px 0;font-size:.9rem}.detected-source .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}.gap-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin:6px 0;border-left:3px solid var(--red)}.gap-card .gap-title{font-weight:600;font-size:.85rem;margin-bottom:2px}.gap-card .gap-meta{color:var(--text2);font-size:.75rem}.gap-card .gap-rec{color:var(--amber);font-size:.8rem;margin-top:4px}.sys-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin:6px 0}.sys-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}.sys-card-header .sys-name{font-weight:700;font-size:.95rem}.sys-card-header .sys-badge{font-size:.7rem;padding:2px 8px;border-radius:10px}.sys-detail-row{display:flex;gap:16px;flex-wrap:wrap;font-size:.82rem;padding:3px 0}.sys-detail-row .sys-label{color:var(--text2);min-width:90px}.sys-detail-row .sys-value{color:var(--text);word-break:break-all}.el-highlight{background:#3b82f626;color:#60a5fa;padding:1px 3px;border-radius:2px;font-family:var(--mono);font-size:.75rem}.effort-bar{display:flex;height:28px;border-radius:6px;overflow:hidden;margin:8px 0}.effort-bar .effort-seg{display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;transition:width .4s ease}.node-upstream{box-shadow:0 0 0 3px #3b82f699!important}.node-downstream{box-shadow:0 0 0 3px #21c35499!important}.node-selected{box-shadow:0 0 0 3px #ff4b4bcc!important}.conform-check{padding:4px 0;font-size:.82rem}.conform-check .check-icon{margin-right:6px}.resource-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}.resource-dot.used{background:#21c354}.resource-dot.orphaned{background:#faca15}.resource-dot.missing{background:#ff4b4b}.match-badge{display:inline-block;padding:1px 8px;border-radius:3px;font-size:.7rem;font-weight:700}.match-exact{background:#21c35433;color:#86efac}.match-functional{background:#eab30833;color:#fde68a}.match-gap{background:#ef444433;color:#fca5a5}.sample-card{display:flex;gap:10px;align-items:center;padding:10px 14px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;background:var(--bg1)}.sample-card:hover{border-color:var(--accent);background:#ff6b350d;transform:translateY(-1px);box-shadow:0 2px 8px #0000001a}.sample-icon{font-size:1.5rem;flex-shrink:0;width:32px;text-align:center}.sample-info{display:flex;flex-direction:column;gap:1px;min-width:0}.sample-info strong{font-size:.85rem;color:var(--text1)}.sample-info span{font-size:.75rem;color:var(--text2)}.sample-tags{font-size:.7rem!important;color:var(--accent)!important;opacity:.8}.manifest-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin:8px 0}.manifest-stat{text-align:center;padding:8px;border-radius:8px;background:var(--surface2)}.manifest-stat .num{font-size:1.3rem;font-weight:700;color:var(--accent)}.manifest-stat .lbl{font-size:.72rem;color:var(--text2)}.venv-tree{font-family:var(--mono);font-size:.82rem;line-height:1.7;padding:8px 0}.venv-tree .dir{color:var(--text2);font-weight:600}.venv-tree .file{color:var(--accent)}.venv-tree .venv-badge{display:inline-block;background:var(--surface2);border-radius:4px;padding:1px 6px;font-size:.72rem;margin-left:6px}.venv-summary{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}.venv-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;text-align:center;flex:1;min-width:100px}.venv-stat .venv-stat-num{font-size:1.5rem;font-weight:700;color:var(--primary)}.venv-stat .venv-stat-label{font-size:.75rem;color:var(--text2);margin-top:4px}.metrics{display:flex;gap:16px;flex-wrap:wrap;margin:16px 0}.metric{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px 20px;min-width:140px;flex:1}.metric .label{font-size:.8rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}.metric .value{font-size:1.8rem;font-weight:700;margin-top:4px}.metric .delta{font-size:.85rem;color:var(--red)}.score-big{font-size:3rem;font-weight:800;text-align:center;padding:20px}table{width:100%;border-collapse:collapse;margin:12px 0;font-size:.85rem}th{text-align:left;padding:8px 12px;background:var(--surface2);color:var(--text2);font-weight:600;text-transform:uppercase;font-size:.75rem;letter-spacing:.5px;border-bottom:2px solid var(--border)}td{padding:8px 12px;border-bottom:1px solid var(--border)}tr:hover td{background:var(--surface)}.table-scroll{overflow-x:auto}.mapping-table{width:100%;border-collapse:collapse;font-size:.78rem;margin:12px 0}.mapping-table th{text-align:left;padding:6px 10px;border-bottom:2px solid var(--border);font-size:.7rem;text-transform:uppercase;color:var(--text2)}.mapping-table td{padding:5px 10px;border-bottom:1px solid var(--border)}.mapping-table tr.unmapped{opacity:.5}.comparison-detail{margin-top:16px}.comparison-detail summary{cursor:pointer;font-weight:600;font-size:.95rem;padding:10px 0;color:var(--text)}.comparison-detail summary:hover{color:var(--primary)}.comparison-detail table{width:100%;font-size:.8rem}.comparison-detail td,.comparison-detail th{padding:6px 8px}.comparison-detail tr:hover{background:var(--surface2)}.ops-log{max-height:400px;overflow-y:auto;font-family:var(--mono);font-size:.78rem}.ops-log-row{display:grid;grid-template-columns:50px 180px 100px 1fr 80px;gap:4px;padding:3px 0;border-bottom:1px solid var(--border);align-items:center}.ops-log-row:hover{background:#ff6b350d}.ops-log-row.header{font-weight:700;color:var(--text2);font-size:.72rem;text-transform:uppercase;border-bottom:2px solid var(--border)}.ops-action{font-weight:600;font-size:.75rem}.ops-action.file{color:#4285f4}.ops-action.sql{color:#21c354}.ops-action.token{color:#faca15}.ops-action.signal{color:#ff6d70}.ops-action.counter{color:#8b5cf6}.ops-action.queue{color:#29b5e8}.action-log{max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;margin:8px 0}.action-log-entry{display:grid;grid-template-columns:100px 1fr 1fr;gap:8px;padding:6px 10px;border-bottom:1px solid var(--border);font-size:.78rem;align-items:start}.action-log-entry:last-child{border-bottom:none}.action-log-entry .action-type{font-weight:600;font-size:.75rem;text-transform:uppercase}.action-log-entry .action-type.file-op{color:#21c354}.action-log-entry .action-type.sql-op{color:#6366f1}.action-log-entry .action-type.token-op{color:#eab308}.action-log-entry .action-type.signal-op{color:#f97316}.action-log-entry .action-type.queue-op{color:#06b6d4}.expander{border:1px solid var(--border);border-radius:8px;margin:12px 0;overflow:hidden}.expander-header{padding:12px 16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:var(--surface);font-weight:500}.expander-header:hover{background:var(--surface2)}.expander-body{padding:16px;display:none;border-top:1px solid var(--border)}.expander.open .expander-body{display:block}.expander-arrow{transition:transform .2s}.expander.open .expander-arrow{transform:rotate(90deg)}.tier-diagram{position:relative;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--bg);min-height:200px;margin:16px 0}.tier-diagram svg.tier-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}.tier-band{padding:16px 20px;border-bottom:1px solid var(--border);position:relative;z-index:2}.tier-band:last-child{border-bottom:none}.tier-band-label{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:10px;opacity:.8}.tier-nodes{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}.tier-node{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 16px;min-width:120px;max-width:200px;text-align:center;cursor:pointer;transition:all .2s;position:relative;z-index:3}.tier-node:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px #0000004d}.tier-node.selected{border-color:var(--primary);box-shadow:0 0 0 2px #ff4b4b4d}.tier-node.highlighted{border-color:var(--green)}.tier-node.dimmed{opacity:.3}.tier-node .node-name{font-weight:600;font-size:.85rem;word-break:break-all}.tier-node .node-meta{font-size:.7rem;color:var(--text2);margin-top:4px}.tier-node .node-badge{position:absolute;top:-6px;right:-6px;background:var(--primary);color:#fff;border-radius:10px;padding:1px 6px;font-size:.65rem;font-weight:700}.tier-node .node-badge.green{background:var(--green)}.tier-node .node-badge.amber{background:var(--amber);color:#000}.tier-node .node-badge.red{background:var(--red)}.tier-node .node-seq{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;font-size:.7rem;font-weight:700;margin-bottom:4px}.tier-node .node-stats{display:flex;gap:4px;justify-content:center;margin-top:6px;flex-wrap:wrap}.tier-node .node-stats .ns{padding:1px 5px;border-radius:3px;font-size:.6rem;font-weight:700}.ns-tx{background:#3b82f6;color:#fff}.ns-ext{background:#21c354;color:#fff}.ns-lkp{background:#eab308;color:#000}.tier-node.table-output{background:var(--surface2);border-style:dashed;min-width:100px;max-width:180px;padding:8px 12px}.tier-node.table-output .node-name{font-size:.75rem}.tier-node.table-output .node-class{font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}.tier-node.conflict-gate{border-color:var(--red);background:#1a0a0a;min-width:140px}.tier-node.conflict-gate .node-name{color:var(--red)}.tier-diagram-wrapper{display:flex;gap:0}.tier-diagram-main{flex:1;min-width:0}.tier-density-sidebar{width:220px;flex-shrink:0;border-left:1px solid var(--border);background:var(--surface);padding:12px;overflow-y:auto;max-height:800px;font-size:.7rem}.tier-density-sidebar h4{font-size:.75rem;margin:0 0 8px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}.density-row{display:flex;align-items:center;gap:6px;margin:3px 0}.density-bar{height:6px;border-radius:3px;flex-shrink:0;min-width:2px}.density-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text2);max-width:120px}@media(max-width:900px){.tier-density-sidebar{display:none}.tier-diagram-wrapper{flex-direction:column}}.node-detail{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:12px;font-size:.85rem}.node-detail h4{margin:0 0 8px}.diagram-legend{display:flex;gap:16px;flex-wrap:wrap;margin:8px 0;font-size:.75rem;color:var(--text2)}.diagram-legend span{display:flex;align-items:center;gap:4px}.diagram-legend .leg-line{width:20px;height:2px;border-radius:1px}.tier-node.in-cycle{border-color:#ef4444;animation:cyclePulse 2s ease-in-out infinite}.cycle-badge{position:absolute;top:-6px;left:-6px;background:#ef4444;color:#fff;border-radius:50%;width:18px;height:18px;font-size:.6rem;display:flex;align-items:center;justify-content:center;z-index:4}.tier-node .expand-indicator{font-size:.6rem;color:var(--text2);margin-top:4px}.tier-node.expanded{border-color:var(--primary);box-shadow:0 0 0 2px #ff4b4b33}.tier-sub-band{padding:8px 20px 12px 40px;border-bottom:1px solid var(--border);background:#ffffff05;position:relative;z-index:2}.tier-sub-band .tier-band-label{font-size:.6rem;opacity:.6;margin-bottom:6px}.tier-sub-band .tier-nodes{gap:8px}.tier-sub-band .tier-node{min-width:100px;max-width:160px;padding:6px 10px}.tier-sub-band .tier-node .node-name{font-size:.75rem}.tier-node.path-selected{border-color:#faca15;box-shadow:0 0 0 3px #faca1566;z-index:10}.tier-node.path-selected:before{content:"✓";position:absolute;top:-8px;left:-8px;width:18px;height:18px;border-radius:50%;background:#faca15;color:#000;font-size:.65rem;font-weight:700;display:flex;align-items:center;justify-content:center;z-index:5}.tier-node.path-member{border-color:#faca15;background:#faca1514}.tier-node.path-dimmed{opacity:.12}.path-trace-toast{position:fixed;bottom:24px;left:50%;transform:translate(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:.85rem;color:var(--text);z-index:1000;display:none;align-items:center;gap:12px;box-shadow:0 4px 24px #00000080}.path-trace-toast .toast-hint{color:var(--text2);font-size:.75rem}.path-trace-toast .toast-clear{cursor:pointer;color:var(--primary);font-weight:600;font-size:.8rem}.notebook-preview{background:var(--surface);border:1px solid var(--border);border-radius:8px;max-height:600px;overflow-y:auto;margin:12px 0}.notebook-cell{padding:10px 16px;border-bottom:1px solid var(--border);font-family:SF Mono,Monaco,Consolas,monospace;font-size:.78rem;line-height:1.5;white-space:pre-wrap;word-break:break-word}.notebook-cell:last-child{border-bottom:none}.notebook-cell.cell-md{background:#3b82f60f;color:#93c5fd}.notebook-cell.cell-sql{background:#a855f70f}.notebook-cell.cell-code{background:var(--surface)}.notebook-cell .cell-label{display:inline-block;padding:1px 8px;border-radius:3px;font-size:.65rem;font-weight:700;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}.cell-label.lb-source{background:#1d3557;color:#93c5fd}.cell-label.lb-transform{background:#2d1b4e;color:#c4b5fd}.cell-label.lb-sink{background:#14532d;color:#86efac}.cell-label.lb-route{background:#422006;color:#fde68a}.cell-label.lb-process{background:#1e1b4b;color:#a5b4fc}.cell-label.lb-utility{background:#1f2937;color:#9ca3af}.cell-label.lb-config{background:#0c4a6e;color:#7dd3fc}.cell-label.lb-manual{background:#450a0a;color:#fca5a5}textarea,input[type=text],input[type=number],select{width:100%;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--mono);font-size:.9rem;resize:vertical}textarea:focus,input:focus{outline:none;border-color:var(--primary)}textarea{min-height:200px}label{display:block;font-size:.85rem;color:var(--text2);margin-bottom:6px;font-weight:500}.coverage-ring{width:120px;height:120px;border-radius:50%;position:relative;display:inline-flex;align-items:center;justify-content:center}.coverage-ring .ring-text{font-size:1.6rem;font-weight:800;z-index:1}.comparison-donuts{display:flex;gap:32px;justify-content:center;flex-wrap:wrap;margin:24px 0}.donut-chart{text-align:center;flex:0 0 160px}.donut-chart svg{filter:drop-shadow(0 2px 8px rgba(0,0,0,.3))}.donut-label{font-size:.85rem;font-weight:600;margin-top:8px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}.donut-sub{font-size:.75rem;color:var(--text2);margin-top:2px}.val-section{margin:16px 0;padding:16px;background:var(--surface2,#1e2030);border-radius:8px;border-left:4px solid var(--primary)}.val-section h4{margin:0 0 10px;color:var(--primary)}.val-score-ring{display:inline-flex;align-items:center;gap:8px;margin:4px 8px 4px 0}.val-score-ring svg{vertical-align:middle}.val-gap{background:var(--red)11;border:1px solid var(--red)44;border-radius:6px;padding:8px 12px;margin:4px 0;font-size:.85rem}.val-gap .gap-label{color:var(--red);font-weight:600}.val-ok{background:var(--green)11;border:1px solid var(--green)44;border-radius:6px;padding:8px 12px;margin:4px 0;font-size:.85rem}.val-warn{background:var(--amber)11;border:1px solid var(--amber)44;border-radius:6px;padding:8px 12px;margin:4px 0;font-size:.85rem}.val-matrix{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:768px){.val-matrix{grid-template-columns:1fr}}.val-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:.85rem}.val-item:last-child{border-bottom:none}.val-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}.val-accel-card{background:var(--primary)11;border:1px solid var(--primary)44;border-radius:8px;padding:12px;margin:6px 0}.val-accel-card h5{margin:0 0 6px;color:var(--primary);font-size:.9rem}.val-accel-card pre{font-size:.78rem;margin:6px 0 0;padding:8px;background:var(--bg);border-radius:4px;overflow-x:auto}.sim-progress{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px 20px;margin:16px 0}.sim-progress-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin:8px 0}.sim-progress-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--primary),#ff8a4b);transition:width .4s ease}.sim-status{font-size:.85rem;color:var(--text2);display:flex;justify-content:space-between;align-items:center}.sim-status .engine-label{font-weight:600}.sim-donuts{display:flex;gap:32px;justify-content:center;flex-wrap:wrap;margin:24px 0}.sim-split{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:8px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}.sim-split-header{background:var(--surface2);padding:8px 12px;font-weight:600;font-size:.8rem;text-transform:uppercase;letter-spacing:.5px;text-align:center}.sim-split-header.nifi-side{border-right:1px solid var(--border);color:#728e9b}.sim-split-header.dbx-side{color:var(--primary)}.sim-split-cell{padding:8px 12px;font-size:.78rem;font-family:var(--mono);background:var(--surface);border-top:1px solid var(--border);overflow-x:auto;max-height:200px;overflow-y:auto}.sim-split-cell.nifi-side{border-right:1px solid var(--border)}.state-diff{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0}.state-diff-panel{background:var(--bg2);border-radius:8px;padding:12px}.state-diff-panel h4{margin:0 0 8px;font-size:.85rem;color:var(--text2)}.state-diff-panel pre{font-size:.72rem;max-height:200px;overflow-y:auto}.filter-toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;align-items:center}.filter-toolbar .filter-group{display:flex;gap:4px;align-items:center}.filter-toolbar label{font-size:.75rem;color:var(--text2);margin-right:4px;white-space:nowrap}.filter-btn{padding:4px 10px;font-size:.75rem;border:1px solid var(--border);border-radius:4px;background:var(--surface2);color:var(--text2);cursor:pointer;transition:all .15s}.filter-btn:hover{border-color:var(--primary);color:var(--text)}.filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}.filter-search{padding:4px 8px;font-size:.75rem;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);width:160px}.filter-search::placeholder{color:var(--text2)}.density-row{cursor:pointer;padding:2px 4px;border-radius:4px;transition:background .15s}.density-row:hover{background:#ffffff0f}.density-row.filter-active{background:#faca1526;border:1px solid rgba(250,202,21,.4)}.density-row.filter-dimmed{opacity:.3}.sidebar-filter-hint{font-size:.6rem;color:var(--text2);margin-bottom:6px;font-style:italic}.sidebar-clear-btn{font-size:.65rem;color:var(--primary);cursor:pointer;margin-top:6px;display:none;text-align:center;padding:4px;border-radius:4px}.sidebar-clear-btn:hover{background:#ff4b4b1a}@keyframes pop{0%{transform:scale(0)}60%{transform:scale(1.3)}to{transform:scale(1)}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes cyclePulse{0%,to{box-shadow:0 0 #ef444466}50%{box-shadow:0 0 0 6px #ef444400}}@keyframes simPulse{0%,to{opacity:1}50%{opacity:.5}}.sim-running{animation:simPulse 1s ease-in-out infinite}</style>
</head>
<body>
<div class="container">
  <h1>NiFi Flow Analyzer</h1>
  <p class="caption">Upload a NiFi flow XML &mdash; analyze processors, assess migration readiness, convert to Databricks, and generate migration reports</p>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="load">1. Load Flow<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="analyze">2. Analyze<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="assess">3. Assess<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="convert">4. Convert<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="report">5. Report<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="reportFinal">6. Final Report<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="validate">7. Validate<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
    <div class="tab locked" data-tab="value">8. Value Analysis<span class="check">&#10003;</span><span class="spinner-sm"></span></div>
  </div>

  <!-- STEP 1: LOAD NIFI FLOW -->
  <div class="panel active" id="panel-load">
    <h2>Step 1: Load NiFi Flow</h2>
    <div class="row">
      <div class="col">
        <h3>Upload NiFi XML</h3>
        <div class="file-upload" id="fileDropZone">
          <p>Drop a NiFi flow XML here or click to browse</p>
          <p style="color:var(--text2);font-size:0.85rem">Supports NiFi templates, flow definitions, and registry exports</p>
          <input type="file" id="fileInput" accept=".xml,.json">
        </div>
        <div id="fileName" class="alert alert-info hidden" style="margin-top:12px"></div>
      </div>
      <div class="col">
        <h3>Paste NiFi XML</h3>
        <textarea id="pasteInput" placeholder="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;template&gt;
  &lt;snippet&gt;
    &lt;processors&gt;...&lt;/processors&gt;
  &lt;/snippet&gt;
&lt;/template&gt;"></textarea>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-primary" id="parseBtn">Analyze Flow</button>
      <div id="parseProgress" style="display:none;flex:1;min-width:300px;align-items:center;gap:10px">
        <div style="flex:0 0 200px;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden"><div id="parsePBar" style="height:100%;width:0%;background:var(--primary);border-radius:4px;transition:width 0.15s"></div></div>
        <span id="parsePPct" style="font-size:0.8rem;font-weight:700;color:var(--primary);min-width:36px">0%</span>
        <span id="parsePStatus" style="font-size:0.78rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:500px"></span>
      </div>
    </div>
    <div style="margin-top:20px;border:1px solid var(--border);border-radius:12px;padding:16px;background:var(--bg2)">
      <h3 style="margin:0 0 4px 0;font-size:0.95rem">Sample NiFi Flows &mdash; Click to Load &amp; Analyze</h3>
      <p style="color:var(--text2);font-size:0.8rem;margin:0 0 12px 0">Pre-built NiFi flow samples that demonstrate the full analysis pipeline.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px">
        <div class="sample-card" data-sample="etl">
          <div class="sample-icon">&#128640;</div>
          <div class="sample-info"><strong>ETL Pipeline</strong><span>NiFi XML &bull; 9 processors</span><span class="sample-tags">GetFile, SQL, Route, PutFile</span></div>
        </div>
        <div class="sample-card" data-sample="streaming">
          <div class="sample-icon">&#9889;</div>
          <div class="sample-info"><strong>Streaming IoT</strong><span>NiFi XML &bull; 10 processors</span><span class="sample-tags">Kafka, JSON, Merge, HDFS</span></div>
        </div>
        <div class="sample-card" data-sample="full">
          <div class="sample-icon">&#127981;</div>
          <div class="sample-info"><strong>Manufacturing Migration</strong><span>NiFi XML &bull; 17 processors</span><span class="sample-tags">ListFile, SFTP, Wait/Notify, SQL</span></div>
        </div>
      </div>
    </div>
    <div id="parseResults"></div>
  </div>

  <!-- STEP 2: ANALYZE -->
  <div class="panel" id="panel-analyze">
    <h2>Step 2: Flow Analysis</h2>
    <div id="analyzeNotReady" class="alert alert-info">Load a NiFi flow first (Step 1).</div>
    <div id="analyzeReady" class="hidden">
      <button class="btn btn-primary" id="analyzeBtn">Run Deep Analysis</button>
      <div id="analyzeResults"></div>
    </div>
  </div>

  <!-- STEP 3: ASSESS -->
  <div class="panel" id="panel-assess">
    <h2>Step 3: Migration Assessment</h2>
    <div id="assessNotReady" class="alert alert-info">Complete the flow analysis first (Step 2).</div>
    <div id="assessReady" class="hidden">
      <button class="btn btn-primary" id="assessBtn">Run Assessment</button>
      <div id="assessResults"></div>
    </div>
  </div>

  <!-- STEP 4: CONVERT -->
  <div class="panel" id="panel-convert">
    <h2>Step 4: NiFi &rarr; Databricks Notebook</h2>
    <div id="convertNotReady" class="alert alert-info">Complete the assessment first (Step 3).</div>
    <div id="convertReady" class="hidden">
      <p style="color:var(--text2);font-size:0.9rem;margin-bottom:12px">
        Reverse-engineer your NiFi flow into a Databricks Python notebook with PySpark equivalents,
        Unity Catalog definitions, and a Databricks workflow.
      </p>
      <div class="expander" id="dbxConfigExpander"><div class="expander-header" id="dbxConfigExpanderHeader"><span>Databricks Configuration</span><span class="expander-arrow">&#9654;</span></div><div class="expander-body">
        <p style="font-size:0.82rem;color:var(--text2);margin-bottom:12px">Configure these to generate a runnable notebook with resolved placeholders. Leave blank for generic templates.</p>
        <div class="row">
          <div class="col"><label>Unity Catalog</label><input type="text" id="cfgCatalog" placeholder="e.g. main"></div>
          <div class="col"><label>Schema</label><input type="text" id="cfgSchema" placeholder="e.g. nifi_migration"></div>
          <div class="col"><label>Secret Scope</label><input type="text" id="cfgScope" placeholder="e.g. migration_secrets"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Cloud Provider</label><select id="cfgCloud"><option value="azure">Azure</option><option value="aws">AWS</option><option value="gcp">GCP</option></select></div>
          <div class="col"><label>Spark Version</label><input type="text" id="cfgSparkVersion" value="14.3.x-scala2.12"></div>
          <div class="col"><label>Node Type</label><input type="text" id="cfgNodeType" value="Standard_DS3_v2"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col"><label>Workers</label><input type="number" id="cfgWorkers" value="2" min="1" max="100"></div>
          <div class="col" style="flex:2"><label>Workspace Path</label><input type="text" id="cfgWorkspacePath" value="/Workspace/Migrations/NiFi"></div>
        </div>
        <div style="margin-top:8px"><button class="btn" id="saveDbxConfigBtn">Save Configuration</button></div>
      </div></div>
      <div style="margin-top:12px"><button class="btn btn-primary" id="generateNotebookBtn">Generate Notebook</button></div>
      <div id="notebookResults"></div>
    </div>
  </div>

  <!-- STEP 5: MIGRATION REPORT -->
  <div class="panel" id="panel-report">
    <h2>Step 5: Migration Report</h2>
    <div id="reportNotReady" class="alert alert-info">Generate the notebook first (Step 4).</div>
    <div id="reportReady" class="hidden">
      <button class="btn btn-primary" id="reportBtn">Generate Report</button>
      <div id="reportResults"></div>
    </div>
  </div>

  <!-- STEP 6: FINAL REPORT -->
  <div class="panel" id="panel-reportFinal">
    <h2>Step 6: Final Report</h2>
    <div id="reportFinalNotReady" class="alert alert-info">Generate the migration report first (Step 5).</div>
    <div id="reportFinalReady" class="hidden">
      <p style="color:var(--text2);font-size:0.9rem;margin-bottom:12px">
        Comprehensive end-to-end analysis &mdash; every processor, every gap, every recommendation. Download as JSON.
      </p>
      <button class="btn btn-primary" id="finalReportBtn">Generate Final Report</button>
      <div id="reportFinalResults"></div>
    </div>
  </div>

  <!-- STEP 7: VALIDATE -->
  <div class="panel" id="panel-validate">
    <h2>Step 7: Notebook &harr; Flow Validation</h2>
    <div id="validateNotReady" class="alert alert-info">Generate the final report first (Step 6).</div>
    <div id="validateReady" class="hidden">
      <p style="color:var(--text2);font-size:0.9rem;margin-bottom:12px">
        Four-angle comparison between the generated PySpark notebook and the original NiFi flow.
        Identifies gaps, manual items, and feeds corrections back into the accelerator.
      </p>
      <button class="btn btn-primary" id="validateBtn">Run Validation</button>
      <div id="validateResults"></div>
    </div>
  </div>

  <!-- STEP 8: VALUE ANALYSIS -->
  <div class="panel" id="panel-value">
    <h2>Step 8: Workflow Value Analysis</h2>
    <div id="valueNotReady" class="alert alert-info">Complete validation first (Step 7).</div>
    <div id="valueReady" class="hidden">
      <p style="color:var(--text2);font-size:0.9rem;margin-bottom:12px">
        Holistic migration value assessment &mdash; what the flow does, how to build it better in Databricks,
        what steps can be dropped, and quantified migration ROI.
      </p>
      <button class="btn btn-primary" id="valueBtn">Run Value Analysis</button>
      <div id="valueResults"></div>
    </div>
  </div>
</div>
<div class="path-trace-toast" id="pathTraceToast">
  <span id="pathTraceText"></span>
  <span class="toast-hint">Click another node to extend path</span>
  <span class="toast-clear" id="pathTraceClear">Clear</span>
</div>

</body>
</html>
