/**
 * reporters/export-formats.js â€” Notebook and workflow export functions
 *
 * Extracted from index.html lines 9108-9198.
 * Provides export to Databricks .py notebook, Jupyter .ipynb, and
 * workflow DAG YAML formats.
 *
 * @module reporters/export-formats
 */

/**
 * Export cells as a Databricks .py notebook file.
 *
 * @param {Array} cells - Notebook cells (from window._lastNotebookCells)
 */
export function exportAsDatabricksNotebook(cells) {
  if (!cells || cells.length === 0) {
    alert('No notebook cells generated yet. Run the conversion pipeline first.');
    return;
  }
  let nb = '# Databricks notebook source\n';
  nb += '# Generated by NiFi Flow Analyzer \u2014 Automated Migration\n';
  nb += '# Date: ' + new Date().toISOString().split('T')[0] + '\n\n';
  cells.forEach((cell, i) => {
    if (i > 0) nb += '\n# COMMAND ----------\n\n';
    const src = cell.source || cell.code || '';
    if (cell.type === 'markdown' || cell.type === 'md' || cell.role === 'markdown') {
      nb += '# MAGIC %md\n';
      src.split('\n').forEach(line => { nb += '# MAGIC ' + line + '\n'; });
    } else if (cell.type === 'sql') {
      nb += '# MAGIC %sql\n';
      src.split('\n').forEach(line => { nb += '# MAGIC ' + line + '\n'; });
    } else {
      nb += src + '\n';
    }
  });
  const blob = new Blob([nb], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'nifi_migration_notebook.py';
  a.click();
  URL.revokeObjectURL(url);
}

/**
 * Export cells as a Jupyter .ipynb notebook file.
 *
 * @param {Array} cells - Notebook cells (from window._lastNotebookCells)
 */
export function exportAsJupyterNotebook(cells) {
  if (!cells || cells.length === 0) {
    alert('No notebook cells generated yet. Run the conversion pipeline first.');
    return;
  }
  const nbJson = {
    nbformat: 4, nbformat_minor: 5,
    metadata: {
      kernelspec: { display_name: 'Python 3', language: 'python', name: 'python3' },
      language_info: { name: 'python', version: '3.10.0' }
    },
    cells: cells.map(cell => {
      const isMarkdown = (cell.type === 'markdown' || cell.type === 'md' || cell.role === 'markdown');
      const c = {
        cell_type: isMarkdown ? 'markdown' : 'code',
        metadata: {},
        source: (cell.source || cell.code || '').split('\n').map((l, i, a) => i < a.length - 1 ? l + '\n' : l),
      };
      if (!isMarkdown) {
        c.outputs = [];
        c.execution_count = null;
      }
      return c;
    })
  };
  const blob = new Blob([JSON.stringify(nbJson, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'nifi_migration_notebook.ipynb';
  a.click();
  URL.revokeObjectURL(url);
}

/**
 * Export the NiFi flow as a Databricks Workflow DAG YAML file.
 *
 * @param {object}   nifiFlow          - Parsed NiFi flow (needs .processGroups, .connections)
 * @param {Function} generateWorkflowDAG - DAG generator function
 */
export function exportWorkflowYAML(nifiFlow, generateWorkflowDAG) {
  if (!nifiFlow) {
    alert('No NiFi flow loaded yet.');
    return;
  }
  const pgs = nifiFlow.processGroups || [];
  const conns = nifiFlow.connections || [];
  const dag = generateWorkflowDAG(pgs, conns);
  let yaml = '# Databricks Workflow \u2014 Generated from NiFi Flow\n';
  yaml += '# Date: ' + new Date().toISOString().split('T')[0] + '\n\n';
  yaml += 'name: nifi_migration_workflow\n';
  yaml += 'tasks:\n';
  dag.tasks.forEach(t => {
    if (!t.task_key || !t.notebook_task?.notebook_path) return;
    yaml += '  - task_key: "' + t.task_key.replace(/"/g, '\\"') + '"\n';
    yaml += '    notebook_task:\n';
    yaml += '      notebook_path: "' + t.notebook_task.notebook_path.replace(/"/g, '\\"') + '"\n';
    yaml += '      source: WORKSPACE\n';
    if (t.depends_on && t.depends_on.length > 0) {
      yaml += '    depends_on:\n';
      t.depends_on.forEach(d => {
        if (!d.task_key) return;
        yaml += '      - task_key: "' + d.task_key.replace(/"/g, '\\"') + '"\n';
      });
    }
    yaml += '\n';
  });
  const blob = new Blob([yaml], { type: 'text/yaml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'nifi_migration_workflow.yml';
  a.click();
  URL.revokeObjectURL(url);
}
